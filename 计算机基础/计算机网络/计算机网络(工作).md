







# TCP 三次握手

## 1️⃣ 第一次握手（SYN）

**客户端 → 服务器**

```
16:29:59.847444 IP 1.116.159.145.32888 > 10.0.4.2.3306: Flags [S], seq 3147299277, win 29200, options [mss 1424,sackOK,TS val 3772856463 ecr 0,nop,wscale 7], length 0
```

### 字段说明

- **时间戳**：16:29:59.847444
- **源/目标**：客户端 1.116.159.145:32888 → 服务器 10.0.4.2:3306
- **TCP 标志**：SYN
- **序列号**：3147299277（客户端 ISN）
- **窗口大小**：29200 → 实际大小 29200×128≈3.6MB
- **TCP 选项**：
  - MSS 1424
  - SACK OK
  - 时间戳 TS val 3772856463 ecr 0
  - NOP
  - 窗口缩放 wscale 7
- **数据长度**：0
- **特点**：
  - 客户端使用公网 IP，服务器内网 IP → 可能经过 NAT/代理
  - 为 MySQL 握手做准备

------

## 2️⃣ 第二次握手（SYN+ACK）

**服务器 → 客户端**

```
16:29:59.847481 IP 10.0.4.2.3306 > 1.116.159.145.32888: Flags [S.], seq 4150827340, ack 3147299278, win 28960, options [mss 1460,sackOK,TS val 3772856464 ecr 3772856463,nop,wscale 7], length 0
```

### 字段说明

- **TCP 标志**：SYN + ACK
- **序列号**：4150827340（服务器 ISN）
- **确认号**：3147299278（确认客户端 ISN + 1）
- **窗口大小**：28960 → 实际大小 28960×128≈3.7MB
- **TCP 选项**：
  - MSS 1460
  - SACK OK
  - 时间戳 TS val 3772856464 ecr 3772856463
  - NOP
  - 窗口缩放 wscale 7
- **数据长度**：0
- **特点**：服务器确认收到客户端 SYN，并同步自己的序列号

------

## 3️⃣ 第三次握手（ACK）

**客户端 → 服务器**

```
16:29:59.848567 IP 1.116.159.145.32888 > 10.0.4.2.3306: Flags [.] ack 4150827341, win 29200, options [TS val 3772856465 ecr 3772856464], length 0
```

### 字段说明

- **TCP 标志**：ACK
- **确认号**：4150827341（确认服务器 ISN + 1）
- **窗口大小**：29200 → 实际 3.7MB
- **TCP 选项**：时间戳 TS val 3772856465 ecr 3772856464
- **数据长度**：0
- **特点**：客户端确认收到服务器的 SYN+ACK，三次握手完成

------

# TCP 四次挥手（断开连接）

## 1️⃣ 第一次挥手（FIN）

**客户端 → 服务器**

```
16:35:12.123456 IP 1.116.159.145.32888 > 10.0.4.2.3306: Flags [F.], seq 3147300000, ack 4150830000, win 29200, length 0
```

### 字段说明

- **TCP 标志**：FIN + ACK
- **序列号**：3147300000
- **确认号**：4150830000
- **特点**：客户端主动关闭连接，通知服务器自己没有数据发送了

------

## 2️⃣ 第二次挥手（ACK）

**服务器 → 客户端**

```
16:35:12.123789 IP 10.0.4.2.3306 > 1.116.159.145.32888: Flags [.] ack 3147300001, win 28960, length 0
```

### 字段说明

- **TCP 标志**：ACK
- **确认号**：3147300001（确认客户端 FIN + 1）
- **特点**：服务器确认收到客户端 FIN

------

## 3️⃣ 第三次挥手（FIN）

**服务器 → 客户端**

```
16:35:12.124123 IP 10.0.4.2.3306 > 1.116.159.145.32888: Flags [F.], seq 4150830000, ack 3147300001, win 28960, length 0
```

### 字段说明

- **TCP 标志**：FIN + ACK
- **序列号**：4150830000
- **确认号**：3147300001
- **特点**：服务器通知客户端自己也没有数据发送了

------

## 4️⃣ 第四次挥手（ACK）

**客户端 → 服务器**

```
16:35:12.124456 IP 1.116.159.145.32888 > 10.0.4.2.3306: Flags [.] ack 4150830001, win 29200, length 0
```

### 字段说明

- **TCP 标志**：ACK
- **确认号**：4150830001（确认服务器 FIN + 1）
- **特点**：客户端确认，连接正式关闭

------

✅ 总结：

- **三次握手**：SYN → SYN+ACK → ACK
- **四次挥手**：FIN → ACK → FIN → ACK

------

如果你愿意，我可以帮你做一个 **`.md` 格式的复习模板**，把三次握手、四次挥手、SYN 包优化点都做成 **checklist + 核心字段说明** 的形式，你直接打勾复习就行，非常适合蚂蚁或银行面试复盘。

你想让我帮你做吗？