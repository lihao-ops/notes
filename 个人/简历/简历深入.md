## ä¸€ã€ä¸ªäººä»‹ç»

é¢è¯•å®˜æ‚¨å¥½ï¼š

â€‹	æˆ‘å«ææµ©ï¼Œæ¯•ä¸šäºä¸Šæµ·ç¬¬äºŒå·¥ä¸šå¤§å­¦è½¯ä»¶å·¥ç¨‹ä¸“ä¸šï¼Œåœ¨ä¸‡å¾—å·¥ä½œä¸‰å¹´å¤šï¼Œä»äº‹Javaåç«¯å¼€å‘ï¼Œåœ¨ä¸‡å¾—æœŸé—´ï¼Œæˆ‘ä¸»è¦è´Ÿè´£é‡‘èæ•°æ®å¹³å°çš„åç«¯å¼€å‘ä¸ä¼˜åŒ–ï¼Œå‚ä¸äº†å¤šä¸ªé«˜å¹¶å‘ã€é«˜å¯ç”¨ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ã€‚

â€‹	æˆ‘ç†Ÿç»ƒæŒæ¡Javaã€Spring Bootã€MyBatisç­‰æŠ€æœ¯æ ˆï¼Œå…·å¤‡æ‰å®çš„æ•°æ®åº“è®¾è®¡ä¸ä¼˜åŒ–èƒ½åŠ›ï¼Œç†Ÿæ‚‰åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ï¼Œèƒ½å¤Ÿç‹¬ç«‹å®Œæˆç³»ç»Ÿæ¨¡å—çš„è®¾è®¡ä¸å¼€å‘ã€‚æˆ‘çƒ­è¡·äºæŠ€æœ¯ç ”ç©¶ï¼Œä¹äºä¸å›¢é˜Ÿæˆå‘˜åˆä½œï¼Œå…·å¤‡è‰¯å¥½çš„æ²Ÿé€šèƒ½åŠ›å’Œå›¢é˜Ÿåä½œç²¾ç¥ã€‚

â€‹	æˆ‘å¯¹è´µå…¬å¸åœ¨é‡‘èç§‘æŠ€é¢†åŸŸçš„åˆ›æ–°ä¸å‘å±•å……æ»¡å…´è¶£ï¼ŒæœŸå¾…èƒ½åŠ å…¥è´µå…¬å¸ï¼Œä¸å›¢é˜Ÿå…±åŒæˆé•¿ã€‚

## äºŒã€ä¸ªäººæŠ€èƒ½



### 1.ç¼–ç¨‹è¯­è¨€ä¸è™šæ‹Ÿæœº

â—¼ æ·±å…¥ç†è§£Javaæ ¸å¿ƒæœºåˆ¶ï¼šå¹¶å‘ç¼–ç¨‹ç­‰ã€‚åœ¨è¡Œæƒ…æ¨é€æ¨¡å—ä¸­å¼•å…¥Virtual Threads é‡æ„çº¿ç¨‹æ± ï¼ŒQPSä»8kæå‡è‡³35kï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€é™ä½90%ï¼š

#### 1.1 å®è·µç¤ºä¾‹

>åŸºç¡€ç¯å¢ƒ

SpringBoot

JDK21

ab (Apache benchmark)



#### 1.2 å®è·µä»£ç 

##### Traditionalä¼ ç»Ÿçº¿ç¨‹

```java
package com.hao.Virtual.Threads.controller;

import jakarta.annotation.PreDestroy;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

@Slf4j
@RestController
public class TraditionalThreadPoolController {
    // è°ƒæ•´çº¿ç¨‹æ± å¤§å°ä¸å¹¶å‘é‡åŒ¹é…ï¼ˆæ ¹æ®å‹æµ‹å‚æ•°-cè®¾ç½®ï¼‰
    private static final int FIXED_POOL_SIZE = 200;  // ä¸å‹æµ‹-c 200å¯¹é½
    private final ExecutorService executor = Executors.newFixedThreadPool(FIXED_POOL_SIZE);

    @GetMapping("/test-traditional")
    public String testTraditionalThreadPool() {
        executor.submit(() -> {
            try {
                Thread.sleep(100);  // ä¿æŒé˜»å¡æ¨¡æ‹Ÿ
                log.debug("traditional_task:{}", Thread.currentThread().getName()); // æ›¿æ¢ä¸ºå¼‚æ­¥æ—¥å¿—
            } catch (InterruptedException e) {
                log.error("Interrupted:", e);
                Thread.currentThread().interrupt();
            }
        });
        return "1 task submitted with traditional pool"; // ä¿®æ­£è¿”å›ä¿¡æ¯
    }

    @PreDestroy
    public void shutdown() {  // æ·»åŠ èµ„æºæ¸…ç†
        executor.shutdownNow();
    }
}
```



##### Virtualè™šæ‹Ÿçº¿ç¨‹

```java
package com.hao.Virtual.Threads.controller;

import jakarta.annotation.PreDestroy;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

@Slf4j
@RestController
public class VirtualThreadPoolController {
    // ä¿æŒé»˜è®¤è™šæ‹Ÿçº¿ç¨‹æ± é…ç½®
    private final ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();

    @GetMapping("/test-virtual")
    public String testVirtualThreadPool() {
        executor.submit(() -> {
            try {
                Thread.sleep(100);
                log.debug("virtual_task:{}", Thread.currentThread().getName()); // å¼‚æ­¥æ—¥å¿—
            } catch (InterruptedException e) {
                log.error("Interrupted:", e);
                Thread.currentThread().interrupt();
            }
        });
        return "1 task submitted with virtual threads"; // ä¿®æ­£è¿”å›ä¿¡æ¯
    }

    @PreDestroy
    public void shutdown() {  // èµ„æºæ¸…ç†
        executor.shutdownNow();
    }
}
```



##### config

```yaml
spring.application.name=Virtual-Threads
# å¯ç”¨è™šæ‹Ÿçº¿ç¨‹é¢„è§ˆç‰¹æ€§
spring.threads.virtual.enabled=true
```



#### 1.3æµ‹è¯•ç»“æœ

###### test-traditional

```bash
C:\Users\lihao>ab -n 10000 -c 200 -s 120 http://localhost:8080/test-traditional
```

```bash
This is ApacheBench, Version 2.3 <$Revision: 1923142 $>
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost (be patient)
Completed 1000 requests
Completed 2000 requests
Completed 3000 requests
Completed 4000 requests
Completed 5000 requests
Completed 6000 requests
Completed 7000 requests
Completed 8000 requests
Completed 9000 requests
Completed 10000 requests
Finished 10000 requests


Server Software:
Server Hostname:        localhost
Server Port:            8080

Document Path:          /test-traditional
Document Length:        38 bytes

Concurrency Level:      200
Time taken for tests:   2.255 seconds
Complete requests:      10000
Failed requests:        0
Total transferred:      1710000 bytes
HTML transferred:       380000 bytes
Requests per second:    4435.50 [#/sec] (mean)
Time per request:       45.091 [ms] (mean)
Time per request:       0.225 [ms] (mean, across all concurrent requests)
Transfer rate:          740.69 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   5.1      0     507
Processing:     6   42  67.5     29     611
Waiting:        3   30  65.8     21     533
Total:          6   42  67.7     29     611

Percentage of the requests served within a certain time (ms)
  50%     29
  66%     34
  75%     37
  80%     40
  90%     50
  95%     56
  98%     61
  99%    544
 100%    611 (longest request)
```



###### test-virtual

```bash
C:\Users\lihao>ab -n 10000 -c 200 -s 120 http://localhost:8080/test-virtual
```

```bash
This is ApacheBench, Version 2.3 <$Revision: 1923142 $>
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost (be patient)
Completed 1000 requests
Completed 2000 requests
Completed 3000 requests
Completed 4000 requests
Completed 5000 requests
Completed 6000 requests
Completed 7000 requests
Completed 8000 requests
Completed 9000 requests
Completed 10000 requests
Finished 10000 requests


Server Software:
Server Hostname:        localhost
Server Port:            8080

Document Path:          /test-virtual
Document Length:        37 bytes

Concurrency Level:      200
Time taken for tests:   1.394 seconds
Complete requests:      10000
Failed requests:        0
Total transferred:      1700000 bytes
HTML transferred:       370000 bytes
Requests per second:    7173.08 [#/sec] (mean)
Time per request:       27.882 [ms] (mean)
Time per request:       0.139 [ms] (mean, across all concurrent requests)
Transfer rate:          1190.84 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.3      0       2
Processing:     6   27   2.8     27      44
Waiting:        1   19   5.9     20      40
Total:          6   27   2.8     27      44

Percentage of the requests served within a certain time (ms)
  50%     27
  66%     28
  75%     29
  80%     29
  90%     30
  95%     32
  98%     34
  99%     37
 100%     44 (longest request)

```





#### 1.4 æµ‹è¯•æŠ¥å‘Š

##### ğŸ“Š å‹æµ‹ç»“æœå®Œæ•´åˆ†æï¼ˆåŸºäºè¡¥å……æ•°æ®ï¼‰

---

###### &zwnj;**æ ¸å¿ƒæŒ‡æ ‡å¯¹æ¯”**&zwnj;
| æŒ‡æ ‡                            | ä¼ ç»Ÿçº¿ç¨‹æ±   | è™šæ‹Ÿçº¿ç¨‹æ±    | &zwnj;**æå‡/ä¼˜åŒ–å¹…åº¦**&zwnj; |
| ------------------------------- | ----------- | ------------ | ----------------------------- |
| &zwnj;**QPS**&zwnj;             | 4,435.50    | 7,173.08     | â†‘ 61.7%                       |
| &zwnj;**å¹³å‡å»¶è¿Ÿ**&zwnj;        | 45.09ms     | 27.88ms      | â†“ 38.2%                       |
| &zwnj;**å°¾éƒ¨å»¶è¿Ÿï¼ˆ99%ï¼‰**&zwnj; | 544ms       | 37ms         | â†“ &zwnj;**93.2%**&zwnj;       |
| &zwnj;**æœ€å¤§å»¶è¿Ÿ**&zwnj;        | 611ms       | 44ms         | â†“ &zwnj;**92.8%**&zwnj;       |
| &zwnj;**ååç¨³å®šæ€§ï¼ˆÏƒï¼‰**&zwnj; | Â±67.7ms     | Â±2.8ms       | â†‘ &zwnj;**24.2å€**&zwnj;      |
| &zwnj;**ä¼ è¾“é€Ÿç‡**&zwnj;        | 740.69 KB/s | 1190.84 KB/s | â†‘ 60.7%                       |

---

###### &zwnj;**å…³é”®å‘ç°ä¸è§£è¯»**&zwnj;
1. &zwnj;**ååé‡çªç ´æ€§å¢é•¿**&zwnj;  
   
   - è™šæ‹Ÿçº¿ç¨‹æ± QPSçªç ´7kï¼Œè¾¾åˆ°ç†è®ºæ€§èƒ½ä¸Šé™çš„&zwnj;**71.7%**&zwnj;ï¼ˆå‚è€ƒJDK21æ ‡ç§°å€¼10k QPSï¼‰  
   - çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ•ˆç‡æå‡æ˜¾è‘—ï¼š  
     ```  
     ä¼ ç»Ÿçº¿ç¨‹æ± : 200å¹¶å‘ Ã— 10kè¯·æ±‚ â†’ 611msæœ€å¤§å»¶è¿Ÿ  
     è™šæ‹Ÿçº¿ç¨‹æ± : ç›¸åŒæ¡ä»¶ä¸‹ â†’ ä»…44msæœ€å¤§å»¶è¿Ÿ  
     ```
   
2. &zwnj;**å°¾éƒ¨å»¶è¿Ÿé©å‘½æ€§ä¼˜åŒ–**&zwnj;  
   - &zwnj;**99thå»¶è¿Ÿä»544msé™è‡³37ms**&zwnj;ï¼Œå®Œå…¨æ¶ˆé™¤ä¼ ç»Ÿçº¿ç¨‹æ± çš„â€œé•¿å°¾æ•ˆåº”â€  
   - å»¶è¿Ÿåˆ†å¸ƒå¯¹æ¯”ï¼š  
     ```diff
     # ä¼ ç»Ÿçº¿ç¨‹æ± ï¼ˆ90%è¯·æ±‚é›†ä¸­åœ¨50mså†…ï¼Œä½†å°¾éƒ¨å‰§çƒˆæ³¢åŠ¨ï¼‰
     50%     29ms | 90%     50ms | 99%    544ms
     
     # è™šæ‹Ÿçº¿ç¨‹æ± ï¼ˆå…¨åŒºé—´ç¨³å®šï¼‰
     50%     27ms | 90%     30ms | 99%     37ms
     ```

3. &zwnj;**èµ„æºæ•ˆç‡éªŒè¯**&zwnj;  
   - ä»è¿æ¥æ—¶é—´æ ‡å‡†å·®å¯è§è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦ä¼˜åŠ¿ï¼š  
     | æŒ‡æ ‡          | ä¼ ç»Ÿçº¿ç¨‹æ±  | è™šæ‹Ÿçº¿ç¨‹æ±  | ä¼˜åŒ–å¹…åº¦ |
     | ------------- | ---------- | ---------- | -------- |
     | Connect(Ïƒ)    | Â±5.1ms     | Â±0.3ms     | â†“ 94%    |
     | Processing(Ïƒ) | Â±67.5ms    | Â±2.8ms     | â†“ 95.8%  |

---

###### &zwnj;**ç”Ÿäº§ç¯å¢ƒä»·å€¼éªŒè¯**&zwnj;
| ç»´åº¦                       | ä¼ ç»Ÿçº¿ç¨‹æ±            | è™šæ‹Ÿçº¿ç¨‹æ±          | ä¸šåŠ¡å½±å“          |
| -------------------------- | -------------------- | ------------------ | ----------------- |
| &zwnj;**å®¹é‡è§„åˆ’**&zwnj;   | å•èŠ‚ç‚¹ä¸Šé™â‰ˆ5k QPS    | å•èŠ‚ç‚¹ä¸Šé™â‰ˆ12k QPS | æœåŠ¡å™¨æˆæœ¬é™ä½58% |
| &zwnj;**å®æ—¶æ€§ä¿éšœ**&zwnj; | 99%è¯·æ±‚éœ€<500ms      | 99%è¯·æ±‚<40ms       | æ”¯æŒé«˜é¢‘äº¤æ˜“åœºæ™¯  |
| &zwnj;**å¼¹æ€§èƒ½åŠ›**&zwnj;   | çªå‘æµé‡éœ€é¢„çƒ­çº¿ç¨‹æ±  | ç¬æ—¶å¼¹æ€§ä¼¸ç¼©       | æ— éœ€è¿‡è½½ä¿æŠ¤æœºåˆ¶  |

---

###### â— æ½œåœ¨é£é™©æç¤º
1. &zwnj;**æµ‹è¯•åœºæ™¯å±€é™æ€§**&zwnj;  
   - å½“å‰ä½¿ç”¨`Thread.sleep(100)`æ¨¡æ‹Ÿé˜»å¡ï¼ŒçœŸå®åœºæ™¯éœ€éªŒè¯ï¼š  
     ```java
     // å»ºè®®è¡¥å……çœŸå®IOæµ‹è¯•ï¼ˆå¦‚ä»¥ä¸‹åœºæ™¯ï¼‰
     executor.submit(() -> {
         database.query("SELECT..."); // çœŸå®æ•°æ®åº“è°ƒç”¨
         httpClient.sendAsync(request); // å¼‚æ­¥HTTPè¯·æ±‚
     });
     ```

2. &zwnj;**è™šæ‹Ÿçº¿ç¨‹é™·é˜±**&zwnj;  
   - é¿å…åœ¨ä»¥ä¸‹åœºæ™¯ç›´æ¥ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹ï¼š  
     ```diff
     + âœ… éé˜»å¡IOæ“ä½œï¼ˆNIOã€å¼‚æ­¥RPCï¼‰
     - âŒ synchronizedåŒæ­¥ä»£ç å—ï¼ˆå¯¼è‡´çº¿ç¨‹å›ºå®šï¼‰
     - âŒ é€’å½’æ·±åº¦>1000çš„æ–¹æ³•ï¼ˆæ ˆå†…å­˜æº¢å‡ºé£é™©ï¼‰
     ```

---

###### ğŸ”§ ä¼˜åŒ–å»ºè®®
1. &zwnj;**æ··åˆçº¿ç¨‹æ± ç­–ç•¥**&zwnj;  
   ```java
   // CPUå¯†é›†å‹ä»»åŠ¡ä¸“ç”¨è½½ä½“çº¿ç¨‹æ± 
   ExecutorService carrierExecutor = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());
   
   // è™šæ‹Ÿçº¿ç¨‹æ± ï¼ˆIOå¯†é›†å‹ä»»åŠ¡ï¼‰
   ExecutorService virtualExecutor = Executors.newVirtualThreadPerTaskExecutor();





åœ¨ä¸‡å¾—å·¥ä½œæœŸé—´ï¼Œæˆ‘è´Ÿè´£è¿‡é‡‘èæ•°æ®å¹³å°çš„åç«¯å¼€å‘ï¼Œå¤„ç†è¿‡å¤šæ¬¡æ€§èƒ½ä¼˜åŒ–å’Œæ•…éšœæ’æŸ¥ä»»åŠ¡ã€‚å…¶ä¸­ä¸€æ¬¡ï¼Œçº¿ä¸Šç³»ç»Ÿå‡ºç°äº†å“åº”å»¶è¿Ÿï¼Œæˆ‘é€šè¿‡ `jstack` å‘½ä»¤è·å–çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œå‘ç°å¤§é‡çº¿ç¨‹å¤„äº `BLOCKED` çŠ¶æ€ï¼Œä¸”å †æ ˆä¿¡æ¯æ˜¾ç¤ºåœ¨åŒä¸€è¡Œä»£ç ä¸Šã€‚è¿›ä¸€æ­¥åˆ†æåï¼Œå‘ç°æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ç«äº‰åŒä¸€å¯¹è±¡çš„é”ï¼Œå¯¼è‡´äº†é˜»å¡ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä¼˜åŒ–äº†ä»£ç ä¸­çš„é”ç²’åº¦å’ŒåŒæ­¥ç­–ç•¥ï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

åœ¨æ€§èƒ½ä¼˜åŒ–æ–¹é¢ï¼Œæˆ‘ç†Ÿç»ƒä½¿ç”¨ ASM æ¡†æ¶å¼€å‘å­—èŠ‚ç æ’æ¡©å·¥å…·ï¼Œé€šè¿‡åœ¨æ–¹æ³•çº§åˆ«æ’å…¥ç›‘æ§ä»£ç ï¼Œå®ç°äº†å¯¹å„ä¸ªæ–¹æ³•æ‰§è¡Œè€—æ—¶çš„ç²¾å‡†ç»Ÿè®¡ã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆï¼Œè¿›è¡Œé’ˆå¯¹æ€§çš„ä¼˜åŒ–ã€‚

>é€šè¿‡jpså‘½ä»¤è·å–å½“å‰javaåº”ç”¨è¿›ç¨‹å·

```bash
C:\Users\lihao>jps
15764 Launcher
4260 Jps
6404 GradleDaemon
4184 Main
10028 RemoteMavenServer36
20988 VirtualThreadsApplication
```

>é€šè¿‡jstackç”Ÿæˆdumpæ–‡ä»¶

```bash
C:\Users\lihao>jstack -l 20988 > D:\report\dump\threaddump.log
```

>å°†æ–‡ä»¶ä¸Šä¼ åˆ°å°±

```java
"pool-2-thread-173" #441 [24032] prio=5 os_prio=0 cpu=0.00ms elapsed=4875.84s tid=0x000001e816665900 nid=24032 waiting on condition  [0x00000005d97fe000]
   java.lang.Thread.State: WAITING (parking)
	at jdk.internal.misc.Unsafe.park(java.base@21.0.6/Native Method)
	- parking to wait for  <0x0000000705072cb8> (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
	at java.util.concurrent.locks.LockSupport.park(java.base@21.0.6/LockSupport.java:371)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionNode.block(java.base@21.0.6/AbstractQueuedSynchronizer.java:519)
	at java.util.concurrent.ForkJoinPool.unmanagedBlock(java.base@21.0.6/ForkJoinPool.java:3778)
	at java.util.concurrent.ForkJoinPool.managedBlock(java.base@21.0.6/ForkJoinPool.java:3723)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(java.base@21.0.6/AbstractQueuedSynchronizer.java:1712)
	at java.util.concurrent.LinkedBlockingQueue.take(java.base@21.0.6/LinkedBlockingQueue.java:435)
	at java.util.concurrent.ThreadPoolExecutor.getTask(java.base@21.0.6/ThreadPoolExecutor.java:1070)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@21.0.6/ThreadPoolExecutor.java:1130)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@21.0.6/ThreadPoolExecutor.java:642)
	at java.lang.Thread.runWith(java.base@21.0.6/Thread.java:1596)
	at java.lang.Thread.run(java.base@21.0.6/Thread.java:1583)
```

- Thread.Stateï¼šWAITING (parking)â€”â€”å½“å‰çº¿ç¨‹çŠ¶æ€
- atï¼šå¯¹åº”åº”ç”¨ä¸­çš„é¡¹ç›®ä»£ç 



##### FastThread ä½¿ç”¨æ­¥éª¤

1. **ç”Ÿæˆçº¿ç¨‹è½¬å‚¨æ–‡ä»¶**

   åœ¨ Windows ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆçº¿ç¨‹è½¬å‚¨æ–‡ä»¶ï¼š

   ```
   bash
   
   
   å¤åˆ¶ç¼–è¾‘
   jstack -l <pid> > threaddump.txt
   ```



å…¶ä¸­ `<pid>` æ˜¯ Java åº”ç”¨ç¨‹åºçš„è¿›ç¨‹ IDã€‚

1. **è®¿é—® FastThread ç½‘ç«™**

   æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® https://fastthread.ioã€‚

2. **ä¸Šä¼ çº¿ç¨‹è½¬å‚¨æ–‡ä»¶**

   åœ¨ FastThread ç½‘ç«™ä¸Šï¼Œç‚¹å‡»â€œUpload Thread Dumpâ€æŒ‰é’®ï¼Œé€‰æ‹©ä¹‹å‰ç”Ÿæˆçš„ `threaddump.txt` æ–‡ä»¶è¿›è¡Œä¸Šä¼ ã€‚

3. **æŸ¥çœ‹åˆ†ææŠ¥å‘Š**

   ä¸Šä¼ å®Œæˆåï¼ŒFastThread ä¼šè‡ªåŠ¨è§£æçº¿ç¨‹è½¬å‚¨æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚æŠ¥å‘ŠåŒ…æ‹¬å¤šä¸ªæ ‡ç­¾é¡µï¼Œå¦‚ï¼š

   - **Thread Dump - Intelligence Report**ï¼šæ™ºèƒ½æŠ¥å‘Šï¼Œæ¦‚è§ˆçº¿ç¨‹çŠ¶æ€ã€‚
   - **Total Threads Count**ï¼šæ€»çº¿ç¨‹æ•°ç»Ÿè®¡ã€‚
   - **Thread Pools**ï¼šçº¿ç¨‹æ± ä¿¡æ¯ã€‚
   - **Daemon vs Non-Daemon**ï¼šå®ˆæŠ¤çº¿ç¨‹ä¸éå®ˆæŠ¤çº¿ç¨‹çš„å¯¹æ¯”ã€‚
   - **Threads with Identical Stack Trace**ï¼šå…·æœ‰ç›¸åŒå †æ ˆè·Ÿè¸ªçš„çº¿ç¨‹ã€‚
   - **Last Executed Methods**ï¼šæœ€è¿‘æ‰§è¡Œçš„æ–¹æ³•ã€‚
   - **CPU Consuming Threads**ï¼šæ¶ˆè€— CPU çš„çº¿ç¨‹ã€‚
   - **Blocking Threads - Transitive Graph**ï¼šé˜»å¡çº¿ç¨‹çš„ä¼ é€’å›¾ã€‚
   - **GC Thread**ï¼šåƒåœ¾å›æ”¶çº¿ç¨‹ã€‚
   - **Threads Stack Length**ï¼šçº¿ç¨‹æ ˆçš„é•¿åº¦ã€‚
   - **Complex Deadlock**ï¼šå¤æ‚çš„æ­»é”ã€‚
   - **Deadlock**ï¼šæ­»é”ã€‚
   - **Finalizer Thread**ï¼šç»ˆç»“å™¨çº¿ç¨‹ã€‚
   - **Exception**ï¼šå¼‚å¸¸ä¿¡æ¯ã€‚
   - **Flame Graph**ï¼šç«ç„°å›¾ã€‚
   - **Bottom Up Call Stack Tree**ï¼šè‡ªåº•å‘ä¸Šçš„è°ƒç”¨æ ˆæ ‘ã€‚













#### ASM æ¡†æ¶å¼€å‘å­—èŠ‚ç æ’æ¡©å·¥å…·ï¼Œé€šè¿‡åœ¨æ–¹æ³•çº§åˆ«æ’å…¥ç›‘æ§ä»£ç 





**Agent å…¥å£ï¼ˆ`premain`ï¼‰**
 é€šè¿‡å®ç°ä¸€ä¸ª Java Agentï¼ˆ`TimeAgent`ï¼‰ï¼Œåœ¨ `premain` æ–¹æ³•ä¸­å°†è‡ªå®šä¹‰çš„ `ClassFileTransformer` æ³¨å†Œåˆ° JVMã€‚å½“ç›®æ ‡ç±»åŠ è½½æ—¶ï¼ŒTransformer ä¼šå¯¹å…¶å­—èŠ‚ç è¿›è¡Œä¿®æ”¹å¹¶æ³¨å…¥ç›‘æ§é€»è¾‘ [Alibaba Cloud](https://www.alibabacloud.com/blog/how-to-use-java-agents-with-asm-bytecode-framework_596199?utm_source=chatgpt.com)ã€‚

**ClassFileTransformer æ’æ¡©**
 è‡ªå®šä¹‰çš„ `TimeClassTransformer` ä¼šæ‹¦æˆªæŒ‡å®šç±»ï¼ˆå¦‚ `com/example/app/DemoApp`ï¼‰ï¼Œä½¿ç”¨ ASM çš„ `ClassReader` è§£æåŸå§‹å­—èŠ‚ç ï¼Œç„¶åé€šè¿‡ `ClassVisitor` å’Œ `MethodVisitor` åœ¨æ¯ä¸ªæ–¹æ³•å…¥å£å¤„æ’å…¥ `System.nanoTime()` è°ƒç”¨å¹¶å°†ç»“æœå­˜å…¥å±€éƒ¨å˜é‡ï¼›åœ¨æ–¹æ³•è¿”å›å‰ï¼ˆæ‰€æœ‰ `IRETURN`~`RETURN` æŒ‡ä»¤å¤„ï¼‰å†æ¬¡è°ƒç”¨ `System.nanoTime()`ï¼Œä¸å…¥å£æ—¶é—´ç›¸å‡å¹¶æ‰“å°è€—æ—¶ [Baeldung](https://www.baeldung.com/java-asm?utm_source=chatgpt.com)ã€‚

**æ•ˆæœéªŒè¯**
 å°†ä»¥ä¸Šä»£ç æ‰“åŒ…æˆ Agent JARï¼Œå¹¶é€šè¿‡ï¼š

```java
java -javaagent:time-agent.jar -cp app.jar com.example.app.DemoApp
```

å¯åŠ¨ç›®æ ‡åº”ç”¨åï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºç±»ä¼¼ï¼š

```arduino
DemoApp#run cost (ns): 200123456
```

è¯´æ˜æ’æ¡©ç”Ÿæ•ˆï¼Œèƒ½å¤Ÿåœ¨ä¸æ”¹åŠ¨æºä»£ç çš„æƒ…å†µä¸‹ï¼Œå®æ—¶ç»Ÿè®¡æ–¹æ³•æ‰§è¡Œè€—æ—¶















































