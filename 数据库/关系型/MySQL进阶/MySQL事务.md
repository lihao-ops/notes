# MySQL äº‹åŠ¡å®Œæ•´å­¦ä¹ ç¬”è®°

> **ä½œè€…**: hli
> **ç›®æ ‡**: ä»åŸç†åˆ°å®æˆ˜ï¼Œå½»åº•åƒé€ MySQL InnoDB äº‹åŠ¡æœºåˆ¶

---

## ğŸ“‹ ç›®å½•

1. [äº‹åŠ¡åŸºç¡€æ¦‚å¿µ](#1-äº‹åŠ¡åŸºç¡€æ¦‚å¿µ)
2. [ACID ç‰¹æ€§æ·±åº¦è§£æ](#2-acid-ç‰¹æ€§æ·±åº¦è§£æ)
3. [InnoDB å­˜å‚¨å±‚å®ç°](#3-innodb-å­˜å‚¨å±‚å®ç°)
4. [äº‹åŠ¡éš”ç¦»çº§åˆ«](#4-äº‹åŠ¡éš”ç¦»çº§åˆ«)
5. [é”æœºåˆ¶è¯¦è§£](#5-é”æœºåˆ¶è¯¦è§£)
6. [MVCC åŸç†](#6-mvcc-åŸç†)
7. [æ­»é”ä¸è°ƒä¼˜](#7-æ­»é”ä¸è°ƒä¼˜)
8. [å®æˆ˜æ¡ˆä¾‹](#8-å®æˆ˜æ¡ˆä¾‹)
9. [é¢è¯•è¦ç‚¹](#9-é¢è¯•è¦ç‚¹)

---

## 1. äº‹åŠ¡åŸºç¡€æ¦‚å¿µ



### ä¸ºä»€ä¹ˆè¦å­¦äº‹åŠ¡ï¼Ÿ

> MySQL æ¯æ¡ DML é»˜è®¤éƒ½åœ¨ä¸€ä¸ªéšå¼äº‹åŠ¡é‡Œæ‰§è¡Œã€‚

æ¯”å¦‚ä½ æ•²ï¼š

```
UPDATE account SET balance = balance - 100 WHERE id = 1;
```

> MySQL èƒŒåæš—æˆ³æˆ³åšäº†ï¼š

```
BEGIN;      -- éšå¼äº‹åŠ¡
write undo log
write redo log (prepare)
apply changes to buffer pool
write redo log (commit)
END;
```

ä½ åªçœ‹åˆ°äº†ä¸€æ¡ SQL
 **ä½† MySQL åšçš„æ˜¯â€œåº•å±‚æ§åˆ¶ç°åœºçš„å…¨å¥—æ“ä½œâ€**ã€‚

ä½ æ²¡å­¦äº‹åŠ¡ï¼Œç­‰äºçœ¼ç›è’™ç€åœ¨é«˜é€Ÿè·¯ä¸Šå¼€è½¦ã€‚





### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ

> **äº‹åŠ¡ï¼ˆTransactionï¼‰** æ˜¯æ•°æ®åº“çš„åŸå­æ‰§è¡Œå•å…ƒï¼Œå®ƒç¡®ä¿æ“ä½œåºåˆ—åœ¨å¤±è´¥æ—¶å¯å®Œå…¨æ’¤é”€ï¼Œåœ¨æˆåŠŸæ—¶æ°¸ä¹…ç”Ÿæ•ˆï¼Œä»è€Œç»´æŠ¤æ•°æ®ä¸€è‡´æ€§ã€‚

å¯¹äºMySQLè€Œè¨€ï¼š

äº‹åŠ¡(Transaction)

1. æ˜¯æ•°æ®åº“ä¸­ä¸€ç»„å¿…é¡»ä½œä¸ºæ•´ä½“æ‰§è¡Œçš„æ“ä½œåºåˆ—ï¼Œ
2. è¿™äº›æ“ä½œè¦ä¹ˆ**å…¨éƒ¨æäº¤æˆåŠŸ(commit)**,
3. è¦ä¹ˆåœ¨**å‡ºç°å¼‚å¸¸æ—¶å…¨éƒ¨å›æ»š(rollback)**ã€‚
4. **äº‹åŠ¡ä¿è¯æ•°æ®åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä¿æŒä¸€è‡´æ€§**ã€‚



```sql
-- ç»å…¸è½¬è´¦ç¤ºä¾‹
START TRANSACTION;

UPDATE account SET balance = balance - 100 WHERE id = 1; -- å¼ ä¸‰æ‰£æ¬¾
UPDATE account SET balance = balance + 100 WHERE id = 2; -- æå››æ”¶æ¬¾

COMMIT; -- æäº¤äº‹åŠ¡
-- æˆ– ROLLBACK; -- å›æ»šäº‹åŠ¡
```

### 1.2 äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰

| ç‰¹æ€§ | è‹±æ–‡ | å«ä¹‰ | InnoDB å®ç°æœºåˆ¶ |
|------|------|------|----------------|
| **åŸå­æ€§** | Atomicity | è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš | **undo log** |
| **ä¸€è‡´æ€§** | Consistency | æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ | **redo log + undo log + éš”ç¦»æœºåˆ¶** |
| **éš”ç¦»æ€§** | Isolation | å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶äº’ä¸å¹²æ‰° | **é” + MVCC** |
| **æŒä¹…æ€§** | Durability | äº‹åŠ¡æäº¤åæ•°æ®æ°¸ä¹…ä¿å­˜ | **redo log + binlog** |

---





### 1.3 å®è·µæ–¹æ¡ˆ

```sql
-- ==========================================
-- MySQL äº‹åŠ¡åŸç†éªŒè¯å®éªŒæ‰‹å†Œ
-- ==========================================

-- ã€å‡†å¤‡å·¥ä½œã€‘åˆ›å»ºæ•°æ®åº“å’Œè¡¨
CREATE DATABASE IF NOT EXISTS transaction_study CHARACTER SET utf8mb4;
USE transaction_study;

DROP TABLE IF EXISTS account;
CREATE TABLE account (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(20) NOT NULL,
    balance DECIMAL(10,2) NOT NULL
) ENGINE=InnoDB;

INSERT INTO account (name, balance) VALUES
('å¼ ä¸‰', 1000.00),
('æå››', 1000.00);

SELECT * FROM account;  -- æŸ¥çœ‹åˆå§‹æ•°æ®


-- ==========================================
-- å®éªŒ1ï¼šéªŒè¯ã€åŸå­æ€§ Atomicityã€‘
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜äº‹åŠ¡è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼Œä¸ä¼šå‡ºç°ä¸­é—´çŠ¶æ€

-- ã€æ“ä½œæ­¥éª¤ã€‘
START TRANSACTION;
UPDATE account SET balance = balance - 500 WHERE name = 'å¼ ä¸‰';  -- å¼ ä¸‰å‡500
UPDATE account SET balance = balance + 500 WHERE name = 'æå››';  -- æå››åŠ 500
-- ç°åœ¨æ•…æ„ä¸æäº¤ï¼Œè€Œæ˜¯å›æ»š
ROLLBACK;

-- ã€æŸ¥çœ‹ç»“æœã€‘
SELECT * FROM account;

-- ã€é¢„æœŸç°è±¡ã€‘å¼ ä¸‰å’Œæå››çš„ä½™é¢éƒ½è¿˜æ˜¯1000ï¼Œæ²¡æœ‰ä»»ä½•å˜åŒ–
-- ã€åŸç†è§£é‡Šã€‘ROLLBACKè§¦å‘äº†undo logå›æ»šï¼Œæ‰€æœ‰ä¿®æ”¹éƒ½è¢«æ’¤é”€


-- ==========================================
-- å®éªŒ2ï¼šéªŒè¯ã€ä¸€è‡´æ€§ Consistencyã€‘
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜äº‹åŠ¡å‰åï¼Œæ•°æ®çš„å®Œæ•´æ€§çº¦æŸå¾—åˆ°ä¿æŒï¼ˆå¦‚æ€»é‡‘é¢å®ˆæ’ï¼‰

-- ã€æ“ä½œæ­¥éª¤ã€‘
-- å…ˆæŸ¥çœ‹æ€»é‡‘é¢
SELECT SUM(balance) AS total FROM account;  -- åº”è¯¥æ˜¯2000

START TRANSACTION;
UPDATE account SET balance = balance - 300 WHERE name = 'å¼ ä¸‰';
UPDATE account SET balance = balance + 300 WHERE name = 'æå››';
COMMIT;

-- ã€æŸ¥çœ‹ç»“æœã€‘
SELECT SUM(balance) AS total FROM account;  -- ä¾ç„¶æ˜¯2000
SELECT * FROM account;

-- ã€é¢„æœŸç°è±¡ã€‘è½¬è´¦å‰åæ€»é‡‘é¢ä¸å˜ï¼Œä¿æŒ2000å…ƒ
-- ã€åŸç†è§£é‡Šã€‘ä¸€è‡´æ€§æ˜¯ACIDçš„ç»¼åˆä½“ç°ï¼Œä¿è¯ä¸šåŠ¡è§„åˆ™ä¸è¢«ç ´å


-- ==========================================
-- å®éªŒ3ï¼šéªŒè¯ã€æŒä¹…æ€§ Durabilityã€‘
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿æ•°æ®åº“å´©æºƒä¹Ÿä¸ä¸¢å¤±

-- ã€æ“ä½œæ­¥éª¤ã€‘
START TRANSACTION;
UPDATE account SET balance = 1500 WHERE name = 'å¼ ä¸‰';
COMMIT;  -- æäº¤åç«‹å³é‡å¯MySQLæœåŠ¡

-- ã€æŸ¥çœ‹ç»“æœã€‘é‡å¯MySQLåæ‰§è¡Œ
SELECT * FROM account WHERE name = 'å¼ ä¸‰';

-- ã€é¢„æœŸç°è±¡ã€‘å¼ ä¸‰çš„ä½™é¢æ˜¯1500ï¼Œä¿®æ”¹è¢«æ°¸ä¹…ä¿å­˜
-- ã€åŸç†è§£é‡Šã€‘COMMITæ—¶æ•°æ®å†™å…¥redo logå¹¶åˆ·ç›˜ï¼Œå³ä½¿å´©æºƒä¹Ÿèƒ½æ¢å¤


-- ==========================================
-- å®éªŒ4ï¼šéªŒè¯ã€è„è¯»ã€‘(READ UNCOMMITTED)
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜åœ¨æœ€ä½éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¯ä»¥è¯»åˆ°æœªæäº¤çš„æ•°æ®

-- ã€ä¼šè¯1 - çª—å£1æ‰§è¡Œã€‘
SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
START TRANSACTION;
UPDATE account SET balance = 9999 WHERE name = 'å¼ ä¸‰';
-- æ³¨æ„ï¼šä¸è¦æäº¤ï¼Œä¿æŒäº‹åŠ¡å¼€å¯

-- ã€ä¼šè¯2 - çª—å£2æ‰§è¡Œã€‘
SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SELECT * FROM account WHERE name = 'å¼ ä¸‰';

-- ã€é¢„æœŸç°è±¡ã€‘ä¼šè¯2èƒ½çœ‹åˆ°9999ï¼ˆè„è¯»ï¼‰
-- ã€åŸç†è§£é‡Šã€‘READ UNCOMMITTEDä¸åŠ ä»»ä½•é”ï¼Œç›´æ¥è¯»å–å½“å‰æœ€æ–°å€¼

-- ã€ä¼šè¯1ç»§ç»­ã€‘
ROLLBACK;  -- å›æ»šåï¼Œä¼šè¯2ä¹‹å‰è¯»åˆ°çš„9999å°±æ˜¯"è„æ•°æ®"


-- ==========================================
-- å®éªŒ5ï¼šéªŒè¯ã€ä¸å¯é‡å¤è¯»ã€‘(READ COMMITTED)
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜åœ¨è¯»å·²æäº¤çº§åˆ«ï¼ŒåŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–å¯èƒ½å¾—åˆ°ä¸åŒç»“æœ

-- ã€ä¼šè¯1 - çª—å£1æ‰§è¡Œã€‘
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
START TRANSACTION;
SELECT balance FROM account WHERE name = 'æå››';  -- ç¬¬ä¸€æ¬¡è¯»ï¼Œè®°ä½è¿™ä¸ªå€¼

-- ã€ä¼šè¯2 - çª—å£2æ‰§è¡Œã€‘
UPDATE account SET balance = balance + 500 WHERE name = 'æå››';
COMMIT;

-- ã€ä¼šè¯1ç»§ç»­ã€‘
SELECT balance FROM account WHERE name = 'æå››';  -- ç¬¬äºŒæ¬¡è¯»
COMMIT;

-- ã€é¢„æœŸç°è±¡ã€‘ä¸¤æ¬¡è¯»å–çš„å€¼ä¸åŒï¼Œç¬¬äºŒæ¬¡è¯»åˆ°äº†ä¼šè¯2æäº¤çš„æ–°å€¼
-- ã€åŸç†è§£é‡Šã€‘READ COMMITTEDæ¯æ¬¡è¯»å–éƒ½æ˜¯æœ€æ–°æäº¤çš„ç‰ˆæœ¬


-- ==========================================
-- å®éªŒ6ï¼šéªŒè¯ã€MVCC - å¯é‡å¤è¯»ã€‘(REPEATABLE READ)
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜åœ¨å¯é‡å¤è¯»çº§åˆ«ï¼ŒåŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–ç»“æœä¸€è‡´ï¼ˆå¿«ç…§è¯»ï¼‰

-- ã€ä¼šè¯1 - çª—å£1æ‰§è¡Œã€‘
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION;
SELECT balance FROM account WHERE name = 'å¼ ä¸‰';  -- ç¬¬ä¸€æ¬¡è¯»ï¼Œå‡è®¾æ˜¯1500

-- ã€ä¼šè¯2 - çª—å£2æ‰§è¡Œã€‘
UPDATE account SET balance = balance - 200 WHERE name = 'å¼ ä¸‰';
COMMIT;

-- ã€ä¼šè¯1ç»§ç»­ã€‘
SELECT balance FROM account WHERE name = 'å¼ ä¸‰';  -- ç¬¬äºŒæ¬¡è¯»ï¼Œä¾ç„¶æ˜¯1500ï¼
COMMIT;

-- ã€é¢„æœŸç°è±¡ã€‘ä¸¤æ¬¡è¯»å–çš„å€¼ç›¸åŒï¼Œçœ‹ä¸åˆ°ä¼šè¯2çš„ä¿®æ”¹
-- ã€åŸç†è§£é‡Šã€‘MVCCé€šè¿‡undo logä¿å­˜å¿«ç…§ç‰ˆæœ¬ï¼Œäº‹åŠ¡å¼€å§‹æ—¶ç”ŸæˆReadView


-- ==========================================
-- å®éªŒ7ï¼šéªŒè¯ã€å¹»è¯»ã€‘(REPEATABLE READ + èŒƒå›´æŸ¥è¯¢)
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜å¯é‡å¤è¯»çº§åˆ«åœ¨æŸäº›åœºæ™¯ä¸‹ä¾ç„¶ä¼šå‡ºç°å¹»è¯»

-- ã€ä¼šè¯1 - çª—å£1æ‰§è¡Œã€‘
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION;
SELECT * FROM account WHERE balance > 500;  -- ç¬¬ä¸€æ¬¡èŒƒå›´æŸ¥è¯¢

-- ã€ä¼šè¯2 - çª—å£2æ‰§è¡Œã€‘
INSERT INTO account (name, balance) VALUES ('ç‹äº”', 2000);
COMMIT;

-- ã€ä¼šè¯1ç»§ç»­ã€‘
SELECT * FROM account WHERE balance > 500;  -- ç¬¬äºŒæ¬¡èŒƒå›´æŸ¥è¯¢
-- å¦‚æœæ²¡æœ‰é—´éš™é”ï¼Œå¯èƒ½çœ‹åˆ°ç‹äº”ï¼ˆå¹»è¯»ï¼‰

-- ã€é¢„æœŸç°è±¡ã€‘InnoDBé€šè¿‡é—´éš™é”(Gap Lock)é¿å…äº†å¹»è¯»
-- ã€åŸç†è§£é‡Šã€‘Next-Key Lock = è¡Œé” + é—´éš™é”ï¼Œé”å®šèŒƒå›´é˜²æ­¢æ’å…¥


-- ==========================================
-- å®éªŒ8ï¼šéªŒè¯ã€è¡Œé” - FOR UPDATEã€‘
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜SELECT FOR UPDATEä¼šå¯¹è¡ŒåŠ æ’ä»–é”

-- ã€ä¼šè¯1 - çª—å£1æ‰§è¡Œã€‘
START TRANSACTION;
SELECT * FROM account WHERE name = 'å¼ ä¸‰' FOR UPDATE;  -- é”ä½å¼ ä¸‰è¿™ä¸€è¡Œ
-- ä¸è¦æäº¤ï¼Œä¿æŒé”

-- ã€ä¼šè¯2 - çª—å£2æ‰§è¡Œã€‘
UPDATE account SET balance = balance + 100 WHERE name = 'å¼ ä¸‰';  -- å°è¯•ä¿®æ”¹

-- ã€é¢„æœŸç°è±¡ã€‘ä¼šè¯2è¢«é˜»å¡ï¼Œç­‰å¾…ä¼šè¯1é‡Šæ”¾é”
-- ã€åŸç†è§£é‡Šã€‘FOR UPDATEåŠ Xé”ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•ä¿®æ”¹è¯¥è¡Œ

-- ã€ä¼šè¯1ç»§ç»­ã€‘
COMMIT;  -- ä¼šè¯2ç«‹å³æ‰§è¡ŒæˆåŠŸ


-- ==========================================
-- å®éªŒ9ï¼šéªŒè¯ã€æ­»é”æ£€æµ‹ã€‘
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜InnoDBèƒ½è‡ªåŠ¨æ£€æµ‹æ­»é”å¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡

-- ã€ä¼šè¯1 - çª—å£1æ‰§è¡Œã€‘
START TRANSACTION;
UPDATE account SET balance = balance + 10 WHERE name = 'å¼ ä¸‰';  -- é”ä½å¼ ä¸‰

-- ã€ä¼šè¯2 - çª—å£2æ‰§è¡Œã€‘
START TRANSACTION;
UPDATE account SET balance = balance + 10 WHERE name = 'æå››';  -- é”ä½æå››

-- ã€ä¼šè¯1ç»§ç»­ã€‘
UPDATE account SET balance = balance + 10 WHERE name = 'æå››';  -- ç­‰å¾…ä¼šè¯2çš„é”

-- ã€ä¼šè¯2ç»§ç»­ã€‘
UPDATE account SET balance = balance + 10 WHERE name = 'å¼ ä¸‰';  -- ç­‰å¾…ä¼šè¯1çš„é”

-- ã€é¢„æœŸç°è±¡ã€‘å…¶ä¸­ä¸€ä¸ªä¼šè¯æŠ¥é”™ "Deadlock found when trying to get lock"
-- ã€åŸç†è§£é‡Šã€‘InnoDBæ£€æµ‹åˆ°å¾ªç¯ç­‰å¾…ï¼Œè‡ªåŠ¨å›æ»šä¸€ä¸ªäº‹åŠ¡æ‰“ç ´æ­»é”


-- ==========================================
-- å®éªŒ10ï¼šéªŒè¯ã€å½“å‰è¯» vs å¿«ç…§è¯»ã€‘
-- ==========================================
-- ã€ç›®çš„ã€‘è¯æ˜FOR UPDATEæ˜¯å½“å‰è¯»ï¼Œä¼šè¯»åˆ°æœ€æ–°æäº¤çš„æ•°æ®

-- ã€ä¼šè¯1 - çª—å£1æ‰§è¡Œã€‘
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION;
SELECT balance FROM account WHERE name = 'å¼ ä¸‰';  -- å¿«ç…§è¯»

-- ã€ä¼šè¯2 - çª—å£2æ‰§è¡Œã€‘
UPDATE account SET balance = 3000 WHERE name = 'å¼ ä¸‰';
COMMIT;

-- ã€ä¼šè¯1ç»§ç»­ã€‘
SELECT balance FROM account WHERE name = 'å¼ ä¸‰';  -- å¿«ç…§è¯»ï¼Œæ—§å€¼
SELECT balance FROM account WHERE name = 'å¼ ä¸‰' FOR UPDATE;  -- å½“å‰è¯»ï¼Œæ–°å€¼3000ï¼
COMMIT;

-- ã€é¢„æœŸç°è±¡ã€‘æ™®é€šSELECTè¯»æ—§ç‰ˆæœ¬ï¼ŒFOR UPDATEè¯»æœ€æ–°ç‰ˆæœ¬
-- ã€åŸç†è§£é‡Šã€‘å½“å‰è¯»ä¼šåŠ é”å¹¶è¯»å–æœ€æ–°æäº¤çš„è®°å½•


-- ==========================================
-- ã€å®éªŒæ€»ç»“ã€‘
-- ==========================================
-- âœ… åŸå­æ€§ï¼šé€šè¿‡ undo log å®ç°å›æ»š
-- âœ… ä¸€è‡´æ€§ï¼šä¸šåŠ¡è§„åˆ™åœ¨äº‹åŠ¡å‰åä¿æŒä¸å˜
-- âœ… éš”ç¦»æ€§ï¼šé€šè¿‡é”å’ŒMVCCå®ç°ä¸åŒéš”ç¦»çº§åˆ«
-- âœ… æŒä¹…æ€§ï¼šé€šè¿‡ redo log ä¿è¯å´©æºƒæ¢å¤
-- âœ… MVCCï¼šé€šè¿‡ReadView + undo logå®ç°å¿«ç…§è¯»
-- âœ… é”æœºåˆ¶ï¼šè¡Œé”(FOR UPDATE)ã€é—´éš™é”(é˜²å¹»è¯»)ã€æ­»é”æ£€æµ‹
```







## ç¯å¢ƒå‡†å¤‡



### ACIDç¯å¢ƒ

> åˆ›å»ºå®éªŒæ‰€éœ€åº“`tx_lab`ä»¥åŠè¡¨`account`

```sql
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| test_sql_flow      |
| wordpress          |
+--------------------+
6 rows in set (0.03 sec)
```



##### åˆ›å»º`transaction_study`åº“

```sql
mysql> CREATE DATABASE IF NOT EXISTS transaction_study CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
Query OK, 1 row affected (0.05 sec)
```



##### åˆ›å»º`account`è¡¨

```sql
mysql> USE transaction_study;
Database changed
mysql> -- å»ºç«‹äº‹åŠ¡æµ‹è¯•è¡¨ï¼ˆå»ºè®®å®Œæ•´ç‰ˆæœ¬ï¼‰
mysql> DROP TABLE IF EXISTS account;
Query OK, 0 rows affected, 1 warning (0.03 sec)

mysql> CREATE TABLE account (
    ->     id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®',
    ->     name VARCHAR(20) NOT NULL COMMENT 'è´¦æˆ·åç§°',
    ->     balance DECIMAL(10,2) NOT NULL COMMENT 'è´¦æˆ·ä½™é¢',
    ->     version INT NOT NULL DEFAULT 0 COMMENT 'MVCCç‰ˆæœ¬å·',
    ->     update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´'
    -> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='äº‹åŠ¡ä¸MVCCå®éªŒè¡¨';
Query OK, 0 rows affected (0.07 sec)
```



```sql
mysql> -- åˆå§‹åŒ–æµ‹è¯•æ•°æ®
mysql> INSERT INTO account (name, balance) VALUES
    -> ('A', 1000.00),
    -> ('B', 1000.00),
    -> ('C', 1000.00);
Query OK, 3 rows affected (0.04 sec)
Records: 3  Duplicates: 0  Warnings: 0
```



#### éªŒè¯äº‹åŠ¡å‚æ•°



##### innodb_flush_log_at_trx_commit(äº‹åŠ¡åˆ·ç›˜é¢‘æ¬¡)



###### æŒ‡æ ‡è¯´æ˜

| å€¼   | åˆ·ç›˜ç­–ç•¥                                    | å´©æºƒé£é™©               | æ€§èƒ½       |
| ---- | ------------------------------------------- | ---------------------- | ---------- |
| `0`  | æ¯ç§’å†™ä¸€æ¬¡ redo logï¼Œä¸ä¸€å®šåœ¨æäº¤æ—¶è½ç›˜     | å¯èƒ½ä¸¢å¤±æœ€è¿‘ 1 ç§’äº‹åŠ¡  | ğŸš€ æœ€é«˜     |
| `1`  | æ¯æ¬¡ `COMMIT` éƒ½ç«‹åˆ»åˆ·ç›˜                    | ä¸ä¸¢æ•°æ®ï¼ˆæœ€å®‰å…¨ï¼‰     | ğŸ¢ æœ€æ…¢     |
| `2`  | æ¯æ¬¡ `COMMIT` å†™ OS ç¼“å†²åŒºï¼Œæ¯ç§’ fsync ä¸€æ¬¡ | å¯èƒ½ä¸¢ OS ç¼“å†²åŒºçš„äº‹åŠ¡ | âš–ï¸ æŠ˜ä¸­æ–¹æ¡ˆ |

> âœ… **ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬è®¾ç½®ä¸º `1`**ï¼ˆä¿è¯å´©æºƒåæ•°æ®ä¸ä¸¢ï¼‰
>  âš™ï¸ **å¼€å‘ç¯å¢ƒå¯ä»¥ç”¨ `2`**ï¼Œå…¼é¡¾æ€§èƒ½ã€‚

æŸ¥çœ‹ï¼š

```sql
SHOW VARIABLES LIKE 'innodb_flush_log_at_trx_commit';
```

ä¿®æ”¹ï¼š

```sql
[mysqld]
innodb_flush_log_at_trx_commit=1
```



###### æŸ¥çœ‹è¯­å¥

```sql
mysql> SHOW VARIABLES LIKE 'innodb_flush_log_at_trx_commit';
```

>è¿”å›1è¡¨ç¤ºæ¯ä¸ªäº‹åŠ¡çš„æ‰§è¡Œéƒ½åˆ·ç›˜(æœ€æ…¢ï¼Œä½†æœ€å®‰å…¨)

```sql
+--------------------------------+-------+
| Variable_name                  | Value |
+--------------------------------+-------+
| innodb_flush_log_at_trx_commit | 1     |
+--------------------------------+-------+
1 row in set (0.02 sec)
```





##### transaction_isolation(æ§åˆ¶äº‹åŠ¡éš”ç¦»çº§åˆ«)



###### ğŸ¯ **æ§åˆ¶äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆå½±å“â€œéš”ç¦»æ€§â€ï¼‰**

| å€¼                 | ä¸­æ–‡è¯´æ˜         | ç‰¹æ€§                       | å¯è§æ€§ç‰¹ç‚¹           |
| ------------------ | ---------------- | -------------------------- | -------------------- |
| `READ-UNCOMMITTED` | è¯»æœªæäº¤         | æœ‰è„è¯»                     | è¯»åˆ°æœªæäº¤äº‹åŠ¡       |
| `READ-COMMITTED`   | è¯»å·²æäº¤         | æ— è„è¯»ï¼Œæœ‰ä¸å¯é‡å¤è¯»       | æ¯æ¬¡æŸ¥è¯¢é‡æ–°ç”Ÿæˆå¿«ç…§ |
| `REPEATABLE-READ`  | å¯é‡å¤è¯»ï¼ˆé»˜è®¤ï¼‰ | æ— è„è¯»æ— ä¸å¯é‡å¤è¯»ï¼Œæœ‰å¹»è¯» | åŒäº‹åŠ¡å¿«ç…§ä¸€è‡´       |
| `SERIALIZABLE`     | ä¸²è¡ŒåŒ–           | å®Œå…¨éš”ç¦»                   | åŠ é”æ‰§è¡Œï¼Œæ€§èƒ½æœ€ä½   |

set global transaction isolation level repeatable read;

###### æŸ¥çœ‹

```sql
SHOW VARIABLES LIKE 'transaction_isolation';
```



```sql
mysql> SHOW VARIABLES LIKE 'transaction_isolation';


+-----------------------+-----------------+
| Variable_name         | Value           |
+-----------------------+-----------------+
| transaction_isolation | REPEATABLE-READ |
+-----------------------+-----------------+
1 row in set (0.00 sec)
```

æ³¨æ„ï¼šè¿™æ˜¯é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šREPEATABLE-READï¼šå¯é‡å¤è¯»ï¼ˆé»˜è®¤ï¼‰





###### ä¿®æ”¹

```sql
SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ;
```





###### å®é™…éªŒè¯

>-- âœ… 1ï¸âƒ£ é”™è¯¯ç¤ºä¾‹ï¼ˆå¸¦è¿å­—ç¬¦çš„è¯­æ³•æ˜¯é”™çš„ï¼‰

```sql
-- MySQL ä¸æ¥å—ä¸­é—´çš„ â€œ-â€ï¼Œæ­£ç¡®å†™æ³•è¦ç”¨ç©ºæ ¼åˆ†éš”ã€‚
set global transaction isolation level read-uncommitted;
-- âŒ ERROR 1064 (42000)
```



>-- âœ… 2ï¸âƒ£ æ­£ç¡®å†™æ³•ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼‰

```sql
-- è®¾ç½®å…¨å±€ï¼ˆGLOBALï¼‰é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º â€œè¯»æœªæäº¤â€
-- è¯¥è®¾ç½®åªå¯¹ **æ–°è¿æ¥** ç”Ÿæ•ˆï¼Œå¯¹å½“å‰ä¼šè¯ä¸å½±å“ã€‚
set global transaction isolation level read uncommitted;
-- Query OK, 0 rows affected (0.00 sec)
```

è¯¥è®¾ç½®åªå¯¹ **æ–°è¿æ¥** ç”Ÿæ•ˆï¼Œå¯¹å½“å‰ä¼šè¯ä¸å½±å“ã€‚



>-- âœ… 3ï¸âƒ£ æŸ¥çœ‹å½“å‰ä¼šè¯çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆSESSIONï¼‰

```sql
-- ä»ç„¶æ˜¯é»˜è®¤å€¼ REPEATABLE-READï¼ˆå¯é‡å¤è¯»ï¼‰
-- å› ä¸º GLOBAL ä¿®æ”¹ä¸ä¼šå½±å“å·²ç»å­˜åœ¨çš„è¿æ¥
SHOW VARIABLES LIKE 'transaction_isolation';
-- +-----------------------+-----------------+
-- | Variable_name         | Value           |
-- +-----------------------+-----------------+
-- | transaction_isolation | REPEATABLE-READ |
-- +-----------------------+-----------------+
```

-- ä»ç„¶æ˜¯é»˜è®¤å€¼ REPEATABLE-READï¼ˆå¯é‡å¤è¯»ï¼‰
-- å› ä¸º GLOBAL ä¿®æ”¹ä¸ä¼šå½±å“å·²ç»å­˜åœ¨çš„è¿æ¥



>-- âœ… 4ï¸âƒ£ æŸ¥çœ‹å…¨å±€äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆGLOBALï¼‰

```sql
-- âœ… 4ï¸âƒ£ æŸ¥çœ‹å…¨å±€äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆGLOBALï¼‰
-- å·²æˆåŠŸå˜ä¸º READ-UNCOMMITTED
SHOW GLOBAL VARIABLES LIKE 'transaction_isolation';
-- +-----------------------+------------------+
-- | Variable_name         | Value            |
-- +-----------------------+------------------+
-- | transaction_isolation | READ-UNCOMMITTED |
-- +-----------------------+------------------+
```

å·²æˆåŠŸå˜ä¸º READ-UNCOMMITTED



>-- âœ… 5ï¸âƒ£ ä¿®æ”¹å½“å‰ä¼šè¯éš”ç¦»çº§åˆ«ä¸º READ UNCOMMITTED

```sql
-- ä½¿ç”¨ SESSION çº§åˆ«è®¾ç½®å¯ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡è¿ã€‚
SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
-- Query OK, 0 rows affected (0.00 sec)
```

ä½¿ç”¨ SESSION çº§åˆ«è®¾ç½®å¯ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡è¿



>-- âœ… 6ï¸âƒ£ éªŒè¯å½“å‰ä¼šè¯éš”ç¦»çº§åˆ«å·²ç”Ÿæ•ˆ

```sql
-- âœ… 6ï¸âƒ£ éªŒè¯å½“å‰ä¼šè¯éš”ç¦»çº§åˆ«å·²ç”Ÿæ•ˆ
SHOW VARIABLES LIKE 'transaction_isolation';
-- +-----------------------+------------------+
-- | Variable_name         | Value            |
-- +-----------------------+------------------+
-- | transaction_isolation | READ-UNCOMMITTED |
-- +-----------------------+------------------+
```



>-- âœ… 7ï¸âƒ£ éªŒè¯å…¨å±€ä»ä¿æŒ READ-UNCOMMITTED

```sql
-- âœ… 7ï¸âƒ£ éªŒè¯å…¨å±€ä»ä¿æŒ READ-UNCOMMITTED
-- å½“å‰ä¼šè¯çš„ä¿®æ”¹ä¸ä¼šå½±å“å…¨å±€é…ç½®ï¼ˆéš”ç¦»ä½œç”¨åŸŸç›¸åï¼‰
SHOW GLOBAL VARIABLES LIKE 'transaction_isolation';
-- +-----------------------+------------------+
-- | Variable_name         | Value            |
-- +-----------------------+------------------+
-- | transaction_isolation | READ-UNCOMMITTED |
-- +-----------------------+------------------+
```





>è®°å¾—è®¾ç½®å›æ¥é»˜è®¤çš„å¯é‡å¤è¯»

```sql
mysql> set global transaction isolation level repeatable read;


Query OK, 0 rows affected (0.00 sec)

mysql> SHOW GLOBAL VARIABLES LIKE 'transaction_isolation';
+-----------------------+-----------------+
| Variable_name         | Value           |
+-----------------------+-----------------+
| transaction_isolation | REPEATABLE-READ |
+-----------------------+-----------------+
1 row in set (0.00 sec)
```





###### ç­”ç–‘

ğŸ’¬ é¢è¯•æ ‡å‡†ç­”æ³•

> **Q1ï¼šå¦‚æœè®¾ç½®äº†å½“å‰ä¼šè¯çš„éš”ç¦»çº§åˆ«ä¸º READ UNCOMMITTEDï¼ˆè¯»æœªæäº¤ï¼‰ï¼Œé‡å¯ MySQL åè¿˜ä¼šç”Ÿæ•ˆå—ï¼Ÿ**

**Aï¼šä¸ä¼šã€‚**
 `SET SESSION TRANSACTION ISOLATION LEVEL ...` åªåœ¨**å½“å‰ä¼šè¯**æœ‰æ•ˆã€‚

- æ–­å¼€è¿æ¥ï¼ˆé€€å‡º MySQLï¼‰åï¼Œè¯¥è®¾ç½®ç«‹å³å¤±æ•ˆï¼›
- é‡å¯ MySQL ä¹Ÿä¸ä¼šä¿ç•™æ­¤å€¼ï¼›
- ä¸‹æ¬¡è¿æ¥æ—¶ä¼šè‡ªåŠ¨ç»§æ‰¿å…¨å±€ï¼ˆ`GLOBAL`ï¼‰çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚

------

> **Q2ï¼šå¦‚æœè®¾ç½®äº†å…¨å±€éš”ç¦»çº§åˆ«ä¸º READ UNCOMMITTEDï¼Œé‡å¯ MySQL æˆ–é‡æ–°ç™»å½•åä¼šæ€æ ·ï¼Ÿ**

**Aï¼šä¼šç”Ÿæ•ˆã€‚**
 `SET GLOBAL TRANSACTION ISOLATION LEVEL ...` ä¿®æ”¹çš„æ˜¯**å…¨å±€é»˜è®¤å€¼**ï¼Œ
 å½±å“æ‰€æœ‰**æ–°å»ºè¿æ¥**ã€‚

- æ— éœ€é‡å¯ MySQLï¼›
- åªè¦é‡æ–°ç™»å½•æˆ–æ–°å»ºè¿æ¥ï¼Œå°±ä¼šè‡ªåŠ¨åº”ç”¨æ–°çš„å…¨å±€éš”ç¦»çº§åˆ«ï¼›
- å·²ç»å­˜åœ¨çš„è¿æ¥ä»ä¿æŒåŸæ¥çš„ session å€¼ï¼ˆä¸ä¼šè¢«å¼ºåˆ¶æ”¹å˜ï¼‰ã€‚



###### ç”Ÿæ•ˆèŒƒå›´

ğŸ§© ä¸€ã€éš”ç¦»çº§åˆ«çš„ç»§æ‰¿è§„åˆ™

> **æ¯æ¬¡æ–°å»ºè¿æ¥ï¼ˆç™»å½• MySQLï¼‰æ—¶ï¼Œå½“å‰ä¼šè¯ï¼ˆSESSIONï¼‰ä¼šè‡ªåŠ¨ç»§æ‰¿å…¨å±€ï¼ˆGLOBALï¼‰çš„éš”ç¦»çº§åˆ«ã€‚**

ä¹Ÿå°±æ˜¯è¯´ï¼š

- ä½ ç°åœ¨æ‰§è¡Œçš„

  ```sql
  SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ;
  ```

  å·²ç»æŠŠå…¨å±€é…ç½®æ”¹å›é»˜è®¤å€¼ `REPEATABLE-READ`ã€‚

- ä¹‹åå½“ä½ é€€å‡ºå½“å‰è¿æ¥ã€é‡æ–°ç™»å½•æ—¶ï¼š
   ç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ–° session çš„éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºè¿™ä¸ªå…¨å±€é»˜è®¤å€¼ã€‚

------



âœ… äºŒã€éªŒè¯æ–¹å¼ï¼ˆæ¨èä½ é‡æ–°ç™»å½•åæ‰§è¡Œï¼‰

```sql
-- éªŒè¯å½“å‰ä¼šè¯éš”ç¦»çº§åˆ«
SHOW VARIABLES LIKE 'transaction_isolation';
```

ç»“æœåº”è¯¥æ˜¯ï¼š

```sql
| transaction_isolation | REPEATABLE-READ |
```

åŒæ—¶ï¼š

```sql
SHOW GLOBAL VARIABLES LIKE 'transaction_isolation';
```

ä¹Ÿä¼šæ˜¯ï¼š

```sql
| transaction_isolation | REPEATABLE-READ |
```

è¯´æ˜ä¸¤è€…ä¸€è‡´ï¼Œæ–°è¿æ¥å·²ç»åŒæ­¥ä½¿ç”¨å…¨å±€è®¾ç½®ã€‚



ä¸‰ã€æ€»ç»“è®°å¿†å£è¯€

> **GLOBAL æ”¹æœªæ¥ï¼ŒSESSION æ”¹ç°åœ¨ã€‚**
>  **æ–°è¿ç»§æ‰¿å…¨å±€ï¼Œè€è¿ä¿ç•™å½“å‰ã€‚**







## 2. ACID(åŸå­æ€§/ä¸€è‡´æ€§/éš”ç¦»æ€§/æŒä¹…æ€§)





### 2.1 åŸå­æ€§ï¼ˆAtomicityï¼‰

#### æ ¸å¿ƒåŸç†

> **undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰** è®°å½•æ¯æ¬¡ä¿®æ”¹å‰çš„æ—§å€¼ï¼Œå½“äº‹åŠ¡å›æ»šæ—¶ï¼Œé€šè¿‡ undo log æ¢å¤æ•°æ®ã€‚

åŸå­æ€§æŒ‡çš„æ˜¯ï¼š

- ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œå¿…é¡»è¢«å½“ä½œä¸€ä¸ªä¸å¯å†åˆ†çš„æ•´ä½“ï¼Œ
- **è¦ä¹ˆå…¨éƒ¨æˆåŠŸæäº¤ï¼Œ**
- **è¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šï¼Œ**
- **ä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½ä¸èƒ½ç•™ä¸‹éƒ¨åˆ†å†™å…¥ã€‚**





#### åŸç†å›¾

```mermaid
flowchart TD
    A[å¼€å§‹äº‹åŠ¡] --> B[ç¬¬ä¸€æ¬¡æ›´æ–°è´¦æˆ·ä½™é¢\nè´¦æˆ·åŸä½™é¢ä¸€åƒ\næ›´æ–°ä¸ºä¹ç™¾]
    B --> C[è®°å½•å›æ»šæ—¥å¿—\næ—§å€¼ä¸€åƒ]
    C --> D[ç¬¬äºŒæ¬¡æ›´æ–°è´¦æˆ·ä½™é¢\nè´¦æˆ·å½“å‰ä½™é¢ä¹ç™¾\næ›´æ–°ä¸ºå…«ç™¾]
    D --> E[è®°å½•å›æ»šæ—¥å¿—\næ—§å€¼ä¹ç™¾]
    E --> F[æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸]
    F --> G[æ‰§è¡Œå›æ»šæ“ä½œ]
    G --> H[æ ¹æ®å›æ»šæ—¥å¿—æ¢å¤ä¸ºä¹ç™¾]
    H --> I[ç»§ç»­è¯»å–ä¸‹ä¸€æ¡å›æ»šæ—¥å¿—]
    I --> J[æ ¹æ®å›æ»šæ—¥å¿—æ¢å¤ä¸ºä¸€åƒ]
    J --> K[äº‹åŠ¡å›æ»šå®Œæˆ]
```

#### éªŒè¯ä»£ç 

```java
    /**
     * æ–¹æ³•è¯´æ˜ / Method Description:
     * ä¸­æ–‡ï¼šåŸå­æ€§ï¼ˆAtomicityï¼‰éªŒè¯ï¼šäº‹åŠ¡å†…å¼‚å¸¸è§¦å‘æ•´ä½“å›æ»šï¼Œä»»ä½•éƒ¨åˆ†å†™å…¥éƒ½ä¸ä¼šç”Ÿæ•ˆã€‚
     * English: Atomicity verification: exception in transaction triggers full rollback; no partial writes persist.
     * <p>
     * å‚æ•° / Parameters: æ— 
     * è¿”å›å€¼ / Return: æ— 
     * å¼‚å¸¸ / Exceptions: SQL æ‰§è¡Œå¼‚å¸¸æˆ–æ–­è¨€å¤±è´¥ä¼šä½¿æµ‹è¯•å¤±è´¥
     */
    @Test
    @DisplayName("ACID-Atomicity: rollback on exception leaves no partial writes")
    void atomicityRollbackOnFailure() throws Exception {
        try (Connection conn = dataSource.getConnection()) {
            // ä¸­æ–‡ï¼šå…³é—­è‡ªåŠ¨æäº¤ä»¥æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡
            // English: Disable auto-commit to manually control transaction
            conn.setAutoCommit(false);

            // ä¸­æ–‡ï¼šå…ˆæ‰§è¡Œç¬¬ä¸€æ­¥æ‰£å‡
            // English: Perform first deduction
            //ä¸ºä»€ä¹ˆ update æ‰§è¡Œäº†ä½†â€œçœ‹ä¸åˆ°â€ï¼Ÿäº‹åŠ¡æœªæäº¤ â†’ ä¿®æ”¹åªåœ¨ å½“å‰è¿æ¥ çš„äº‹åŠ¡ä¸Šä¸‹æ–‡å¯è§ã€‚
            updateBalance(conn, 1L, new BigDecimal("900.00"));

            // ä¸­æ–‡ï¼šæ¨¡æ‹Ÿå¼‚å¸¸ï¼ˆä¾‹å¦‚è¿åçº¦æŸæˆ–ä¸»åŠ¨æŠ›å‡ºï¼‰
            // English: Simulate exception (constraint violation or manual throw)
            assertThatThrownBy(() -> updateBalance(conn, 2L, null)).isInstanceOf(Exception.class);

            // ä¸­æ–‡ï¼šå¼‚å¸¸åå›æ»šäº‹åŠ¡ï¼Œä¿è¯ä¸¤ä¸ªæ›´æ–°éƒ½ä¸ç”Ÿæ•ˆ
            // English: Roll back ensuring none of updates persist
            conn.rollback();

            // ä¸­æ–‡ï¼šéªŒè¯ä¸¤æ¡è®°å½•ä¿æŒåˆå§‹å€¼
            // English: Verify both rows keep initial values
            assertThat(readBalance(conn, 1L)).isEqualByComparingTo("1000.00");
            assertThat(readBalance(conn, 2L)).isEqualByComparingTo("2000.00");
            log.info("å®éªŒæˆåŠŸï¼šåŸå­æ€§éªŒè¯é€šè¿‡ï¼›äº‹åŠ¡å¼‚å¸¸å·²æ•´ä½“å›æ»šï¼Œæœªäº§ç”Ÿéƒ¨åˆ†å†™å…¥ / Success: Atomicity confirmed; transaction rolled back on error, no partial writes");
        }
    }
```

#### æ‰‹åŠ¨éªŒè¯

```sql
-- ä¼šè¯1
START TRANSACTION;
UPDATE account SET balance = 500 WHERE id = 1;
ROLLBACK; -- æ‰‹åŠ¨å›æ»š

-- ä¼šè¯2ï¼šéªŒè¯æ•°æ®æœªæ”¹å˜
SELECT balance FROM account WHERE id = 1; -- ä»ç„¶æ˜¯åŸå€¼
```

#### å…³é”®å‚æ•°

```ini
# my.cnf
innodb_undo_tablespaces = 2    # undo log è¡¨ç©ºé—´æ•°é‡
innodb_max_undo_log_size = 1G  # å•ä¸ª undo log æ–‡ä»¶æœ€å¤§å¤§å°
```

---



#### é—®ç­”



##### MySQLæ€ä¹ˆä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Ÿ



###### èƒŒè¯µç‰ˆ

æœªæäº¤ â†’ Undo å›æ»š
 å·²æäº¤ â†’ Redo é‡åš
 æ­£åœ¨æäº¤ â†’ ä¸¤é˜¶æ®µæäº¤ç¡®ä¿ä¸ä¼šä¸€åŠæˆåŠŸä¸€åŠå¤±è´¥



###### redo.log + undo.log

InnoDB 

1. é€šè¿‡ Undo Log æ”¯æŒå›æ»šã€
2. Redo Log æ”¯æŒå´©æºƒæ¢å¤ã€ä¸¤é˜¶æ®µæäº¤é˜²æ­¢æäº¤ä¸­æ–­ä¸‰è€…å…±åŒä½œç”¨ï¼Œ

å®ç°äº‹åŠ¡çš„åŸå­æ€§ï¼Œä»è€Œä¿è¯äº‹åŠ¡è¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥ã€‚







##### å¦‚æœäº‹åŠ¡åœ¨æ‰§è¡Œäº† updateï¼ˆäº‹åŠ¡æœªæäº¤ï¼‰æ—¶çªç„¶æ–­ç”µï¼Œè¿™æ¬¡æ›´æ–°æ˜¯å¦ä¼šç”Ÿæ•ˆï¼Ÿ

```mermaid
flowchart TD
    A[æ‰§è¡Œæ›´æ–°\nä½™é¢ç”±ä¸€åƒå˜ä¸ºä¹ç™¾\näº‹åŠ¡æœªæäº¤] --> B[çªç„¶æ–­ç”µ]
    B --> C[æ•°æ®åº“é‡å¯]
    C --> D[æ£€æŸ¥é‡åšæ—¥å¿—\næœªæ‰¾åˆ°æäº¤è®°å½•]
    D --> E[æ£€æŸ¥å›æ»šæ—¥å¿—\næ‰¾åˆ°æ—§å€¼ä¸€åƒ]
    E --> F[åˆ¤å®šäº‹åŠ¡æœªæäº¤]
    F --> G[æ ¹æ®å›æ»šæ—¥å¿—æ¢å¤ä¸ºä¸€åƒ]
    G --> H[æœªæäº¤äº‹åŠ¡è¢«è‡ªåŠ¨å›æ»š]
```



######  é€šä¿—æ˜“æ‡‚ç‰ˆæœ¬ï¼ˆä½ æœ€éœ€è¦è®°ä½çš„ï¼‰

- ä½ æ›´æ–°äº†ä½™é¢ä¸º 900
- ä½†è¿˜æ²¡ commit
- å°±æ–­ç”µäº†
- MySQL é‡å¯åï¼š
   â†’ çœ‹ redo logï¼šæ²¡æœ‰ commit è®°å½•
   â†’ çœ‹ undo logï¼šæœ‰æ—§å€¼ 1000
   â†’ å› ä¸ºäº‹åŠ¡æœªæäº¤ï¼Œæ‰€ä»¥ç”¨ undo log æŠŠ 900 æ¢å¤åˆ° 1000

æœ€ç»ˆç»“æœï¼š

**è¿™æ¡ update å®Œå…¨æ²¡ç”Ÿæ•ˆï¼Œåƒä»æœªæ‰§è¡Œè¿‡ä¸€æ ·ã€‚**





> åœ¨ update æ‰§è¡Œä¹‹åã€commit ä¹‹å‰æ–­ç”µâ€”â€”è¿™ç¬”ä¿®æ”¹æ ¹æœ¬ä¸ä¼šç”Ÿæ•ˆï¼Œä¹Ÿä¸ä¼šè¢«æŒä¹…åŒ–

åœ¨æ‰§è¡Œ

```sql
conn.setAutoCommit(false);
updateBalance(conn, 1L, new BigDecimal("900.00"));
```

åæ–­ç”µ



>æ­¤æ—¶çŠ¶æ€æ˜¯ï¼š

| é¡¹ç›®        | çŠ¶æ€                                |
| ----------- | ----------------------------------- |
| redo log    | æœªå†™å…¥ï¼ˆå› ä¸ºè¿˜æ²¡è¿›å…¥ prepare é˜¶æ®µï¼‰ |
| undo log    | å·²å†™å…¥ï¼ˆè®°å½•æ—§å€¼ 1000.00ï¼‰          |
| buffer pool | å·²ä¿®æ”¹ä¸º 900.00ï¼ˆè„é¡µï¼‰             |
| æäº¤ï¼Ÿ      | âŒ æ²¡æœ‰ commit                       |
| äº‹åŠ¡çŠ¶æ€    | æ´»è·ƒäº‹åŠ¡ï¼ˆactive trxï¼‰              |



åªè¦æ²¡æœ‰ commitï¼Œå°±æ„å‘³ç€ï¼š

> **è¿™ç¬”äº‹åŠ¡æ˜¯â€œæœªæäº¤äº‹åŠ¡â€ï¼Œé‡å¯åå¿…é¡»å›æ»šã€‚**



è¿™æ˜¯åŸå­æ€§çš„æœ¬è´¨è¦æ±‚ï¼š

> **æœªæäº¤ = ä¸å…è®¸ç•™ä¸‹ä»»ä½•ç—•è¿¹ã€‚**





##### æ–­ç”µé‡å¯å InnoDB ä¼šå¦‚ä½•å¤„ç†æœªæäº¤äº‹åŠ¡ï¼Œundo log ä¸ crash recovery çš„è¡Œä¸ºæ˜¯ä»€ä¹ˆï¼Ÿ

> InnoDB crash recovery çš„æµç¨‹å¦‚ä¸‹ï¼š

###### â‘  åŠ è½½ redo log

å‘ç°è¿™æ¡ update æ²¡æœ‰è¿›å…¥ prepare é˜¶æ®µ
 â†’ redo log é‡Œæ‰¾ä¸åˆ°ç›¸å…³äº‹åŠ¡

è¯´æ˜ï¼š

**è¿™ä¸ªäº‹åŠ¡ä»æœªâ€œå‡†å¤‡æäº¤â€ã€‚**



###### â‘¡ æ¸…ç† undo log

é‡å¯åæ¢å¤ï¼š

- æŠŠ page æ¢å¤ä¸ºæ—§å€¼ï¼ˆ1000.00ï¼‰
- undo æ—¥å¿—è¢«è§†ä¸ºæœªæäº¤äº‹åŠ¡ â†’ è¢«ä¸¢å¼ƒ

###### â‘¢ äº‹åŠ¡å›æ»š

è¿™ä¸ªâ€œå›æ»šâ€ä¸æ˜¯ä½ æ‰‹åŠ¨ rollback
 è€Œæ˜¯ **Innodb å´©æºƒæ¢å¤è‡ªåŠ¨å›æ»šï¼ˆauto rollbackï¼‰**







### 2.2 éš”ç¦»æ€§ï¼ˆIsolationï¼‰

>åœ¨ InnoDB çš„å¯é‡å¤è¯»ï¼ˆRRï¼‰ä¸‹ï¼Œäº‹åŠ¡ä¼šåŸºäº MVCC åˆ›å»ºä¸€ä¸ªåªå±äºè‡ªå·±çš„å¿«ç…§è§†å›¾ï¼Œè¿™ä¸ªè§†å›¾åœ¨æ•´ä¸ªäº‹åŠ¡ç”Ÿå‘½å‘¨æœŸä¸­ä¿æŒç¨³å®šï¼Œä¸éšç€å…¶ä»–äº‹åŠ¡çš„æäº¤è€Œå˜åŒ–ã€‚
> å¯¹å½“å‰äº‹åŠ¡æ¥è¯´ï¼Œâ€œæ­£ç¡®çš„æ•°æ®â€æ˜¯å…¶å¿«ç…§ä¸­çš„ä¸€è‡´ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯æ•°æ®åº“ä¸­çš„æœ€æ–°ç‰ˆæœ¬ã€‚
> è¿™ç¡®ä¿äº†å¹¶å‘åœºæ™¯ä¸‹è¯»å–çš„ç¨³å®šæ€§å’Œé€»è¾‘ä¸€è‡´æ€§ã€‚

æ¯ä¸ªäº‹åŠ¡éƒ½åƒåœ¨ä¸€ä¸ªç‹¬ç«‹ã€é™æ­¢çš„æ•°æ®ä¸–ç•Œé‡Œæ‰§è¡Œè‡ªå·±çš„é€»è¾‘ã€‚å³ä½¿çœŸå®ä¸–ç•Œåœ¨ç–¯ç‹‚å˜åŒ–ï¼Œä½ çš„ä¸–ç•Œä¾ç„¶ç¨³å®šå¯é ã€‚



#### æ ¸å¿ƒåŸç†

> é€šè¿‡ **é”æœºåˆ¶ + MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰** å®ç°äº‹åŠ¡ä¹‹é—´çš„éš”ç¦»ã€‚

éš”ç¦»æ€§æŒ‡çš„æ˜¯ï¼š

â€‹	å¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´ç›¸äº’éš”ç¦»ã€å½¼æ­¤çš„ä¸­é—´çŠ¶æ€ä¸å¯è§ã€ä½¿æ¯ä¸ªäº‹åŠ¡éƒ½åƒç‹¬ç«‹æ‰§è¡Œä¸€æ ·ï¼Œ**é¿å…å¹¶å‘è¯»å†™å¯¼è‡´æ•°æ®é”™è¯¯**ã€‚



>ä¸€å¥è¯é€šä¿—è§£é‡Š

éš”ç¦»æ€§è®©"åˆ«äººæ²¡æäº¤çš„æ•°æ®ï¼Œä½ çœ‹ä¸åˆ°"ï¼Œ"åˆ«äººæäº¤çš„æ—¶æœºï¼Œä¹Ÿå–å†³äºéš”ç¦»çº§åˆ«"ã€‚



#### å››ç§éš”ç¦»çº§åˆ«

| éš”ç¦»çº§åˆ«     | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯»       | å®ç°æ–¹å¼               |
| ------------ | ---- | ---------- | ---------- | ---------------------- |
| RU è¯»æœªæäº¤  | âœ”    | âœ”          | âœ”          | ä¸éš”ç¦»                 |
| RC è¯»å·²æäº¤  | âœ˜    | âœ”          | âœ”          | MVCC æ¯æ¬¡æ–°å¿«ç…§        |
| RR å¯é‡å¤è¯»  | âœ˜    | âœ˜          | âœ˜ï¼ˆMySQLï¼‰ | MVCC å›ºå®šå¿«ç…§ + é—´éš™é” |
| Serializable | âœ˜    | âœ˜          | âœ˜          | å¼ºåˆ¶æ’é˜Ÿæ‰§è¡Œ           |

- RUï¼šæœ€å¼±ï¼Œä¸éš”ç¦»
- RCï¼šè§£å†³è„è¯»ï¼Œä½†ä¸å¯é‡å¤è¯»ã€å¹»è¯»ä»å¯èƒ½
- RRï¼šMySQLæœ€å¼ºæ€§ä»·æ¯” â†’ è§£å†³ç»å¤§éƒ¨åˆ†é—®é¢˜
- Serializableï¼šæœ€ä¸¥æ ¼ä½†å¹¶å‘èƒ½åŠ›çˆ†ç‚¸ä¸‹é™



#### éªŒè¯ä»£ç 

```java
    /**
     * æ–¹æ³•è¯´æ˜ / Method Description:
     * ä¸­æ–‡ï¼š
     * å•æ–¹æ³•éªŒè¯ MySQL å››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆRUã€RCã€RRã€SERIALIZABLEï¼‰çš„å®é™…éš”ç¦»è¡Œä¸ºï¼Œ
     * ä¾æ¬¡æµ‹è¯•â€œæ˜¯å¦èƒ½è¯»å–åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®â€â€œæ˜¯å¦å‡ºç°ä¸å¯é‡å¤è¯»â€â€œæ˜¯å¦å‡ºç°å¹»è¯»è¶‹åŠ¿â€ç­‰å…³é”®å¹¶å‘ç°è±¡ã€‚
     * <p>
     * English:
     * Single-method verification of all four MySQL isolation levels (RU, RC, RR, SERIALIZABLE),
     * validating visibility of uncommitted writes, non-repeatable reads, and phantom tendencies.
     * <p>
     * å®éªŒç›®çš„ / Experiment Goal:
     * ä¸­æ–‡ï¼šéªŒè¯ä¸åŒéš”ç¦»çº§åˆ«å¯¹æ•°æ®å¯è§æ€§çš„å½±å“ï¼Œç†è§£è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»æ˜¯å¦ä¼šå‘ç”Ÿã€‚
     * English: Verify how each isolation level affects data visibility and concurrent anomalies.
     * <p>
     * é¢„æœŸç»“è®º / Expected Result:
     * RUï¼šèƒ½è¯»åˆ°æœªæäº¤æ•°æ®ï¼ˆè„è¯»ï¼‰
     * RCï¼šä¸èƒ½è¯»æœªæäº¤æ•°æ®ï¼Œä½†ä¼šå‡ºç°ä¸å¯é‡å¤è¯»
     * RRï¼šä¸èƒ½è„è¯»ï¼Œä¸å¯é‡å¤è¯»è¢«è§£å†³ï¼Œä½†å¯èƒ½å‡ºç°å¹»è¯»è¶‹åŠ¿
     * SERIALIZABLEï¼šæ‰€æœ‰è¯»å†™ä¸¥æ ¼ä¸²è¡ŒåŒ–ï¼Œä¸ä¼šå‘ç”Ÿä»»æ„å¹¶å‘é—®é¢˜
     */
    @Test
    @DisplayName("Isolation-AllLevels: RU / RC / RR / SERIALIZABLE å…¨é¢éš”ç¦»æ€§éªŒè¯")
    void isolationAllLevelsTest() throws Exception {

        // å‡†å¤‡ä¸¤ä¸ªä¼šè¯ï¼ˆä¸¤ä¸ªç‹¬ç«‹è¿æ¥ï¼‰
        try (Connection sessionA = dataSource.getConnection();
             Connection sessionB = dataSource.getConnection()) {

            sessionA.setAutoCommit(false);
            sessionB.setAutoCommit(false);

            //------------------------------------------------------------
            // å®éªŒä¸€ï¼šè¯»æœªæäº¤ï¼ˆRUï¼‰
            // å®ç°æ€è·¯ï¼šsessionAè¯»å–sessionBæœªæäº¤çš„add(50.00)ï¼Œå®ƒçœ‹åˆ°äº†1050.00
            //------------------------------------------------------------
            log.info("ã€RUå®éªŒå¼€å§‹ã€‘è¯»æœªæäº¤éªŒè¯ â€” ç†è®ºä¸Šå…è®¸è„è¯» / Start RU Isolation Test");

            sessionA.createStatement().execute("SET SESSION transaction_isolation = 'READ-UNCOMMITTED'");
            sessionB.createStatement().execute("SET SESSION transaction_isolation = 'READ-UNCOMMITTED'");

            BigDecimal initRU = readBalance(sessionB, 1L);
            updateBalance(sessionB, 1L, initRU.add(new BigDecimal("50.00")));  // æœªæäº¤

            BigDecimal aReadRU = readBalance(sessionA, 1L); // A ç«‹å³è¯»å–
            assertThat(aReadRU).isEqualByComparingTo(initRU.add(new BigDecimal("50.00")));

            log.info("RUéªŒè¯æˆåŠŸï¼šä¼šè¯Aè¯»åˆ°äº†æœªæäº¤çš„æ•°æ®ï¼ˆè„è¯»ï¼‰ / RU Success: dirty read occurred");

            sessionB.rollback();  // æ¢å¤
            sessionA.rollback();


            //------------------------------------------------------------
            // å®éªŒäºŒï¼šè¯»å·²æäº¤ï¼ˆRCï¼‰
            // å®ç°æ€è·¯ï¼š
            // é˜¶æ®µä¸€ï¼šsessionAè¯»å–åˆ°sessionBæœªæäº¤äº‹åŠ¡å‰çš„åŸå§‹å€¼1000.00
            // é˜¶æ®µäºŒï¼šsessionAè¯»å–sessionBå·²æäº¤äº‹åŠ¡çš„add(60.00)ï¼Œå®ƒçœ‹åˆ°äº†1060.00
            // ä¸å¯é‡å¤è¯»æˆç«‹ï¼
            //------------------------------------------------------------
            log.info("ã€RCå®éªŒå¼€å§‹ã€‘è¯»å·²æäº¤éªŒè¯ â€” æœç»è„è¯» / Start RC Isolation Test");

            sessionA.createStatement().execute("SET SESSION transaction_isolation = 'READ-COMMITTED'");
            sessionB.createStatement().execute("SET SESSION transaction_isolation = 'READ-COMMITTED'");

            BigDecimal initRC = readBalance(sessionB, 1L);
            updateBalance(sessionB, 1L, initRC.add(new BigDecimal("60.00"))); // æœªæäº¤

            // RC ä¸åº”çœ‹åˆ°æœªæäº¤æ•°æ®
            BigDecimal aReadBeforeCommitRC = readBalance(sessionA, 1L);
            assertThat(aReadBeforeCommitRC).isEqualByComparingTo(initRC);

            log.info("RCéªŒè¯é˜¶æ®µ1ï¼šä¼šè¯Aæœªçœ‹åˆ°ä¼šè¯Bæœªæäº¤æ•°æ®ï¼ˆæ­£ç¡®ï¼‰ / RC Stage1: uncommitted data invisible");

            sessionB.commit(); // æäº¤ B

            BigDecimal aReadAfterCommitRC = readBalance(sessionA, 1L);
            assertThat(aReadAfterCommitRC).isEqualByComparingTo(initRC.add(new BigDecimal("60.00")));

            log.info("RCéªŒè¯é˜¶æ®µ2ï¼šæäº¤åä¼šè¯Açœ‹åˆ°æ–°å€¼ â†’ ä¸å¯é‡å¤è¯»æˆç«‹ / RC Stage2: non-repeatable read observed");

            sessionA.rollback();


            //------------------------------------------------------------
            // å®éªŒä¸‰ï¼šå¯é‡å¤è¯»ï¼ˆRRï¼‰
            // ç›®çš„ï¼šéªŒè¯åœ¨ InnoDB çš„ REPEATABLE-READ éš”ç¦»çº§åˆ«ä¸‹ï¼Œ
            //       åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€è¡Œæ•°æ®ï¼Œå§‹ç»ˆçœ‹åˆ°åŒä¸€ä¸ªâ€œå¿«ç…§ç‰ˆæœ¬â€ã€‚
            // åŸç†ï¼šRR ä¸‹é¦–æ¬¡ SELECT ä¼šåˆ›å»ºä¸€è‡´æ€§å¿«ç…§ï¼ˆReadViewï¼‰ã€‚
            //       åç»­è¯»å–ä¸å†åˆ·æ–°è§†å›¾ï¼Œå³ä½¿å…¶ä»–äº‹åŠ¡æäº¤äº†æ›´æ–°ï¼Œä¹Ÿä¸å¯è§ã€‚
            // éªŒè¯ç‚¹ï¼šä¼šè¯ A åœ¨äº‹åŠ¡æœŸé—´ä¸¤æ¬¡è¯»å–åŒä¸€è¡Œ â†’ ç»“æœä¸€è‡´ â†’ æ— ä¸å¯é‡å¤è¯»ã€‚
            //------------------------------------------------------------
            log.info("ã€RRå®éªŒå¼€å§‹ã€‘å¯é‡å¤è¯»éªŒè¯ â€” å¿«ç…§ä¸€è‡´ / Start RR Isolation Test");
            sessionA.createStatement().execute("SET SESSION transaction_isolation = 'REPEATABLE-READ'");
            sessionB.createStatement().execute("SET SESSION transaction_isolation = 'REPEATABLE-READ'");

            BigDecimal initRR = readBalance(sessionA, 1L);  // A ç¬¬ä¸€æ¬¡è¯»ï¼Œç”Ÿæˆå¿«ç…§

            updateBalance(sessionB, 1L, initRR.add(new BigDecimal("70.00"))); // B ä¿®æ”¹
            sessionB.commit(); // æäº¤ B

            // RRï¼šA å†è¯»ï¼Œä¾æ—§åº”çœ‹åˆ°æ—§å¿«ç…§
            BigDecimal aReadRR = readBalance(sessionA, 1L);
            assertThat(aReadRR).isEqualByComparingTo(initRR);

            log.info("RRéªŒè¯æˆåŠŸï¼šä¼šè¯Aä¸¤æ¬¡è¯»å–ä¸€è‡´ï¼Œæ²¡æœ‰ä¸å¯é‡å¤è¯»ï¼ˆæ­£ç¡®ï¼‰ / RR Success: no non-repeatable read");

            sessionA.commit();

            //------------------------------------------------------------
            // å®éªŒå››ï¼šå¯ä¸²è¡ŒåŒ–ï¼ˆSERIALIZABLEï¼‰
            //------------------------------------------------------------
            log.info("ã€SERIALIZABLEå®éªŒå¼€å§‹ã€‘æœ€é«˜éš”ç¦»çº§åˆ«éªŒè¯ / Start Serializable Isolation Test");

            try (Connection sessionC = dataSource.getConnection();
                 Connection sessionD = dataSource.getConnection()) {

                sessionC.setAutoCommit(false);
                sessionD.setAutoCommit(false);
                //è®¾ç½®é”ç­‰å¾…è¶…æ—¶ä¸º1S
                sessionC.createStatement().execute("SET SESSION innodb_lock_wait_timeout = 1");
                sessionD.createStatement().execute("SET SESSION innodb_lock_wait_timeout = 1");

                sessionC.createStatement().execute("SET SESSION transaction_isolation = 'SERIALIZABLE'");
                sessionD.createStatement().execute("SET SESSION transaction_isolation = 'SERIALIZABLE'");

                // ===========================
                // 1. ä¼šè¯Cè¿›è¡Œ SELECTï¼ˆåŠ é”ï¼‰
                // ===========================
                BigDecimal initValue = readBalance(sessionC, 1L);
                log.info("Serializable: ä¼šè¯Cè¯»å–å¹¶åŠ å…±äº«é” / SessionC SELECT(lock)");

                // ===========================
                // 2. ä¼šè¯Då°è¯•æ›´æ–°ï¼Œä¼šè¢«é˜»å¡
                // ===========================
                boolean blocked = false;
                try {
                    updateBalance(sessionD, 1L, initValue.add(new BigDecimal("100.00")));
                } catch (Exception e) {
                    blocked = true; // è¿™ä¸ªå¼‚å¸¸æ˜¯å› ä¸ºæ­»é”æˆ–é”ç­‰å¾…è¶…æ—¶è€Œè¢«æŠ›å‡º
                }

                assertThat(blocked).isTrue();
                log.info("Serializable: ä¼šè¯Då†™å…¥è¢«é˜»å¡ï¼ˆæ­£ç¡®ï¼‰ / SessionD update blocked");

                // ===========================
                // 3. ä¼šè¯Cæäº¤ â†’ è§£é”
                // ===========================
                sessionC.commit();
                log.info("Serializable: ä¼šè¯Cæäº¤å¹¶é‡Šæ”¾é” / SessionC commit(unlock)");

                // ===========================
                // 4. å› ä¸º D å·²ç»å¤±è´¥ï¼ˆé˜»å¡+æŠ›å¼‚å¸¸ï¼‰ï¼Œå¿…é¡» rollback D
                // ===========================
                sessionD.rollback();
                log.info("Serializable: ä¼šè¯Då›æ»š / SessionD rollback");

            } catch (SQLException e) {
                log.error("Serializable Test Error", e);
                throw e;
            }
        }
    }
```



##### æ‰§è¡Œè§£æ

###### 1. **ã€RUå®éªŒå¼€å§‹ã€‘è¯»æœªæäº¤éªŒè¯**

- `RUéªŒè¯æˆåŠŸï¼šä¼šè¯Aè¯»åˆ°äº†æœªæäº¤çš„æ•°æ®ï¼ˆè„è¯»ï¼‰`
- **è§£é‡Š**ï¼šäº‹åŠ¡AæˆåŠŸè¯»å–åˆ°äº†äº‹åŠ¡Bæœªæäº¤çš„æ•°æ®ï¼ŒéªŒè¯äº†è„è¯»ï¼ˆè¿™æ˜¯RUçš„ç‰¹ç‚¹ï¼‰ã€‚



###### 2. **ã€RCå®éªŒå¼€å§‹ã€‘è¯»å·²æäº¤éªŒè¯**

- `RCéªŒè¯é˜¶æ®µ1ï¼šä¼šè¯Aæœªçœ‹åˆ°ä¼šè¯Bæœªæäº¤æ•°æ®ï¼ˆæ­£ç¡®ï¼‰`
- **è§£é‡Š**ï¼šä¼šè¯Aä¸èƒ½çœ‹åˆ°äº‹åŠ¡Bæœªæäº¤çš„æ•°æ®ï¼Œç¬¦åˆ **RC** éš”ç¦»çº§åˆ«çš„è¦æ±‚ã€‚
- `RCéªŒè¯é˜¶æ®µ2ï¼šæäº¤åä¼šè¯Açœ‹åˆ°æ–°å€¼ â†’ ä¸å¯é‡å¤è¯»æˆç«‹`
- **è§£é‡Š**ï¼šå½“äº‹åŠ¡Bæäº¤åï¼Œä¼šè¯Aèƒ½çœ‹åˆ°æ›´æ–°åçš„æ•°æ®ï¼Œè¯æ˜äº†ä¸å¯é‡å¤è¯»ï¼ˆnon-repeatable readï¼‰ç°è±¡ã€‚



###### 3. **ã€RRå®éªŒå¼€å§‹ã€‘å¯é‡å¤è¯»éªŒè¯**

- `RRéªŒè¯æˆåŠŸï¼šä¼šè¯Aä¸¤æ¬¡è¯»å–ä¸€è‡´ï¼Œæ²¡æœ‰ä¸å¯é‡å¤è¯»ï¼ˆæ­£ç¡®ï¼‰`
- **è§£é‡Š**ï¼šä¼šè¯Aåœ¨ **RR** éš”ç¦»çº§åˆ«ä¸‹ï¼Œç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è¯»å–çš„å€¼ä¸€è‡´ï¼ŒéªŒè¯äº†å¿«ç…§ä¸€è‡´æ€§ã€‚



###### 4. **ã€SERIALIZABLEå®éªŒå¼€å§‹ã€‘æœ€é«˜éš”ç¦»çº§åˆ«éªŒè¯**

- `Serializable: ä¼šè¯Cè¯»å–å¹¶åŠ å…±äº«é” / SessionC SELECT(lock)`
  - **è§£é‡Š**ï¼šä¼šè¯C è¯»å–æ•°æ®å¹¶åŠ é”ï¼Œè¿›è¡Œå…±äº«é”ï¼ˆSé”ï¼‰æ“ä½œã€‚
- `Serializable: ä¼šè¯Då†™å…¥è¢«é˜»å¡ï¼ˆæ­£ç¡®ï¼‰ / SessionD update blocked`
  - **è§£é‡Š**ï¼šä¼šè¯Då°è¯•æ›´æ–°æ—¶ï¼Œç”±äºäº‹åŠ¡Açš„è¯»æ“ä½œé”å®šäº†æ•°æ®ï¼ŒD è¢«é˜»å¡ï¼Œç¬¦åˆä¸²è¡ŒåŒ–çš„ç‰¹æ€§ã€‚
- `Serializable: ä¼šè¯Cæäº¤å¹¶é‡Šæ”¾é” / SessionC commit(unlock)`
  - **è§£é‡Š**ï¼šä¼šè¯C æäº¤äº‹åŠ¡å¹¶é‡Šæ”¾é”ï¼Œå…¶ä»–äº‹åŠ¡ï¼ˆå¦‚Dï¼‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚
- `Serializable: ä¼šè¯Då›æ»š / SessionD rollback`
  - **è§£é‡Š**ï¼šç”±äºä¼šè¯Då°è¯•æ›´æ–°æ—¶è¢«é˜»å¡å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤è¿›è¡Œå›æ»šæ“ä½œã€‚

------



###### ğŸ”¥ **æ€»ç»“**

- **Serializable æµ‹è¯•çš„è¡Œä¸º**ï¼šç¬¦åˆé¢„æœŸï¼Œäº‹åŠ¡Dåœ¨ä¼šè¯Cæäº¤ä¹‹å‰è¢«é˜»å¡ï¼ŒæˆåŠŸéªŒè¯äº†**ä¸²è¡ŒåŒ–**äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹çš„**ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ**è¡Œä¸ºã€‚
- **è¶…æ—¶é—®é¢˜**ï¼šä»æ—¥å¿—æ¥çœ‹ï¼Œæ‰€æœ‰äº‹åŠ¡çš„é”ç­‰å¾…æ—¶é—´åˆç†ï¼Œæ²¡æœ‰å‡ºç°å¡æ­»ç°è±¡ï¼Œè¡¨æ˜ä½ è®¾ç½®çš„ **`innodb_lock_wait_timeout`** åœ¨å¤„ç† **Serializable** æµ‹è¯•æ—¶æœ‰æ•ˆï¼Œé¿å…äº†é•¿æ—¶é—´çš„æ­»é”æˆ–é˜»å¡ã€‚
- **æ—¥å¿—è¾“å‡º**ï¼šæ¯ä¸ªå®éªŒçš„è¡Œä¸ºéƒ½æ˜ç¡®ä¸”æ— é—æ¼ï¼Œç»“æœæ¸…æ™°ï¼Œé€‚åˆé¢è¯•å±•ç¤ºã€‚





#### é—®ç­”



##### äº‹åŠ¡BåŒæ—¶è¯»å–äº‹åŠ¡Aæäº¤äº‹åŠ¡å‰å’Œäº‹åŠ¡åéƒ½æ˜¯ä¸€æ ·çš„å€¼æ•°æ®ä¸å°±é”™äº†å—ï¼Ÿ

- å‡è®¾äº‹åŠ¡Aæ²¡æœ‰æäº¤add(100)ä¹‹å‰æ˜¯1000ï¼Œé‚£ä¹ˆäº‹åŠ¡Bæ­¤æ—¶å»è¯»å–åˆ°äº†ï¼Œäº‹åŠ¡Aæ­¤æ—¶æ˜¯1000ç”Ÿæˆäº†å¿«ç…§ï¼Œ
- è¿™ä¸ªæ—¶å€™äº‹åŠ¡Aå·²ç»æäº¤äº†add(100)å˜æˆäº†1100ï¼Œäº‹åŠ¡Bè¿˜æ˜¯å»è¯»å–äº†æ—§çš„å¿«ç…§æ˜¯1000ï¼Œé‚£ä¹ˆæ•°æ®ä¸å°±é”™äº†ï¼Ÿ



###### ä¸ºä»€ä¹ˆæ•°æ®ä¸ç®—é”™ï¼Ÿ

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šè™½ç„¶äº‹åŠ¡ A åœ¨æäº¤åæ›´æ–°äº†æ•°æ®ï¼Œä½†äº‹åŠ¡ B åœ¨è¯»å–æ—¶ï¼Œçœ‹åˆ°çš„æ˜¯å®ƒ **å¯åŠ¨æ—¶çš„ç‰ˆæœ¬**ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡å†…éƒ¨è¯»å–çš„ä¸€è‡´æ€§ï¼Œé˜²æ­¢å‡ºç°â€œä¸å¯é‡å¤è¯»â€çš„é—®é¢˜ã€‚
2. **ä¸å¼•å…¥è„è¯»**ï¼šç”±äºäº‹åŠ¡ A åœ¨æäº¤å‰ä¸€ç›´ä¿®æ”¹çš„æ˜¯å®ƒçš„ **ä¸´æ—¶å¿«ç…§**ï¼ˆA å¯¹åº”çš„å¿«ç…§å’Œäº‹åŠ¡Bæ˜¯ä¸å…±äº«çš„ï¼‰ï¼Œäº‹åŠ¡ B çœ‹ä¸åˆ° A å…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹ã€‚è¿™æ ·å¯ä»¥æœ‰æ•ˆé˜²æ­¢**è„è¯»**çš„å‘ç”Ÿã€‚
3. **å¿«ç…§éš”ç¦»**ï¼šå¯é‡å¤è¯»ä¸‹ï¼Œäº‹åŠ¡ B æ€»æ˜¯ä¼šè¯»å–åˆ°äº‹åŠ¡ A å¼€å§‹æ—¶åˆ›å»ºçš„å¿«ç…§ï¼Œè€Œ **ä¸ä¼šè¢«äº‹åŠ¡ A æäº¤åçš„æ–°å€¼å½±å“**ã€‚è¿™æ˜¯**å¿«ç…§éš”ç¦»**çš„æ ¸å¿ƒï¼Œç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œéš”ç¦»æ€§ã€‚
4. **å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰**ï¼šæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹è§†å›¾ã€‚A æäº¤çš„ `1100` åªä¼šå¯¹ **æ–°äº‹åŠ¡** å¯è§ï¼Œ**B äº‹åŠ¡ä»ç„¶çœ‹åˆ°çš„æ˜¯å®ƒäº‹åŠ¡å¼€å§‹æ—¶çš„ç‰ˆæœ¬ï¼ˆ1000ï¼‰**ã€‚è¿™ç§æœºåˆ¶é¿å…äº†è·¨äº‹åŠ¡çš„å¹²æ‰°ï¼Œä¹Ÿä¿è¯äº†å¹¶å‘ä¸‹æ•°æ®çš„ç¨³å®šæ€§ã€‚



###### æ€»ç»“

> åœ¨ **Repeatable Readï¼ˆå¯é‡å¤è¯»ï¼‰** éš”ç¦»çº§åˆ«ä¸‹ï¼Œ

- äº‹åŠ¡ B **ä¼šè¯»å–åˆ°å®ƒäº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆçš„å¿«ç…§**ï¼ˆå¦‚ `1000`ï¼‰ï¼Œ
- å³**ä½¿äº‹åŠ¡ A å·²ç»æäº¤äº†å¯¹è¯¥æ•°æ®çš„ä¿®æ”¹ï¼ˆä» `1000` åˆ° `1100`ï¼‰**ã€‚
- è¿™æ˜¯ä¸ºäº†ç¡®ä¿äº‹åŠ¡å†…çš„è¯»å–ä¸€è‡´æ€§ï¼Œé¿å…äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚
- äº‹åŠ¡ A æäº¤åçš„ä¿®æ”¹ä¸ä¼šå½±å“äº‹åŠ¡ B å·²ç»åˆ›å»ºçš„å¿«ç…§ç‰ˆæœ¬ã€‚
- é€šè¿‡ **MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰**ï¼Œæ¯ä¸ªäº‹åŠ¡æœ‰è‡ªå·±çš„è§†å›¾ï¼Œä¿éšœäº†å¹¶å‘æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚



##### ä¸ºä»€ä¹ˆè¯´RRï¼ˆå¯é‡å¤è¯»ï¼‰æœ¬è´¨å°±æ˜¯ä¸ºäº†ä¿è¯å¹¶å‘è¯»å–çš„å‡†ç¡®æ€§å’Œç¨³å®šæ€§ï¼Ÿ



###### 1."å‡†ç¡®æ€§"ä¸æ˜¯è¯»åˆ°æœ€æ–°ï¼Œè€Œæ˜¯è¯»åˆ°"å¯¹æˆ‘æ¥è¯´ä¸€è‡´çš„ç‰ˆæœ¬"

>åœ¨RRå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹

å¯¹äºå½“å‰äº‹åŠ¡Bè€Œè¨€ï¼Œå®ƒ**ä»å¼€å¯äº‹åŠ¡é‚£ä¸€åˆ»èµ·ï¼Œå°±ç»‘å®šåˆ°äº†ä¸€ä¸ª"ä¸“å±çš„æ•°æ®ç‰ˆæœ¬è§†å›¾"ã€‚**

è¿™ä¸ªè§†å›¾é‡Œçš„æ•°æ®å°±æ˜¯å¯¹å®ƒæ¥è¯´**"å‡†ç¡®çš„"ï¼**



> å‡†ç¡®çš„å«ä¹‰ä¸æ˜¯"æœ€æ–°"è€Œæ˜¯

"**åŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œæ‰€æœ‰è¯»å–éƒ½ä¸€è‡´ã€ä¸å˜ã€ä¸å—åˆ«äººæäº¤çš„å½±å“**"ã€‚

è¿™å°±æ˜¯æ•°æ®åº“ä¸€è‡´æ€§çš„å®šä¹‰æ–¹å¼ã€‚



###### 2."ç¨³å®šæ€§"çš„å«ä¹‰å°±æ˜¯å¿«ç…§ä¸å˜

>å¯¹äºäº‹åŠ¡Bæ¥è¯´ï¼Œå®ƒçš„å¿«ç…§ç‰ˆæœ¬å°±æ˜¯ç¨³å®šä¸å˜çš„

è¿™æ„å‘³ç€ï¼š

1. åˆ«äººæ›´æ–°ï¼Ÿå¯ä»¥æ›´æ–°
2. åˆ«äººæäº¤ï¼Ÿå¯ä»¥æäº¤
3. åˆ«äººåˆ äº†å†åŠ ï¼Ÿéšä¾¿
4. åªè¦Bä¸commitï¼Œå®ƒæ°¸è¿œåªçœ‹åˆ°å®ƒçš„é‚£ä»½å¿«ç…§



>ä¹Ÿå°±æ˜¯è¯´

- **äº‹åŠ¡Bçš„è¯»æ“ä½œä¸ä¼šè¢«å¤–ç•Œçš„å†™æ“ä½œæ‰“ä¹±èŠ‚å¥ï¼Œä¹Ÿä¸ä¼šè¢«"æœ€æ–°å€¼"å¹²æ‰°ã€‚**
- **å®ƒçœ‹çš„å§‹ç»ˆæ˜¯ä¸€è‡´çš„å†å²è§†å›¾ã€‚**



è¿™å°±æ˜¯"å¯é‡å¤è¯»"çš„æœ¬è´¨å«ä¹‰ã€‚







---

### 2.3 æŒä¹…æ€§ï¼ˆDurabilityï¼‰

>**æŒä¹…æ€§** æ˜¯ **ACID** å››å¤§ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒä¿è¯äº†åœ¨äº‹åŠ¡æäº¤åï¼Œæ•°æ®ä¼šè¢«æ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿå´©æºƒã€æ–­ç”µç­‰å¼‚å¸¸æƒ…å†µï¼Œå·²æäº¤çš„äº‹åŠ¡æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚
> æŒä¹…æ€§é€šå¸¸ä¾èµ–äºä»¥ä¸‹å‡ ä¸ªæŠ€æœ¯ï¼š
>
>1. **æ—¥å¿—æœºåˆ¶ï¼ˆWALï¼ŒWrite-Ahead Loggingï¼‰**ï¼šäº‹åŠ¡ä¿®æ”¹æ•°æ®å‰ï¼Œå…ˆå†™å…¥æ—¥å¿—ï¼Œç¡®ä¿æ•°æ®æäº¤ä¸ä¼šä¸¢å¤±ã€‚
>2. **é‡åšæ—¥å¿—ï¼ˆRedo Logï¼‰å’Œæ’¤é”€æ—¥å¿—ï¼ˆUndo Logï¼‰**ï¼šé€šè¿‡é‡åšæ—¥å¿—æ¢å¤å·²æäº¤çš„äº‹åŠ¡ï¼Œæ’¤é”€æ—¥å¿—æ”¯æŒäº‹åŠ¡å›æ»šã€‚
>3. **æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰**ï¼šå®šæœŸå°†å†…å­˜ä¸­çš„æ•°æ®é¡µå†™å…¥ç£ç›˜ï¼Œå‡å°‘æ¢å¤æ—¶é—´ã€‚

> **åªè¦äº‹åŠ¡ commit äº†ï¼Œå“ªæ€•æ•°æ®åº“é©¬ä¸Šå´©æºƒï¼Œæ–­ç”µé‡å¯ï¼Œå·²æäº¤çš„æ•°æ®å¿…é¡»æ¢å¤å›æ¥ï¼Œä¸èƒ½ä¸¢ã€‚**



#### ç®€ä»‹

>æŒä¹…å‹ä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š

**ä¸€æ—¦äº‹åŠ¡æäº¤(commit)ï¼Œå…¶ä¿®æ”¹çš„æ•°æ®å¿…é¡»æ°¸ä¹…ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œä¸ä¼šä¸¢å¤±**ã€‚

**æ— è®ºå‘ç”Ÿä»€ä¹ˆæ•…éšœæˆ–ç³»ç»Ÿå´©æºƒï¼Œå·²æäº¤çš„äº‹åŠ¡æ•°æ®å¿…é¡»ä¿è¯æ¢å¤**ï¼Œè¿™å°±æ˜¯æŒä¹…å‹çš„å…³é”®æ‰€åœ¨ã€‚



#### æ ¸å¿ƒåŸç†

é€šè¿‡ **redo log + binlog + ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰** ä¿è¯æ•°æ®æŒä¹…åŒ–ã€‚



#### æ ¸å¿ƒè§„åˆ™

> æ•°æ®ä¿®æ”¹**å¿…é¡»å…ˆå†™æ—¥å¿—ï¼ˆredo logï¼‰**ï¼ŒæˆåŠŸåæ‰ç®— commitï¼Œ
> **æ•°æ®é¡µå¯ä»¥æ…¢æ…¢å†™å›ç£ç›˜**ï¼Œä¸ç€æ€¥ã€‚

ä¸ºä»€ä¹ˆï¼Ÿ

å› ä¸ºç£ç›˜éšæœºå†™å¤ªæ…¢ï¼Œredo é¡ºåºå†™éå¸¸å¿«ã€‚



#### ä¸¤é˜¶æ®µæäº¤æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            MySQL ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  1. æ‰§è¡ŒSQLå¹¶æ›´æ–°å†…å­˜                              â”‚
â”‚     â†“                                            â”‚
â”‚  2. å†™ redo log (prepare çŠ¶æ€) â”€â”€â”€â”              â”‚
â”‚     â†“                              â”‚              â”‚
â”‚  3. å†™ binlog                      â”‚ é˜¶æ®µ1: Prepareâ”‚
â”‚     â†“                              â”‚              â”‚
â”‚  4. è°ƒç”¨å­˜å‚¨å¼•æ“æäº¤æ¥å£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚     â†“                                            â”‚
â”‚  5. å†™ redo log (commit çŠ¶æ€) â”€â”€â”€â”€â”              â”‚
â”‚     â†“                              â”‚ é˜¶æ®µ2: Commit â”‚
â”‚  6. äº‹åŠ¡æäº¤å®Œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                  â”‚
â”‚  âœ… å¦‚æœåœ¨æ­¥éª¤3-4ä¹‹é—´å´©æºƒï¼Œé‡å¯åï¼š                â”‚
â”‚     - redo log æœ‰ prepare æ ‡è®°                    â”‚
â”‚     - binlog å·²å†™å…¥                               â”‚
â”‚     â†’ è‡ªåŠ¨æäº¤äº‹åŠ¡                                 â”‚
â”‚                                                  â”‚
â”‚  âœ… å¦‚æœåœ¨æ­¥éª¤2-3ä¹‹é—´å´©æºƒï¼Œé‡å¯åï¼š                â”‚
â”‚     - redo log æœ‰ prepare æ ‡è®°                    â”‚
â”‚     - binlog æœªå†™å…¥                               â”‚
â”‚     â†’ è‡ªåŠ¨å›æ»šäº‹åŠ¡                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### redo log vs binlog å¯¹æ¯”

| ç»´åº¦ | redo log | binlog |
|------|----------|--------|
| **å±‚çº§** | InnoDB å¼•æ“å±‚ | MySQL Server å±‚ |
| **ä½œç”¨** | å´©æºƒæ¢å¤ | ä¸»ä»å¤åˆ¶ã€æ•°æ®å¤‡ä»½ |
| **è®°å½•å†…å®¹** | ç‰©ç†æ—¥å¿—ï¼ˆæ•°æ®é¡µå˜åŒ–ï¼‰ | é€»è¾‘æ—¥å¿—ï¼ˆSQLè¯­å¥ï¼‰ |
| **å†™å…¥æ–¹å¼** | å¾ªç¯å†™å…¥ï¼ˆå›ºå®šå¤§å°ï¼‰ | è¿½åŠ å†™å…¥ |
| **åˆ·ç›˜æ—¶æœº** | innodb_flush_log_at_trx_commit | sync_binlog |

#### åˆ·ç›˜ç­–ç•¥

```ini
# my.cnf é…ç½®

# ===== redo log åˆ·ç›˜ç­–ç•¥ =====
innodb_flush_log_at_trx_commit = 1  # æ¨èé‡‘èç³»ç»Ÿ
# 0 = æ¯ç§’åˆ·ä¸€æ¬¡ï¼ˆå¯èƒ½ä¸¢1ç§’æ•°æ®ï¼‰
# 1 = æ¯æ¬¡æäº¤éƒ½åˆ·ç›˜ï¼ˆæœ€å®‰å…¨ï¼‰
# 2 = æ¯æ¬¡æäº¤å†™OSç¼“å­˜ï¼Œæ¯ç§’åˆ·ç›˜ï¼ˆæŠ˜ä¸­ï¼‰

# ===== binlog åˆ·ç›˜ç­–ç•¥ =====
sync_binlog = 1  # æ¨èé‡‘èç³»ç»Ÿ
# 0 = ä¸å¼ºåˆ¶åˆ·ç›˜ï¼ˆä¾èµ–OSï¼‰
# 1 = æ¯æ¬¡æäº¤éƒ½åˆ·binlogï¼ˆæœ€å®‰å…¨ï¼‰
# N = æ¯Næ¬¡äº‹åŠ¡åˆ·ä¸€æ¬¡ï¼ˆæŠ˜ä¸­ï¼‰
```

#### éªŒè¯æŒä¹…æ€§

```bash
# 1. æ’å…¥æ•°æ®
mysql> INSERT INTO account (name, balance) VALUES ('æŒä¹…åŒ–æµ‹è¯•', 1000);
Query OK, 1 row affected (0.01 sec)

# 2. å¼ºåˆ¶æ€æ‰MySQLè¿›ç¨‹ï¼ˆæ¨¡æ‹Ÿå®•æœºï¼‰
$ kill -9 $(pidof mysqld)

# 3. é‡å¯MySQL
$ systemctl start mysql

# 4. éªŒè¯æ•°æ®ä»ç„¶å­˜åœ¨
mysql> SELECT * FROM account WHERE name = 'æŒä¹…åŒ–æµ‹è¯•';
+----+--------------+---------+
| id | name         | balance |
+----+--------------+---------+
|  1 | æŒä¹…åŒ–æµ‹è¯•    | 1000.00 |
+----+--------------+---------+
âœ… æ•°æ®æœªä¸¢å¤±ï¼
```











### 2.4 ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰

#### æ ¸å¿ƒåŸç†

> ä¸€è‡´æ€§æ˜¯é€šè¿‡ **åŸå­æ€§ + éš”ç¦»æ€§ + æŒä¹…æ€§** å…±åŒä¿è¯çš„ï¼ŒåŒæ—¶éœ€è¦åº”ç”¨å±‚çš„ä¸šåŠ¡çº¦æŸã€‚

ä¸€è‡´æ€§æ€§æŒ‡çš„æ˜¯ï¼š

- äº‹åŠ¡æ‰§è¡Œå‰åï¼Œ
- æ•°æ®åº“**å¿…é¡»ä»ä¸€ä¸ªåˆæ³•çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªåˆæ³•çŠ¶æ€**ï¼Œ
- ä¸èƒ½ç ´åä¸šåŠ¡è§„åˆ™ä¸æ•°æ®çº¦æŸã€‚

**ä¸ç®¡ä½ åšä»€ä¹ˆæ“ä½œï¼Œåªè¦äº‹åŠ¡æˆåŠŸæäº¤ï¼Œæ•°æ®å¿…é¡»ä¿æŒæ­£ç¡®ï¼Œä¸å…è®¸å‡ºç°è¿åçº¦æŸçš„çŠ¶æ€ã€‚**





#### è½¬è´¦åœºæ™¯ç¤ºä¾‹

```mermaid
flowchart TD
    A[è¯»å–åˆå§‹æ€»é¢\nä¸€å·ä¸€åƒ\näºŒå·äºŒåƒ\næ€»é¢ä¸‰åƒ] --> B[å¼€å§‹äº‹åŠ¡]
    B --> C[è¯»å–ä¸€å·è´¦æˆ·ä½™é¢ä¸€åƒ\næ‰£å‡ä¸‰ç™¾å˜ä¸ºä¸ƒç™¾]
    C --> D[è¯»å–äºŒå·è´¦æˆ·ä½™é¢äºŒåƒ\nå¢åŠ ä¸‰ç™¾å˜ä¸ºäºŒåƒä¸‰ç™¾]
    D --> E[æäº¤äº‹åŠ¡]
    E --> F[å†æ¬¡è®¡ç®—æ€»é¢\nä¸ƒç™¾åŠ äºŒåƒä¸‰ç™¾ç­‰äºä¸‰åƒ]
    F --> G[æ€»é¢æœªå˜åŒ–\nä¸€è‡´æ€§éªŒè¯é€šè¿‡]
```

#### éªŒè¯ä»£ç 

```java
   /**
     * æ–¹æ³•è¯´æ˜ / Method Description:
     * ä¸­æ–‡ï¼šä¸€è‡´æ€§ï¼ˆConsistencyï¼‰éªŒè¯ï¼šè·¨ä¸¤è¡Œçš„è½¬è´¦åœ¨æäº¤åä¿æŒæ€»ä½™é¢å®ˆæ’ï¼Œå‡ºç°é”™è¯¯æ—¶å›æ»šä¿æŒä¸å˜é‡ã€‚
     * English: Consistency verification: cross-row transfer preserves total sum after commit; on error, rollback keeps invariant.
     * <p>
     * å‚æ•° / Parameters: æ— 
     * è¿”å›å€¼ / Return: æ— 
     * å¼‚å¸¸ / Exceptions: SQL æ‰§è¡Œå¼‚å¸¸æˆ–æ–­è¨€å¤±è´¥ä¼šä½¿æµ‹è¯•å¤±è´¥
     */
    @Test
    @DisplayName("ACID-Consistency: transfer preserves sum invariant")
    void consistencySumInvariant() throws Exception {
        try (Connection conn = dataSource.getConnection()) {
            conn.setAutoCommit(false);

            // ä¸­æ–‡ï¼šåˆå§‹æ€»é¢
            // English: Initial sum
            BigDecimal sum0 = readSum(conn);

            // ä¸­æ–‡ï¼šæ‰§è¡Œä» id=1 å‘ id=2 è½¬è´¦ 300
            // English: Transfer 300 from id=1 to id=2
            BigDecimal b1 = readBalance(conn, 1L);
            BigDecimal b2 = readBalance(conn, 2L);
            updateBalance(conn, 1L, b1.subtract(new BigDecimal("300.00")));
            updateBalance(conn, 2L, b2.add(new BigDecimal("300.00")));

            // ä¸­æ–‡ï¼šæäº¤äº‹åŠ¡
            // English: Commit transaction
            conn.commit();

            // ä¸­æ–‡ï¼šæäº¤åæ€»é¢åº”ä¿æŒä¸å˜
            // English: Sum invariant must hold after commit
            BigDecimal sum1 = readSum(conn);
            assertThat(sum1).isEqualByComparingTo(sum0);
            log.info("å®éªŒæˆåŠŸï¼šä¸€è‡´æ€§éªŒè¯é€šè¿‡ï¼›è·¨è¡Œè½¬è´¦åæ€»é¢å®ˆæ’ / Success: Consistency confirmed; cross-row transfer preserved total sum");
        }
    }
```

#### æ•°æ®åº“çº¦æŸ

```sql
-- ä½™é¢éè´Ÿçº¦æŸ
ALTER TABLE account ADD CONSTRAINT chk_balance CHECK (balance >= 0);

-- å¤–é”®çº¦æŸ
ALTER TABLE orders ADD CONSTRAINT fk_user 
FOREIGN KEY (user_id) REFERENCES users(id);
```

---





#### é—®ç­”



##### æ€ä¹ˆä¿è¯çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

> MySQLï¼ˆInnoDBï¼‰é€šè¿‡ã€Œçº¦æŸæœºåˆ¶ã€ï¼‹ã€ŒåŸå­æ€§ã€ï¼‹ã€Œéš”ç¦»æ€§ã€ï¼‹ã€ŒæŒä¹…æ€§ã€å››ç±»æ‰‹æ®µå…±åŒä¿è¯ä¸€è‡´æ€§ã€‚

ä¸€è‡´æ€§æœ¬èº«æ˜¯ç»“æœï¼šæ•°æ®åº“å§‹ç»ˆä¿æŒåˆæ³•çŠ¶æ€ï¼Œä¸å‡ºç°è¿åçº¦æŸçš„æ•°æ®ã€‚



###### 1.çº¦æŸ(consistencyçš„æ ¸å¿ƒåŸºç¡€)

>ä¸€è‡´æ€§ä¸æ˜¯æ•°æ®åº“è‡ªåŠ¨å‡­ç©ºä¿è¯çš„ï¼Œå®ƒé¦–å…ˆä¾èµ–çº¦æŸ(Constraint)

- ä¸»é”®å”¯ä¸€
- å¤–é”®çº¦æŸ
- éç©ºçº¦æŸ
- check
- ä¸šåŠ¡è§„åˆ™(æ¯”å¦‚ä½™é¢ä¸èƒ½ä¸ºè´Ÿ)



>æ•°æ®åº“ä¿è¯

**åªè¦ä½ å®šä¹‰äº†è§„åˆ™ï¼Œæˆ‘å°±ä¿è¯æäº¤åçš„æ•°æ®ä¸€å®šä¸è¿åè§„åˆ™**

è¿™æ˜¯æœ€åº•å±‚çš„â€œä¸€è‡´æ€§åŸºç¡€â€ã€‚



###### 2.åŸå­æ€§(Atomicity)â€”â€”é¿å…å†™ä¸€åŠ

>é€šè¿‡Undo Logå®ç°

- äº‹åŠ¡å¤±è´¥â€”â€”>æ•´ä½“å›æ»š
- ä¸ä¼šç•™ä¸‹ä¸­é—´çŠ¶æ€
- è½¬è´¦æ‰£äº†é’±ã€åŠ é’±å¤±è´¥è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿã€‚

å¦‚æœæ²¡æœ‰åŸå­æ€§ï¼Œå°±ä¼šé€ æˆæœ¬è´¨ä¸Šçš„æ•°æ®ä¸ä¸€è‡´ã€‚



###### 3.éš”ç¦»æ€§(Lsolation)â€”â€”é¿å…å¹¶å‘ç¯¡æ”¹æ•°æ®

>InnoDBé€šè¿‡

- MVCC(å¿«ç…§è¯»)
- è¡Œé”ã€é—´éš™é”ã€ä¸´é”®é”(å½“å‰è¯»)
- äº‹åŠ¡éš”ç¦»çº§åˆ«(RCã€RR)

>ä¿è¯ï¼š

ä¸åŒäº‹åŠ¡ä¸ä¼šè¯»åˆ°å…¶å®ƒäº‹åŠ¡ï¼Œæœªæäº¤çš„è„æ•°æ®ï¼Œä¹Ÿä¸ä¼šäº’ç›¸ç¯¡æ”¹å¯¼è‡´ä¸ä¸€è‡´ã€‚

ä¾‹å¦‚:

- å¹¶å‘æ‰£æ¬¾æ—¶é¿å…ä¸¤ä¸ªäº‹åŠ¡éƒ½è¯»åˆ°æ—§ä½™é¢
- é˜²æ­¢å¹¶å‘äº§ç”Ÿä¸¢å¤±æ›´æ–°



éš”ç¦»æ€§å¤„ç†çš„æ˜¯"å¹¶å‘ä¸‹å¦‚ä½•ä¿æŒä¸€è‡´"ã€‚



###### 4.æŒä¹…æ€§(Durability)â€”â€”é¿å…"æäº¤åä¸¢æ•°æ®"

>InnoDBé€šè¿‡

- redo log
- WALå†™å‰æ—¥å¿—
- crash recover(å´©æºƒæ¢å¤)



>ç¡®ä¿æäº¤åçš„æ•°æ®

æ–­ç”µä¹Ÿä¸ä¼šä¸¢ï¼Œä¿è¯æäº¤åçš„çŠ¶æ€æ˜¯æœ€ç»ˆä¸€è‡´çš„ã€‚



>å¦‚æœcommitä¹‹åæ–­ç”µå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œä¹Ÿä¼šç ´åä¸€è‡´æ€§ã€‚



###### 5.æ€»ç»“

- ä¸€è‡´æ€§æ˜¯ç›®æ ‡
- åŸå­æ€§ + éš”ç¦»æ€§ + æŒä¹…å‹ = ä¿è¯ä¸€è‡´æ€§çš„æ‰‹æ®µ
- çº¦æŸ = å®šä¹‰ä»€ä¹ˆæ˜¯"åˆæ³•çŠ¶æ€"

å››è€…åˆåœ¨ä¸€èµ·æ‰èƒ½ä¿è¯ä¸€è‡´æ€§ã€‚



>æ ‡å‡†æ€»ç»“å¥

MySQLçš„ä¸€è‡´æ€§ä¸æ˜¯å•ä¸€æœºåˆ¶å®ç°çš„ï¼Œè€Œæ˜¯ä¾èµ–

1. çº¦æŸæœºåˆ¶å®šä¹‰åˆæ³•çŠ¶æ€ï¼Œ
2. å†ç”±åŸå­æ€§ä¿è¯å¤±è´¥ä¸ç•™ç—•ã€
3. éš”ç¦»æ€§ä¿è¯å¹¶å‘ä¸ç ´åçŠ¶æ€ã€
4. æŒä¹…æ€§ç¡®ä¿æäº¤ä¸ä¸¢å¤±

å››è€…å…±åŒä¿è¯äº‹åŠ¡å‰åå§‹ç»ˆå¤„äºä¸€è‡´çš„åˆæ³•æ•°æ®çŠ¶æ€

















---

## 3. InnoDB å­˜å‚¨å±‚å®ç°

### 3.1 ä¸‰å¤§æ—¥å¿—ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           InnoDB æ—¥å¿—ç³»ç»Ÿæ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ undo log â”‚    â”‚ redo log â”‚    â”‚  binlog  â”‚   â”‚
â”‚  â”‚ å›æ»šæ—¥å¿—  â”‚    â”‚ é‡åšæ—¥å¿—  â”‚    â”‚ äºŒè¿›åˆ¶æ—¥å¿—â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚               â”‚               â”‚          â”‚
â”‚       â†“               â†“               â†“          â”‚
â”‚  ä¿è¯åŸå­æ€§       ä¿è¯æŒä¹…æ€§       ä¸»ä»å¤åˆ¶        â”‚
â”‚  + MVCC          + å´©æºƒæ¢å¤       + å¢é‡å¤‡ä»½      â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 undo log è¯¦è§£

#### ä½œç”¨
1. **äº‹åŠ¡å›æ»š**ï¼šè®°å½•ä¿®æ”¹å‰çš„æ—§å€¼
2. **MVCC è¯»å–**ï¼šæä¾›å†å²ç‰ˆæœ¬å¿«ç…§

#### å­˜å‚¨ä½ç½®
```sql
-- æŸ¥çœ‹ undo log é…ç½®
SHOW VARIABLES LIKE '%undo%';

-- è¾“å‡ºç¤ºä¾‹
innodb_undo_directory = ./
innodb_undo_tablespaces = 2
innodb_max_undo_log_size = 1073741824
```

#### ç‰ˆæœ¬é“¾ç»“æ„

```
å½“å‰è®°å½•: id=1, name='å¼ ä¸‰', balance=800, trx_id=103, roll_ptr=0x1234

         â†“ roll_ptr æŒ‡å‘

undo log: id=1, name='å¼ ä¸‰', balance=900, trx_id=102, roll_ptr=0x1235

         â†“ roll_ptr æŒ‡å‘

undo log: id=1, name='å¼ ä¸‰', balance=1000, trx_id=101, roll_ptr=NULL

âœ… é€šè¿‡ç‰ˆæœ¬é“¾å¯ä»¥å›æ»šåˆ°ä»»æ„å†å²ç‰ˆæœ¬
```

### 3.3 redo log è¯¦è§£

#### ä½œç”¨
ä¿è¯æŒä¹…æ€§ï¼šå³ä½¿æ•°æ®é¡µæœªåˆ·ç›˜ï¼Œä¹Ÿèƒ½é€šè¿‡ redo log æ¢å¤æ•°æ®

#### WALï¼ˆWrite-Ahead Loggingï¼‰æœºåˆ¶

```
æ­£å¸¸æµç¨‹ï¼ˆæœªä¼˜åŒ–ï¼‰:
1. ä¿®æ”¹æ•°æ® â†’ 2. åˆ·è„é¡µåˆ°ç£ç›˜ï¼ˆéšæœºIOï¼Œæ…¢ï¼‰

WALä¼˜åŒ–æµç¨‹:
1. ä¿®æ”¹æ•°æ® â†’ 2. å†™redo logï¼ˆé¡ºåºIOï¼Œå¿«ï¼‰â†’ 3. å¼‚æ­¥åˆ·è„é¡µ

âœ… ä¼˜ç‚¹ï¼š
  - redo log é¡ºåºå†™å…¥ï¼Œé€Ÿåº¦å¿«
  - è„é¡µåˆ·ç›˜å¯ä»¥å»¶è¿Ÿï¼Œåˆå¹¶å¤šæ¬¡ä¿®æ”¹
  - å´©æºƒæ¢å¤æ—¶ï¼Œé€šè¿‡redo logé‡æ”¾å³å¯
```

#### redo log æ–‡ä»¶ç»“æ„

```
# æŸ¥çœ‹redo logæ–‡ä»¶
$ ls -lh /var/lib/mysql/ib_logfile*
-rw-r----- 1 mysql mysql 48M ib_logfile0
-rw-r----- 1 mysql mysql 48M ib_logfile1

# å¾ªç¯å†™å…¥æ¨¡å¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ib_logfile0  â”‚  ib_logfile1        â”‚
â”‚  â†“å†™å…¥        â”‚  â†“å†™å…¥              â”‚
â”‚  å·²åˆ·ç›˜è®°å½•    â”‚  æœªåˆ·ç›˜è®°å½•          â”‚
â”‚  (å¯è¦†ç›–)     â”‚  (ä¸å¯è¦†ç›–)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                  â†‘
  checkpoint        write pos
```

### 3.4 binlog è¯¦è§£

#### ä¸‰ç§æ ¼å¼

| æ ¼å¼ | è®°å½•å†…å®¹ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **STATEMENT** | åŸå§‹SQL | æ—¥å¿—é‡å° | æŸäº›å‡½æ•°æ— æ³•å¤åˆ¶ï¼ˆNOW()ï¼‰ |
| **ROW** | æ¯è¡Œå˜åŒ– | ç²¾ç¡®å¤åˆ¶ | æ—¥å¿—é‡å¤§ |
| **MIXED** | æ··åˆæ¨¡å¼ | è‡ªåŠ¨é€‰æ‹© | å¤æ‚åº¦é«˜ |

```sql
-- æŸ¥çœ‹å½“å‰æ ¼å¼
SHOW VARIABLES LIKE 'binlog_format';

-- ä¿®æ”¹ä¸ºROWæ ¼å¼ï¼ˆæ¨èï¼‰
SET GLOBAL binlog_format = 'ROW';
```

#### æŸ¥çœ‹binlog

```sql
-- æŸ¥çœ‹å½“å‰binlogæ–‡ä»¶
SHOW MASTER STATUS;
+------------------+----------+--------------+
| File             | Position | Binlog_Do_DB |
+------------------+----------+--------------+
| mysql-bin.000001 |     1234 |              |
+------------------+----------+--------------+

-- æŸ¥çœ‹binlogå†…å®¹
SHOW BINLOG EVENTS IN 'mysql-bin.000001' LIMIT 10;

-- è§£æbinlogï¼ˆæ¨èå·¥å…·ï¼‰
$ mysqlbinlog mysql-bin.000001
```

---

## 4. äº‹åŠ¡éš”ç¦»çº§åˆ«

### 4.1 éš”ç¦»çº§åˆ«è®¾ç½®

```sql
-- æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«
SELECT @@transaction_isolation;
-- æˆ–
SHOW VARIABLES LIKE 'transaction_isolation';

-- è®¾ç½®ä¼šè¯çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;

-- è®¾ç½®å…¨å±€çº§åˆ«ï¼ˆéœ€é‡å¯ï¼‰
SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ;
```

### 4.2 éš”ç¦»çº§åˆ«è¯¦è§£

#### READ UNCOMMITTEDï¼ˆè¯»æœªæäº¤ï¼‰

```sql
-- ä¼šè¯A
SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
START TRANSACTION;
SELECT balance FROM account WHERE id = 1; -- è¯»åˆ°1000

-- ä¼šè¯B
START TRANSACTION;
UPDATE account SET balance = 500 WHERE id = 1;
-- æ³¨æ„ï¼šæœªæäº¤ï¼

-- ä¼šè¯Aï¼ˆç»§ç»­ï¼‰
SELECT balance FROM account WHERE id = 1; -- è¯»åˆ°500ï¼ˆè„è¯»ï¼ï¼‰

-- ä¼šè¯Bï¼ˆç»§ç»­ï¼‰
ROLLBACK; -- å›æ»š

-- ä¼šè¯Aï¼ˆç»§ç»­ï¼‰
SELECT balance FROM account WHERE id = 1; -- è¯»åˆ°1000ï¼ˆä¹‹å‰è¯»åˆ°çš„500æ˜¯è„æ•°æ®ï¼‰
```

**ç»“è®º**: âŒ ä¸æ¨èä½¿ç”¨ï¼Œä¼šäº§ç”Ÿè„è¯»

---

#### READ COMMITTEDï¼ˆè¯»å·²æäº¤ï¼‰

```sql
-- ä¼šè¯A
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
START TRANSACTION;
SELECT balance FROM account WHERE id = 1; -- è¯»åˆ°1000

-- ä¼šè¯B
UPDATE account SET balance = 500 WHERE id = 1;
COMMIT; -- æäº¤

-- ä¼šè¯Aï¼ˆç»§ç»­ï¼‰
SELECT balance FROM account WHERE id = 1; -- è¯»åˆ°500ï¼ˆä¸å¯é‡å¤è¯»ï¼ï¼‰
COMMIT;
```

**ç‰¹ç‚¹**:
- âœ… è§£å†³è„è¯»
- âŒ å­˜åœ¨ä¸å¯é‡å¤è¯»
- ğŸ”§ é€‚ç”¨åœºæ™¯ï¼šé«˜å¹¶å‘ç³»ç»Ÿï¼ˆOracleé»˜è®¤çº§åˆ«ï¼‰

---

#### REPEATABLE READï¼ˆå¯é‡å¤è¯»ï¼‰- MySQLé»˜è®¤

```sql
-- ä¼šè¯A
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION;
SELECT balance FROM account WHERE id = 1; -- è¯»åˆ°1000

-- ä¼šè¯B
UPDATE account SET balance = 500 WHERE id = 1;
COMMIT; -- æäº¤

-- ä¼šè¯Aï¼ˆç»§ç»­ï¼‰
SELECT balance FROM account WHERE id = 1; -- ä»ç„¶è¯»åˆ°1000ï¼ˆå¯é‡å¤è¯»ï¼‰âœ…
COMMIT;
```

**ç‰¹ç‚¹**:
- âœ… è§£å†³è„è¯»
- âœ… è§£å†³ä¸å¯é‡å¤è¯»
- âœ… é€šè¿‡Next-Key Lockè§£å†³å¹»è¯»
- ğŸ”§ é€‚ç”¨åœºæ™¯ï¼šé‡‘èç³»ç»Ÿã€æŠ¥è¡¨ç»Ÿè®¡

---

#### SERIALIZABLEï¼ˆä¸²è¡ŒåŒ–ï¼‰

```sql
-- ä¼šè¯A
SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;
START TRANSACTION;
SELECT * FROM account WHERE id = 1; -- è‡ªåŠ¨åŠ è¯»é”

-- ä¼šè¯B
UPDATE account SET balance = 500 WHERE id = 1; -- ç­‰å¾…ä¼šè¯Aé‡Šæ”¾é”...
```

**ç‰¹ç‚¹**:
- âœ… å®Œå…¨é¿å…å¹¶å‘é—®é¢˜
- âŒ æ€§èƒ½æå·®
- ğŸ”§ é€‚ç”¨åœºæ™¯ï¼šå…³é”®ä¸šåŠ¡ï¼ˆå¦‚å¯¹è´¦ï¼‰

---

### 4.3 éš”ç¦»çº§åˆ«é€‰æ‹©å»ºè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡åœºæ™¯             â”‚ æ¨èéš”ç¦»çº§åˆ«      â”‚ ç†ç”±       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é“¶è¡Œè½¬è´¦             â”‚ REPEATABLE READ  â”‚ å¼ºä¸€è‡´æ€§   â”‚
â”‚ è®¢å•æ”¯ä»˜             â”‚ REPEATABLE READ  â”‚ é˜²æ­¢é‡å¤æ‰£æ¬¾â”‚
â”‚ ç”µå•†ç§’æ€             â”‚ READ COMMITTED   â”‚ é«˜å¹¶å‘     â”‚
â”‚ æŠ¥è¡¨ç»Ÿè®¡             â”‚ READ UNCOMMITTED â”‚ å¯å®¹å¿è„è¯»  â”‚
â”‚ è´¢åŠ¡å¯¹è´¦             â”‚ SERIALIZABLE     â”‚ ç»å¯¹å‡†ç¡®   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. é”æœºåˆ¶è¯¦è§£

### 5.1 é”åˆ†ç±»ä½“ç³»

```
InnoDB é”æœºåˆ¶
â”œâ”€â”€ è¡¨çº§é”
â”‚   â”œâ”€â”€ è¡¨é” (LOCK TABLES)
â”‚   â”œâ”€â”€ å…ƒæ•°æ®é” (MDL)
â”‚   â””â”€â”€ æ„å‘é” (IS/IX)
â”‚
â”œâ”€â”€ è¡Œçº§é”
â”‚   â”œâ”€â”€ è®°å½•é” (Record Lock)
â”‚   â”œâ”€â”€ é—´éš™é” (Gap Lock)
â”‚   â””â”€â”€ ä¸´é”®é” (Next-Key Lock)
â”‚
â””â”€â”€ å…¨å±€é”
    â””â”€â”€ FTWRL (Flush Tables With Read Lock)
```

### 5.2 è¡Œé”è¯¦è§£

#### è®°å½•é” (Record Lock)

```sql
-- ä¼šè¯A
START TRANSACTION;
SELECT * FROM account WHERE id = 1 FOR UPDATE; -- é”å®šid=1çš„è®°å½•

-- ä¼šè¯B
UPDATE account SET balance = 500 WHERE id = 1; -- ç­‰å¾…...
UPDATE account SET balance = 500 WHERE id = 2; -- ç«‹å³æ‰§è¡Œ âœ…
```

**ç‰¹ç‚¹**: åªé”å®šç´¢å¼•è®°å½•ï¼Œä¸é”å®šèŒƒå›´

---

#### é—´éš™é” (Gap Lock)

```sql
-- å‡è®¾è¡¨ä¸­æœ‰ id: 1, 5, 10 ä¸‰æ¡è®°å½•

-- ä¼šè¯Aï¼ˆREPEATABLE READï¼‰
START TRANSACTION;
SELECT * FROM account WHERE id BETWEEN 3 AND 7 FOR UPDATE;

-- é”å®šçš„é—´éš™: (1, 5) å’Œ (5, 10)

-- ä¼šè¯B
INSERT INTO account (id, balance) VALUES (3, 1000); -- ç­‰å¾…...ï¼ˆé—´éš™é”é˜»æ­¢ï¼‰
INSERT INTO account (id, balance) VALUES (6, 1000); -- ç­‰å¾…...ï¼ˆé—´éš™é”é˜»æ­¢ï¼‰
INSERT INTO account (id, balance) VALUES (11, 1000); -- ç«‹å³æ‰§è¡Œ âœ…
```

**ä½œç”¨**: é˜²æ­¢å¹»è¯»ï¼ˆé˜²æ­¢åœ¨èŒƒå›´å†…æ’å…¥æ–°è®°å½•ï¼‰

---

#### ä¸´é”®é” (Next-Key Lock)

```
Next-Key Lock = Record Lock + Gap Lock

é”å®šèŒƒå›´ï¼š(å·¦å¼€å³é—­]

ç¤ºä¾‹ï¼šid = 1, 5, 10
SELECT * FROM account WHERE id <= 7 FOR UPDATE;

é”å®šèŒƒå›´ï¼š
(-âˆ, 1]  -- Next-Key Lock
(1, 5]   -- Next-Key Lock
(5, 10)  -- Gap Lock
```

---

### 5.3 æ„å‘é” (Intention Lock)

#### ä½œç”¨

åè°ƒè¡Œé”ä¸è¡¨é”çš„å…³ç³»ï¼Œæé«˜åŠ è¡¨é”çš„æ•ˆç‡ã€‚

```
åœºæ™¯ï¼šäº‹åŠ¡AæŒæœ‰æŸè¡Œçš„è¡Œé”ï¼Œäº‹åŠ¡Bæƒ³åŠ è¡¨é”

æ²¡æœ‰æ„å‘é”ï¼š
  äº‹åŠ¡Béœ€è¦é€è¡Œæ£€æŸ¥æ˜¯å¦æœ‰è¡Œé”ï¼ˆæ…¢ï¼‰

æœ‰æ„å‘é”ï¼š
  äº‹åŠ¡AåŠ è¡Œé”æ—¶ï¼Œè‡ªåŠ¨åœ¨è¡¨ä¸ŠåŠ æ„å‘é”
  äº‹åŠ¡Bæ£€æŸ¥è¡¨çš„æ„å‘é”å³å¯åˆ¤æ–­ï¼ˆå¿«ï¼‰
```

#### ç±»å‹

- **IS (Intention Shared)**ï¼šæ„å‘å…±äº«é”
- **IX (Intention Exclusive)**ï¼šæ„å‘æ’ä»–é”

#### å…¼å®¹çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚    â”‚ IS â”‚ IX â”‚ S  â”‚ X  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ IS â”‚ âœ… â”‚ âœ… â”‚ âœ… â”‚ âŒ â”‚
â”‚ IX â”‚ âœ… â”‚ âœ… â”‚ âŒ â”‚ âŒ â”‚
â”‚ S  â”‚ âœ… â”‚ âŒ â”‚ âœ… â”‚ âŒ â”‚
â”‚ X  â”‚ âŒ â”‚ âŒ â”‚ âŒ â”‚ âŒ â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
```

---

### 5.4 åŠ é”ç¤ºä¾‹

```sql
-- å…±äº«é” (Sé”)
SELECT * FROM account WHERE id = 1 LOCK IN SHARE MODE;

-- æ’ä»–é” (Xé”)
SELECT * FROM account WHERE id = 1 FOR UPDATE;

-- è‡ªåŠ¨åŠ é”
UPDATE account SET balance = 500 WHERE id = 1; -- è‡ªåŠ¨åŠ Xé”
INSERT INTO account VALUES (...);               -- è‡ªåŠ¨åŠ Xé”
DELETE FROM account WHERE id = 1;               -- è‡ªåŠ¨åŠ Xé”
```

---

## 6. MVCC åŸç†

### 6.1 ä»€ä¹ˆæ˜¯ MVCCï¼Ÿ

**MVCC (Multi-Version Concurrency Control)** å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶

- è¯»ä¸åŠ é”ï¼Œå†™ä¸é˜»å¡è¯»
- é€šè¿‡ä¿å­˜æ•°æ®çš„å¤šä¸ªå†å²ç‰ˆæœ¬å®ç°å¹¶å‘æ§åˆ¶
- åªåœ¨ **READ COMMITTED** å’Œ **REPEATABLE READ** ä¸‹ç”Ÿæ•ˆ

---

### 6.2 MVCC å®ç°æœºåˆ¶

#### éšè—å­—æ®µ

InnoDB ä¸ºæ¯è¡Œæ•°æ®æ·»åŠ ä¸‰ä¸ªéšè—å­—æ®µï¼š

```sql
CREATE TABLE account (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  balance DECIMAL(10,2),
  -- ä»¥ä¸‹ä¸ºéšè—å­—æ®µï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰
  DB_TRX_ID,    -- æœ€åä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ID
  DB_ROLL_PTR,  -- æŒ‡å‘undo logçš„å›æ»šæŒ‡é’ˆ
  DB_ROW_ID     -- éšè—ä¸»é”®ï¼ˆä»…åœ¨æ— ä¸»é”®æ—¶å­˜åœ¨ï¼‰
);
```

#### ç‰ˆæœ¬é“¾ç¤ºä¾‹

```
å½“å‰æ•°æ®è¡Œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id=1, name='å¼ ä¸‰', balance=800         â”‚
â”‚ DB_TRX_ID=103, DB_ROLL_PTR=0x1234     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ (æŒ‡å‘undo log)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ undo log: balance=900, trx_id=102     â”‚
â”‚ roll_ptr=0x1235                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ (ç»§ç»­æŒ‡å‘)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ undo log: balance=1000, trx_id=101    â”‚
â”‚ roll_ptr=NULL                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… é€šè¿‡ç‰ˆæœ¬é“¾ï¼Œä¸åŒäº‹åŠ¡å¯ä»¥è¯»å–åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®
```

---

### 6.3 ReadView æœºåˆ¶

#### ReadView æ˜¯ä»€ä¹ˆï¼Ÿ

äº‹åŠ¡å¼€å§‹æ—¶ï¼ŒInnoDB ä¼šç”Ÿæˆä¸€ä¸ª **ReadViewï¼ˆè¯»è§†å›¾ï¼‰**ï¼Œè®°å½•å½“å‰æ´»è·ƒçš„äº‹åŠ¡åˆ—è¡¨ï¼Œç”¨äºåˆ¤æ–­æ•°æ®çš„å¯è§æ€§ã€‚

#### ReadView å­—æ®µ

```java
class ReadView {
    long m_low_limit_id;     // å½“å‰ç³»ç»Ÿä¸­æœ€å¤§äº‹åŠ¡ID + 1
    long m_up_limit_id;      // å½“å‰æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ID
    List<Long> m_ids;        // å½“å‰æ´»è·ƒçš„äº‹åŠ¡IDåˆ—è¡¨
    long m_creator_trx_id;   // åˆ›å»ºè¯¥ReadViewçš„äº‹åŠ¡ID
}
```

#### å¯è§æ€§åˆ¤æ–­è§„åˆ™

```
ç»™å®šæ•°æ®è¡Œçš„ trx_idï¼Œåˆ¤æ–­æ˜¯å¦å¯è§ï¼š

1. trx_id < m_up_limit_id
   â†’ è¯¥ç‰ˆæœ¬åœ¨ReadViewç”Ÿæˆå‰å·²æäº¤ï¼Œå¯è§ âœ…

2. trx_id >= m_low_limit_id
   â†’ è¯¥ç‰ˆæœ¬åœ¨ReadViewç”Ÿæˆåæ‰æäº¤ï¼Œä¸å¯è§ âŒ

3. m_up_limit_id <= trx_id < m_low_limit_id
   a) å¦‚æœ trx_id åœ¨ m_ids ä¸­ï¼ˆæ´»è·ƒäº‹åŠ¡ï¼‰
      â†’ ä¸å¯è§ âŒ
   b) å¦‚æœ trx_id ä¸åœ¨ m_ids ä¸­ï¼ˆå·²æäº¤ï¼‰
      â†’ å¯è§ âœ…

4. trx_id == m_creator_trx_id
   â†’ æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ä¿®æ”¹çš„ï¼Œå¯è§ âœ…
```

---

### 6.4 MVCC å·¥ä½œæµç¨‹

#### åœºæ™¯ï¼šä¸¤ä¸ªäº‹åŠ¡å¹¶å‘è¯»å†™

```
åˆå§‹æ•°æ®: id=1, balance=1000, trx_id=100

æ—¶é—´çº¿:
T1  äº‹åŠ¡A(trx_id=101) BEGIN
T2  äº‹åŠ¡A ç”Ÿæˆ ReadView(m_ids=[101])
T3  äº‹åŠ¡A SELECT balance WHERE id=1  â†’ è¯»åˆ°1000 âœ…
T4  
T5  äº‹åŠ¡B(trx_id=102) BEGIN
T6  äº‹åŠ¡B UPDATE balance=500 WHERE id=1
T7  äº‹åŠ¡B COMMIT
T8  
T9  äº‹åŠ¡A SELECT balance WHERE id=1  â†’ è¯»åˆ°1000è¿˜æ˜¯500ï¼Ÿ

ç­”æ¡ˆå–å†³äºéš”ç¦»çº§åˆ«ï¼š
- READ COMMITTED: è¯»åˆ°500ï¼ˆæ¯æ¬¡SELECTç”Ÿæˆæ–°ReadViewï¼‰
- REPEATABLE READ: è¯»åˆ°1000ï¼ˆå¤ç”¨ç¬¬ä¸€æ¬¡çš„ReadViewï¼‰
```

#### è¯¦ç»†è¿‡ç¨‹ï¼ˆREPEATABLE READï¼‰

```
T3æ—¶åˆ» äº‹åŠ¡A ç¬¬ä¸€æ¬¡æŸ¥è¯¢:
1. ç”Ÿæˆ ReadView: {m_ids=[101], m_up_limit_id=101, m_low_limit_id=102}
2. æŸ¥æ‰¾ id=1 çš„è®°å½•: trx_id=100
3. åˆ¤æ–­å¯è§æ€§: 100 < 101ï¼ˆåœ¨ReadViewå‰å·²æäº¤ï¼‰â†’ å¯è§ âœ…
4. è¿”å› balance=1000

T9æ—¶åˆ» äº‹åŠ¡A ç¬¬äºŒæ¬¡æŸ¥è¯¢:
1. å¤ç”¨ T3 çš„ ReadViewï¼ˆREPEATABLE READç‰¹æ€§ï¼‰
2. æŸ¥æ‰¾ id=1 çš„è®°å½•: trx_id=102
3. åˆ¤æ–­å¯è§æ€§: 102 >= 102ï¼ˆåœ¨ReadViewåæ‰æäº¤ï¼‰â†’ ä¸å¯è§ âŒ
4. é€šè¿‡ roll_ptr æ‰¾åˆ° undo log ç‰ˆæœ¬: trx_id=100, balance=1000
5. åˆ¤æ–­å¯è§æ€§: 100 < 101 â†’ å¯è§ âœ…
6. è¿”å› balance=1000

âœ… å®ç°äº†å¯é‡å¤è¯»ï¼
```

---

### 6.5 å¿«ç…§è¯» vs å½“å‰è¯»

#### å¿«ç…§è¯»

é€šè¿‡ MVCC è¯»å–å†å²ç‰ˆæœ¬ï¼Œ**ä¸åŠ é”**

```sql
-- å¿«ç…§è¯»ï¼ˆä¸åŠ é”ï¼‰
SELECT * FROM account WHERE id = 1;
```

#### å½“å‰è¯»

è¯»å–æœ€æ–°ç‰ˆæœ¬ï¼Œ**åŠ é”**

```sql
-- å½“å‰è¯»ï¼ˆåŠ Sé”ï¼‰
SELECT * FROM account WHERE id = 1 LOCK IN SHARE MODE;

-- å½“å‰è¯»ï¼ˆåŠ Xé”ï¼‰
SELECT * FROM account WHERE id = 1 FOR UPDATE;

-- å½“å‰è¯»ï¼ˆè‡ªåŠ¨åŠ Xé”ï¼‰
UPDATE account SET balance = 500 WHERE id = 1;
INSERT INTO account VALUES (...);
DELETE FROM account WHERE id = 1;
```

---

## 7. æ­»é”ä¸è°ƒä¼˜

### 7.1 æ­»é”äº§ç”ŸåŸå› 

#### ç»å…¸æ­»é”åœºæ™¯

```
æ—¶é—´çº¿:
T1  äº‹åŠ¡A: SELECT * FROM account WHERE id=1 FOR UPDATE; -- æŒæœ‰é”A
T2  äº‹åŠ¡B: SELECT * FROM account WHERE id=2 FOR UPDATE; -- æŒæœ‰é”B
T3  äº‹åŠ¡A: SELECT * FROM account WHERE id=2 FOR UPDATE; -- ç­‰å¾…é”B
T4  äº‹åŠ¡B: SELECT * FROM account WHERE id=1 FOR UPDATE; -- ç­‰å¾…é”A

ğŸ’¥ æ­»é”ï¼äº‹åŠ¡Aç­‰å¾…äº‹åŠ¡Bï¼Œäº‹åŠ¡Bç­‰å¾…äº‹åŠ¡A
```

---

### 7.2 æ­»é”æ£€æµ‹

#### æŸ¥çœ‹æ­»é”æ—¥å¿—

```sql
SHOW ENGINE INNODB STATUS\G

-- è¾“å‡ºç¤ºä¾‹ï¼ˆå…³é”®éƒ¨åˆ†ï¼‰
------------------------
LATEST DETECTED DEADLOCK
------------------------
2024-11-11 10:30:00 0x7f8b9c001700
*** (1) TRANSACTION:
TRANSACTION 12345, ACTIVE 2 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s)
MySQL thread id 10, OS thread handle 140243567890432, query id 100 localhost root
UPDATE account SET balance=500 WHERE id=2

*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 2 page no 3 n bits 72 index PRIMARY of table `test`.`account` 
trx id 12345 lock_mode X locks rec but not gap waiting

*** (2) TRANSACTION:
TRANSACTION 12346, ACTIVE 1 sec starting index read
mysql tables in use 1, locked 1
2 lock struct(s), heap size 1136, 1 row lock(s)
MySQL thread id 11, OS thread handle 140243567894528, query id 101 localhost root
UPDATE account SET balance=500 WHERE id=1

*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 2 page no 3 n bits 72 index PRIMARY of table `test`.`account`
trx id 12346 lock_mode X locks rec but not gap

*** WE ROLL BACK TRANSACTION (1)
```

---

### 7.3 æ­»é”é¢„é˜²ç­–ç•¥

#### 1. æŒ‰å›ºå®šé¡ºåºåŠ é”

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¯èƒ½æ­»é”
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    Account from = repository.findByIdForUpdate(fromId); // å…ˆé”from
    Account to = repository.findByIdForUpdate(toId);     // å†é”to
    // å¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡å…ˆé”toå†é”fromï¼Œå°±ä¼šæ­»é”
}

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šæŒ‰IDæ’åºåŠ é”
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    Long firstId = Math.min(fromId, toId);
    Long secondId = Math.max(fromId, toId);
    
    Account first = repository.findByIdForUpdate(firstId);  // å§‹ç»ˆå…ˆé”å°ID
    Account second = repository.findByIdForUpdate(secondId); // å†é”å¤§ID
    
    // æ‰§è¡Œè½¬è´¦é€»è¾‘
}
```

#### 2. è®¾ç½®é”ç­‰å¾…è¶…æ—¶

```sql
-- è®¾ç½®é”ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
SET innodb_lock_wait_timeout = 50; -- é»˜è®¤50ç§’

-- æŸ¥çœ‹å½“å‰é…ç½®
SHOW VARIABLES LIKE 'innodb_lock_wait_timeout';
```

#### 3. ä½¿ç”¨ä¹è§‚é”

```java
@Entity
public class Account {
    @Id
    private Long id;
    
    @Version // ä¹è§‚é”ç‰ˆæœ¬å·
    private Integer version;
    
    private BigDecimal balance;
}

// æ›´æ–°æ—¶è‡ªåŠ¨æ£€æŸ¥ç‰ˆæœ¬å·
@Transactional
public void updateBalance(Long id, BigDecimal amount) {
    Account account = repository.findById(id).orElseThrow();
    account.setBalance(account.getBalance().add(amount));
    repository.save(account); 
    // SQL: UPDATE account SET balance=?, version=version+1 
    //      WHERE id=? AND version=?
    // å¦‚æœversionä¸åŒ¹é…ï¼ŒæŠ› OptimisticLockingFailureException
}
```

#### 4. å‡å°‘äº‹åŠ¡æŒæœ‰é”çš„æ—¶é—´

```java
// âŒ é•¿äº‹åŠ¡
@Transactional
public void processOrder(Long orderId) {
    Order order = repository.findByIdForUpdate(orderId); // åŠ é”
    
    // è€—æ—¶æ“ä½œ
    callThirdPartyAPI();      // è°ƒç”¨å¤–éƒ¨æ¥å£ï¼ˆ2ç§’ï¼‰
    complexCalculation();     // å¤æ‚è®¡ç®—ï¼ˆ3ç§’ï¼‰
    sendEmail();              // å‘é€é‚®ä»¶ï¼ˆ1ç§’ï¼‰
    
    order.setStatus("COMPLETED");
    repository.save(order);   // é‡Šæ”¾é”
    // é”æŒæœ‰æ—¶é—´: 6ç§’+
}

// âœ… çŸ­äº‹åŠ¡ï¼šå°†éDBæ“ä½œç§»åˆ°äº‹åŠ¡å¤–
public void processOrder(Long orderId) {
    // éäº‹åŠ¡æ“ä½œ
    String apiResult = callThirdPartyAPI();
    BigDecimal result = complexCalculation();
    
    // äº‹åŠ¡æ“ä½œ
    updateOrderInTransaction(orderId, result);
    
    // éäº‹åŠ¡æ“ä½œ
    sendEmail();
}

@Transactional
private void updateOrderInTransaction(Long orderId, BigDecimal result) {
    Order order = repository.findByIdForUpdate(orderId);
    order.setStatus("COMPLETED");
    order.setAmount(result);
    repository.save(order);
    // é”æŒæœ‰æ—¶é—´: <100ms
}
```

---

### 7.4 äº‹åŠ¡è°ƒä¼˜å®æˆ˜

#### 1. æŸ¥æ‰¾é•¿äº‹åŠ¡

```sql
-- æŸ¥çœ‹è¿è¡Œè¶…è¿‡10ç§’çš„äº‹åŠ¡
SELECT trx_id, trx_state, trx_started, 
       TIMESTAMPDIFF(SECOND, trx_started, NOW()) AS duration,
       trx_mysql_thread_id, trx_query
FROM information_schema.innodb_trx
WHERE TIMESTAMPDIFF(SECOND, trx_started, NOW()) > 10;
```

#### 2. æŸ¥çœ‹é”ç­‰å¾…

```sql
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…æƒ…å†µ
SELECT 
    r.trx_id AS waiting_trx_id,
    r.trx_mysql_thread_id AS waiting_thread,
    r.trx_query AS waiting_query,
    b.trx_id AS blocking_trx_id,
    b.trx_mysql_thread_id AS blocking_thread,
    b.trx_query AS blocking_query
FROM information_schema.innodb_lock_waits w
INNER JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id
INNER JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id;
```

#### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–

```java
// âŒ é€æ¡æäº¤ï¼ˆæ…¢ï¼‰
for (int i = 0; i < 10000; i++) {
    insertRecord(i); // 10000æ¬¡äº‹åŠ¡
}
// è€—æ—¶: 30ç§’+

// âœ… æ‰¹é‡æäº¤ï¼ˆå¿«ï¼‰
List<Account> batch = new ArrayList<>();
for (int i = 0; i < 10000; i++) {
    batch.add(new Account(...));
    if (batch.size() == 1000) {
        saveBatch(batch); // åˆ†æ‰¹æäº¤
        batch.clear();
    }
}
saveBatch(batch); // æäº¤å‰©ä½™
// è€—æ—¶: 3ç§’

@Transactional
private void saveBatch(List<Account> accounts) {
    repository.saveAll(accounts);
}
```

#### 4. è¿æ¥æ± ä¼˜åŒ–

```yaml
# application.yml
spring:
  datasource:
    hikari:
      minimum-idle: 10           # æœ€å°ç©ºé—²è¿æ¥
      maximum-pool-size: 50      # æœ€å¤§è¿æ¥æ•°
      connection-timeout: 30000  # è¿æ¥è¶…æ—¶(ms)
      idle-timeout: 600000       # ç©ºé—²è¶…æ—¶(ms)
      max-lifetime: 1800000      # è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´(ms)
      
      # æ€§èƒ½ä¼˜åŒ–
      auto-commit: false         # å…³é—­è‡ªåŠ¨æäº¤
      connection-test-query: SELECT 1  # è¿æ¥æµ‹è¯•æŸ¥è¯¢
```

---

## 8. å®æˆ˜æ¡ˆä¾‹

### 8.1 é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿ

#### åœºæ™¯æè¿°
å•†å“åº“å­˜1000ä»¶ï¼Œ10000ä¸ªç”¨æˆ·åŒæ—¶æŠ¢è´­

#### æ–¹æ¡ˆ1ï¼šæ‚²è§‚é”ï¼ˆä¼ ç»Ÿï¼‰

```java
@Transactional
public boolean seckill(Long productId, Long userId) {
    // åŠ æ’ä»–é”
    Product product = productRepository.findByIdForUpdate(productId);
    
    if (product.getStock() <= 0) {
        return false; // åº“å­˜ä¸è¶³
    }
    
    // æ‰£å‡åº“å­˜
    product.setStock(product.getStock() - 1);
    productRepository.save(product);
    
    // åˆ›å»ºè®¢å•
    createOrder(productId, userId);
    
    return true;
}
```

**ä¼˜ç‚¹**: é€»è¾‘ç®€å•ï¼Œä¸ä¼šè¶…å–  
**ç¼ºç‚¹**: æ€§èƒ½å·®ï¼Œå¤§é‡é”ç­‰å¾…

---

#### æ–¹æ¡ˆ2ï¼šä¹è§‚é” + é‡è¯•

```java
@Transactional
public boolean seckill(Long productId, Long userId) {
    Product product = productRepository.findById(productId).orElseThrow();
    
    if (product.getStock() <= 0) {
        return false;
    }
    
    // ä½¿ç”¨ä¹è§‚é”æ›´æ–°
    int updated = productRepository.updateStockWithVersion(
        productId, 
        product.getVersion(),
        product.getStock() - 1
    );
    
    if (updated == 0) {
        throw new OptimisticLockingFailureException("ç‰ˆæœ¬å†²çª");
    }
    
    createOrder(productId, userId);
    return true;
}

// Repository
@Query("UPDATE Product p SET p.stock = p.stock - 1, p.version = p.version + 1 " +
       "WHERE p.id = :id AND p.version = :version AND p.stock > 0")
int updateStockWithVersion(@Param("id") Long id, 
                          @Param("version") Integer version, 
                          @Param("newStock") Integer newStock);

// Controller å±‚é‡è¯•
@PostMapping("/seckill")
public Result seckill(Long productId) {
    int maxRetry = 3;
    for (int i = 0; i < maxRetry; i++) {
        try {
            boolean success = seckillService.seckill(productId, userId);
            return success ? Result.ok() : Result.fail("åº“å­˜ä¸è¶³");
        } catch (OptimisticLockingFailureException e) {
            if (i == maxRetry - 1) {
                return Result.fail("ç³»ç»Ÿç¹å¿™");
            }
            // é‡è¯•
        }
    }
}
```

**ä¼˜ç‚¹**: æ€§èƒ½é«˜ï¼Œæ— é”ç­‰å¾…  
**ç¼ºç‚¹**: éœ€è¦å¤„ç†é‡è¯•é€»è¾‘

---

#### æ–¹æ¡ˆ3ï¼šRedis + Luaè„šæœ¬ï¼ˆæœ€ä¼˜ï¼‰

```java
// Redis åŸå­æ‰£å‡åº“å­˜
@Service
public class SeckillService {
    
    @Autowired
    private RedisTemplate<String, String> redis;
    
    private static final String LUA_SCRIPT = 
        "local stock = redis.call('get', KEYS[1]) " +
        "if stock and tonumber(stock) > 0 then " +
        "  redis.call('decr', KEYS[1]) " +
        "  return 1 " +
        "else " +
        "  return 0 " +
        "end";
    
    public boolean seckill(Long productId, Long userId) {
        String key = "product:stock:" + productId;
        
        // æ‰§è¡ŒLuaè„šæœ¬ï¼ˆåŸå­æ“ä½œï¼‰
        Long result = redis.execute(
            new DefaultRedisScript<>(LUA_SCRIPT, Long.class),
            Collections.singletonList(key)
        );
        
        if (result == 0) {
            return false; // åº“å­˜ä¸è¶³
        }
        
        // å¼‚æ­¥åˆ›å»ºè®¢å•
        asyncCreateOrder(productId, userId);
        
        return true;
    }
    
    @Async
    private void asyncCreateOrder(Long productId, Long userId) {
        // å¼‚æ­¥å†™å…¥MySQL
        orderService.create(productId, userId);
    }
}
```

**ä¼˜ç‚¹**: 
- æ€§èƒ½æé«˜ï¼ˆRediså•æœº10ä¸‡QPS+ï¼‰
- Luaè„šæœ¬ä¿è¯åŸå­æ€§
- å¼‚æ­¥å†™åº“ï¼Œå‰Šå³°å¡«è°·

---

### 8.2 åˆ†å¸ƒå¼äº‹åŠ¡

#### åœºæ™¯ï¼šè®¢å•æœåŠ¡ + åº“å­˜æœåŠ¡

```
è®¢å•æœåŠ¡: åˆ›å»ºè®¢å•
åº“å­˜æœåŠ¡: æ‰£å‡åº“å­˜

è¦æ±‚: è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
```

#### æ–¹æ¡ˆ1ï¼šTCCï¼ˆTry-Confirm-Cancelï¼‰

```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    // Tryé˜¶æ®µ: é¢„åˆ›å»ºè®¢å•
    public void tryCreateOrder(Long orderId, Long productId) {
        Order order = new Order();
        order.setStatus("TRY"); // é¢„åˆ›å»ºçŠ¶æ€
        orderRepository.save(order);
    }
    
    // Confirmé˜¶æ®µ: ç¡®è®¤è®¢å•
    public void confirmOrder(Long orderId) {
        Order order = orderRepository.findById(orderId).orElseThrow();
        order.setStatus("SUCCESS");
        orderRepository.save(order);
    }
    
    // Cancelé˜¶æ®µ: å–æ¶ˆè®¢å•
    public void cancelOrder(Long orderId) {
        orderRepository.deleteById(orderId);
    }
}

// åº“å­˜æœåŠ¡
@Service
public class StockService {
    
    // Tryé˜¶æ®µ: å†»ç»“åº“å­˜
    public void tryReduceStock(Long productId, Integer count) {
        Product product = productRepository.findByIdForUpdate(productId);
        product.setStock(product.getStock() - count);
        product.setFrozenStock(product.getFrozenStock() + count);
        productRepository.save(product);
    }
    
    // Confirmé˜¶æ®µ: æ‰£å‡å†»ç»“åº“å­˜
    public void confirmReduceStock(Long productId, Integer count) {
        Product product = productRepository.findByIdForUpdate(productId);
        product.setFrozenStock(product.getFrozenStock() - count);
        productRepository.save(product);
    }
    
    // Cancelé˜¶æ®µ: é‡Šæ”¾å†»ç»“åº“å­˜
    public void cancelReduceStock(Long productId, Integer count) {
        Product product = productRepository.findByIdForUpdate(productId);
        product.setStock(product.getStock() + count);
        product.setFrozenStock(product.getFrozenStock() - count);
        productRepository.save(product);
    }
}
```

---

#### æ–¹æ¡ˆ2ï¼šSeata ATæ¨¡å¼ï¼ˆæ¨èï¼‰

```yaml
# application.yml
seata:
  enabled: true
  application-id: order-service
  tx-service-group: my_tx_group
  service:
    vgroup-mapping:
      my_tx_group: default
    grouplist:
      default: 127.0.0.1:8091
```

```java
// ä¸»æœåŠ¡
@Service
public class BusinessService {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private StockServiceClient stockServiceClient; // Feignå®¢æˆ·ç«¯
    
    @GlobalTransactional // Seataå…¨å±€äº‹åŠ¡
    public void createOrder(Long productId, Integer count) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        orderService.create(productId, count);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹æœåŠ¡ï¼‰
        stockServiceClient.reduceStock(productId, count);
        
        // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼ŒSeataä¼šè‡ªåŠ¨å›æ»šæ‰€æœ‰æ“ä½œ
    }
}
```

---

## 9. é¢è¯•è¦ç‚¹

### 9.1 é«˜é¢‘é¢è¯•é¢˜

#### Q1: è¯´è¯´ MySQL çš„ ACID æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**:

1. **åŸå­æ€§ï¼ˆAtomicityï¼‰**: é€šè¿‡ **undo log** å®ç°
   - äº‹åŠ¡æ‰§è¡Œæ—¶è®°å½•ä¿®æ”¹å‰çš„æ—§å€¼
   - å›æ»šæ—¶åˆ©ç”¨ undo log æ¢å¤æ•°æ®

2. **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**: é€šè¿‡ **åŸå­æ€§ + éš”ç¦»æ€§ + æŒä¹…æ€§** ä¿è¯
   - æ•°æ®åº“çº¦æŸï¼ˆä¸»é”®ã€å¤–é”®ã€å”¯ä¸€ç´¢å¼•ï¼‰
   - åº”ç”¨å±‚ä¸šåŠ¡è§„åˆ™

3. **éš”ç¦»æ€§ï¼ˆIsolationï¼‰**: é€šè¿‡ **MVCC + é”æœºåˆ¶** å®ç°
   - MVCC: è¯»ä¸åŠ é”ï¼Œé€šè¿‡ç‰ˆæœ¬é“¾è¯»å–å†å²å¿«ç…§
   - é”: å†™æ“ä½œåŠ é”ï¼Œé˜²æ­¢å¹¶å‘å†²çª

4. **æŒä¹…æ€§ï¼ˆDurabilityï¼‰**: é€šè¿‡ **redo log + binlog + ä¸¤é˜¶æ®µæäº¤** ä¿è¯
   - redo log: è®°å½•ç‰©ç†å˜åŒ–ï¼Œç”¨äºå´©æºƒæ¢å¤
   - binlog: è®°å½•é€»è¾‘å˜åŒ–ï¼Œç”¨äºä¸»ä»å¤åˆ¶
   - ä¸¤é˜¶æ®µæäº¤: ä¿è¯ redo å’Œ binlog çš„ä¸€è‡´æ€§

---

#### Q2: InnoDB æ˜¯å¦‚ä½•å®ç°å¯é‡å¤è¯»çš„ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**:

é€šè¿‡ **MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰** å®ç°ï¼š

1. **éšè—å­—æ®µ**: æ¯è¡Œæ•°æ®åŒ…å« `trx_id`ï¼ˆäº‹åŠ¡IDï¼‰å’Œ `roll_ptr`ï¼ˆå›æ»šæŒ‡é’ˆï¼‰

2. **ç‰ˆæœ¬é“¾**: é€šè¿‡ undo log å½¢æˆå†å²ç‰ˆæœ¬é“¾

3. **ReadView**: äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆè¯»è§†å›¾ï¼Œè®°å½•æ´»è·ƒäº‹åŠ¡åˆ—è¡¨

4. **å¯è§æ€§åˆ¤æ–­**: æ ¹æ® ReadView åˆ¤æ–­å“ªä¸ªç‰ˆæœ¬å¯è§
   - READ COMMITTED: æ¯æ¬¡æŸ¥è¯¢ç”Ÿæˆæ–° ReadView
   - REPEATABLE READ: äº‹åŠ¡å†…å¤ç”¨ç¬¬ä¸€æ¬¡çš„ ReadView

5. **é˜²æ­¢å¹»è¯»**: é€šè¿‡ **Next-Key Lockï¼ˆä¸´é”®é”ï¼‰** é”å®šèŒƒå›´ï¼Œé˜²æ­¢æ’å…¥æ–°è®°å½•

---

#### Q3: redo log å’Œ binlog æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**:

| ç»´åº¦ | redo log | binlog |
|------|----------|--------|
| **å±‚çº§** | InnoDB å¼•æ“å±‚ | MySQL Server å±‚ |
| **ä½œç”¨** | å´©æºƒæ¢å¤ | ä¸»ä»å¤åˆ¶ã€å¤‡ä»½ |
| **è®°å½•å†…å®¹** | ç‰©ç†æ—¥å¿—ï¼ˆæ•°æ®é¡µä¿®æ”¹ï¼‰ | é€»è¾‘æ—¥å¿—ï¼ˆSQLè¯­å¥ï¼‰ |
| **å†™å…¥æ–¹å¼** | å¾ªç¯å†™ï¼ˆå›ºå®šå¤§å°ï¼‰ | è¿½åŠ å†™ï¼ˆæ— é™å¢é•¿ï¼‰ |
| **åˆ·ç›˜æ—¶æœº** | innodb_flush_log_at_trx_commit | sync_binlog |
| **æ˜¯å¦å¿…éœ€** | å¿…éœ€ï¼ˆä¿è¯æŒä¹…æ€§ï¼‰ | å¯é€‰ï¼ˆä¸»ä»å¤åˆ¶æ‰éœ€è¦ï¼‰ |

---

#### Q4: ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**:

**ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰** æ˜¯ä¿è¯ redo log å’Œ binlog ä¸€è‡´æ€§çš„æœºåˆ¶ï¼š

**æµç¨‹**:
1. **Prepareé˜¶æ®µ**: å†™ redo logï¼Œæ ‡è®°ä¸º prepare çŠ¶æ€
2. **Commité˜¶æ®µ**: å†™ binlogï¼Œç„¶åå°† redo log æ ‡è®°ä¸º commit

**ä½œç”¨**:
- é˜²æ­¢åªå†™äº† redo log æ²¡å†™ binlogï¼ˆä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼‰
- é˜²æ­¢åªå†™äº† binlog æ²¡å†™ redo logï¼ˆå´©æºƒåæ•°æ®ä¸¢å¤±ï¼‰

**å´©æºƒæ¢å¤**:
- å¦‚æœåœ¨å†™ binlog å‰å´©æºƒ: redo log æ˜¯ prepare çŠ¶æ€ â†’ å›æ»š
- å¦‚æœåœ¨å†™ binlog åå´©æºƒ: redo log æ˜¯ prepare çŠ¶æ€ä½†binlogå·²å†™å…¥ â†’ æäº¤

---

#### Q5: å¦‚ä½•é¿å…æ­»é”ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**:

1. **æŒ‰å›ºå®šé¡ºåºåŠ é”**: æ‰€æœ‰äº‹åŠ¡æŒ‰ç›¸åŒé¡ºåºé”å®šèµ„æºï¼ˆå¦‚æŒ‰IDæ’åºï¼‰

2. **å‡å°‘é”æŒæœ‰æ—¶é—´**: 
   - å°†éDBæ“ä½œç§»å‡ºäº‹åŠ¡
   - é¿å…é•¿äº‹åŠ¡

3. **ä½¿ç”¨ä¹è§‚é”**: é€šè¿‡ç‰ˆæœ¬å·ï¼ˆ@Versionï¼‰å‡å°‘é”å†²çª

4. **é™ä½éš”ç¦»çº§åˆ«**: ä» RR é™åˆ° RCï¼ˆç‰ºç‰²ä¸€è‡´æ€§æ¢æ€§èƒ½ï¼‰

5. **è®¾ç½®é”ç­‰å¾…è¶…æ—¶**: `innodb_lock_wait_timeout = 50`

6. **ç›‘æ§å‘Šè­¦**: å®šæœŸæ£€æŸ¥ `SHOW ENGINE INNODB STATUS` çš„æ­»é”æ—¥å¿—

---

#### Q6: é«˜å¹¶å‘åœºæ™¯å¦‚ä½•ä¼˜åŒ–äº‹åŠ¡ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆ**:

1. **æ‰¹é‡æäº¤**: `saveAll()` ä»£æ›¿å¾ªç¯ `save()`
2. **å¼‚æ­¥å¤„ç†**: éå…³é”®æ“ä½œå¼‚æ­¥åŒ–ï¼ˆå¦‚å‘é€é€šçŸ¥ï¼‰
3. **è¯»å†™åˆ†ç¦»**: è¯»æ“ä½œèµ°ä»åº“ï¼Œå‡è½»ä¸»åº“å‹åŠ›
4. **ç¼“å­˜é¢„çƒ­**: çƒ­ç‚¹æ•°æ®æ”¾Redisï¼Œå‡å°‘DBæŸ¥è¯¢
5. **åˆ†åº“åˆ†è¡¨**: å•è¡¨è¿‡å¤§æ—¶æ°´å¹³æ‹†åˆ†
6. **è¿æ¥æ± è°ƒä¼˜**: æ ¹æ®å¹¶å‘é‡è°ƒæ•´è¿æ¥æ•°
7. **ç´¢å¼•ä¼˜åŒ–**: WHERE/JOINå­—æ®µåŠ ç´¢å¼•
8. **é¿å…å…¨è¡¨æ‰«æ**: ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢

---

### 9.2 æ‰‹å†™SQLåœºæ™¯é¢˜

#### åœºæ™¯1: æŸ¥æ‰¾æŒæœ‰é”è¶…è¿‡30ç§’çš„äº‹åŠ¡

```sql
SELECT 
    trx_id,
    trx_state,
    trx_started,
    TIMESTAMPDIFF(SECOND, trx_started, NOW()) AS lock_duration,
    trx_mysql_thread_id AS thread_id,
    trx_query
FROM information_schema.innodb_trx
WHERE trx_state = 'LOCK WAIT'
  AND TIMESTAMPDIFF(SECOND, trx_started, NOW()) > 30
ORDER BY trx_started;
```

---

#### åœºæ™¯2: åˆ†æå“ªä¸ªäº‹åŠ¡é˜»å¡äº†å…¶ä»–äº‹åŠ¡

```sql
SELECT 
    w.requesting_trx_id AS waiting_trx,
    w.blocking_trx_id AS blocking_trx,
    t1.trx_query AS waiting_query,
    t2.trx_query AS blocking_query,
    t1.trx_mysql_thread_id AS waiting_thread,
    t2.trx_mysql_thread_id AS blocking_thread
FROM information_schema.innodb_lock_waits w
LEFT JOIN information_schema.innodb_trx t1 
    ON w.requesting_trx_id = t1.trx_id
LEFT JOIN information_schema.innodb_trx t2 
    ON w.blocking_trx_id = t2.trx_id;
```

---

#### åœºæ™¯3: æ€æ‰é•¿äº‹åŠ¡

```sql
-- 1. æ‰¾å‡ºè¿è¡Œè¶…è¿‡60ç§’çš„äº‹åŠ¡
SELECT CONCAT('KILL ', trx_mysql_thread_id, ';') AS kill_cmd
FROM information_schema.innodb_trx
WHERE TIMESTAMPDIFF(SECOND, trx_started, NOW()) > 60;

-- 2. å¤åˆ¶è¾“å‡ºçš„KILLå‘½ä»¤æ‰§è¡Œ
KILL 12345;
```

---

### 9.3 ä¸€å¥è¯æ€»ç»“ï¼ˆé¢è¯•å¿…èƒŒï¼‰

> "æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ MySQL InnoDB å­˜å‚¨å¼•æ“ï¼Œäº‹åŠ¡å±‚é¢ä¸¥æ ¼éµå¾ª ACID åŸåˆ™ã€‚
> 
> **åŸå­æ€§**é€šè¿‡ undo log ä¿è¯å›æ»šï¼Œ  
> **ä¸€è‡´æ€§**é€šè¿‡ redo + undo + éš”ç¦»æœºåˆ¶ä¿è¯ï¼Œ  
> **éš”ç¦»æ€§**é€šè¿‡ MVCC + é”æœºåˆ¶å®ç°ï¼ˆé»˜è®¤REPEATABLE READçº§åˆ«ï¼‰ï¼Œ  
> **æŒä¹…æ€§**é€šè¿‡ redo log + binlog çš„ä¸¤é˜¶æ®µæäº¤ä¿è¯ã€‚
> 
> å®æˆ˜ä¸­æˆ‘ä»¬æ ¹æ®åœºæ™¯è°ƒæ•´ï¼š
> - é‡‘èæ¨¡å—ç”¨ REPEATABLE READ + æ‚²è§‚é”
> - æ—¥å¿—æ¨¡å—ç”¨ READ COMMITTED + æ‰¹é‡æäº¤
> - ç§’æ€åœºæ™¯ç”¨ Redis + Luaè„šæœ¬ + å¼‚æ­¥å†™åº“
> 
> æ€§èƒ½ä¼˜åŒ–æ–¹é¢ï¼šæ‰¹é‡æ“ä½œã€è¿æ¥æ± è°ƒä¼˜ã€é¿å…é•¿äº‹åŠ¡ã€æŒ‰IDæ’åºåŠ é”é˜²æ­¢æ­»é”ã€‚"

---