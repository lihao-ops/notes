# ä¸‡å¾—å¥—é¤æ­»é”å®æˆ˜æ¡ˆä¾‹

## ä¸€ã€æ•°æ®åº“è¡¨è®¾è®¡

```sql
USE `transaction_study`;

-- äº§å“åº“å­˜è¡¨
CREATE TABLE `product_stock` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `product_code` VARCHAR(50) NOT NULL UNIQUE COMMENT 'äº§å“ç¼–ç ï¼ˆå¦‚ï¼šPRO_MONTHï¼‰',
  `product_name` VARCHAR(100) NOT NULL COMMENT 'äº§å“åç§°ï¼ˆå¦‚ï¼šä¸“ä¸šè¡Œæƒ…ç‰ˆ-æœˆï¼‰',
  `product_type` VARCHAR(20) NOT NULL COMMENT 'äº§å“ç±»å‹ï¼ˆPROFESSIONAL/DEPTH/SUPER/LIMIT_UP/REVERSALï¼‰',
  `duration` VARCHAR(10) NOT NULL COMMENT 'æ—¶é•¿ï¼ˆMONTH/QUARTER/YEARï¼‰',
  `stock_quantity` INT NOT NULL DEFAULT 0 COMMENT 'åº“å­˜æ•°é‡',
  `version` INT NOT NULL DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  INDEX `idx_product_type` (`product_type`)
) ENGINE=INNODB DEFAULT CHARSET=utf8mb4 COMMENT='äº§å“åº“å­˜è¡¨';

-- åˆå§‹åŒ–æµ‹è¯•æ•°æ®
INSERT INTO `product_stock` (`product_code`, `product_name`, `product_type`, `duration`, `stock_quantity`) VALUES
-- ä¸“ä¸šè¡Œæƒ…ç‰ˆ
('PRO_MONTH', 'ä¸“ä¸šè¡Œæƒ…ç‰ˆ-æœˆ', 'PROFESSIONAL', 'MONTH', 1000),
('PRO_QUARTER', 'ä¸“ä¸šè¡Œæƒ…ç‰ˆ-å­£', 'PROFESSIONAL', 'QUARTER', 1000),
('PRO_YEAR', 'ä¸“ä¸šè¡Œæƒ…ç‰ˆ-å¹´', 'PROFESSIONAL', 'YEAR', 1000),
-- æ·±åº¦èµ„æ–™ç‰ˆ
('DEPTH_MONTH', 'æ·±åº¦èµ„æ–™ç‰ˆ-æœˆ', 'DEPTH', 'MONTH', 1000),
('DEPTH_QUARTER', 'æ·±åº¦èµ„æ–™ç‰ˆ-å­£', 'DEPTH', 'QUARTER', 1000),
('DEPTH_YEAR', 'æ·±åº¦èµ„æ–™ç‰ˆ-å¹´', 'DEPTH', 'YEAR', 1000),
-- è¶…çº§æœºæ„ç‰ˆ
('SUPER_MONTH', 'è¶…çº§æœºæ„ç‰ˆ-æœˆ', 'SUPER', 'MONTH', 1000),
('SUPER_QUARTER', 'è¶…çº§æœºæ„ç‰ˆ-å­£', 'SUPER', 'QUARTER', 1000),
('SUPER_YEAR', 'è¶…çº§æœºæ„ç‰ˆ-å¹´', 'SUPER', 'YEAR', 1000),
-- æ¶¨åœé€‰è‚¡
('LIMIT_UP_MONTH', 'æ¶¨åœé€‰è‚¡-æœˆ', 'LIMIT_UP', 'MONTH', 1000),
('LIMIT_UP_QUARTER', 'æ¶¨åœé€‰è‚¡-å­£', 'LIMIT_UP', 'QUARTER', 1000),
('LIMIT_UP_YEAR', 'æ¶¨åœé€‰è‚¡-å¹´', 'LIMIT_UP', 'YEAR', 1000),
-- åè½¬ä¿¡å·
('REVERSAL_MONTH', 'åè½¬ä¿¡å·-æœˆ', 'REVERSAL', 'MONTH', 1000),
('REVERSAL_QUARTER', 'åè½¬ä¿¡å·-å­£', 'REVERSAL', 'QUARTER', 1000),
('REVERSAL_YEAR', 'åè½¬ä¿¡å·-å¹´', 'REVERSAL', 'YEAR', 1000);

-- è®¢å•è¡¨ï¼ˆç®€åŒ–ï¼‰
CREATE TABLE `product_order` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®¢å•ID',
  `order_no` VARCHAR(50) NOT NULL UNIQUE COMMENT 'è®¢å•å·',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `status` VARCHAR(20) NOT NULL COMMENT 'è®¢å•çŠ¶æ€',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´'
) ENGINE=INNODB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•è¡¨';

-- è®¢å•æ˜ç»†è¡¨
CREATE TABLE `order_item` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ˜ç»†ID',
  `order_id` BIGINT NOT NULL COMMENT 'è®¢å•ID',
  `product_id` BIGINT NOT NULL COMMENT 'äº§å“ID',
  `product_code` VARCHAR(50) NOT NULL COMMENT 'äº§å“ç¼–ç ',
  `quantity` INT NOT NULL DEFAULT 1 COMMENT 'è´­ä¹°æ•°é‡',
  INDEX `idx_order_id` (`order_id`)
) ENGINE=INNODB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•æ˜ç»†è¡¨';
```

------

## äºŒã€å®ä½“ç±»

```java
package com.windstock.entity;

import lombok.Data;
import java.time.LocalDateTime;

/**
 * äº§å“åº“å­˜å®ä½“
 */
@Data
public class ProductStock {
    private Long id;
    private String productCode;      // äº§å“ç¼–ç 
    private String productName;      // äº§å“åç§°
    private String productType;      // äº§å“ç±»å‹
    private String duration;         // æ—¶é•¿
    private Integer stockQuantity;   // åº“å­˜æ•°é‡
    private Integer version;         // ä¹è§‚é”ç‰ˆæœ¬
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

/**
 * å¥—é¤å•†å“é¡¹ï¼ˆç”¨äºä¸‹å•ï¼‰
 */
@Data
public class PackageItem {
    private String productCode;  // äº§å“ç¼–ç 
    private Integer quantity;    // è´­ä¹°æ•°é‡
    
    public PackageItem(String productCode, Integer quantity) {
        this.productCode = productCode;
        this.quantity = quantity;
    }
}
```

------

## ä¸‰ã€Mapper



### mapperæ¥å£

```java
package com.transactioninsight.foundation.deadlock.order_inventory.mapper;

import com.transactioninsight.foundation.deadlock.order_inventory.model.ProductStock;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * äº§å“åº“å­˜ Mapper
 * æ³¨æ„ï¼šæ‰€æœ‰ SQL å·²è¿ç§»åˆ° XML é…ç½®æ–‡ä»¶
 */
@Mapper
public interface ProductStockMapper {

    /**
     * ã€ä¼šå¯¼è‡´æ­»é”ã€‘æ— åºåŠ é”æŸ¥è¯¢åº“å­˜
     * å®éªŒç›®çš„ï¼šæ¨¡æ‹Ÿæ­»é”åœºæ™¯ï¼ŒæŒ‰ä¼ å…¥é¡ºåºåŠ é”
     * é¢„æœŸç°è±¡ï¼šå¹¶å‘æ—¶å‡ºç° Deadlock found when trying to get lock
     */
    List<ProductStock> selectByCodeForUpdateNoOrder(@Param("code") String code);

    /**
     * ã€è§£å†³æ­»é”ã€‘æœ‰åºåŠ é”æŸ¥è¯¢åº“å­˜
     * å®éªŒç›®çš„ï¼šé€šè¿‡ç»Ÿä¸€åŠ é”é¡ºåºé¿å…æ­»é”
     * é¢„æœŸç°è±¡ï¼šå¹¶å‘æ—¶æŒ‰ä¸»é”®å‡åºæ’é˜Ÿï¼Œä¸ä¼šæ­»é”
     * æ ¸å¿ƒåŸç†ï¼šORDER BY id å¼ºåˆ¶MySQLæŒ‰ä¸»é”®é¡ºåºåŠ è¡Œé”
     */
    List<ProductStock> selectByCodesForUpdateOrdered(@Param("codes") List<String> codes);

    /**
     * æ‰£å‡åº“å­˜ï¼ˆå¸¦åº“å­˜æ ¡éªŒï¼‰
     * æ³¨æ„ï¼šæ­¤æ–¹æ³•å¿…é¡»åœ¨å·²åŠ è¡Œé”åè°ƒç”¨
     *
     * @return å½±å“è¡Œæ•°ï¼ˆ0è¡¨ç¤ºåº“å­˜ä¸è¶³æˆ–å•†å“ä¸å­˜åœ¨ï¼‰
     */
    int deductStock(@Param("code") String productCode, @Param("quantity") Integer quantity);

    /**
     * æŸ¥è¯¢å½“å‰åº“å­˜ï¼ˆä¸åŠ é”ï¼Œç”¨äºæµ‹è¯•éªŒè¯ï¼‰
     *
     * @return åº“å­˜æ•°é‡ï¼Œnullè¡¨ç¤ºå•†å“ä¸å­˜åœ¨
     */
    Integer getStock(@Param("code") String productCode);

    /**
     * é‡ç½®åº“å­˜ï¼ˆæµ‹è¯•ç”¨ï¼‰
     */
    void resetStock(@Param("code") String productCode, @Param("quantity") Integer quantity);
}
```





### Mapper.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.transactioninsight.foundation.deadlock.order_inventory.mapper.ProductStockMapper">

    <!-- ===================== ResultMap å®šä¹‰ ===================== -->

    <!--
        ProductStock å®Œæ•´å­—æ®µæ˜ å°„
        è§£å†³ä¸‹åˆ’çº¿å‘½å â†’ é©¼å³°å‘½åçš„æ˜ å°„é—®é¢˜
    -->
    <resultMap id="ProductStockMap" type="com.transactioninsight.foundation.deadlock.order_inventory.model.ProductStock">
        <id property="id" column="id"/>
        <result property="productCode" column="product_code"/>
        <result property="productName" column="product_name"/>
        <result property="productType" column="product_type"/>
        <result property="duration" column="duration"/>
        <result property="stockQuantity" column="stock_quantity"/>
        <result property="version" column="version"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- ===================== æŸ¥è¯¢æ–¹æ³• ===================== -->

    <!--
        ã€ä¼šå¯¼è‡´æ­»é”ã€‘æ— åºåŠ é”æŸ¥è¯¢åº“å­˜
        å®éªŒç›®çš„ï¼šæ¨¡æ‹Ÿæ­»é”åœºæ™¯ï¼ŒæŒ‰ä¼ å…¥é¡ºåºåŠ é”
        é¢„æœŸç°è±¡ï¼šå¹¶å‘æ—¶å‡ºç° Deadlock found when trying to get lock

        æ­»é”åŸç†ï¼š
        - äº‹åŠ¡Aï¼šæŒ‰ [PRO_MONTH, LIMIT_UP_MONTH] é¡ºåºåŠ é”
        - äº‹åŠ¡Bï¼šæŒ‰ [LIMIT_UP_MONTH, PRO_MONTH] é¡ºåºåŠ é”
        - å½¢æˆå¾ªç¯ç­‰å¾… â†’ æ­»é”
    -->
    <select id="selectByCodesForUpdateNoOrder" resultMap="ProductStockMap">
        SELECT
        id,
        product_code,
        product_name,
        product_type,
        duration,
        stock_quantity,
        version,
        created_at,
        updated_at
        FROM product_stock
        WHERE product_code = #{code}
        FOR UPDATE
        <!-- æ³¨æ„ï¼šæ²¡æœ‰ ORDER BYï¼ŒMySQL æŒ‰æŸ¥æ‰¾åˆ°çš„é¡ºåºåŠ é”ï¼ˆä¸ç¡®å®šæ€§ï¼‰ -->
    </select>

    <!--
        ã€è§£å†³æ­»é”ã€‘æœ‰åºåŠ é”æŸ¥è¯¢åº“å­˜
        å®éªŒç›®çš„ï¼šé€šè¿‡ç»Ÿä¸€åŠ é”é¡ºåºé¿å…æ­»é”
        é¢„æœŸç°è±¡ï¼šå¹¶å‘æ—¶æŒ‰ä¸»é”®å‡åºæ’é˜Ÿï¼Œä¸ä¼šæ­»é”

        æ ¸å¿ƒåŸç†ï¼š
        - ORDER BY id ASC å¼ºåˆ¶æ‰€æœ‰äº‹åŠ¡æŒ‰ç›¸åŒé¡ºåºåŠ é”
        - æ‰“ç ´å¾ªç¯ç­‰å¾…æ¡ä»¶
        - äº‹åŠ¡åªèƒ½ä¸²è¡Œç­‰å¾…ï¼Œæ— æ³•å½¢æˆæ­»é”ç¯
    -->
    <!--å³ä½¿æ²¡æœ‰ ORDER BYï¼ŒInnoDB ä¹Ÿä¼šæŒ‰ç…§ç´¢å¼•é¡ºåºï¼ˆé€šå¸¸æ˜¯ä¸»é”® ASCï¼‰åŠ é”ã€‚å†™ ASC ä¸ä¸å†™ ASCï¼Œæœ¬è´¨ä¸Šä¸å½±å“åŠ é”é¡ºåºï¼ˆå‰ææ˜¯ä½¿ç”¨ç´¢å¼•ï¼‰-->
    <select id="selectByCodesForUpdateOrdered" resultMap="ProductStockMap">
        SELECT
        id,
        product_code,
        product_name,
        product_type,
        duration,
        stock_quantity,
        version,
        created_at,
        updated_at
        FROM product_stock
        WHERE product_code IN
        <foreach collection="codes" item="code" open="(" separator="," close=")">
            #{code}
        </foreach>
        ORDER BY id ASC  <!-- ğŸ”‘ å…³é”®ï¼šå¼ºåˆ¶æŒ‰ä¸»é”®å‡åºåŠ é” -->
        FOR UPDATE
    </select>

    <!--
        æŸ¥è¯¢å½“å‰åº“å­˜ï¼ˆä¸åŠ é”ï¼‰
        ç”¨é€”ï¼šæµ‹è¯•éªŒè¯åº“å­˜æ‰£å‡æ˜¯å¦æ­£ç¡®
    -->
    <select id="getStock" resultType="java.lang.Integer">
        SELECT stock_quantity
        FROM product_stock
        WHERE product_code = #{code}
    </select>

    <!-- ===================== æ›´æ–°æ–¹æ³• ===================== -->

    <!--
        æ‰£å‡åº“å­˜ï¼ˆå¸¦åº“å­˜æ ¡éªŒï¼‰
        æ³¨æ„ï¼šæ­¤æ–¹æ³•å¿…é¡»åœ¨å·²åŠ è¡Œé”ï¼ˆFOR UPDATEï¼‰åè°ƒç”¨

        ä¹è§‚é”åŸç†ï¼š
        - WHERE æ¡ä»¶åŒ…å« stock_quantity >= #{quantity}
        - å¦‚æœåº“å­˜ä¸è¶³ï¼Œupdate è¿”å› 0ï¼ˆå½±å“è¡Œæ•°ï¼‰
        - ä¸šåŠ¡å±‚æ£€æŸ¥è¿”å›å€¼åˆ¤æ–­æ˜¯å¦æ‰£å‡æˆåŠŸ
    -->
    <update id="deductStock">
        UPDATE product_stock
        SET stock_quantity = stock_quantity - #{quantity}
        WHERE product_code = #{code}
          AND stock_quantity >= #{quantity}
    </update>

    <!--
        é‡ç½®åº“å­˜ï¼ˆæµ‹è¯•ç”¨ï¼‰
        ç”¨é€”ï¼šåœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹å‰é‡ç½®æ•°æ®
    -->
    <update id="resetStock">
        UPDATE product_stock
        SET stock_quantity = #{quantity}
        WHERE product_code = #{code}
    </update>

</mapper>
```







------

## å››ã€æœåŠ¡å±‚

```java
package com.transactioninsight.foundation.deadlock.order_inventory.service;


import com.transactioninsight.foundation.deadlock.order_inventory.mapper.ProductStockMapper;
import com.transactioninsight.foundation.deadlock.order_inventory.model.PackageItem;
import com.transactioninsight.foundation.deadlock.order_inventory.model.ProductStock;
import jakarta.annotation.Resource;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Slf4j
@Service
public class OrderService {

    @Resource
    private ProductStockMapper stockMapper;

    /**
     * ã€é”™è¯¯ç¤ºèŒƒã€‘ä¸æ’åºç›´æ¥åŠ é” - ä¼šå¯¼è‡´æ­»é”
     * ä¸»é”®æ˜¯é€’å¢èšç°‡ç´¢å¼• â†’ MySQL ä¼šæŒ‰ä¸»é”®å‡åºåŠ é” â†’ å³ä½¿ä½ ä¸æ’åºä¹Ÿä¸ä¼šæ­»é”
     * <p>
     * å®éªŒç›®çš„ï¼š
     * æ¨¡æ‹ŸçœŸå®æ­»é”åœºæ™¯ï¼Œä¸¤ä¸ªäº‹åŠ¡ä»¥ä¸åŒé¡ºåºé”ç›¸åŒèµ„æº
     * <p>
     * æ­»é”åŸå› ï¼š
     * äº‹åŠ¡Aï¼šé”PRO_MONTH â†’ ç­‰å¾…LIMIT_UP_MONTH
     * äº‹åŠ¡Bï¼šé”LIMIT_UP_MONTH â†’ ç­‰å¾…PRO_MONTH
     * <p>
     * é¢„æœŸç°è±¡ï¼š
     * å¹¶å‘æ‰§è¡Œæ—¶MySQLæ£€æµ‹åˆ°æ­»é”ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š
     * Deadlock found when trying to get lock; try restarting transaction
     */
    @Transactional(rollbackFor = Exception.class)
    public void createOrderWithDeadlock(Long userId, List<PackageItem> items) {
        log.info("[æ­»é”æµ‹è¯•] ç”¨æˆ·{}å¼€å§‹ä¸‹å•ï¼Œå•†å“ï¼š{}", userId, items);

        // 1. æå–äº§å“ç¼–ç ï¼ˆä¸æ’åºï¼ï¼‰
        List<String> productCodes = items.stream()
                .map(PackageItem::getProductCode)
                .collect(Collectors.toList());

        // 2. æŒ‰ä¼ å…¥é¡ºåºåŠ é”ï¼ˆå±é™©æ“ä½œï¼ï¼‰
        List<ProductStock> result = new ArrayList<>();
        for (String code : productCodes) {
            //todo å› ä¸»é”®idæ˜¯é€’å¢ç´¢å¼•ï¼Œæ‰€ä»¥MySQLå³ä¾¿ä¸æ’åºä¹Ÿä¼šåŠ é€’å¢åŠ é”ï¼Œä¸ä¼šé€ æˆæ­»é”ï¼Œæ•…æ­¤åœ¨æ­¤æ¯æ¬¡éƒ½éšæœºæŸ¥è¯¢ä¸€ä¸ªä»»æ„å…¶ä¸­ä¸€ä¸ªcodeï¼Œä¸åŒçº¿ç¨‹åŠ é”é¡ºåºä¸ä¸€è‡´å¶ç°æ­»é”
            List<ProductStock> productStockList = stockMapper.selectByCodeForUpdateNoOrder(code);
            result.addAll(productStockList);
        }
        log.info("[æ­»é”æµ‹è¯•] ç”¨æˆ·{}å·²é”å®šï¼š{}", userId, productCodes);

        // 3. æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†å»¶è¿Ÿï¼ˆæ”¾å¤§æ­»é”æ¦‚ç‡ï¼‰
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }

        // 4. æ ¡éªŒå¹¶æ‰£å‡åº“å­˜
        Map<String, ProductStock> stockMap = result.stream()
                .collect(Collectors.toMap(ProductStock::getProductCode, s -> s));

        for (PackageItem item : items) {
            ProductStock stock = stockMap.get(item.getProductCode());
            if (stock.getStockQuantity() < item.getQuantity()) {
                throw new RuntimeException("åº“å­˜ä¸è¶³ï¼š" + stock.getProductName());
            }
            int updated = stockMapper.deductStock(item.getProductCode(), item.getQuantity());
            if (updated == 0) {
                throw new RuntimeException("æ‰£å‡åº“å­˜å¤±è´¥ï¼š" + stock.getProductName());
            }
        }

        log.info("[æ­»é”æµ‹è¯•] ç”¨æˆ·{}è®¢å•å®Œæˆ", userId);
    }

    /**
     * ã€æ­£ç¡®å®ç°ã€‘æ’åºååŠ é” - é¿å…æ­»é”
     * <p>
     * å®éªŒç›®çš„ï¼š
     * é€šè¿‡ç»Ÿä¸€åŠ é”é¡ºåºæ‰“ç ´å¾ªç¯ç­‰å¾…æ¡ä»¶
     * <p>
     * æ ¸å¿ƒåŸç†ï¼š
     * æ‰€æœ‰äº‹åŠ¡æŒ‰ product_stock.id å‡åºåŠ é”
     * â†’ äº‹åŠ¡Aï¼šç­‰å¾…id=5 â†’ è·å–id=10
     * â†’ äº‹åŠ¡Bï¼šç­‰å¾…id=5ï¼ˆæ’é˜Ÿï¼‰
     * â†’ ä¸å­˜åœ¨ç›¸äº’ç­‰å¾…ï¼Œæ— æ³•å½¢æˆæ­»é”ç¯
     * <p>
     * é¢„æœŸç°è±¡ï¼š
     * é«˜å¹¶å‘ä¸‹äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œä¸ä¼šæ­»é”
     */
    @Transactional(rollbackFor = Exception.class)
    public void createOrderSafely(Long userId, List<PackageItem> items) {
        log.info("[å®‰å…¨ä¸‹å•] ç”¨æˆ·{}å¼€å§‹ä¸‹å•ï¼Œå•†å“ï¼š{}", userId, items);

        // 1. æå–äº§å“ç¼–ç å¹¶æ’åºï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
        // æ³¨æ„ï¼šè¿™é‡Œæ’åºçš„æ˜¯productCodeï¼Œä½†SQLä¸­ORDER BY id
        // MySQLä¼šæ ¹æ®WHERE INçš„ç»“æœæŒ‰idæ’åºåŠ é”
        List<String> productCodes = items.stream()
                .map(PackageItem::getProductCode)
                .sorted()  // å…ˆå¯¹ä¸šåŠ¡å‚æ•°æ’åºä¿è¯ä¸€è‡´æ€§
                .collect(Collectors.toList());

        // 2. æŒ‰ä¸»é”®é¡ºåºåŠ é”ï¼ˆSQLä¸­çš„ORDER BY idç”Ÿæ•ˆï¼‰
        List<ProductStock> stocks = stockMapper.selectByCodesForUpdateOrdered(productCodes);
        log.info("[å®‰å…¨ä¸‹å•] ç”¨æˆ·{}å·²æŒ‰åºé”å®šï¼š{}", userId,
                stocks.stream().map(ProductStock::getId).collect(Collectors.toList()));

        // 3. æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†å»¶è¿Ÿ
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }

        // 4. æ ¡éªŒå¹¶æ‰£å‡åº“å­˜
        Map<String, ProductStock> stockMap = stocks.stream()
                .collect(Collectors.toMap(ProductStock::getProductCode, s -> s));

        for (PackageItem item : items) {
            ProductStock stock = stockMap.get(item.getProductCode());
            if (stock.getStockQuantity() < item.getQuantity()) {
                throw new RuntimeException("åº“å­˜ä¸è¶³ï¼š" + stock.getProductName());
            }
            int updated = stockMapper.deductStock(item.getProductCode(), item.getQuantity());
            if (updated == 0) {
                throw new RuntimeException("æ‰£å‡åº“å­˜å¤±è´¥ï¼š" + stock.getProductName());
            }
        }

        log.info("[å®‰å…¨ä¸‹å•] ç”¨æˆ·{}è®¢å•å®Œæˆ", userId);
    }
}
```

------

## äº”ã€æ­»é”å¤ç°æµ‹è¯•ç±»

```java
package com.windstock.test;

import com.windstock.entity.PackageItem;
import com.windstock.mapper.ProductStockMapper;
import com.windstock.service.OrderService;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import javax.annotation.Resource;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * æ­»é”åœºæ™¯å¤ç°æµ‹è¯•
 * 
 * æµ‹è¯•åœºæ™¯ï¼š
 * 100ä¸ªç”¨æˆ·å¹¶å‘è´­ä¹°"ä¸“ä¸šè¡Œæƒ…ç‰ˆå¥—é¤"ï¼ˆåŒ…å«PRO_MONTH + LIMIT_UP_MONTHï¼‰
 * 
 * æ­»é”åŸç†ï¼š
 * çº¿ç¨‹å¥‡æ•°ï¼šå…ˆé”PRO_MONTH(id=1) â†’ å†é”LIMIT_UP_MONTH(id=10)
 * çº¿ç¨‹å¶æ•°ï¼šå…ˆé”LIMIT_UP_MONTH(id=10) â†’ å†é”PRO_MONTH(id=1)
 * â†’ å½¢æˆå¾ªç¯ç­‰å¾… â†’ MySQLæ£€æµ‹æ­»é” â†’ å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡
 * 
 * é¢„æœŸç»“æœï¼š
 * âœ… éƒ¨åˆ†çº¿ç¨‹æˆåŠŸ
 * âŒ éƒ¨åˆ†çº¿ç¨‹æŠ›å‡º DeadlockLoserDataAccessException
 * ğŸ“Š æˆåŠŸç‡çº¦50%-80%ï¼ˆå–å†³äºå¹¶å‘æ—¶åºï¼‰
 */
@Slf4j
@SpringBootTest
public class DeadlockReproduceTest {
    
    @Resource
    private OrderService orderService;
    
    @Resource
    private ProductStockMapper stockMapper;
    
    /**
     * æ¯æ¬¡æµ‹è¯•å‰é‡ç½®åº“å­˜
     */
    @BeforeEach
    public void setup() {
        stockMapper.resetStock("PRO_MONTH", 1000);
        stockMapper.resetStock("LIMIT_UP_MONTH", 1000);
        log.info("åº“å­˜å·²é‡ç½®");
    }
    
    /**
     * ã€å¿…ç°æ­»é”ã€‘æ¨¡æ‹Ÿ100ç”¨æˆ·å¹¶å‘è´­ä¹°å¥—é¤
     * 
     * è¿è¡Œå‰å‡†å¤‡ï¼š
     * 1. ç¡®ä¿æ•°æ®åº“å·²åˆ›å»ºå¹¶åˆå§‹åŒ–æ•°æ®
     * 2. è°ƒæ•´æ—¥å¿—çº§åˆ«æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹
     * 
     * è§‚å¯Ÿé‡ç‚¹ï¼š
     * 1. æ—¥å¿—ä¸­çš„åŠ é”é¡ºåº
     * 2. å¼‚å¸¸å †æ ˆä¸­çš„ "Deadlock found"
     * 3. æœ€ç»ˆæˆåŠŸ/å¤±è´¥ç»Ÿè®¡
     */
    @Test
    public void testDeadlockScenario() throws InterruptedException {
        int threadCount = 100;
        ExecutorService executor = Executors.newFixedThreadPool(50);
        CountDownLatch latch = new CountDownLatch(threadCount);
        
        AtomicInteger successCount = new AtomicInteger(0);
        AtomicInteger failCount = new AtomicInteger(0);
        
        log.warn("========== å¼€å§‹æ­»é”å¤ç°æµ‹è¯• ==========");
        
        for (int i = 0; i < threadCount; i++) {
            final long userId = i;
            
            // å…³é”®ï¼šå¥‡å¶ç”¨æˆ·æŒ‰ä¸åŒé¡ºåºä¼ å…¥å•†å“ï¼ˆæ¨¡æ‹ŸçœŸå®éšæœºåœºæ™¯ï¼‰
            List<PackageItem> items = (userId % 2 == 0) 
                ? Arrays.asList(
                    new PackageItem("PRO_MONTH", 1),      // å¶æ•°ç”¨æˆ·ï¼šå…ˆä¸“ä¸šç‰ˆ
                    new PackageItem("LIMIT_UP_MONTH", 1)  // åæ¶¨åœé€‰è‚¡
                  )
                : Arrays.asList(
                    new PackageItem("LIMIT_UP_MONTH", 1), // å¥‡æ•°ç”¨æˆ·ï¼šå…ˆæ¶¨åœé€‰è‚¡
                    new PackageItem("PRO_MONTH", 1)       // åä¸“ä¸šç‰ˆ
                  );
            
            executor.submit(() -> {
                try {
                    orderService.createOrderWithDeadlock(userId, items);
                    successCount.incrementAndGet();
                } catch (Exception e) {
                    failCount.incrementAndGet();
                    if (e.getMessage().contains("Deadlock")) {
                        log.error("ç”¨æˆ·{}é­é‡æ­»é”ï¼š{}", userId, e.getMessage());
                    } else {
                        log.error("ç”¨æˆ·{}ä¸‹å•å¤±è´¥ï¼š{}", userId, e.getMessage());
                    }
                } finally {
                    latch.countDown();
                }
            });
        }
        
        latch.await();
        executor.shutdown();
        
        // éªŒè¯ç»“æœ
        log.warn("========== æµ‹è¯•ç»“æœ ==========");
        log.warn("æˆåŠŸ: {}ç¬”", successCount.get());
        log.warn("å¤±è´¥: {}ç¬” (åŒ…å«æ­»é”)", failCount.get());
        log.warn("PRO_MONTHå‰©ä½™åº“å­˜: {}", stockMapper.getStock("PRO_MONTH"));
        log.warn("LIMIT_UP_MONTHå‰©ä½™åº“å­˜: {}", stockMapper.getStock("LIMIT_UP_MONTH"));
        
        // æ–­è¨€ï¼šå¿…å®šæœ‰æ­»é”å‘ç”Ÿ
        assert failCount.get() > 0 : "é¢„æœŸä¼šå‘ç”Ÿæ­»é”ï¼Œä½†å…¨éƒ¨æˆåŠŸäº†ï¼";
    }
}
```

------

## å…­ã€è§£å†³æ–¹æ¡ˆæµ‹è¯•ç±»

```java
package com.windstock.test;

import com.windstock.entity.PackageItem;
import com.windstock.mapper.ProductStockMapper;
import com.windstock.service.OrderService;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import javax.annotation.Resource;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * é¡ºåºåŠ é”è§£å†³æ­»é”æµ‹è¯•
 * 
 * æµ‹è¯•ç›®æ ‡ï¼š
 * éªŒè¯ORDER BYæ–¹æ¡ˆåœ¨é«˜å¹¶å‘ä¸‹100%æ— æ­»é”
 * 
 * æ ¸å¿ƒæœºåˆ¶ï¼š
 * æ— è®ºä¸šåŠ¡å±‚ä¼ å…¥é¡ºåºå¦‚ä½•ï¼ŒSQLå±‚ç»Ÿä¸€æŒ‰ id ASC åŠ é”
 * â†’ æ‰€æœ‰äº‹åŠ¡æ’é˜Ÿç­‰å¾…ï¼Œä¸ä¼šå½¢æˆå¾ªç¯ä¾èµ–
 * 
 * é¢„æœŸç»“æœï¼š
 * âœ… 100%æˆåŠŸç‡ï¼ˆæ— æ­»é”ï¼‰
 * âœ… åº“å­˜æ‰£å‡å‡†ç¡®
 * âœ… æ€§èƒ½æŸè€—å¯æ§ï¼ˆä»…å¢åŠ æ’åºå¼€é”€ï¼‰
 */
@Slf4j
@SpringBootTest
public class DeadlockSolutionTest {
    
    @Resource
    private OrderService orderService;
    
    @Resource
    private ProductStockMapper stockMapper;
    
    @BeforeEach
    public void setup() {
        stockMapper.resetStock("PRO_MONTH", 1000);
        stockMapper.resetStock("LIMIT_UP_MONTH", 1000);
        log.info("åº“å­˜å·²é‡ç½®");
    }
    
    /**
     * ã€é›¶æ­»é”ã€‘100ç”¨æˆ·å¹¶å‘è´­ä¹° - é¡ºåºåŠ é”æ–¹æ¡ˆ
     * 
     * å¯¹æ¯”å®éªŒï¼š
     * ä¸ DeadlockReproduceTest ä½¿ç”¨ç›¸åŒå¹¶å‘é‡å’Œåœºæ™¯
     * å”¯ä¸€åŒºåˆ«ï¼šä½¿ç”¨ createOrderSafely æ–¹æ³•
     * 
     * éªŒè¯ç‚¹ï¼š
     * 1. æ—  Deadlock å¼‚å¸¸
     * 2. 100ç¬”è®¢å•å…¨éƒ¨æˆåŠŸ
     * 3. åº“å­˜ç²¾ç¡®æ‰£å‡200ï¼ˆæ¯äººä¹°2ä»¶ï¼‰
     */
    @Test
    public void testNoDeadlockWithOrdering() throws InterruptedException {
        int threadCount = 100;
        ExecutorService executor = Executors.newFixedThreadPool(50);
        CountDownLatch latch = new CountDownLatch(threadCount);
        
        AtomicInteger successCount = new AtomicInteger(0);
        AtomicInteger failCount = new AtomicInteger(0);
        
        log.warn("========== å¼€å§‹é¡ºåºåŠ é”æµ‹è¯• ==========");
        
        for (int i = 0; i < threadCount; i++) {
            final long userId = i;
            
            // åŒæ ·éšæœºé¡ºåºä¼ å…¥ï¼ˆä½†SQLå±‚ä¼šç»Ÿä¸€æ’åºï¼‰
            List<PackageItem> items = (userId % 2 == 0) 
                ? Arrays.asList(
                    new PackageItem("PRO_MONTH", 1),
                    new PackageItem("LIMIT_UP_MONTH", 1)
                  )
                : Arrays.asList(
                    new PackageItem("LIMIT_UP_MONTH", 1),
                    new PackageItem("PRO_MONTH", 1)
                  );
            
            executor.submit(() -> {
                try {
                    orderService.createOrderSafely(userId, items);
                    successCount.incrementAndGet();
                } catch (Exception e) {
                    failCount.incrementAndGet();
                    log.error("ç”¨æˆ·{}ä¸‹å•å¼‚å¸¸ï¼š{}", userId, e.getMessage(), e);
                } finally {
                    latch.countDown();
                }
            });
        }
        
        latch.await();
        executor.shutdown();
        
        // éªŒè¯ç»“æœ
        log.warn("========== æµ‹è¯•ç»“æœ ==========");
        log.warn("æˆåŠŸ: {}ç¬”", successCount.get());
        log.warn("å¤±è´¥: {}ç¬”", failCount.get());
        log.warn("PRO_MONTHå‰©ä½™åº“å­˜: {}", stockMapper.getStock("PRO_MONTH"));
        log.warn("LIMIT_UP_MONTHå‰©ä½™åº“å­˜: {}", stockMapper.getStock("LIMIT_UP_MONTH"));
        
        // ä¸¥æ ¼æ–­è¨€
        assert failCount.get() == 0 : "ä¸åº”æœ‰ä»»ä½•å¤±è´¥ï¼";
        assert successCount.get() == threadCount : "å¿…é¡»å…¨éƒ¨æˆåŠŸï¼";
        assert stockMapper.getStock("PRO_MONTH") == 900 : "åº“å­˜æ‰£å‡é”™è¯¯ï¼";
        assert stockMapper.getStock("LIMIT_UP_MONTH") == 900 : "åº“å­˜æ‰£å‡é”™è¯¯ï¼";
        
        log.warn("âœ… æµ‹è¯•é€šè¿‡ï¼šé›¶æ­»é”ï¼Œåº“å­˜å‡†ç¡®ï¼");
    }
}
```

------

## ä¸ƒã€é¢è¯•å›ç­”è¦ç‚¹

**é¢è¯•å®˜ï¼šä¸ºä»€ä¹ˆä¼šæ­»é”ï¼Ÿ**

> ä¸¤ä¸ªäº‹åŠ¡ä»¥ä¸åŒé¡ºåºé”ç›¸åŒè¡Œã€‚ç”¨æˆ·Aå…ˆé”ä¸“ä¸šç‰ˆå†é”æ¶¨åœé€‰è‚¡ï¼Œç”¨æˆ·Båè¿‡æ¥ï¼Œå½¢æˆå¾ªç¯ç­‰å¾…ã€‚

**é¢è¯•å®˜ï¼šORDER BYå¦‚ä½•è§£å†³ï¼Ÿ**

> å¼ºåˆ¶æ‰€æœ‰äº‹åŠ¡æŒ‰ä¸»é”®å‡åºåŠ é”ï¼Œæ‰“ç ´å¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚å³ä½¿ä¸šåŠ¡å±‚é¡ºåºä¸åŒï¼Œæ•°æ®åº“å±‚ä¹Ÿç»Ÿä¸€æ’åºã€‚

**é¢è¯•å®˜ï¼šä¸ºä»€ä¹ˆä¸ç”¨ä¹è§‚é”ï¼Ÿ**

> å¥—é¤åŒ…å«å¤šä¸ªå•†å“ï¼Œéœ€è¦åŸå­æ€§æ‰£å‡ã€‚ä¹è§‚é”åœ¨é«˜å¹¶å‘ä¸‹é‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œæ‚²è§‚é”æ›´ç¨³å®šã€‚

**é¢è¯•å®˜ï¼šæ€§èƒ½å½±å“ï¼Ÿ**

> å†…å­˜æ’åºO(nlogn)å¯å¿½ç•¥ï¼›å…³é”®æ”¶ç›Šæ˜¯é¿å…æ­»é”åçš„äº‹åŠ¡å›æ»šå’Œé‡è¯•å¼€é”€ã€‚