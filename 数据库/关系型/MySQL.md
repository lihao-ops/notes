# MySQL



## åŸºç¡€SQL



### è¡¨ç»“æ„ç¤ºä¾‹

**orders è¡¨**

| å­—æ®µå      | å«ä¹‰     |
| ----------- | -------- |
| id          | è®¢å•ID   |
| user_id     | ç”¨æˆ·ID   |
| amount      | è®¢å•é‡‘é¢ |
| status      | è®¢å•çŠ¶æ€ |
| create_time | ä¸‹å•æ—¶é—´ |

**users è¡¨**

| å­—æ®µå | å«ä¹‰     |
| ------ | -------- |
| id     | ç”¨æˆ·ID   |
| name   | ç”¨æˆ·å§“å |
| age    | ç”¨æˆ·å¹´é¾„ |

------

### 1ï¸âƒ£ èšåˆ + åˆ†ç»„

**é¢˜ç›®**ï¼šç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„æ€»è®¢å•é‡‘é¢

```sql
SELECT user_id, SUM(amount) AS total_amount
FROM orders
GROUP BY user_id;
```

**é¢è¯•ç‚¹**ï¼š

- `SUM(amount)` â†’ èšåˆå‡½æ•°
- `GROUP BY user_id` â†’ æŒ‰ç”¨æˆ·åˆ†ç»„

------

### 2ï¸âƒ£ èšåˆ + HAVING

**é¢˜ç›®**ï¼šç»Ÿè®¡æ€»é‡‘é¢å¤§äº 1000 çš„ç”¨æˆ·

```sql
SELECT user_id, COUNT(id) AS order_count, SUM(amount) AS total_amount
FROM orders
GROUP BY user_id
HAVING SUM(amount) > 1000;
```

**é¢è¯•ç‚¹**ï¼š

- `HAVING` â†’ å¯¹åˆ†ç»„èšåˆåçš„ç»“æœè¿‡æ»¤
- åŒºåˆ« `WHERE`ï¼ˆåˆ†ç»„å‰è¿‡æ»¤ï¼‰

------

### 3ï¸âƒ£ æ’åº + åˆ†é¡µ

**é¢˜ç›®**ï¼šæŸ¥è¯¢é‡‘é¢æœ€é«˜çš„å‰ 5 æ¡è®¢å•

```sql
SELECT *
FROM orders
ORDER BY amount DESC
LIMIT 5;
```

**é¢è¯•ç‚¹**ï¼š

- `ORDER BY` â†’ æ’åº
- `LIMIT` â†’ åˆ†é¡µ/é™åˆ¶ç»“æœæ•°

**è¿›é˜¶**ï¼š

```sql
-- æŸ¥è¯¢ç¬¬2é¡µï¼Œæ¯é¡µ10æ¡
SELECT *
FROM orders
ORDER BY create_time DESC
LIMIT 10 OFFSET 10;
```

------

### 4ï¸âƒ£ å¤šè¡¨å…³è”æŸ¥è¯¢

**é¢˜ç›®**ï¼šæŸ¥è¯¢å·²æ”¯ä»˜è®¢å•å¯¹åº”çš„ç”¨æˆ·å§“å

```sql
SELECT o.id, o.amount, u.name
FROM users u
INNER JOIN orders o ON u.id = o.user_id
WHERE o.status = 'PAID';
```

**é¢è¯•ç‚¹**ï¼š

- `INNER JOIN` â†’ åªè¿”å›æœ‰å¯¹åº”è®¢å•çš„ç”¨æˆ·
- `ON u.id = o.user_id` â†’ å…³è”æ¡ä»¶
- `WHERE` â†’ è¿‡æ»¤è®¢å•çŠ¶æ€

------

### 5ï¸âƒ£ ç»¼åˆé¢˜ï¼ˆæ—¶é—´ + èšåˆ + æ’åº + é™åˆ¶ï¼‰

**é¢˜ç›®**ï¼šæŸ¥è¯¢è¿‘ 30 å¤©ä¸‹å•é‡‘é¢æœ€é«˜çš„ 3 ä¸ªç”¨æˆ·

```sql
SELECT user_id, SUM(amount) AS total_amount
FROM orders
WHERE create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY user_id
ORDER BY total_amount DESC
LIMIT 3;
```

**é¢è¯•ç‚¹**ï¼š

- `WHERE` â†’ æ—¶é—´èŒƒå›´ç­›é€‰
- `GROUP BY` â†’ ç”¨æˆ·èšåˆ
- `ORDER BY total_amount DESC` â†’ æŒ‰æ€»é‡‘é¢æ’åº
- `LIMIT 3` â†’ å–å‰ 3 æ¡
- å¯åŠ  `status = 'PAID'` â†’ åªç»Ÿè®¡å·²æ”¯ä»˜è®¢å•

------

ğŸ’¡ **é¢è¯•åŠ åˆ†å°æŠ€å·§**ï¼š

1. å¤šèšåˆå‡½æ•°å¯ä»¥ä¸€èµ·ä½¿ç”¨ï¼ˆSUM + COUNT + AVGï¼‰
2. `HAVING` ç”¨äºèšåˆç»“æœè¿‡æ»¤
3. å¤šè¡¨å…³è”æ—¶æ³¨æ„ä¸€å¯¹å¤šå…³ç³»ï¼ŒINNER JOIN vs LEFT JOIN çš„åŒºåˆ«
4. æ—¶é—´èŒƒå›´æŸ¥è¯¢ç”¨ `DATE_SUB(NOW(), INTERVAL X DAY)`ï¼Œæ¯”å†™æ­»æ—¥æœŸæ›´é€šç”¨





## äº‹åŠ¡

```text
MySQL äº‹åŠ¡
â”œâ”€ äº‹åŠ¡æ¦‚å¿µ
â”‚   â”œâ”€ å®šä¹‰ï¼šä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
â”‚   â””â”€ ACID ç‰¹æ€§
â”‚       â”œâ”€ Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šå…¨æˆåŠŸæˆ–å…¨å›æ»š
â”‚       â”œâ”€ Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡å‰åæ•°æ®ä¸€è‡´
â”‚       â”œâ”€ Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šäº‹åŠ¡äº’ä¸å¹²æ‰°
â”‚       â””â”€ Durabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šæäº¤åæ•°æ®æ°¸ä¹…ä¿å­˜
â”‚
â”œâ”€ äº‹åŠ¡éš”ç¦»çº§åˆ«
â”‚   â”œâ”€ è¯»æœªæäº¤ï¼ˆRUï¼‰        â†’ è„è¯»/ä¸å¯é‡å¤è¯»/å¹»è¯»éƒ½å¯èƒ½
â”‚   â”œâ”€ è¯»å·²æäº¤ï¼ˆRCï¼‰        â†’ é¿å…è„è¯»ï¼Œå¯èƒ½æœ‰ä¸å¯é‡å¤è¯»/å¹»è¯»
â”‚   â”œâ”€ å¯é‡å¤è¯»ï¼ˆRRï¼‰        â†’ é¿å…è„è¯»/ä¸å¯é‡å¤è¯»ï¼Œé»˜è®¤çº§åˆ«
â”‚   â””â”€ ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰â†’ å®Œå…¨éš”ç¦»ï¼Œæ€§èƒ½å·®
â”‚
â”œâ”€ å¹»è¯» & MVCC
â”‚   â”œâ”€ å¹»è¯»ï¼šåŒä¸€äº‹åŠ¡é‡å¤æŸ¥è¯¢èŒƒå›´ç»“æœå‡ºç°æ–°è¡Œ
â”‚   â”œâ”€ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰
â”‚   â”‚   â”œâ”€ åŸç†ï¼šæ¯è¡Œæ•°æ®ç»´æŠ¤éšè—å­—æ®µ trx_id + roll_pointer
â”‚   â”‚   â”œâ”€ è¯»æ“ä½œï¼šè¯»å–äº‹åŠ¡å¼€å§‹æ—¶çš„å¿«ç…§ï¼ˆReadViewï¼‰
â”‚   â”‚   â””â”€ å†™æ“ä½œï¼šåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œé¿å…é˜»å¡è¯»
â”‚   â””â”€ ä¼˜åŠ¿ï¼š
â”‚       â”œâ”€ è¯»ä¸åŠ é” â†’ é«˜å¹¶å‘
â”‚       â””â”€ éš”ç¦»çº§åˆ«å¯æ§ï¼Œé¿å…è„è¯»/ä¸å¯é‡å¤è¯»
â”‚
â””â”€ é¢è¯•é‡ç‚¹
    â”œâ”€ å››å¤§éš”ç¦»çº§åˆ«åŒºåˆ«
    â”œâ”€ å¹»è¯»æ˜¯ä»€ä¹ˆï¼ŒMVCC å¦‚ä½•é¿å…
    â””â”€ é‡‘èä¸šåŠ¡åœºæ™¯åº”ç”¨ï¼ˆèµ„é‡‘æ“ä½œã€æµæ°´è¡¨ä¸€è‡´æ€§ï¼‰
```



### è¯„åˆ†ï¼ˆæ»¡åˆ†100ï¼‰

**85 / 100**ã€‚
 ä¼˜ç‚¹ï¼šè„è¯» / è¯»å·²æäº¤ / ä¸²è¡ŒåŒ– ç­‰åŸºæœ¬æ¦‚å¿µæŠ“ä½äº†ï¼Œæåˆ°äº† InnoDB çš„ MVCC å’Œé—´éš™é”ã€‚
 ä¸è¶³ï¼šå¯¹ **å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰** å’Œ **å¹»è¯»ï¼ˆphantomï¼‰** çš„æè¿°æ··æ·†â€”â€”æ²¡æŠŠâ€œMVCC çš„å¿«ç…§è¡Œä¸ºâ€å’Œâ€œé—´éš™/next-key é”åœ¨å†™æ“ä½œæ—¶é˜²å¹»è¯»â€çš„èŒè´£åˆ†æ¸…ï¼›ç¤ºä¾‹ä¸å¤Ÿç²¾ç¡®ã€‚ä¸‹é¢ç›´æ¥ç»™ä½ èƒ½èƒŒçš„â€œå‹ç¼©ç‰ˆâ€ï¼Œå†ç»™å¿…è¦çš„çº æ­£ä¸è¡¥å……ç‚¹ã€‚

#### æœ€ç»ˆ â€” ç›´æ¥èƒŒè¯µçš„ä¸€æ®µç®€æ´è¡¨è¿°ï¼ˆé¢è¯•å¯ç›´æ¥è¯´ï¼‰

> MySQLï¼ˆInnoDBï¼‰æœ‰å››ä¸ªæ ‡å‡†éš”ç¦»çº§åˆ«ï¼š
>  **READ UNCOMMITTED** å…è®¸è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼›
>  **READ COMMITTED** é˜²æ­¢è„è¯»ï¼Œä½†å…è®¸ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼ˆæ¯æ¡è¯­å¥çœ‹åˆ°æœ€æ–°å·²æäº¤æ•°æ®ï¼‰ï¼›
>  **REPEATABLE READ**ï¼ˆInnoDB é»˜è®¤ï¼‰é€šè¿‡**äº‹åŠ¡å¿«ç…§ï¼ˆMVCCï¼‰**ä¿è¯åŒä¸€äº‹åŠ¡ä¸­æ™®é€š SELECT çš„å¯é‡å¤è¯»ï¼ˆä¸ä¼šçœ‹åˆ°åç»­äº‹åŠ¡æäº¤çš„æ–°è¡Œï¼‰ï¼Œå¹¶ä¸”å¯¹äºå†™æ“ä½œï¼ˆUPDATE/DELETE/INSERT çš„èŒƒå›´ï¼‰ä½¿ç”¨ **next-key / é—´éš™é”** é˜²æ­¢å¹»è¯»ï¼›
>  **SERIALIZABLE** æœ€ä¸¥æ ¼ï¼Œæ™®é€š SELECT é€€åŒ–ä¸ºåŠ é”è¯»å–ï¼Œé¿å…æ‰€æœ‰å¹¶å‘å¼‚å¸¸ä½†å¹¶å‘æ€§èƒ½æœ€å·®ã€‚
>  InnoDB çš„ MVCC é  undo log å’Œ read view å®ç°ï¼šREPEATABLE READ åœ¨äº‹åŠ¡å¼€å§‹å»ºç«‹å¿«ç…§ï¼ˆstatement vs transaction çš„å·®å¼‚æ˜¯ç†è§£å…³é”®ï¼‰ï¼›è¦ä¿®æ”¹å¹¶å‘è¡Œä¸ºç”¨ `SELECT ... FOR UPDATE`ã€æ˜¾å¼äº‹åŠ¡è¾¹ç•Œæˆ–æ”¹éš”ç¦»çº§åˆ«ã€‚

#### å¿…è¦çš„çº æ­£ä¸è¡¥å……ï¼ˆç®€æ´è¦ç‚¹ï¼‰

1. **ä¸‰ç§å¹¶å‘å¼‚å¸¸ï¼ˆå®šä¹‰ã€ç¤ºä¾‹ï¼‰**
   - **è„è¯»ï¼ˆDirty readï¼‰**ï¼šè¯»åˆ°åˆ«çš„äº‹åŠ¡æœªæäº¤çš„ä¿®æ”¹ã€‚
      ç¤ºä¾‹ï¼šT1 ä¿®æ”¹ä½†æœªæäº¤ â†’ T2 è¯»åˆ°è¯¥å€¼ â†’ è‹¥ T1 å›æ»šï¼Œåˆ™ T2 è¯»çš„æ˜¯â€œè„â€æ•°æ®ã€‚
   - **ä¸å¯é‡å¤è¯»ï¼ˆNon-repeatable readï¼‰**ï¼šåŒä¸€äº‹åŠ¡ä¸¤æ¬¡è¯»åŒä¸€è¡Œå¾—åˆ°ä¸åŒå€¼ï¼ˆä¸­é—´è¢«ä»–äººæäº¤ä¿®æ”¹ï¼‰ã€‚
      ç¤ºä¾‹ï¼šT1 SELECT vï¼›T2 UPDATE v å¹¶ COMMITï¼›T1 å† SELECT vï¼Œå€¼å˜äº†ã€‚
   - **å¹»è¯»ï¼ˆPhantomï¼‰**ï¼šåŒä¸€äº‹åŠ¡ä¸¤æ¬¡åšç›¸åŒèŒƒå›´æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡å¤šå‡º/å°‘äº†è¡Œï¼ˆä¸æ˜¯å•è¡Œå€¼å˜åŒ–ï¼Œè€Œæ˜¯è¡Œçš„â€œå‡ºç°/æ¶ˆå¤±â€ï¼‰ã€‚
      ç¤ºä¾‹ï¼šT1 `SELECT COUNT(*) FROM t WHERE cond` = 3ï¼›T2 æ’å…¥ä¸€æ¡æ»¡è¶³ cond çš„è®°å½•å¹¶ COMMITï¼›T1 å† COUNT å˜æˆ 4ã€‚
2. **å„éš”ç¦»çº§åˆ«èƒ½/ä¸èƒ½é˜²æ­¢ä»€ä¹ˆï¼ˆä¸€ç›®äº†ç„¶ï¼‰**
   - **READ UNCOMMITTED**ï¼šå…è®¸ è„è¯» / ä¸å¯é‡å¤ / å¹»è¯»ã€‚
   - **READ COMMITTED**ï¼šé˜»æ­¢ è„è¯»ï¼›å…è®¸ ä¸å¯é‡å¤ åŠ å¹»è¯»ï¼ˆå› ä¸ºæ¯ä¸ªè¯­å¥æœ‰æ–°çš„ read viewï¼‰ã€‚
   - **REPEATABLE READï¼ˆInnoDBï¼‰**ï¼šé˜»æ­¢ è„è¯» å’Œ ä¸å¯é‡å¤è¯»ï¼›**ç»“åˆ MVCC çš„äº‹åŠ¡å¿«ç…§**ä½¿æ™®é€š SELECT åœ¨åŒä¸€äº‹åŠ¡é‡Œå¯é‡å¤ï¼›å¯¹å†™å¼•èµ·çš„å¹»è¯»ï¼ŒInnoDB é€šè¿‡ **next-keyï¼ˆè®°å½•é”ï¼‹é—´éš™é”ï¼‰** åœ¨èŒƒå›´å†™æ“ä½œæ—¶é˜»æ­¢å…¶å®ƒäº‹åŠ¡æ’å…¥ï¼Œä»è€Œé¿å…å¹»è¯»ã€‚
   - **SERIALIZABLE**ï¼šé˜»æ­¢æ‰€æœ‰ä¸Šè¿°å¼‚å¸¸ï¼Œä½†å¹¶å‘ä»£ä»·æœ€å¤§ã€‚
3. **MVCC çš„å…³é”®ç‚¹ï¼ˆä¸è¦è¯´é”™ï¼‰**
   - å†™æ“ä½œåœ¨è¡Œä¸Šåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬ä¿å­˜åœ¨ **undo log**ã€‚
   - **Read viewï¼ˆå¿«ç…§ï¼‰** å†³å®šå“ªäº›ç‰ˆæœ¬å¯¹å½“å‰è¯»å–å¯è§ï¼š
     - åœ¨ **REPEATABLE READ** ä¸‹ï¼Œäº‹åŠ¡å¼€å§‹æ—¶å»ºç«‹ä¸€æ¬¡å¿«ç…§ â†’ åŒä¸€äº‹åŠ¡å†…é‡å¤ SELECT çœ‹åˆ°ç›¸åŒå¿«ç…§ï¼ˆä¸ä¼šçœ‹åˆ°éšåäº‹åŠ¡æäº¤çš„æ–°è¡Œï¼‰ã€‚
     - åœ¨ **READ COMMITTED** ä¸‹ï¼Œread view æ˜¯**æ¯ä¸ªè¯­å¥**éƒ½ä¼šé‡å»º â†’ åŒä¸€äº‹åŠ¡çš„ä¸åŒè¯­å¥å¯èƒ½çœ‹åˆ°åˆ«çš„äº‹åŠ¡å·²æäº¤çš„æ•°æ®ï¼ˆå¯¼è‡´ä¸å¯é‡å¤è¯»/å¹»è¯»ï¼‰ã€‚
4. **é—´éš™é” / next-key é”ï¼ˆç®€æ´ç‰ˆï¼‰**
   - **next-key lock = record lock + gap lock**ï¼Œç”¨äºèŒƒå›´æ‰«æçš„å†™æ“ä½œï¼ˆå¦‚ UPDATE/DELETEã€SELECT ... FOR UPDATEï¼‰ä»¥é˜»æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¯¥èŒƒå›´æ’å…¥ï¼Œä»è€Œé¿å…å¹»è¯»ã€‚
   - æ³¨æ„ï¼šæŸäº›æ“ä½œ/ç´¢å¼•æƒ…å†µä¸‹ InnoDB å¯èƒ½åªç”¨è®°å½•é”æˆ–æ’å…¥æ„å‘é”ï¼ˆä¾‹å¦‚ç²¾ç¡®å”¯ä¸€ç´¢å¼•æŸ¥æ‰¾ï¼‰ï¼Œä¼šå½±å“æ˜¯å¦åŠ  gap é” â€”â€” ç»†èŠ‚ä¼šå½±å“å¹¶å‘ä¸æ­»é”æ¦‚ç‡ã€‚
5. **å¸¸ç”¨å‘½ä»¤ï¼ˆå¿«é€Ÿè®°ï¼‰**

```
-- æŸ¥çœ‹å½“å‰ï¼ˆç°ä»£ MySQLï¼‰
SELECT @@transaction_isolation;

-- è®¾ç½®ï¼ˆå½“å‰ä¼šè¯ï¼‰
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
-- æˆ–ä»…å¯¹ä¸‹ä¸€äº‹åŠ¡
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

-- å…¨å±€ï¼ˆéœ€æ³¨æ„å½±å“æ‰€æœ‰æ–°è¿æ¥ï¼‰
SET GLOBAL TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

1. **å®è·µå»ºè®®ï¼ˆé¢è¯•ç­”é¢˜/å·¥ç¨‹å®è·µè¦ç‚¹ï¼‰**
   - ç”Ÿäº§é»˜è®¤ **REPEATABLE READ**ï¼ˆInnoDBï¼‰é€šå¸¸å®‰å…¨ï¼›é«˜å¹¶å‘å†™åœºæ™¯å¯è€ƒè™‘ **READ COMMITTED** æ¥å‡å°‘é”äº‰ç”¨ï¼Œä½†è¦æ¥å—ä¸å¯é‡å¤è¯»çš„é£é™©ã€‚
   - å¯¹å…³é”®æ›´æ–°ä½¿ç”¨ **SELECT ... FOR UPDATE** æˆ–æ˜¾å¼æ‚²è§‚é”ï¼›å¯¹å¹¶å‘æ’å…¥/å»é‡ä½¿ç”¨å”¯ä¸€ç´¢å¼• + å¤„ç†é‡å¤é”®ã€‚
   - é¿å…é•¿äº‹åŠ¡ï¼ˆä¼šå¯¼è‡´ undo å¤§ã€é˜»å¡ purgeã€å¢åŠ å›æ»šæ®µå’Œæ­»é”æ¦‚ç‡ï¼‰ã€‚
   - è‹¥çœŸè¦ç»å¯¹å¼ºä¸€è‡´ï¼ˆå†™å¤šã€è¯»å°‘çš„åœºæ™¯ï¼‰ï¼Œç”¨ **SERIALIZABLE** æˆ–å¤–éƒ¨ä¹è§‚/æ‚²è§‚æ§åˆ¶ã€‚

#### é€ŸæŸ¥ checklistï¼ˆä½ å–œæ¬¢çš„æ‰“å‹¾å½¢å¼ï¼‰

-  èƒ½å®šä¹‰è„è¯» / ä¸å¯é‡å¤è¯» / å¹»è¯»ï¼Œå¹¶ç”¨ SQL æ­¥éª¤ä¸¾ä¾‹è¯´æ˜ã€‚
-  èƒ½è¯´æ˜å„éš”ç¦»çº§åˆ«å…è®¸/é˜»æ­¢å“ªå‡ ç§å¼‚å¸¸ï¼ˆè¡¨æ ¼è®°ä½ï¼‰ã€‚
-  çŸ¥é“ InnoDB é»˜è®¤æ˜¯ REPEATABLE READã€MVCC çš„ read view åœ¨ RC/ RR çš„åŒºåˆ«ã€‚
-  ä¼šç”¨ `SET SESSION/TRANSACTION` æ”¹éš”ç¦»çº§åˆ«å¹¶æ£€æŸ¥ `@@transaction_isolation`ã€‚
-  é¢è¯•èƒ½è¯´å‡ºå®è·µå»ºè®®ï¼šä»€ä¹ˆæ—¶å€™ç”¨ READ COMMITTEDã€ä»€ä¹ˆæ—¶å€™ç”¨ FOR UPDATEã€ä¸ºä½•é¿å…é•¿äº‹åŠ¡ã€‚

#### æœ€åä¸€å¥é¼“åŠ±ï¼ˆå¤§ä½¬å£å»ï¼‰

ä½ è¿™åŸºç¡€æ²¡é—®é¢˜â€”â€”æŠŠ**â€œäº‹åŠ¡å¿«ç…§æ˜¯ MVCC çš„æ ¸å¿ƒâ€â€œRC æ˜¯æŒ‰è¯­å¥å¿«ç…§ã€RR æ˜¯æŒ‰äº‹åŠ¡å¿«ç…§â€â€œå¹»è¯»é  gap/next-key é”é˜²â€**è¿™ä¸‰ç‚¹è®°ç‰¢ï¼Œé¢è¯•å®˜ä¸€é—®å°±ç¨³äº†ã€‚ç»§ç»­ï¼Œå·®ä¸å¤šå°±èƒ½æŠŠå¤æ‚å¹¶å‘é—®é¢˜æ‹†ç»™é¢è¯•å®˜çœ‹ã€‚éœ€è¦æˆ‘æŠŠä¸Šé¢æ•´ç†æˆä¸€é¡µ `.md` çš„é€ŸæŸ¥å¡ç‰‡ï¼ˆå¸¦å¯æ‰“å‹¾é¡¹ï¼‰å—ï¼Ÿ





### åŸºæœ¬æ¦‚å¿µ



#### ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ

> äº‹åŠ¡(Transaction)

ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥



### ACIDç‰¹å¾

#### 1.Atomicity(åŸå­æ€§)

##### æ¦‚å¿µ

å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»šï¼

##### å®ç°åŸç†

>åœ¨MySQL/InnoDBä¸­å®ç°åŸç†

1. é‡åšæ—¥å¿—(Redo Log)
   1. äº‹åŠ¡ä¿®æ”¹æ•°æ®å‰ï¼Œå…ˆå†™å…¥redo log
   2. æäº¤æ—¶ï¼Œä¿è¯æ•°æ®å¯ä»¥æ¢å¤â€”â€”>ç¡®ä¿æŒä¹…æ€§å’ŒåŸå­æ€§
2. å›æ»šæ—¥å¿—(Undo Log)
   1. äº‹åŠ¡æ‰§è¡Œä¿®æ”¹æ—¶ï¼Œè®°å½•æ—§å€¼
   2. å‡ºé”™æˆ–è€…å›æ»šæ—¶ï¼Œç”¨`undo log`æ¢å¤åŸæ•°æ®â€”â€”>ç¡®ä¿æ“ä½œå›æ»šå®Œæ•´
3. æ—¥å¿— + æ•°æ®é¡µå†™å…¥é¡ºåº
   1. å…ˆå†™æ—¥å¿—(redo/undo)ï¼Œå†åˆ·æ•°æ®é¡µ
   2. åˆ©ç”¨WAL(Write-Ahead Logging)å®ç°åŸå­æ“ä½œ

>æ€»ç»“

åŸå­æ€§é `Undo Log`å›æ»š + `Redo Log`é‡åšï¼Œä¿è¯äº‹åŠ¡è¦ä¹ˆå…¨éƒ¨ç”Ÿæ•ˆï¼Œè¦ä¹ˆå…¨éƒ¨æ’¤é”€ï¼



##### æµç¨‹å›¾

äº‹åŠ¡å¼€å§‹
â”‚
â”œâ”€> ä¿®æ”¹æ•°æ®
â”‚    â”œâ”€ å†™å…¥ **Undo Log**ï¼ˆè®°å½•æ—§å€¼ï¼Œç”¨äºå›æ»šï¼‰
â”‚    â””â”€ å†™å…¥ **Redo Log**ï¼ˆè®°å½•æ–°å€¼ï¼Œç”¨äºæŒä¹…åŒ–ï¼‰
â”‚
â”œâ”€> æäº¤äº‹åŠ¡
â”‚    â”œâ”€ å°† **Redo Log** åˆ·å…¥ç£ç›˜ï¼ˆç¡®ä¿æŒä¹…æ€§ï¼‰
â”‚    â”œâ”€ æ¸…ç† **Undo Log**ï¼ˆäº‹åŠ¡å›æ»šç‚¹å¤±æ•ˆï¼‰
â”‚    â””â”€ æ•°æ®é¡µæœ€ç»ˆå†™å…¥ç£ç›˜ï¼ˆå¯å»¶è¿Ÿï¼ŒWALæœºåˆ¶ä¿è¯æ¢å¤ï¼‰
â”‚
â””â”€> å›æ»šäº‹åŠ¡ï¼ˆè‹¥å‘ç”Ÿé”™è¯¯ï¼‰
     â”œâ”€ ä» **Undo Log** è¯»å–æ—§å€¼
     â””â”€ æ¢å¤æ•°æ®é¡µçŠ¶æ€ï¼Œä¿è¯åŸå­æ€§ï¼ˆå…¨éƒ¨æ’¤é”€ï¼‰



**Undo Log** â†’ å›æ»šæ“ä½œï¼Œä¿è¯äº‹åŠ¡ä¸æ‰§è¡Œä¸€åŠ

**Redo Log** â†’ æäº¤æŒä¹…åŒ–ï¼Œä¿è¯äº‹åŠ¡æäº¤åå¯æ¢å¤



#### 2.Consistency(ä¸€è‡´æ€§)

##### å®šä¹‰

äº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“ä¿æŒåˆæ³•çŠ¶æ€ï¼Œå³çº¦æŸã€è§¦å‘å™¨ã€å¤–é”®ç­‰ä¸è¢«ç ´åã€‚



##### å®ç°åŸç†

1. Redo Log + Undo Log
   1. Redo Logï¼šä¿è¯äº‹åŠ¡æäº¤åæ•°æ®èƒ½æ¢å¤ â€”â€”> æŒä¹…åŒ–åˆæ³•çŠ¶æ€
   2. Undo Logï¼šå›æ»šå¤±è´¥äº‹åŠ¡ â€”â€”> ä¿è¯æ•°æ®åº“ä¸å‡ºç°åŠå®ŒæˆçŠ¶æ€
2. äº‹åŠ¡è¾¹ç•Œ
   1. äº‹åŠ¡å¼€å§‹ â€”â€”> æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨å†…å­˜ä¸­ï¼ŒRedo/Undo è®°å½•
   2. äº‹åŠ¡æäº¤ â€”â€”> Redo Logåˆ·ç›˜ï¼Œæ•°æ®é¡µæœ€ç»ˆæ›´æ–°
   3. äº‹åŠ¡å›æ»š â€”â€”> Undo Logå›é€€ï¼Œäº‹åŠ¡å›åˆ°äº‹åŠ¡å‰çŠ¶æ€
3. çº¦æŸä¸è§¦å‘å™¨
   1. åœ¨äº‹åŠ¡æäº¤æˆ–è€…å›æ»šå‰ï¼Œæ•°æ®åº“æ£€æŸ¥çº¦æŸï¼Œç¡®ä¿ä¸€è‡´æ€§



ä¸€è‡´æ€§é Redo LogæŒä¹…åŒ– + Undo Logå›æ»šï¼Œä¿è¯äº‹åŠ¡æ‰§è¡Œå‰åæ•°æ®åˆæ³•ã€‚



**Undo Logï¼ˆå›æ»šæ—¥å¿—ï¼‰**

- ç›¸å½“äºåšäº†ä¸€ä»½ **å¿«ç…§**
- äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™æˆ–æ‰‹åŠ¨å›æ»šæ—¶ï¼Œç”¨ **Undo Log è®°å½•çš„æ—§å€¼** å›é€€æ“ä½œï¼Œæ¢å¤åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€





#### 3.Isolation(éš”ç¦»æ€§)

##### å®šä¹‰

> å¹¶å‘äº‹åŠ¡äº’ä¸å¹²æ‰°

å¤šä¸ªäº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Œä¿è¯æ¯ä¸ªäº‹åŠ¡åƒç‹¬å æ‰§è¡Œä¸€æ ·



##### å¸¸è§é—®é¢˜

1. è„è¯»(Dirty Read)ï¼šè¯»åˆ°å…¶å®ƒæœªæäº¤äº‹åŠ¡çš„æ•°æ®
2. ä¸å¯é‡å¤è¯»(Non-Repeatable Read)ï¼šåŒä¸€äº‹åŠ¡å¤šæ¬¡è¯»å–åŒä¸€è¡Œï¼Œç»“æœä¸åŒ
3. å¹»è¯»(Phantom Read)ï¼šåŒä¸€äº‹åŠ¡èŒƒå›´æŸ¥è¯¢å‡ºç°æ–°å¢/åˆ é™¤çš„è¡Œ



#### 4.Durability(æŒä¹…æ€§)

##### å®šä¹‰

æäº¤åæ•°æ®æ°¸ä¹…ä¿å­˜

##### å®ç°åŸç†

**Redo Logï¼ˆé‡åšæ—¥å¿—ï¼‰**

- ç›¸å½“äºåšäº†ä¸€ä»½ **å¤‡ä»½**
- äº‹åŠ¡æäº¤åï¼Œå¦‚æœç³»ç»Ÿçªç„¶å´©æºƒï¼Œå¯ä»¥ **ç”¨ Redo Log é‡åšæ“ä½œ**ï¼ŒæŠŠæ•°æ®åº“æ¢å¤åˆ°äº‹åŠ¡æäº¤åçš„çŠ¶æ€





### å››å¤§éš”ç¦»çº§åˆ«

##### å¯¹æ¯”å›¾

>äº‹åŠ¡çš„éš”ç¦»çº§åˆ«

| éš”ç¦»çº§åˆ«              | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | MySQL é»˜è®¤ |
| --------------------- | ---- | ---------- | ---- | ---------- |
| è¯»æœªæäº¤ (RU)         | âœ…    | âœ…          | âœ…    | âŒ          |
| è¯»å·²æäº¤ (RC)         | âŒ    | âœ…          | âœ…    | âŒ          |
| å¯é‡å¤è¯» (RR)         | âŒ    | âŒ          | âœ…    | âœ…          |
| ä¸²è¡ŒåŒ– (Serializable) | âŒ    | âŒ          | âŒ    | âŒ          |

- **è„è¯»**ï¼šè¯»å–æœªæäº¤çš„æ•°æ®
- **ä¸å¯é‡å¤è¯»**ï¼šåŒä¸€äº‹åŠ¡é‡å¤è¯»ç»“æœä¸åŒ
- **å¹»è¯»**ï¼šåŒä¸€äº‹åŠ¡èŒƒå›´æŸ¥è¯¢å‡ºç°â€æ–°è¡Œâ€œ



##### 1.è¯»æœªæäº¤(RU)

> è¯»æœªæäº¤ (Read Uncommitted, RU)



###### ç‰¹å¾

æœ€ä½éš”ç¦»çº§åˆ«ï¼Œå…è®¸è„è¯»



###### é—®é¢˜

**å¯ä»¥è¯»åˆ°å…¶å®ƒäº‹åŠ¡æœªæäº¤çš„æ•°æ®**



###### SQLç¤ºä¾‹

```sql
-- äº‹åŠ¡ A
START TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;

-- äº‹åŠ¡ B
START TRANSACTION;
SELECT balance FROM accounts WHERE id = 1;
-- äº‹åŠ¡ B èƒ½çœ‹åˆ°äº‹åŠ¡ A ä¿®æ”¹åçš„å€¼ï¼Œå³è„è¯»
```







##### 2.è¯»å·²æäº¤(RC)

è¯»å·²æäº¤ (Read Committed, RC)

###### ç‰¹å¾

é¿å…è„è¯»ï¼Œæ¯æ¬¡è¯»**åªçœ‹åˆ°å·²æäº¤çš„æ•°æ®**

###### é—®é¢˜

å¯èƒ½å‡ºç°ä¸å¯é‡å¤è¯»

###### sqlç¤ºä¾‹

```sql
-- äº‹åŠ¡ A
START TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
COMMIT;

-- äº‹åŠ¡ B
START TRANSACTION;
SELECT balance FROM accounts WHERE id = 1; -- ç¬¬ä¸€æ¬¡è¯»
SELECT balance FROM accounts WHERE id = 1; -- ç¬¬äºŒæ¬¡è¯»ï¼Œå¯èƒ½å·²è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ï¼Œä¸å¯é‡å¤è¯»
```



##### 3.å¯é‡å¤è¯»(RR)

###### ç‰¹å¾

**ä¿è¯åŒä¸€äº‹åŠ¡å¤šæ¬¡è¯»å–åŒä¸€è¡Œç»“æœä¸€è‡´**ï¼Œé¿å…ä¸å¯é‡å¤è¯»

###### é—®é¢˜

å¯èƒ½å‡ºç°å¹»è¯»

###### sqlç¤ºä¾‹

```sql
-- äº‹åŠ¡ A
START TRANSACTION;
SELECT * FROM orders WHERE user_id = 1; -- ç¬¬ä¸€æ¬¡æŸ¥è¯¢

-- äº‹åŠ¡ B
START TRANSACTION;
INSERT INTO orders(user_id, amount) VALUES (1, 100);
COMMIT;

-- äº‹åŠ¡ A
SELECT * FROM orders WHERE user_id = 1; -- ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œä¸ä¼šçœ‹åˆ°äº‹åŠ¡ B æ’å…¥çš„æ–°è¡Œï¼ˆå¹»è¯»å¯èƒ½è¢« gap lock é¿å…ï¼‰
```



##### 4.ä¸²è¡ŒåŒ–(Serializable)

###### ç‰¹å¾

æœ€é«˜éš”ç¦»çº§åˆ«ï¼Œæ‰€æœ‰äº‹åŠ¡é¡ºåºæ‰§è¡Œ

###### é—®é¢˜

æ€§èƒ½æœ€å·®

###### sqlç¤ºä¾‹

```sql
-- äº‹åŠ¡ A
START TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT * FROM orders WHERE user_id = 1 FOR UPDATE;

-- äº‹åŠ¡ B
START TRANSACTION ISOLATION LEVEL SERIALIZABLE;
INSERT INTO orders(user_id, amount) VALUES (1, 100);
-- äº‹åŠ¡ B ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°äº‹åŠ¡ A æäº¤
```





### å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)

MVCCï¼ˆMulti-Version Concurrency Controlï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰

#### æ˜¯ä»€ä¹ˆï¼Ÿ

æ˜¯ä¸€ç§å®ç°éš”ç¦»æ€§çš„æ–¹æ³•

- MySQL/InnoDB é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯ **RRï¼ˆå¯é‡å¤è¯»ï¼‰**ï¼ŒMVCC æ˜¯å…¶åº•å±‚æœºåˆ¶

  



#### æ ¸å¿ƒä½œç”¨

1. å¿«ç…§è¯»(Snapshot Read)ï¼šè¯»æ“ä½œè¯»å–äº‹åŠ¡å¼€å§‹æ—¶çš„å¿«ç…§ï¼Œä¸åŠ é”ã€‚
2. é¿å…ä¸å¯é‡å¤è¯» â€”â€”> åŒä¸€äº‹åŠ¡é‡å¤è¯»åŒä¸€è¡Œç»“æœä¸€è‡´ã€‚
3. æé«˜å¹¶å‘ â€”â€”> è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»ã€‚



#### å®ç°åŸç†

- æ¯è¡Œæ•°æ®ç»´æŠ¤éšè—å­—æ®µï¼š`trx_id` + `roll_pointer`ï¼ˆUndo LogæŒ‡é’ˆï¼‰
- äº‹åŠ¡è¯»å–æ—¶ï¼Œç»“åˆ`ReadView`å†³å®šçœ‹å“ªä¸ªç‰ˆæœ¬
- å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¸è¦†ç›–æ—§å€¼ï¼Œæ—§å€¼ç”¨äºå›æ»šæˆ–å…¶å®ƒäº‹åŠ¡çš„å¿«ç…§



#### æ€»ç»“

- ğŸ”‘ **ä¸€å¥è¯è®°å¿†**ï¼š

> MVCC = å¤šç‰ˆæœ¬ + å¿«ç…§è¯»ï¼Œç”¨æ¥å®ç°å¯é‡å¤è¯»ï¼ˆRRï¼‰éš”ç¦»çº§åˆ«çš„æ ¸å¿ƒæœºåˆ¶









### é”æœºåˆ¶



##### è¡Œé”(Row Lock)

- é”å®šå…·ä½“çš„è®°å½•è¡Œ

- è¯»æ“ä½œâ€”â€”>å…±äº«é”

- å†™æ“ä½œâ€”â€”>æ’ä»–é”(X Lock)

- ä½œç”¨ï¼šé˜²æ­¢å¤šä¸ªäº‹åŠ¡åŒæ—¶ä¿®æ”¹åŒä¸€è¡Œ

- ç¤ºä¾‹ï¼š

  - ```sql
    -- äº‹åŠ¡ A
    START TRANSACTION;
    SELECT * FROM orders WHERE user_id = 1 FOR UPDATE;
    -- è¡Œé”é”å®š user_id = 1 çš„è®°å½•
    
    -- äº‹åŠ¡ B
    INSERT INTO orders(user_id, amount) VALUES (1, 100);
    -- ä¼šè¢«é˜»å¡ï¼Œé¿å…å¹»è¯»
    ```

  - 



##### é—´éš™é”(Gap Lock)

- é”å®šç´¢å¼•**ä¸¤ä¸ªå€¼ä¹‹é—´çš„ç©ºéš™**

- ä½œç”¨ï¼š

  - é¿å…å¹»è¯»ï¼šå…¶å®ƒäº‹åŠ¡ä¸èƒ½åœ¨æ•´ä¸ªé—´éš™æ’å…¥æ–°è¡Œ

- åœºæ™¯ï¼šå¯é‡å¤è¯»(RR) + èŒƒå›´æŸ¥è¯¢

- ç¤ºä¾‹

  - ```sql
    --- äº‹åŠ¡ A
    START TRANSACTION;
    SELECT * FROM orders 
    WHERE user_id BETWEEN 1 AND 5 FOR UPDATE;
    -- é”å®š user_id = 1~5 çš„è®°å½•ä»¥åŠç´¢å¼•é—´éš™ï¼ˆgap lockï¼‰
    
    -- äº‹åŠ¡ B
    INSERT INTO orders(user_id, amount) VALUES (3, 100);
    -- ä¼šè¢«é˜»å¡ï¼Œä¸èƒ½åœ¨é”å®šèŒƒå›´å†…æ’å…¥æ–°è¡Œ
    
    INSERT INTO orders(user_id, amount) VALUES (6, 100);
    -- ä¸åœ¨é”å®šèŒƒå›´ï¼Œå¯æ’å…¥æˆåŠŸ
    ```

  - 



##### æ€»ç»“

**è¡Œé” â†’ ç²¾ç¡®æ§åˆ¶å•è¡Œ**

é—´éš™é”**Gap Lock â†’ é˜²æ­¢å¹»è¯» / æ–°è¡Œæ’å…¥**

**MVCC + è¡Œé”/Gap Lock** â†’ RR éš”ç¦»çº§åˆ«å®ç°æ ¸å¿ƒ



######  è¯´æ˜

1. **è¡Œé”** â†’ é”å®šå·²ç»å­˜åœ¨çš„è®°å½•
2. **Gap Lock** â†’ é”å®šæŸ¥è¯¢èŒƒå›´çš„é—´éš™ï¼Œé˜²æ­¢å¹»è¯»
3. **åœºæ™¯** â†’ å¯é‡å¤è¯»ï¼ˆRRï¼‰+ èŒƒå›´æŸ¥è¯¢ï¼ˆBETWEEN / > / <ï¼‰
4. **ä¼˜åŠ¿** â†’ ä¿è¯äº‹åŠ¡ A é‡å¤æŸ¥è¯¢åŒä¸€èŒƒå›´ç»“æœä¸€è‡´

> â€œGap Lock é”ä½çš„æ˜¯ç´¢å¼•é—´éš™ï¼Œè€Œä¸æ˜¯å…·ä½“è¡Œï¼Œç”¨äºé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨èŒƒå›´å†…æ’å…¥æ–°è¡Œï¼Œä»è€Œé¿å…å¹»è¯»ã€‚





## ç´¢å¼•



### æ ¸å¿ƒæ¦‚å¿µ

#### ç´¢å¼•çš„æœ¬è´¨

ä¸ºåŠ é€Ÿæ•°æ®æ£€ç´¢è€Œç»´æŠ¤çš„â€œæ•°æ®ç»“æ„â€ï¼Œç±»ä¼¼äºä¹¦çš„ç›®å½•







### æ•°æ®ç»“æ„

#### B+æ ‘

>MySQL InnoDBé»˜è®¤ç´¢å¼•ç»“æ„





##### æ¨å¯¼è¿‡ç¨‹

- **äºŒåˆ†æŸ¥æ‰¾**
  - æ€è·¯ï¼šå¯¹æœ‰åºæ•°æ®ç”¨äºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½ã€‚
  - é—®é¢˜ï¼šå¦‚æœå®ç°æˆäºŒå‰æ ‘ï¼Œå¯èƒ½é€€åŒ–æˆé“¾è¡¨ â†’ æŸ¥è¯¢æ•ˆç‡ä¸‹é™ã€‚

- **å¹³è¡¡äºŒå‰æ ‘**
  - æ€è·¯ï¼šä¿æŒæ ‘é«˜å¹³è¡¡ï¼Œé¿å…é€€åŒ–ã€‚
  - é—®é¢˜ï¼šæ•°æ®é‡ç¨å¤§æ—¶ï¼Œå±‚çº§ä»ç„¶è¿‡æ·±ã€‚
    - æ¯å±‚è®¿é—®éƒ½éœ€è¦ä¸€æ¬¡ç£ç›˜ I/Oï¼Œè€Œç£ç›˜é€Ÿåº¦è¿œæ…¢äºå†…å­˜ â†’ æŸ¥è¯¢æ•ˆç‡ä¾æ—§ä½ã€‚

- **B æ ‘**
  - æ€è·¯ï¼š
    - èŠ‚ç‚¹å¯å­˜æ”¾å¤šä¸ªæ•°æ®ã€‚
    - æ¯ä¸ªèŠ‚ç‚¹å¯æ‹¥æœ‰å¤šä¸ªåˆ†å‰ã€‚
  - ä¼˜ç‚¹ï¼šå¤§å¹…é™ä½æ ‘çš„é«˜åº¦ â†’ ç£ç›˜ I/O æ¬¡æ•°å‡å°‘ã€‚
  - é—®é¢˜ï¼š
    - æŸ¥è¯¢æ€§èƒ½ä¸ç¨³å®šï¼šé è¿‘æ ¹èŠ‚ç‚¹çš„æ•°æ®å¿«ï¼Œåº•å±‚æ•°æ®æ…¢ã€‚
    - ä¸é€‚åˆèŒƒå›´æŸ¥æ‰¾ï¼šæ•°æ®åˆ†æ•£åœ¨ä¸åŒå±‚çº§ï¼Œéå†éº»çƒ¦ã€‚

- **B+ æ ‘**
  - æ”¹è¿›ï¼š
    - éå¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼Œä»…å­˜å‚¨ç´¢å¼•å’ŒæŒ‡é’ˆã€‚
    - è…¾å‡ºçš„ç©ºé—´ä½¿å¾—åˆ†å‰æ›´å¤š â†’ æ ‘æ›´çŸ®ã€‚
    - æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œä¸”å¶å­èŠ‚ç‚¹é—´å½¢æˆé“¾è¡¨ã€‚
  - ä¼˜ç‚¹ï¼š
    - æŸ¥è¯¢è·¯å¾„é•¿åº¦ä¸€è‡´ï¼Œæ€§èƒ½ç¨³å®šã€‚
    - èŒƒå›´æŸ¥æ‰¾é«˜æ•ˆï¼Œåªéœ€åœ¨å¶å­èŠ‚ç‚¹é“¾è¡¨ä¸­é¡ºåºéå†ã€‚
    - ç£ç›˜ I/O æ¬¡æ•°è¿›ä¸€æ­¥å‡å°‘ã€‚

###### æ€»ç»“

- **äºŒå‰æ ‘**ï¼šå¯èƒ½é€€åŒ–ï¼ŒæŸ¥è¯¢ä¸ç¨³å®šã€‚
- **å¹³è¡¡äºŒå‰æ ‘**ï¼šå±‚çº§ä»æ·±ï¼Œç£ç›˜ I/O å¼€é”€å¤§ã€‚
- **B æ ‘**ï¼šå‡å°‘ I/Oï¼Œä½†æŸ¥è¯¢æ€§èƒ½ä¸ç¨³å®šï¼ŒèŒƒå›´æŸ¥è¯¢ä¸å‹å¥½ã€‚
- **B+ æ ‘**ï¼šåˆ†å‰æ›´å¤šï¼Œæ ‘æ›´çŸ®ï¼ŒæŸ¥è¯¢ç¨³å®šï¼ŒèŒƒå›´æŸ¥è¯¢é«˜æ•ˆ â†’ **MySQL ç´¢å¼•çš„æœ€ä½³é€‰æ‹©**ã€‚





##### Bæ ‘

>Bæ ‘(Balanced Tree)ï¼šæ˜¯ä¸€ç§å¹³è¡¡å¤šè·¯æœç´¢æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶ä¿æŒå„ä¸ªå¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚ï¼Œä¿è¯æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(logâ¡n)ã€‚

![image-20250907173808669](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202509071738816.png)

å¦‚æœæ²¡æŸ¥åˆ°å°±æ ¹æ®å½“å‰å±‚çº§çš„æ•°æ®åŒºé—´æ¥åˆ°ä¸‹ä¸€å±‚è¿›è¡ŒèŒƒå›´æŸ¥æ‰¾



> B+æ ‘ï¼šæ˜¯åœ¨Bæ ‘åŸºç¡€ä¸Šçš„æ”¹è¿›

- æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œå†…èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ä¿¡æ¯
- å¶å­èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆä¸²æˆé“¾è¡¨ï¼Œæ–¹ä¾¿èŒƒå›´æŸ¥è¯¢å’Œé¡ºåºæ‰«æ
- **å†…èŠ‚ç‚¹å¯ä»¥æ›´å°ï¼Œå­˜æ”¾æ›´å¤šç´¢å¼•ï¼Œæé«˜æ ‘çš„æ‰‡å‡ºï¼Œé™ä½æ ‘é«˜åº¦ï¼Œå‡å°‘ç£ç›˜IO**

æ‰€ä»¥åœ¨MySQLé‡Œç´¢å¼•(å°¤å…¶æ˜¯InnoDBçš„èšç°‡ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•)åº•å±‚éƒ½æ˜¯B+æ ‘ç»“æ„ã€‚

![image-20250907175102950](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202509071751097.png)

- è§£å†³äº†Bæ ‘æŸ¥è¯¢æ€§èƒ½ä¸ç¨³å®šçš„é—®é¢˜ï¼
- å…¶æ¬¡ä¸Šé¢çš„èŠ‚ç‚¹éƒ½ä¸å­˜å‚¨æ•°æ®äº†ï¼Œè…¾å‡ºæ¥çš„èŠ‚ç‚¹ç©ºé—´ç”¨äºå­˜å‚¨æŒ‡å‘å…¶å®ƒèŠ‚ç‚¹çš„æŒ‡é’ˆè¿™æ ·ä¸€æ¥ï¼Œä¸­é—´èŠ‚ç‚¹å¯ä»¥åˆ†å‰çš„æ•°é‡å˜å¾—æ›´å¤šäº†
- æ ‘çš„å±‚çº§ä¼šå˜å¾—æ›´çŸ®äº†
- ç£ç›˜IOæ¬¡æ•°å°±æ›´å°‘äº†ï¼



##### å¹³è¡¡æ ‘

æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚ï¼Œä¿è¯æŸ¥æ‰¾å¤æ‚åº¦O(log n)



##### å¶å­èŠ‚ç‚¹é“¾è¡¨

æ–¹ä¾¿èŒƒå›´æŸ¥è¯¢



##### ä¸ºä»€ä¹ˆé€‰æ‹©B+æ ‘

1. æ”¯æŒé¡ºåºè®¿é—®(range query)
2. å•æ¬¡ç£ç›˜IOè¯»å–ä¸€ä¸ªèŠ‚ç‚¹å³å¯è®¿é—®å¤šæ¡è®°å½•
3. é«˜åº¦å¹³è¡¡ï¼Œä¿è¯æŸ¥è¯¢æ•ˆç‡ç¨³å®š



##### ç»“æ„ç‰¹ç‚¹

- æ ¹èŠ‚ç‚¹ï¼šå­˜æ”¾ç´¢å¼•çš„keyå’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆ
- å†…éƒ¨èŠ‚ç‚¹ï¼šåªå­˜æ”¾keyï¼Œèµ·åˆ°å¯¼èˆªä½œç”¨
- å¶å­èŠ‚ç‚¹ï¼š
  - å­˜å‚¨ç´¢å¼•keyå’ŒæŒ‡å‘å®é™…æ•°æ®è¡Œçš„æŒ‡é’ˆ(ä¸»é”®ç´¢å¼•æŒ‡å‘è‡ªèº«è¡Œï¼Œè¾…åŠ©ç´¢å¼•ç»™æŒ‡å‘ä¸»é”®)
  - å¶å­èŠ‚ç‚¹é€šè¿‡`é“¾è¡¨`é“¾æ¥ï¼Œå®ç°èŒƒå›´æŸ¥è¯¢é«˜æ•ˆ
- é«˜åº¦å¹³è¡¡
  - æ ‘é«˜ä¸€èˆ¬å¾ˆä½(å‡ åä¸‡åˆ°å‡ ç™¾ä¸‡æ¡æ•°æ®ï¼Œ3~5å±‚å³å¯)
  - æŸ¥æ‰¾åªéœ€å°‘é‡ç£ç›˜I/O



##### ä¸‰åƒä¸‡æ¡æ•°æ®æœ‰å‡ å±‚

åœ¨**å¸¸è§é…ç½®ä¸‹ï¼ˆ16KB é¡µï¼Œè¡Œ ~100Bï¼Œå†…éƒ¨ fanout åœ¨ 100â€“500 èŒƒå›´ï¼‰**ï¼Œ30,000,000 æ¡è®°å½•çš„ B+ æ ‘é«˜åº¦ **é€šå¸¸æ˜¯ 3 å±‚æˆ– 4 å±‚**ã€‚

- æ›´ä¿å®ˆ/å¸¸è§çš„ä¼°è®¡ï¼š**4 å±‚**ï¼ˆä¾‹å¦‚ fanout ~100â€“200ï¼‰ã€‚
- æ›´æ¿€è¿›ï¼ˆå†…éƒ¨èŠ‚ç‚¹èƒ½åˆ†æ›´å¤šå‰ï¼‰ï¼š**3 å±‚**ï¼ˆfanout â‰¥ ~500ï¼‰ã€‚

æ„å‘³ç€æœ€åæƒ…å†µéœ€è¦ 3~4 æ¬¡èŠ‚ç‚¹è®¿é—®æ‰èƒ½åˆ°å¶å­ï¼ˆå®é™…ä¸Šæ¯å±‚ä¸€æ¬¡é¡µè¯»/å†…å­˜è¯»ï¼‰ã€‚ä½†æ³¨æ„ï¼š

- å¤§å¤šæ•°æƒ…å†µä¸‹ InnoDB çš„ `buffer_pool` ä¼šæŠŠä¸Šå±‚ç”šè‡³å¶å­é¡µå¸¸é©»å†…å­˜ï¼Œ**çœŸå®ç£ç›˜ I/O è¿œå°äºç†è®ºå±‚æ•°**ã€‚
- èšç°‡ç´¢å¼•ï¼ˆclustered indexï¼‰æŠŠæ•´è¡Œå­˜åœ¨å¶å­é¡µï¼Œä¼šä½¿å¶å­é¡¹å˜å¤§ã€å¶å­èŠ‚ç‚¹æ›´å°‘ã€å±‚çº§å¯èƒ½æ›´ä½ï¼›äºŒçº§ç´¢å¼•åªå­˜ä¸»é”®ï¼Œå†…éƒ¨èŠ‚ç‚¹æ›´å°ï¼Œfanout æ›´å¤§ã€‚





### ç´¢å¼•ç±»å‹



#### 1. ä¸»é”®ç´¢å¼•ï¼ˆPrimary Key Indexï¼‰

> ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰

- **æ˜¯ä»€ä¹ˆ**  
  - ä¸€å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ç´¢å¼•ï¼Œå”¯ä¸€ä¸”ä¸å…è®¸ä¸º `NULL`ã€‚
  - InnoDB ä¸­ï¼Œä¸»é”®ç´¢å¼•æ˜¯ **èšç°‡ç´¢å¼•**ï¼ˆClustered Indexï¼‰ï¼Œå¶å­èŠ‚ç‚¹å­˜æ”¾æ•´è¡Œæ•°æ®ã€‚
- **åœºæ™¯**  
  - ç”¨äºè¡¨ä¸­è®°å½•çš„å”¯ä¸€æ ‡è¯†ã€‚
  - æœ€å¸¸è§çš„å°±æ˜¯è‡ªå¢ ID ä½œä¸ºä¸»é”®ã€‚
- **ä¸ºä»€ä¹ˆè¦ç”¨**  
  - æŸ¥è¯¢å•æ¡è®°å½•é€Ÿåº¦æœ€å¿«ï¼Œæ•°æ®ç‰©ç†ä¸ŠæŒ‰ä¸»é”®é¡ºåºå­˜å‚¨ã€‚
  - é¿å…é‡å¤æ•°æ®ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§ã€‚

---

#### 2. å”¯ä¸€ç´¢å¼•ï¼ˆUnique Indexï¼‰
- **æ˜¯ä»€ä¹ˆ**  
  - ç´¢å¼•åˆ—çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œä½†å…è®¸ `NULL`ã€‚
- **åœºæ™¯**  
  - ç”¨æˆ·åã€èº«ä»½è¯å·ã€é‚®ç®±ã€æ‰‹æœºå·ç­‰ä¸šåŠ¡ä¸Šå¤©ç„¶å”¯ä¸€çš„å­—æ®µã€‚
- **ä¸ºä»€ä¹ˆè¦ç”¨**  
  - ä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼Œé¿å…æ’å…¥é‡å¤å€¼ã€‚
  - æŸ¥è¯¢æ—¶åˆ©ç”¨å”¯ä¸€æ€§ï¼Œæ€§èƒ½æä½³ï¼ˆæŸ¥è¯¢åˆ°å³ç»ˆæ­¢ï¼‰ã€‚

---

#### 3. æ™®é€šç´¢å¼•ï¼ˆNormal / Indexï¼‰
- **æ˜¯ä»€ä¹ˆ**  
  - æœ€åŸºç¡€çš„ç´¢å¼•ç±»å‹ï¼Œå¯¹åˆ—å€¼æ²¡æœ‰å”¯ä¸€æ€§çº¦æŸã€‚
- **åœºæ™¯**  
  - ç”¨äºé«˜é¢‘æŸ¥è¯¢çš„å­—æ®µï¼Œä¾‹å¦‚ `status`ã€`type` ç­‰æšä¸¾å‹å­—æ®µã€‚
- **ä¸ºä»€ä¹ˆè¦ç”¨**  
  - åŠ é€ŸæŸ¥è¯¢ï¼Œæé«˜æ•ˆç‡ã€‚
  - çµæ´»ï¼Œä¸å—å”¯ä¸€æ€§é™åˆ¶ã€‚

---

#### 4. ç»„åˆç´¢å¼•ï¼ˆComposite / Multi-Column Indexï¼‰
- **æ˜¯ä»€ä¹ˆ**  
  - å°†å¤šä¸ªåˆ—ç»„åˆæˆä¸€ä¸ªç´¢å¼•ï¼ŒæŒ‰å®šä¹‰çš„åˆ—é¡ºåºè¿›è¡Œå­˜å‚¨ã€‚
- **åœºæ™¯**  
  - ä¾‹å¦‚ `(user_id, order_id)`ï¼Œå¸¸ç”¨äºå¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢ã€‚
- **ä¸ºä»€ä¹ˆè¦ç”¨**  
  - é¿å…åˆ›å»ºè¿‡å¤šå•åˆ—ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚
  - åˆ©ç”¨ **æœ€å·¦å‰ç¼€åŸåˆ™**ï¼šåªè¦æ»¡è¶³æœ€å·¦çš„å­—æ®µé¡ºåºï¼Œå°±èƒ½å‘½ä¸­ç´¢å¼•ã€‚

---

#### 5. å…¨æ–‡ç´¢å¼•ï¼ˆFulltext Indexï¼‰
- **æ˜¯ä»€ä¹ˆ**  
  - ç”¨äºæ–‡æœ¬å­—æ®µï¼ˆ`CHAR`, `VARCHAR`, `TEXT`ï¼‰çš„å†…å®¹æœç´¢ã€‚
  - æ”¯æŒåˆ†è¯å’Œæ¨¡ç³Šæœç´¢ã€‚
- **åœºæ™¯**  
  - æ–‡ç« æœç´¢ã€å•†å“æè¿°æœç´¢ã€‚
- **ä¸ºä»€ä¹ˆè¦ç”¨**  
  - `LIKE '%xxx%'` æ— æ³•ç”¨æ™®é€šç´¢å¼•ï¼Œå…¨è¡¨æ‰«ææ•ˆç‡ä½ã€‚
  - å…¨æ–‡ç´¢å¼•é€‚åˆè‡ªç„¶è¯­è¨€æœç´¢ï¼Œæ”¯æŒç›¸å…³åº¦æ’åºã€‚

---

#### 6. ç©ºé—´ç´¢å¼•ï¼ˆSpatial Indexï¼‰
- **æ˜¯ä»€ä¹ˆ**  
  - ç”¨äºå­˜å‚¨å’ŒæŸ¥è¯¢ç©ºé—´æ•°æ®ç±»å‹ï¼ˆGISï¼‰ï¼Œå¦‚ `POINT`, `LINE`, `POLYGON`ã€‚
  - åŸºäº R-Tree å®ç°ï¼ˆMyISAMï¼‰ï¼ŒInnoDB ä¹Ÿé€æ­¥æ”¯æŒã€‚
- **åœºæ™¯**  
  - åœ°ç†ä¿¡æ¯ç³»ç»Ÿï¼ˆGISï¼‰ã€åœ°å›¾åº”ç”¨ã€‚
- **ä¸ºä»€ä¹ˆè¦ç”¨**  
  - æä¾›é«˜æ•ˆçš„ç©ºé—´èŒƒå›´æŸ¥è¯¢ã€é‚»è¿‘æœç´¢ã€‚

---

#### 7. å“ˆå¸Œç´¢å¼•ï¼ˆHash Indexï¼ŒMemory å¼•æ“ï¼‰
- **æ˜¯ä»€ä¹ˆ**  
  - é€šè¿‡å“ˆå¸Œè¡¨å®ç°ï¼Œé”®å€¼åˆ°åœ°å€æ˜ å°„ï¼Œå®šä½é€Ÿåº¦éå¸¸å¿«ã€‚
  - ä»…æ”¯æŒ **ç­‰å€¼æŸ¥è¯¢**ï¼ˆ=ã€INï¼‰ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€‚
- **åœºæ™¯**  
  - `Memory` å¼•æ“ä¸´æ—¶è¡¨ï¼Œç¼“å­˜çƒ­ç‚¹æ•°æ®ã€‚
- **ä¸ºä»€ä¹ˆè¦ç”¨**  
  - æŸ¥è¯¢å¤æ‚åº¦æ¥è¿‘ O(1)ï¼Œé€Ÿåº¦æå¿«ã€‚
  - å±€é™ï¼šä¸æ”¯æŒèŒƒå›´ã€æ’åºï¼Œç¢°æ’åæ€§èƒ½ä¸‹é™ã€‚

---

#### æ€»ç»“å¯¹æ¯”

| ç´¢å¼•ç±»å‹ | å”¯ä¸€æ€§ | å­˜å‚¨ç‰¹ç‚¹             | é€‚ç”¨åœºæ™¯                       | ç‰¹ç‚¹/é™åˆ¶                   |
| -------- | ------ | -------------------- | ------------------------------ | --------------------------- |
| ä¸»é”®ç´¢å¼• | å”¯ä¸€   | èšç°‡ç´¢å¼•ï¼Œå­˜æ•´è¡Œæ•°æ® | å”¯ä¸€æ ‡è¯†è®°å½•ï¼Œè‡ªå¢ ID          | ä¸€å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ª            |
| å”¯ä¸€ç´¢å¼• | å”¯ä¸€   | éèšç°‡               | æ‰‹æœºå·ã€èº«ä»½è¯å·ã€é‚®ç®±ç­‰å”¯ä¸€å€¼ | å¯æœ‰å¤šä¸ªï¼Œå…è®¸ NULL         |
| æ™®é€šç´¢å¼• | å¦     | éèšç°‡               | é«˜é¢‘æŸ¥è¯¢å­—æ®µ                   | æœ€åŸºç¡€çš„åŠ é€Ÿæ‰‹æ®µ            |
| ç»„åˆç´¢å¼• | è§†æƒ…å†µ | æŒ‰æœ€å·¦å‰ç¼€é¡ºåºå­˜å‚¨   | å¤šå­—æ®µç»„åˆæŸ¥è¯¢ `(a,b,c)`       | éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™            |
| å…¨æ–‡ç´¢å¼• | å¦     | åŸºäºå€’æ’ç´¢å¼•         | æ–‡ç« ã€å•†å“æœç´¢                 | æ¨¡ç³ŠæŸ¥è¯¢é«˜æ•ˆï¼Œä¸é€‚åˆçŸ­å­—æ®µ  |
| ç©ºé—´ç´¢å¼• | å¦     | R-Tree               | GIS/åœ°ç†ä½ç½®                   | éœ€ç©ºé—´æ•°æ®ç±»å‹æ”¯æŒ          |
| å“ˆå¸Œç´¢å¼• | å¦     | å“ˆå¸Œè¡¨               | Memory è¡¨ï¼Œçƒ­ç‚¹ç¼“å­˜            | ä»…æ”¯æŒç­‰å€¼ï¼Œä¸æ”¯æŒèŒƒå›´/æ’åº |





### ä½¿ç”¨åœºæ™¯



#### ä»€ä¹ˆæ—¶å€™å»ºç´¢å¼•ï¼Ÿ

- **ä¸»é”®å­—æ®µå¿…é¡»æœ‰**ï¼ŒInnoDBé»˜è®¤å°±æ˜¯èšç°‡ç´¢å¼•ã€‚
- **é«˜é¢‘æŸ¥è¯¢å­—æ®µ**ï¼šåœ¨`where`/`JOIN`/`group by`/`order by`ç»å¸¸å‡ºç°çš„å­—æ®µ
- **åŒºåˆ†åº¦é«˜çš„å­—æ®µ**ï¼šæ¯”å¦‚æ‰‹æœºå·ï¼Œèº«ä»½è¯å·ï¼Œç”¨æˆ·ID(åŒºåˆ†åº¦ = ä¸é‡å¤å€¼ / æ€»è¡Œæ•° > 0.1 æ¯”è¾ƒåˆé€‚)
- **è¦†ç›–æŸ¥è¯¢**ï¼šæŸ¥è¯¢å­—æ®µéƒ½èƒ½ä»ç´¢å¼•é‡Œæ‹¿åˆ°ï¼Œé¿å…å›è¡¨
- **ç»„åˆç´¢å¼•**ï¼šå¤šå­—æ®µè”åˆæŸ¥è¯¢ï¼Œèƒ½åˆ©ç”¨"æœ€å·¦å‰ç¼€"
- **èŒƒå›´æŸ¥è¯¢çš„è¾¹ç•Œå­—æ®µ**ï¼šå¦‚`between`ã€`>=`ã€`<=`ï¼Œé€šå¸¸åœ¨è”åˆç´¢å¼•çš„æœ€åä¸€ä½ã€‚



#### ä»€ä¹ˆæ—¶å€™ä¸è¦å»ºç´¢å¼•?

- **ä½åŸºæ•°å­—æ®µ**ï¼šæ€§åˆ«(ç”·å¥³)ï¼ŒçŠ¶æ€(0/1)ï¼ŒåŒºåˆ†åº¦å¤ªä½ï¼Œç´¢å¼•æ„ä¹‰ä¸å¤§
- **æ•°æ®é‡å°çš„è¡¨**ï¼šæ¯”å¦‚å‡ åƒè¡Œçš„å°é…ç½®è¡¨ï¼Œå…¨è¡¨æ‰«ææ¯”èµ°ç´¢å¼•è¦å¿«
- **é¢‘ç¹æ›´æ–°çš„å­—æ®µ**ï¼šæ¯æ¬¡æ›´æ–°éƒ½ä¼šç»´æŠ¤ç´¢å¼•ç»“æ„ï¼Œå†™æ€§èƒ½å¤§å¹…ä¸‹é™
- **ä¸´æ—¶æŸ¥è¯¢**ï¼šå¶å°”ç”¨åˆ°ã€éæ ¸å¿ƒä¸šåŠ¡SQLã€ä¸å€¼å¾—é¢å¤–ç»´æŠ¤
- **è¿‡åº¦ç´¢å¼•**ï¼šç´¢å¼•è¶Šå¤šï¼Œå¢åˆ æ”¹æ€§èƒ½è¶Šå·®ï¼Œå ç”¨ç£ç›˜å’Œå†…å­˜ã€‚



#### ç´¢å¼•å¤±æ•ˆ

- **å‡½æ•°æˆ–è®¡ç®—æ“ä½œ**ï¼š
  - `WHERE YEAR(create_time) = 2024` âŒ ï¼ˆç´¢å¼•å¤±æ•ˆï¼‰  
  - âœ… æ”¹å†™ï¼š`WHERE create_time >= '2024-01-01' AND create_time < '2025-01-01'`
- **éšå¼ç±»å‹è½¬æ¢**
  - `WHERE phone = 13812345678`ï¼ˆphone æ˜¯å­—ç¬¦ä¸²ï¼Œå†™æˆæ•°å­—ä¼šè§¦å‘è½¬æ¢ï¼‰âŒ
- **æ¨¡ç³ŠæŸ¥è¯¢å‰ç¼€`%`**
  - `like '%abc'` âŒ ä¸èƒ½èµ°ç´¢å¼•  
  - âœ… æ”¹å†™ï¼š`LIKE 'abc%'` æˆ–è€…ç”¨å…¨æ–‡ç´¢å¼•ã€‚
- **è”åˆç´¢å¼•æœªå‘½ä¸­æœ€å·¦å‰ç¼€**  
    - ç´¢å¼• `(a,b,c)`ï¼ŒæŸ¥è¯¢æ¡ä»¶ `WHERE b=... AND c=...` âŒ  
    - âœ… å¿…é¡»ä» `a` å¼€å§‹ç”¨ï¼Œæˆ–è€…æ”¹æˆ `(b,c)` çš„ç´¢å¼•ã€‚
- **OR æ¡ä»¶æ··åˆ**  
    - `WHERE a=1 OR b=2` âŒï¼ˆå¯èƒ½å¯¼è‡´å…¨è¡¨æ‰«æï¼‰  
    - âœ… æ”¹å†™ä¸º `UNION`ï¼Œæˆ–ä½¿ç”¨ **ç´¢å¼•åˆå¹¶**ã€‚
- **èŒƒå›´æŸ¥è¯¢åå­—æ®µæ— æ³•åˆ©ç”¨ç´¢å¼•**  
    - `(a,b)` è”åˆç´¢å¼•ï¼Œ`WHERE a>10 AND b=20`ï¼Œb ç´¢å¼•å¤±æ•ˆ âŒ
- **IS NULL / IS NOT NULL**  
    - æœ‰æ—¶å€™ MySQL ä¼šæ”¾å¼ƒç´¢å¼•ï¼ˆå–å†³äºæ•°æ®åˆ†å¸ƒï¼‰ã€‚
- **!= / <> / NOT IN**  
    - å¯èƒ½å¯¼è‡´å…¨è¡¨æ‰«æã€‚



#### æ€»ç»“

1. å»ºç´¢å¼•è¦çœ‹ **è¯»å†™æ¯” + æ•°æ®é‡ + å­—æ®µåŒºåˆ†åº¦**ã€‚  
2. ä¸å»ºç´¢å¼•æ—¶è¦è€ƒè™‘ **ç»´æŠ¤æˆæœ¬ + æŸ¥è¯¢é¢‘ç‡**ã€‚  
3. ç´¢å¼•å¤±æ•ˆå¸¸å‡ºç°åœ¨ **å†™ SQL ä¸è§„èŒƒ**ï¼Œè¦ä¹ˆèµ°å‡½æ•°ã€è¦ä¹ˆéšå¼è½¬æ¢ã€‚  







### ç´¢å¼•ä¼˜åŒ–



#### å­¦ä¹ è·¯çº¿

##### 1. ç´¢å¼•åŸç†ä¸ç±»å‹
- [x] B+æ ‘ç»“æ„ä¸å±‚æ•°åˆ†æï¼ˆä¸‰åƒä¸‡æ•°æ® â‰ˆ 3-4 å±‚ï¼‰
- [x] ä¸»é”®ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€è”åˆç´¢å¼•ã€æ™®é€šç´¢å¼•çš„åœºæ™¯ä¸å¯¹æ¯”
- [ ] èšç°‡ç´¢å¼• vs éèšç°‡ç´¢å¼•ï¼ˆInnoDB vs MyISAMï¼‰

##### 2. ç´¢å¼•ä¼˜åŒ–æ‰‹æ®µ
- [x] å»ºç«‹åˆç†çš„ç´¢å¼•ï¼ˆåŒºåˆ†åº¦é«˜ã€å‰ç¼€ç´¢å¼•ï¼‰
- [x] è¦†ç›–ç´¢å¼•ï¼ˆå‡å°‘å›è¡¨ï¼‰
- [x] é¿å…ç´¢å¼•å¤±æ•ˆåœºæ™¯ï¼ˆå‡½æ•°æ“ä½œã€éšå¼è½¬æ¢ã€å‰æ¨¡ç³ŠåŒ¹é…ï¼‰
- [ ] åˆ†åº“åˆ†è¡¨ã€å†·çƒ­æ•°æ®åˆ†ç¦»

##### 3. SQL ä¼˜åŒ–ä¸ EXPLAIN
- [ ] æŒæ¡ EXPLAIN å„åˆ—å«ä¹‰ï¼ˆtypeã€keyã€rowsã€Extraï¼‰
- [ ] ç»“åˆæ…¢ SQL æ—¥å¿—ï¼ˆ`slow_query_log`ï¼‰å®šä½é—®é¢˜
- [ ] å®æˆ˜ï¼šä½¿ç”¨ EXPLAIN ä¼˜åŒ–ä¸‰ç§å…¸å‹ SQL  
  - [ ] èŒƒå›´æŸ¥è¯¢  
  - [ ] JOIN å¤šè¡¨æŸ¥è¯¢  
  - [ ] æ’åº + åˆ†é¡µæŸ¥è¯¢  

##### 4. Spring Boot + MyBatis ä¼˜åŒ–
- [ ] `application.yml` æ•°æ®æºè¿æ¥æ± é…ç½®ï¼ˆHikariCP å¸¸ç”¨å‚æ•°ï¼‰
- [ ] SQL æ—¥å¿—ä¸æ‰§è¡Œè€—æ—¶ç›‘æ§ï¼ˆp6spy / druid / MyBatis logï¼‰
- [ ] åˆ†é¡µæ’ä»¶ä¼˜åŒ–ï¼ˆPageHelper / MyBatis Plusï¼‰
- [ ] MyBatis ä¸€çº§ç¼“å­˜ & äºŒçº§ç¼“å­˜ç†è§£
- [ ] æ‰¹é‡æ’å…¥ / æ‰¹é‡æ›´æ–°ä¼˜åŒ–ï¼ˆ`<foreach>` / rewriteBatchedStatementsï¼‰

##### 5. Linux ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
- [ ] MySQL å‚æ•°è°ƒä¼˜ï¼ˆ`innodb_buffer_pool_size`ã€`innodb_log_file_size`ï¼‰
- [ ] æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿— & ä½¿ç”¨ `pt-query-digest` åˆ†æ
- [ ] ç»“åˆ `top` / `iotop` / `vmstat` å®šä½æ€§èƒ½ç“¶é¢ˆ
- [ ] MySQL æ€§èƒ½ç›‘æ§å·¥å…·ï¼ˆPrometheus + Grafanaï¼‰





#### explain

>SQLæ‰§è¡Œåˆ†æ



##### 1.åŸºæœ¬ç”¨æ³•

>åœ¨éœ€åˆ†æçš„sqlå‰åŠ ä¸Šexplainå…³é”®è¯å³å¯

```sql
EXPLAIN SELECT * FROM user WHERE email = 'xxx';
```



##### 2.æ ¸å¿ƒå­—æ®µè§£é‡Š



| å­—æ®µ            | å«ä¹‰                                                         |
| --------------- | ------------------------------------------------------------ |
| `id`            | æŸ¥è¯¢æ ‡è¯†ï¼Œè¡¨ç¤ºæŸ¥è¯¢æ‰§è¡Œé¡ºåºï¼Œè¶Šå¤§è¶Šåæ‰§è¡Œ                     |
| `select_type`   | æŸ¥è¯¢ç±»å‹ï¼ˆSIMPLE/PRIMARY/UNION/SUBQUERY ç­‰ï¼‰                 |
| `table`         | å½“å‰è¡Œæ•°æ®å¯¹åº”çš„è¡¨å                                         |
| `type`          | è¿æ¥ç±»å‹ / æ‰«æç±»å‹ï¼Œæ€§èƒ½æŒ‡æ ‡ï¼ˆæœ€å¥½ â†’ æœ€å·®ï¼š `const` â†’ `eq_ref` â†’ `ref` â†’ `range` â†’ `index` â†’ `ALL`ï¼‰ |
| `possible_keys` | å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•                                               |
| `key`           | å®é™…ä½¿ç”¨çš„ç´¢å¼•                                               |
| `key_len`       | ä½¿ç”¨ç´¢å¼•çš„é•¿åº¦                                               |
| `ref`           | å“ªä¸ªå­—æ®µæˆ–å¸¸é‡ä¸ç´¢å¼•åˆ—åŒ¹é…                                   |
| `rows`          | é¢„è®¡æ‰«æçš„è¡Œæ•°                                               |
| `Extra`         | é™„åŠ ä¿¡æ¯ï¼Œå¦‚ `Using where` / `Using index` / `Using temporary` / `Using filesort` |





##### 3.ä¼˜åŒ–æ€è·¯å‚è€ƒ

- type è¶Šé å‰ï¼ˆconst/eq_refï¼‰ â†’ æŸ¥è¯¢è¶Šå¿«
- é¿å… `ALL` æ‰«æå…¨è¡¨
- æ£€æŸ¥ Extra å­—æ®µï¼š
  - `Using where` â†’ æœ‰è¿‡æ»¤æ¡ä»¶
  - `Using index` â†’ ç´¢å¼•è¦†ç›–æŸ¥è¯¢ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
  - `Using temporary` / `Using filesort` â†’ å¯èƒ½å½±å“æ€§èƒ½
- æ ¹æ® `possible_keys` / `key` è°ƒæ•´ç´¢å¼•è®¾è®¡







## çº¿ä¸Šæ…¢SQLæ’æŸ¥



<img src="https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202509072112531.png" alt="image-20250907211222739" style="zoom:33%;" />



### æ…¢SQLæ’æŸ¥

**MySQL æ…¢æŸ¥è¯¢æ—¥å¿—**

- æ•°æ®åº“ç«¯å¼€å…³ `slow_query_log`
- é˜ˆå€¼ `long_query_time`ï¼ˆç§’çº§ï¼‰
- å¯é€‰è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„ SQL
- è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶ï¼Œä¸æŒ‰åº“è¿‡æ»¤ï¼Œéœ€è¦ `grep` æˆ– `performance_schema` æ¥åˆ†æ

**åº”ç”¨å±‚æ…¢ SQLï¼ˆDruidï¼‰**

- é€šè¿‡ `StatFilter` æ‹¦æˆª SQL
- é˜ˆå€¼ `slow-sql-millis`ï¼ˆæ¯«ç§’çº§ï¼‰
- å¯ç›´æ¥åœ¨æ—¥å¿—ä¸­æ‰“å°ï¼Œå•ç‹¬è¾“å‡ºæ…¢ SQL æ–‡ä»¶
- åªç»Ÿè®¡è¯¥ DataSource çš„åº“ï¼Œæ–¹ä¾¿é’ˆå¯¹åº”ç”¨æ’æŸ¥

**åŒºåˆ†**

- æ•°æ®åº“å…¨å±€æ…¢æŸ¥è¯¢ â†’ ç›‘æ§æ•´ä¸ªå®ä¾‹ï¼Œé€‚åˆ DBA
- åº”ç”¨å±‚æ…¢ SQL â†’ é’ˆå¯¹é¡¹ç›®/æœåŠ¡ï¼Œæ’æŸ¥æ€§èƒ½é—®é¢˜æ›´ç²¾å‡†



>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå‡å¦‚å“ˆï¼ŒSpringBoot + Mybatis + MySQLåœ¨Linuxä¸Šï¼Œæ­¤æ—¶å¦‚ä½•è¿›è¡Œä¼˜åŒ–å‘¢ï¼Œé¦–å…ˆè¦é€šè¿‡SpringBootçš„ymlé…ç½®ï¼Œé…ç½®ä¸Šç›¸å…³æ…¢sqlè®°å½•çš„é…ç½®ï¼Œç„¶ååœ¨æ…¢sqlè®°å½•çš„æ—¥å¿—ä¸­æŸ¥æ‰¾ï¼Œä¾‹å¦‚sqlæ‰§è¡Œè¶…è¿‡å¤šä¹…å°±è¢«å®šä¸ºæ…¢sqlå‘¢ï¼Ÿç„¶åä¸Šè¿°é…ç½®æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

#### 1ï¸âƒ£ é…ç½® MySQL æ…¢ SQL æ—¥å¿—

##### MySQL å±‚é…ç½®ï¼ˆLinux ä¸Šï¼‰

```sql
-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
-- æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆå•ä½ç§’ï¼Œè¶…è¿‡ 1 ç§’å°±è®°å½•ï¼‰
SET GLOBAL long_query_time = 1;
-- æ˜¯å¦åªè®°å½•æœªä½¿ç”¨ç´¢å¼•çš„ SQL
SET GLOBAL log_queries_not_using_indexes = 1;
-- æ—¥å¿—è¾“å‡ºæ–‡ä»¶ï¼ˆLinux é»˜è®¤ /var/lib/mysql/<hostname>.slowï¼‰
SHOW VARIABLES LIKE 'slow_query_log_file';
```

- **slow_query_log**ï¼šå¼€å¯æ…¢ SQL æ—¥å¿—
- **long_query_time**ï¼šè¶…è¿‡å¤šå°‘ç§’çš„æŸ¥è¯¢è®°å½•ä¸ºæ…¢ SQL
- **log_queries_not_using_indexes**ï¼šæœªä½¿ç”¨ç´¢å¼•çš„ SQL ä¹Ÿè®°å½•
- å¯ä»¥åœ¨ `my.cnf` æ°¸ä¹…ç”Ÿæ•ˆï¼š

```bash
[mysqld]
slow_query_log = ON
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 1
log_queries_not_using_indexes = ON
```

------

#### 2ï¸âƒ£ SpringBoot é…ç½®ï¼ˆymlï¼‰

- ç›®çš„æ˜¯åœ¨åº”ç”¨å±‚è®°å½• SQL æ‰§è¡Œæ—¶é—´ï¼Œå°¤å…¶ MyBatis SQL

```yml
mybatis:
  configuration:
    # å¼€å¯æ—¥å¿—æ‰“å° SQLï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/your_db?serverTimezone=UTC&useSSL=false
    username: your_user
    password: your_password
  jpa:
    properties:
      hibernate:
        generate_statistics: true # å¦‚æœç”¨ JPA/Hibernate
```

- å¦‚æœä½¿ç”¨ **MyBatis Plus æˆ– PageHelper**ï¼Œå¯ä»¥å¯ç”¨ **æ€§èƒ½åˆ†ææ’ä»¶**ï¼š

```java
@Bean
@Profile({"dev","test"}) // ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ä¸å¯ç”¨æ‰“å°
public PerformanceInterceptor performanceInterceptor() {
    PerformanceInterceptor performanceInterceptor = new PerformanceInterceptor();
    performanceInterceptor.setMaxTime(1000); // msï¼Œè¶…è¿‡ 1 ç§’çš„ SQL æŠ¥è­¦
    performanceInterceptor.setFormat(true);  // æ ¼å¼åŒ– SQL
    return performanceInterceptor;
}
```

- **maxTime** é…ç½®å°±æ˜¯åº”ç”¨å±‚çš„æ…¢ SQL é˜ˆå€¼

------





#### **Spring Boot + Druid + Logback** çš„å®Œæ•´æ–¹æ¡ˆï¼š

------

##### 1ï¸âƒ£ `application.yml` é…ç½®ï¼ˆåªå¼€å¯æ…¢ SQL è®°å½•ï¼‰

```
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/a_share_quant?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    username: root
    password: Q836184425

    # Druid è¿æ¥æ± å‚æ•°
    initialSize: 5
    minIdle: 5
    maxActive: 20
    maxWait: 60000
    validationQuery: SELECT 1
    testWhileIdle: true
    poolPreparedStatements: true
    maxPoolPreparedStatementPerConnectionSize: 20

    # Druid è¿‡æ»¤å™¨ï¼šstat ç”¨äºæ…¢ SQL
    filters: stat
    connection-properties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=1000
```

é‡ç‚¹ï¼š

- `druid.stat.slowSqlMillis=1000` â†’ è¶…è¿‡ 1 ç§’çš„ SQL è¢«è®¤ä¸ºæ…¢ SQL
- `filters: stat` â†’ ç»Ÿè®¡ SQLï¼ŒåŒ…æ‹¬æ…¢ SQL
- `mergeSql=true` â†’ åˆå¹¶ç›¸åŒ SQL æ–¹ä¾¿ç»Ÿè®¡

------

##### 2ï¸âƒ£ Logback é…ç½®å•ç‹¬è¾“å‡ºæ…¢ SQL

åœ¨ `src/main/resources` ä¸‹å»º `logback-spring.xml`ï¼š

```
<configuration>

    <!-- æ…¢ SQL æ—¥å¿—è¾“å‡º -->
    <appender name="SLOW_SQL_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/slow-sql.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/slow-sql.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} %-5level [%thread] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- æ…¢ SQL å•ç‹¬ logger -->
    <logger name="com.alibaba.druid.filter.stat.StatFilter" level="INFO" additivity="false">
        <appender-ref ref="SLOW_SQL_FILE"/>
    </logger>

    <!-- æ§åˆ¶å°è¾“å‡ºï¼ˆå¯é€‰ï¼‰ -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} %-5level [%thread] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>
</configuration>
```

âœ… åŠŸèƒ½è¯´æ˜ï¼š

1. æ‰€æœ‰æ…¢ SQL éƒ½ä¼šå†™åˆ° `logs/slow-sql.log`
2. æŒ‰å¤©åˆ‡åˆ†ï¼Œä¿ç•™æœ€è¿‘ 30 å¤©æ—¥å¿—
3. æ§åˆ¶å°ä»è¾“å‡ºæ™®é€šæ—¥å¿—ï¼Œä¸åˆ·æ…¢ SQL

------

è¿™æ ·é…ç½®åï¼š

- ç”Ÿäº§ç¯å¢ƒä¸ä¼šè¢«å¤§é‡ SQL åˆ·å±
- å¯ä»¥ç›´æ¥æ’æŸ¥æ…¢ SQL æ–‡ä»¶ï¼Œå®šä½é—®é¢˜
- åªç»Ÿè®¡ä½ é¡¹ç›®ä½¿ç”¨çš„åº“ `a_share_quant` çš„ SQL







#### 3ï¸âƒ£ ç”Ÿäº§ç¯å¢ƒåˆ†ææµç¨‹

1. **å¼€å¯æ…¢ SQL æ—¥å¿—**ï¼ˆMySQL + SpringBoot ç›‘æ§ï¼‰
2. **æ”¶é›†æ—¥å¿—**ï¼šLinux `/var/log/mysql/slow.log` æˆ–åº”ç”¨æ—¥å¿—
3. **åˆ†æ SQL**ï¼š
   - æ˜¯å¦æœ‰ç´¢å¼•æœªå‘½ä¸­
   - æ˜¯å¦å­˜åœ¨èŒƒå›´æŸ¥è¯¢æˆ–å…¨è¡¨æ‰«æ
   - æ˜¯å¦å¯ä»¥ç”¨è¦†ç›–ç´¢å¼•æˆ–åˆ†é¡µä¼˜åŒ–
4. **ä¼˜åŒ– SQL**ï¼š
   - æ·»åŠ /è°ƒæ•´ç´¢å¼•
   - åˆ†åŒºè¡¨æˆ–å†å²æ•°æ®å½’æ¡£
   - åˆ†é¡µæŸ¥è¯¢ï¼Œå‡å°‘å•æ¬¡æ‰«æé‡

------

#### 4ï¸âƒ£ æ¨èé˜ˆå€¼

- **å°å‹/ä¸­å‹è¡¨**ï¼š1 ç§’
- **å¤§è¡¨ï¼ˆåƒä¸‡çº§ä»¥ä¸Šï¼‰**ï¼š2~5 ç§’
- **æå¤§æ•°æ®é‡ï¼ˆäº¿çº§ï¼‰**ï¼š10 ç§’

> é˜ˆå€¼è®¾ç½®è¿‡ä½æ—¥å¿—é‡è¿‡å¤§ï¼Œè¿‡é«˜å¯èƒ½æ¼æ‰æ…¢ SQL

------

#### æ€»ç»“

> **MySQL æ…¢ SQL + SpringBoot MyBatis ç›‘æ§**
>
> 1. MySQL å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆlong_query_timeï¼‰
> 2. SpringBoot å¯ä»¥ç”¨æ€§èƒ½åˆ†ææ’ä»¶ï¼ˆmaxTimeï¼‰
> 3. æ”¶é›†æ—¥å¿—ï¼Œåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µã€æ‰«æè¡Œæ•°
> 4. ä¼˜åŒ– SQLï¼šç´¢å¼•/åˆ†é¡µ/åˆ†åŒº/è¦†ç›–ç´¢å¼•

------









- **MySQL æ…¢æŸ¥è¯¢æ—¥å¿—** â†’ æ•°æ®åº“ç«¯ï¼Œè®°å½•å…¨å®ä¾‹ SQL
- **Druid æ…¢ SQL** â†’ åº”ç”¨ç«¯ï¼Œé€šè¿‡è¿æ¥æ± æ‹¦æˆªï¼Œè®°å½•åº”ç”¨è‡ªèº«çš„æ…¢ SQL