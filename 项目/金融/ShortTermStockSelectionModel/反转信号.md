# 反转信号

## 一、功能说明



### 1.推广文案

> 标题：波段低位池和高位风险池：您的投资稳赚助手

正文：
作为股票投资者，您可能会遇到一个常见的问题：如何在市场波动的环境下获得稳定的收益？波段低位池和高位风险池是解决这个问题的最佳选择。
我们的团队每天都会根据市场趋势和数据，筛选出最具潜力的股票，并将它们分为波段低位池和高位风险池。波段低位池中的股票具有较低的风险和较高的收益潜力，而高位风险池中的股票具有高收益潜力，但也有相应的风险。
我们提醒用户，在高位风险池中的股票可能存在风险，需要谨慎投资。我们建议用户在投资前仔细研究股票的基本面和市场趋势，以做出明智的投资决策。
今年以来，我们在波段低位池和高位风险池中选出的股票实测盈利概率高达0.848，具有非常高的成功率。我们使用最先进的技术和分析工具，以确保我们选出的股票具有最大的潜力和最小的风险。
我们的投资策略是买入并持有一段时间，以确保您获得最大的收益。我们相信，这是获得最大收益的最佳方式。我们的投资组合已经经过严格的测试和验证，它们是市场上最优质的股票之一。
波段低位池和高位风险池是您的投资稳赚助手。我们提供各种工具和功能，帮助您轻松地搜索和分析股票，以做出最佳的投资决策。我们致力于通过提供最好的投资工具和支持，帮助您获得成功。
如果您想要获得稳定的收益并成为一名成功的股票投资者，那么请联系我们，了解更多关于我们波段低位池和高位风险池的信息。让我们一起开始您的投资之旅吧！




### 2.回测数据

>2023-01-01~2023-05-30固定20个交易日卖出

设买入和及卖出一次交易盈利3%即为交易成功

| 入选日期  | 初始资金 | 期末资金 | 总收益率 | 交易次数 | 交易成功次数 | 胜率     |
| --------- | -------- | -------- | -------- | -------- | ------------ | -------- |
| 2023/1/4  | 100000   | 115370.8 | 0.153708 | 3        | 3            | 1        |
| 2023/1/5  | 100000   | 108533.2 | 0.085332 | 1        | 1            | 1        |
| 2023/1/6  | 100000   | 105232.6 | 0.052326 | 1        | 1            | 1        |
| 2023/1/10 | 100000   | 100453.3 | 0.004533 | 1        | 1            | 1        |
| 2023/1/12 | 100000   | 107851   | 0.07851  | 1        | 1            | 1        |
| 2023/1/16 | 100000   | 107819.9 | 0.078199 | 3        | 3            | 1        |
| 2023/1/18 | 100000   | 105830.9 | 0.058309 | 1        | 1            | 1        |
| 2023/1/19 | 100000   | 107204.4 | 0.072044 | 5        | 5            | 1        |
| 2023/1/20 | 100000   | 107781   | 0.07781  | 8        | 8            | 1        |
| 2023/2/7  | 100000   | 99241.1  | -0.00759 | 1        | 0            | 0        |
| 2023/2/8  | 100000   | 100636.4 | 0.006364 | 4        | 3            | 0.75     |
| 2023/2/9  | 100000   | 108290.3 | 0.082903 | 2        | 2            | 1        |
| 2023/2/10 | 100000   | 102882.9 | 0.028829 | 5        | 4            | 0.8      |
| 2023/2/13 | 100000   | 100805.6 | 0.008056 | 4        | 2            | 0.5      |
| 2023/2/14 | 100000   | 107125.2 | 0.071252 | 2        | 1            | 0.5      |
| 2023/2/15 | 100000   | 97662.5  | -0.02338 | 2        | 1            | 0.5      |
| 2023/2/16 | 100000   | 88578.95 | -0.11421 | 1        | 0            | 0        |
| 2023/2/17 | 100000   | 108751.7 | 0.087517 | 2        | 2            | 1        |
| 2023/2/20 | 100000   | 98383.97 | -0.01616 | 6        | 2            | 0.333333 |
| 2023/2/21 | 100000   | 102479.6 | 0.024796 | 6        | 2            | 0.333333 |
| 2023/2/22 | 100000   | 109459.7 | 0.094597 | 4        | 4            | 1        |
| 2023/2/23 | 100000   | 110231   | 0.10231  | 1        | 1            | 1        |
| 2023/2/24 | 100000   | 99109.24 | -0.00891 | 2        | 1            | 0.5      |
| 2023/2/27 | 100000   | 106372.1 | 0.063721 | 2        | 1            | 0.5      |
| 2023/2/28 | 100000   | 107359.9 | 0.073599 | 8        | 7            | 0.875    |
| 2023/3/1  | 100000   | 110394.2 | 0.103942 | 23       | 18           | 0.782609 |
| 2023/3/2  | 100000   | 104803.8 | 0.048038 | 7        | 5            | 0.714286 |
| 2023/3/3  | 100000   | 107554.3 | 0.075543 | 1        | 1            | 1        |
| 2023/3/8  | 100000   | 101619.9 | 0.016199 | 2        | 1            | 0.5      |
| 2023/3/9  | 100000   | 106326.4 | 0.063264 | 8        | 7            | 0.875    |
| 2023/3/10 | 100000   | 107895.2 | 0.078952 | 5        | 5            | 1        |
| 2023/3/13 | 100000   | 110791.9 | 0.107919 | 4        | 4            | 1        |
| 2023/3/15 | 100000   | 118314.4 | 0.183144 | 5        | 5            | 1        |
| 2023/3/16 | 100000   | 106232.9 | 0.062329 | 2        | 2            | 1        |
| 2023/3/17 | 100000   | 115364.1 | 0.153641 | 25       | 25           | 1        |
| 2023/3/20 | 100000   | 114041.6 | 0.140416 | 25       | 25           | 1        |
| 2023/3/21 | 100000   | 122929.1 | 0.229291 | 4        | 4            | 1        |
| 2023/3/22 | 100000   | 122123.8 | 0.221238 | 7        | 7            | 1        |
| 2023/3/23 | 100000   | 114099.6 | 0.140996 | 2        | 2            | 1        |
| 2023/3/24 | 100000   | 101227.8 | 0.012278 | 1        | 1            | 1        |
| 2023/3/27 | 100000   | 106714.3 | 0.067143 | 1        | 1            | 1        |
| 2023/3/28 | 100000   | 113783.5 | 0.137835 | 2        | 2            | 1        |
| 2023/3/29 | 100000   | 135678.6 | 0.356786 | 4        | 4            | 1        |
| 2023/3/30 | 100000   | 119013.3 | 0.190133 | 2        | 2            | 1        |
| 2023/3/31 | 100000   | 119258.3 | 0.192583 | 7        | 7            | 1        |
| 2023/4/3  | 100000   | 118346.6 | 0.183466 | 18       | 18           | 1        |
| 2023/4/4  | 100000   | 128982.8 | 0.289828 | 3        | 3            | 1        |
| 2023/4/6  | 100000   | 120275.6 | 0.202756 | 1        | 1            | 1        |
| 2023/4/7  | 100000   | 115368.3 | 0.153683 | 2        | 2            | 1        |
| 2023/4/11 | 100000   | 115116.8 | 0.151168 | 6        | 6            | 1        |
| 2023/4/12 | 100000   | 119872.8 | 0.198728 | 4        | 4            | 1        |
| 2023/4/13 | 100000   | 126061.3 | 0.260613 | 2        | 2            | 1        |
| 2023/4/14 | 100000   | 109072.2 | 0.090722 | 2        | 1            | 0.5      |
| 2023/4/19 | 100000   | 157886.8 | 0.578868 | 1        | 1            | 1        |
| 2023/4/20 | 100000   | 109120.8 | 0.091208 | 1        | 1            | 1        |
| 2023/4/21 | 100000   | 111068   | 0.11068  | 2        | 2            | 1        |
| 2023/4/24 | 100000   | 105810.8 | 0.058108 | 1        | 1            | 1        |
| 2023/4/25 | 100000   | 95081.71 | -0.04918 | 2        | 0            | 0        |
| 2023/4/26 | 100000   | 115239   | 0.15239  | 6        | 6            | 1        |
| 2023/4/27 | 100000   | 116000   | 0.16     | 1        | 1            | 1        |
| 2023/4/28 | 100000   | 113889.4 | 0.138894 | 14       | 11           | 0.785714 |

胜率为将10万本金均分买入波段地位中的股票列表，最终获得的平均胜率







### 3.使用示例

>波段底位

![image-20230703142427083](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202307031424529.png)





>高位风险

![image-20230703142459154](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202307031424490.png)









## 二、核心算法



### 1.九转序列

```bash
N赋值:到最后交易的周期
B赋值:收盘价<4日前的收盘价
T1赋值: 条件连续成立次数
A_B1赋值:(T1>9) AND T1关于9的模=1
A_B2赋值:(T1>9) AND T1关于9的模=2
A_B8赋值:(T1>9) AND T1关于9的模=8
A_B9赋值:(T1>9) AND T1关于9的模=0
B1赋值:(N=6 AND 5日后的(未作平滑处理)统计6日中满足B的天数=6) OR (N=7 AND 6日后的(未作平滑处理)统计7日中满足B的天数=7) OR (N=8 AND 7日后的(未作平滑处理)统计8日中满足B的天数=8) OR (N>=9 AND 8日后的(未作平滑处理)统计9日中满足B的天数=9)
当满足条件B1AND(1日前的B=0ORA_B1)时,在最低价位置书写数字,画洋红色
B2赋值:(N=5 AND 4日后的(未作平滑处理)统计6日中满足B的天数=6) OR (N=6 AND 5日后的(未作平滑处理)统计7日中满足B的天数=7) OR (N=7 AND 6日后的(未作平滑处理)统计8日中满足B的天数=8) OR (N>=8 AND 7日后的(未作平滑处理)统计9日中满足B的天数=9)
当满足条件B2AND(2日前的B=0ORA_B2)时,在最低价位置书写数字,画洋红色
B8赋值:(N=1 AND 统计8日中满足B的天数=8) OR (N>=2 AND 1日后的(未作平滑处理)统计9日中满足B的天数=9)
当满足条件B8AND(8日前的B=0ORA_B8)时,在最低价位置书写数字,画洋红色
B9赋值:(N>=1 AND 统计9日中满足B的天数=9)
当满足条件B9AND(9日前的B=0ORA_B9)时,在最低价位置书写数字,画棕色
S赋值:收盘价>4日前的收盘价
T2赋值: 条件连续成立次数
A_S1赋值:(T2>9) AND T2关于9的模=1
A_S2赋值:(T2>9) AND T2关于9的模=2
A_S8赋值:(T2>9) AND T2关于9的模=8
A_S9赋值:(T2>9) AND T2关于9的模=0
S1赋值:(N=6 AND 5日后的(未作平滑处理)统计6日中满足S的天数=6) OR (N=7 AND 6日后的(未作平滑处理)统计7日中满足S的天数=7) OR (N=8 AND 7日后的(未作平滑处理)统计8日中满足S的天数=8) OR (N>=9 AND 8日后的(未作平滑处理)统计9日中满足S的天数=9)
当满足条件S1AND(1日前的S=0ORA_S1)时,在最高价位置书写数字,画洋红色,显示在位置之上
S2赋值:(N=5 AND 4日后的(未作平滑处理)统计6日中满足S的天数=6) OR (N=6 AND 5日后的(未作平滑处理)统计7日中满足S的天数=7) OR (N=7 AND 6日后的(未作平滑处理)统计8日中满足S的天数=8) OR (N>=8 AND 7日后的(未作平滑处理)统计9日中满足S的天数=9)
当满足条件S2AND(2日前的S=0ORA_S2)时,在最高价位置书写数字,画洋红色,显示在位置之上
S8赋值:(N=1 AND 统计8日中满足S的天数=8) OR (N>=2 AND 1日后的(未作平滑处理)统计9日中满足S的天数=9)
当满足条件S8AND(8日前的S=0ORA_S8)时,在最高价位置书写数字,画洋红色,显示在位置之上
S9赋值:(N>=1 AND 统计9日中满足S的天数=9)
当满足条件S9AND(9日前的S=0ORA_S9)时,在最高价位置书写数字,画绿色,显示在位置之上
```



#### 转义表达式

假设#1~#14均为依次连续且倒序(从后往前)的交易日

>红9表达式：

```java
#9 < #13 and #8 < #12 and #7 < #11 and #6 < #10 and #5 < #9 and #4 < #8 and #3 < #7 and #2 < #6 and #1 < #5 and #10 > #14
```

说明：收盘价 < 4日前的收盘价(前复权)连续成立次数N

- 当N % 9 == 1 则为红1

- 当N % 9 == 2 则为红2

- 当N % 9 == 8 则为红8

- 当N % 9 == 0 则为**红9**

  

> 绿九表达式：

```java
#9 > #13 and #8 > #12 and #7 > #11 and #6 > #10 and #5 > #9 and #4 > #8 and #3 > #7 and #2 > #6 and #1 > #5 and #10 < #14
```

刚好与上述红9表达式相反

说明：收盘价 > 4日前的收盘价(前复权)连续成立次数N

- 当N % 9 == 1 则为绿1
- 当N % 9 == 2 则为绿2
- 当N % 9 == 8 则为绿8
- 当N % 9 == 0 则为**绿9**



注：红9和绿9在成立次数N % 9  == 0的基础上开始边界交易日都要不满足才可！

对应：

​		绿9为：#10 < #14

​		红9为：#10 > #14





### 2.上升通道

```bash
4.3	算法说明
1.	筛选股票算法：
a)	均线筛选法：
	根据日线计算
#MA5：5日平均线
	判断条件：MA5>MA10>MA20
	连续5根K线满足判断条件时，提示为上升通道股
	盘中实时计算，触发条件即提示
b)	MACD筛选法：
	判断条件：MACD 指标 DEA线和DIFF线连续N天同时在零轴以上
	周期：N取20
	计算方法：DIFF = EMA（CLOSE,12) – EMA（CLOSE,26）
DEA = EMA(DIFF,9)
	判断条件算法：BARSLAST(REF(DIFF > 0 and DEA > 0)) 
（判断最后一根k线的DIFF和DEA的值大于0）
c)	 BOLL筛选法：
说明：目前筛选用a）均线筛选法和b）MACD筛选法，取并集

2.	通道持续时间是指：连续符合条件的K线数（显示整数）
上升通道时间的算法：以均线筛选法优先，如果满足均线筛选法，则上升通道的时间为满足均线上升通道的时间；如果不满足均线筛选法，则考虑是否满足MACD筛选法，若满足，则上升通道的时间为满足MACD上升通道的时间。

3.	阻力位价格：
a)	LLV(LOW，N) + [HHV(HIGH，N) – LLV(LOW，N)] * 1.618 
b)	（N取20）
4.	支撑位价格：日线的MA10
5.	距阻力位幅度：（阻力位 - 最新价）/最新价*100%
6.	距支撑位幅度：（最新价 - 支撑位）/最新价*100%

4.4	说明
4.4.1	帮助文本
【模块介绍】上升通道用于筛选沪深A股处于上升通道的个股，向用户展示该个股处于上升通道的形态持续时间，短线支撑位，短线阻力位，距支撑位幅度，距阻力位幅度
【风险揭示】上升通道仅是提供决策参考的信息，用户不可都视为买卖时机建议，用户依此投资决策产生的盈亏，公司不承担任何责任
【计算方法】通道维持时间指连续符合条件的个股周期；短线支撑位指在上升通道个股短线股价支撑价位，距支撑位幅度 = （最新价 – 短线支撑位）/最新价*100%；短线阻力位是指在上升通道个股短线股价阻力价位，距阻力位幅度 = （阻力位-最新价）/最新价*100%
```













## 三、表设计



### 1.表设计

采用MySQL数据库录入数据





### 2.表结构

```sql
USE `wstock_crmservice_db`;
DROP TABLE IF EXISTS `tb_stock_analysis_selection`;
CREATE TABLE `tb_stock_analysis_selection` (
  `selection_id` int(11) NOT NULL AUTO_INCREMENT COMMENT '选股id(自增)',
  `wind_code` varchar(20) NOT NULL COMMENT '股票代码',
  `wind_name` varchar(20) NOT NULL COMMENT '股票名称',
  `choice_type` tinyint(4) NOT NULL DEFAULT '1' COMMENT '入选类型:0.高位风险 1.波段低位(默认)',
  `topics` varchar(100) NOT NULL COMMENT '所属题材',
  `st_flag` tinyint(4) NOT NULL DEFAULT '0' COMMENT '是否ST:0.否(默认),1.是',
  `choice_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '入选时间(单位/天)',
  `choice_price` decimal(10,2) NOT NULL COMMENT '入选价格',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '数据状态:1.正常(默认),0.无效',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`selection_id`)
) ENGINE=InnoDB AUTO_INCREMENT=3173 DEFAULT CHARSET=utf8 COMMENT='股票分析-选股信息表';
```







### 3.录入数据示例

```sql
insert  into `tb_stock_analysis_selection`(`selection_id`,`wind_code`,`wind_name`,`choice_type`,`topics`,`st_flag`,`choice_time`,`choice_price`,`status`,`create_time`,`update_time`) values (618,'000066.SZ','中国长城',0,'中特估;AI算力',0,'2022-01-04 00:00:00','14.60',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(619,'000731.SZ','四川美丰',0,'小市值;预增',0,'2022-01-04 00:00:00','10.11',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(620,'000925.SZ','众合科技',0,'数字水印;硅能源',0,'2022-01-04 00:00:00','9.28',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(621,'002025.SZ','航天电器',0,'中盘股;信创产业',0,'2022-01-04 00:00:00','82.37',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(622,'002088.SZ','鲁阳节能',0,'小盘股;消费建材',0,'2022-01-04 00:00:00','24.84',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(623,'002413.SZ','雷科防务',0,'雷达;小市值',0,'2022-01-04 00:00:00','7.40',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(624,'002465.SZ','海格通信',0,'6G;小盘股',0,'2022-01-04 00:00:00','10.78',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(625,'002755.SZ','奥赛康',0,'小盘股;纳入富时罗素',0,'2022-01-04 00:00:00','12.72',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(626,'002985.SZ','北摩高科',0,'中盘股;航空装备精选',0,'2022-01-04 00:00:00','96.67',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(627,'300137.SZ','先河环保',0,'小市值;大气治理',0,'2022-01-04 00:00:00','7.73',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(628,'300348.SZ','长亮科技',0,'小盘股;跨境支付',0,'2022-01-04 00:00:00','16.34',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(629,'300394.SZ','天孚通信',0,'6G;AI算力',0,'2022-01-04 00:00:00','35.85',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(630,'300395.SZ','菲利华',0,'小盘股;金属非金属新材料精选',0,'2022-01-04 00:00:00','43.69',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(631,'300398.SZ','飞凯材料',0,'小盘股;化学制品精选',0,'2022-01-04 00:00:00','26.36',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(632,'300400.SZ','劲拓股份',0,'小市值;显示屏制造装备',0,'2022-01-04 00:00:00','21.93',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(633,'300412.SZ','迦南科技',0,'小市值',0,'2022-01-04 00:00:00','14.17',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(634,'300620.SZ','光库科技',0,'6G;雷达',0,'2022-01-04 00:00:00','50.71',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(635,'430139.BJ','华岭股份',0,'',0,'2022-01-04 00:00:00','20.26',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(636,'600009.SH','上海机场',0,'机场精选;大盘股',0,'2022-01-04 00:00:00','48.52',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(637,'600038.SH','中直股份',0,'中盘股;航空装备精选',0,'2022-01-04 00:00:00','79.15',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(638,'600251.SH','冠农股份',0,'小市值;棉花',0,'2022-01-04 00:00:00','9.59',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(639,'600273.SH','嘉化能源',0,'小盘股;氢能',0,'2022-01-04 00:00:00','10.96',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(640,'600416.SH','湘电股份',0,'小盘股;电源设备精选',0,'2022-01-04 00:00:00','21.70',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(641,'600900.SH','长江电力',0,'超大盘股;数字能源',0,'2022-01-04 00:00:00','22.09',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(642,'600984.SH','建设机械',0,'小盘股;小市值',0,'2022-01-04 00:00:00','8.49',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(643,'601111.SH','中国国航',0,'国泰君安金股;大盘股',0,'2022-01-04 00:00:00','9.45',1,'2023-04-23 14:00:48','2023-04-23 14:00:48'),(3130,'601238.SH','广汽集团',0,'换电站;大盘股',0,'2022-04-20 00:00:00','11.79',1,'2023-04-23 14:23:55','2023-04-23 14:23:55'),(3131,'601606.SH','长城军工',0,'小市值;军民融合',0,'2022-04-20 00:00:00','12.06',1,'2023-04-23 14:23:55','2023-04-23 14:23:55'),(3168,'002862.SZ','实丰文化',1,'微盘股;小市值',0,'2022-12-30 00:00:00','14.67',1,'2023-04-26 16:04:52','2023-04-26 16:04:52'),(3169,'002235.SZ','安妮股份',0,'ChatGPT;AIGC',0,'2022-12-30 00:00:00','7.41',1,'2023-04-26 16:04:52','2023-04-26 16:04:52'),(3170,'002531.SZ','天顺风能',0,'中盘股;碳中和',0,'2022-12-30 00:00:00','15.13',1,'2023-04-26 16:04:52','2023-04-26 16:04:52'),(3171,'301363.SZ','美好医疗',0,'融资融券标的',0,'2022-12-30 00:00:00','41.91',1,'2023-04-26 16:04:52','2023-04-26 16:04:52'),(3172,'688261.SH','东微半导',0,'科技龙头;私募重仓',0,'2022-12-30 00:00:00','237.00',1,'2023-04-26 16:04:52','2023-04-26 16:04:52');
```








## 四、接口实现



### 1.接口概述

> 为实现此功能，共计开发9接口：

#### 1.获取eqs选股请求参数

##### 请求方式

```java
Get
```



##### 接口路径

```java
/stock_analysis/get_eqs_param
```



##### 接口概述

主要为获取九转序列股票代码，整合eqs请求参数







#### 2.根据命令获取eqs选股数据

##### 请求方式

```java
Post
```



##### 请求路径

```java
/stock_analysis/get_eqs
```



##### 接口概述

通过接口1中整合的eqs请求参数，请求eqs获取九转序列股票数据，并解析









#### 3.获取板块信息列表

##### 请求方式

```java
Get
```



##### 请求路径



```java
/stock_analysis/get_sector_list
```



##### 接口概述

获取所有板块信息数据列表(在最终的选股列表中用作筛选)







#### 4.获取板块下股票信息列表

##### 请求方式

```java
Get
```



##### 请求路径

```java
/stock_analysis/get_sector_codes
```





##### 接口概述

传入需要筛选的板块信息，查询当前板块信息下拥有的股票列表







#### 5.获取上升通道Set股票代码

##### 请求方式

```java
Get
```



##### 请求路径

```java
/stock_analysis/get_rising_sector
```



##### 接口概述

获取上升通道算法筛选出来的所有股票并将其组装成Set集合





#### 6.九转+上升通道列表数据

##### 请求方式

```java
Get
```



##### 请求路径

```java
/stock_analysis/get_shift_list
```



##### 接口概述

根据传入的转档获取包含在上升通道股票列表中的红九与单独不包含上升通道绿九的股票列表





#### 7.获取股票分析列表

##### 请求方式

```java
Get
```



##### 请求路径

```java
/stock_analysis/get_stock_list
```



##### 接口概述

通过获取的股票列表再度增加筛选提出最终展示股票列表





#### 8.插入转档列表

##### 请求方式

```java
Post
```



##### 请求路径

```java
/stock_analysis/insert_shift_list
```



##### 接口概述

将初步筛选出来的股票列表插入表中





#### 9.重置股票分析转档数据

##### 请求方式

```java
Post
```



##### 请求路径

```java
/stock_analysis/reset_stock_job
```



##### 接口概述

先删除输入日期中插入的股票列表数据，重新再调用接口获取股票列表数据再插入(重置)











### 2.核心接口

#### 获取上升通道Set股票代码

##### 请求方式

```java
Get
```



##### 接口路径

```java
/stock_analysis/get_rising_sector
```





##### 核心代码

```java
    /**
     * 获取上升通道数据
     *
     * @param indicatorIds   指标ID列表:3(默认)
     * @param orderedInd     需排序的指标id，无排序添0
     * @param orderDirection 排序方向, =0不排序，=1升序，=2降序
     * @param pageNo         当前页码(默认1)
     * @param pageSize       页面大小(默认最大1000)
     * @return 上升通道数据
     */
    @Override
    public Set<String> getRisingSectorList(Integer indicatorIds, Integer orderedInd, Integer orderDirection, Integer pageNo, Integer pageSize) {
        Set<String> risingSectorSet = new HashSet<>();
        //setTotalNum : set结果集总数,resultNum
        Integer setTotalNum = 0, resultNum = pageSize;
        while (setTotalNum < resultNum) {
            String risingSectorUrl = String.format(this.risingSectorUrl, indicatorIds, orderedInd, orderDirection, pageNo, pageSize);
            PageInfoVO<SectorVO> risingSector = getResponseRisingSector(risingSectorUrl);
            resultNum = risingSector.getTotal();
            Collection<SectorVO> risingSectorList = risingSector.getData();
            pageNo += 1;
            //加入结果集
            for (SectorVO sectorVO : risingSectorList) {
                if (sectorVO == null) {
                    continue;
                }
                risingSectorSet.add(sectorVO.getWindCode());
            }
            setTotalNum += risingSectorList.size();
        }
        log.info("risingSectorSet.size()={}", risingSectorSet.size());
        return risingSectorSet;
    }
```



##### 接口说明

上升通道股票列表数据主要来源于上升通道算法筛选A股所有股票得出。此处直接调用cloud获取数据无实际算法筛选逻辑











#### 九转+上升通道列表数据

##### 请求方式

```java
Get
```



##### 接口路径

```java
/stock_analysis/get_shift_list
```



##### 核心代码

```java
    /**
     * 九转上升收盘转档列表
     *
     * @param shiftDate 转档存储日期
     * @param userId    用户id
     * @return 转档存储结果
     */
    @Override
    public List<AscendingNineTurnsShiftDTO> getAscendingNineTurnsShiftList(String shiftDate, Integer userId) {
        List<AscendingNineTurnsShiftDTO> nineTurnsShiftList = new ArrayList<>();
        //获取上升通道集合
        risingSectorSet = getRisingSectorList(3, 3, 1, 1, 1000);

        //根据入选日期获取九转请求xml参数
        String redNineTurnsEqsParam = getEqsParam(-1, shiftDate, redNineTurnsGreenXml, userId);
        String greenNineTurnsEqsParam = getEqsParam(-1, shiftDate, greenNineTurnsGreenXml, userId);

        //红九绿九
        List<List<Object>> redNineTurnsEqsList = getEqs(redNineTurnsEqsParam);
        List<List<Object>> greenNineTurnsEqsList = getEqs(greenNineTurnsEqsParam);
        log.info("shiftDate={},redNineTurnsEqsList.size={},greenNineTurnsEqsList.size={}", shiftDate, redNineTurnsEqsList.size(), greenNineTurnsEqsList.size());

        //遍历组装结果集
        nineTurnsShiftList.addAll(getResultNineTurnList(redNineTurnsEqsList, shiftDate, CHOICE_TYPE_LOW, RISING_SECTOR_FLAG_YES));
        nineTurnsShiftList.addAll(getResultNineTurnList(greenNineTurnsEqsList, shiftDate, CHOICE_TYPE_HIGH, RISING_SECTOR_FLAG_NO));
        return nineTurnsShiftList;
    }
```



##### 接口说明

1. 获取正在上升通道的股票列表
2. 随后获取九转序列中红九股票列表(注：红九股票列表需要与上升通道股票列表取交集后的股票列表才是地位选股池股票列表)
3. 绿九股票列表则无需与上升通道列表取交集。直接放入高位风险池中








#### 获取股票分析列表

##### 请求方式

```java
Get
```



##### 请求路径

```java
/stock_analysis/get_stock_list
```





##### 核心代码

```java
    /**
     * 获取股票分析列表
     *
     * @param choiceTime    入选时间(交易日到日)
     * @param sectorCodes   所属板块(code)
     * @param choiceType    入选类型:0.高位风险 1.波段低位(默认)
     * @param stFlag        是否ST:0.否(默认),1.是
     * @param eliminateFlag 是否剔除：0.否,1.是(默认)
     * @param pageNo        当前页码(默认1)
     * @param pageSize      页面大小(默认10)
     * @param userId        用户id
     * @return 股票分析列表
     */
    @Override
    public List<StockAnalysisDTO> getStockAnalysisList(String choiceTime, String sectorCodes,
                                                       Integer choiceType, Integer stFlag, Integer eliminateFlag, Integer pageNo, Integer pageSize, Integer userId) {
        List<StockAnalysisDTO> stockAnalysisList = new ArrayList<>();
        //实际入选日期为上一个交易日
        String lastTradingDate = getTradingDateByBaseNum(choiceTime, -1, userId);
        if (lastTradingDate == null) {
            throw new BusinessException(ResultEnum.FAILED_TO_OBTAIN_DATA.getCode(), ResultEnum.FAILED_TO_OBTAIN_DATA.getMessage());
        }
        //避免临界值问题 limitChoiceTime = 次日凌晨00:00:00(现有逻辑其实就是今天)
        String limitChoiceTime = DateUtil.stringTimeToAdjust(DateUtil.getFormatStrByDate(lastTradingDate, DateFormatConstants.YMD_FORMAT_STR, DateFormatConstants.YMD_FORMAT_RAIL_STR), 1);
        List<StockAnalysisDTO> stockAnalysisDataList = stockAnalysisMapper.getStockAnalysisList(lastTradingDate, limitChoiceTime, choiceType, stFlag, (pageNo - 1) * pageSize, pageSize * pageNo);
        //2023-02-28日涨跌幅 <= lowThresholdValue(-0.01) 则continue, lastTradingDate=20230227
        List<StockAnalysisDTO> stockAnalysisDataScreenOut = getStockAnalysisDataScreenOut(stockAnalysisDataList, choiceTime, eliminateFlag, 0, lowThresholdValue, highThresholdValue, userId);
        //sectorCodeList调板块服务查询当前筛选板块下的List<stock>,然后与下列数据库返回数据取交集作为最终结果
        if (StringUtils.hasLength(sectorCodes)) {
            Set<String> sectorWindCodesSet = stockAnalysisService.getSectorWindCodes(sectorCodes, userId);
            for (StockAnalysisDTO stockAnalysisDTO : stockAnalysisDataScreenOut) {
                //不满足筛选条件提前跳过
                if (!sectorWindCodesSet.contains(stockAnalysisDTO.getWindCode())) {
                    continue;
                }
                stockAnalysisList.add(stockAnalysisDTO);
            }
        } else {
            stockAnalysisList = stockAnalysisDataScreenOut;
        }
        //获取days个交易日后收盘价List
        Map<String, Double> changRangeByT5 = getChangRangeByNum(stockAnalysisList, choiceTime, 5, userId);
        Map<String, Double> changRangeByT20 = getChangRangeByNum(stockAnalysisList, choiceTime, 20, userId);

        //组装结果集
        if (changRangeByT5.size() != 0 || changRangeByT20.size() != 0) {
            for (int i = 0; i < stockAnalysisList.size(); i++) {
                //n个交易日后收益(本保留4位小数,X 100后保留两位即可) = (n个交易日后收盘价 - 入选日收盘价) / 入选日收盘价 * 100
                Double choicePrice = stockAnalysisList.get(i).getChoicePrice();
                Double changRangeByT5Value = changRangeByT5.get(stockAnalysisList.get(i).getWindCode());
                Double changRangeByT20Value = changRangeByT20.get(stockAnalysisList.get(i).getWindCode());
                if (changRangeByT5Value != null) {
                    Double changRangeByDayValue = getChangRangeByDayValue(choicePrice, changRangeByT5Value);
                    log.info("i={},changRangeByT5Value={},setT5ChangRange={}", i, changRangeByT5Value, changRangeByDayValue);
                    stockAnalysisList.get(i).setT5ChangRange(changRangeByDayValue);
                }
                if (changRangeByT20Value != null) {
                    Double changRangeByDayValue = getChangRangeByDayValue(choicePrice, changRangeByT20Value);
                    log.info("changRangeByT20Value={},setT20ChangRange={}", changRangeByT20Value, changRangeByDayValue);
                    stockAnalysisList.get(i).setT20ChangRange(changRangeByDayValue);
                }
            }
        }
        return stockAnalysisList;
    }
```









##### 接口说明

> 通过获取的股票列表再度增加筛选提出最终展示股票列表

在此前转档至表中的数据再进行一个剔除、筛选等逻辑。然后最种以自定义的阀值动态剔除选股池中的股票。核心代码为：

```java
    /**
     * 根据阀值剔除不满足股票,并返回剩余有效股票列表(将当前收盘价改为次日开盘价)
     *
     * @param stockAnalysisDataList 待筛选列表
     * @param choiceTime            实际股票列表入选时间
     * @param eliminateFlag         是否剔除：0.否,1.是(默认)
     * @param day                   根据lastTradingDate前几个交易日
     * @param lowThresholdValue     选股筛选阀值
     * @param userId                用户id
     * @return 剩余有效股票列表
     */
    private List<StockAnalysisDTO> getStockAnalysisDataScreenOut(List<StockAnalysisDTO> stockAnalysisDataList, String choiceTime, Integer eliminateFlag, Integer day, Double lowThresholdValue, Double highThresholdValue, Integer userId) {
        //传入choiceTime = 今日 || > 今日则无需判断,一定拿不到数据
        if (DateUtil.getCurrentDateTimeByStr(DateFormatConstants.YMD_FORMAT_RAIL_STR).equals(choiceTime) || DateUtil.compareDates(choiceTime, DateUtil.getCurrentDateTimeByStr(DateFormatConstants.YMD_FORMAT_RAIL_STR), DateFormatConstants.YMD_FORMAT_RAIL_STR)) {
            log.error("getStockAnalysisList,choiceTimeError!={}", choiceTime);
            for (StockAnalysisDTO stockAnalysisDTO : stockAnalysisDataList) {
                stockAnalysisDTO.setChoiceTime(choiceTime);
            }
            return stockAnalysisDataList;
        }
        if (stockAnalysisDataList == null || stockAnalysisDataList.size() == 0) {
            log.error("getStockAnalysisDataScreenOutError!stockAnalysisDataList.size=0");
            return stockAnalysisDataList;
        }
        List<StockAnalysisDTO> stockAnalysisDataScreenOut = new ArrayList<>();
        //拿当前股票列表day(0(28号))的收盘价Map
        Map<String, Double> changRangeByLast = getChangRangeByNum(stockAnalysisDataList, choiceTime, day, userId);

        //获取2023-02-28日(27日的股票列表)股票列表的开盘价Map
        Map<String, Double> startOpeningPriceMap = getOpeningPriceMap(stockAnalysisDataList, choiceTime, userId);
        if (startOpeningPriceMap == null || startOpeningPriceMap.size() == 0) {
            log.error("getOpeningPriceMapError!stockAnalysisDataList.size()={},choiceTime={}", stockAnalysisDataList.size(), choiceTime);
            return stockAnalysisDataList;
        }
        //获取2023-02-28日涨跌幅Map<windCode,priceLimitValue>
        Map<String, Double> priceLimitMap = getPriceLimitMap(stockAnalysisDataList, choiceTime, userId);
        if (priceLimitMap == null || priceLimitMap.size() == 0) {
            log.error("getPriceLimitMapError!stockAnalysisDataList.size()={},choiceTime={}", stockAnalysisDataList.size(), choiceTime);
            return stockAnalysisDataList;
        }
        //筛选判断组装结果集
        for (StockAnalysisDTO stockAnalysisDTO : stockAnalysisDataList) {
            log.info("getWindCode={},startOpeningPriceMap.get(stockAnalysisDTO.getWindCode())={},changRangeByLast.get(stockAnalysisDTO.getWindCode()={}",
                    stockAnalysisDTO.getWindCode(), startOpeningPriceMap.get(stockAnalysisDTO.getWindCode()), changRangeByLast.get(stockAnalysisDTO.getWindCode()));
            //null值判断
            if (startOpeningPriceMap.get(stockAnalysisDTO.getWindCode()) == null || changRangeByLast.get(stockAnalysisDTO.getWindCode()) == null) {
                continue;
            }
            //是否需要筛选
            if (ELIMINATE_FLAG_TRUE_NUM.equals(eliminateFlag)) {
                //此股票在2023-02-28涨跌幅
                double differenceValue = priceLimitMap.get(stockAnalysisDTO.getWindCode());
                //入选类型:0.高位风险 1.波段低位(默认)
                //高位——在2023-02-28涨跌幅 > highThresholdValue(0.01) 还涨了highThresholdValue则当前股票为高位劣质股需剔除
                if (stockAnalysisDTO.getChoiceType() == 0) {
                    if (differenceValue > highThresholdValue) {
                        continue;
                    }
                } else if (stockAnalysisDTO.getChoiceType() == 1) {
                    //低位——在2023-02-28涨跌幅 <= lowThresholdValue(-0.01) 则当前股票为劣质股需剔除
                    if (differenceValue <= lowThresholdValue) {
                        continue;
                    }
                }
            }
            //并最后将当前股票收盘价改为2023-02-08日开盘价
            log.info("WindCode={},getChoiceTime={},setChoiceTime={},getChoicePrice={},setChoicePrice={}", stockAnalysisDTO.getWindCode(), stockAnalysisDTO.getChoiceTime(), choiceTime, stockAnalysisDTO.getChoicePrice(), startOpeningPriceMap.get(stockAnalysisDTO.getWindCode()));
            stockAnalysisDTO.setChoiceTime(choiceTime);
            stockAnalysisDTO.setChoicePrice(startOpeningPriceMap.get(stockAnalysisDTO.getWindCode()));
            stockAnalysisDataScreenOut.add(stockAnalysisDTO);
        }
        return stockAnalysisDataScreenOut;
    }
```






#### 重置股票分析转档数据

##### 请求方式

```java
Post
```



##### 请求路径

```java
/stock_analysis/reset_stock_job
```



##### 接口概述



先删除输入日期中插入的股票列表数据，重新再调用接口获取股票列表数据再插入(重置)

1. ```java
   判断是否输入参数为当天,且当天必须在下午收盘后
   ```

2. 再删除当前日期在表的数据，再调取九转+上升通道列表的数据。重新将当天的表数据替换更新

3. 核心代码为：

4. ```java
   /**
        * 根据重置日期重置转档数据
        *
        * @param shiftDate 重置日期
        * @param userId    用户id
        * @return 重置结果
        */
       @Override
       public Boolean resetShift(String shiftDate, Integer userId) {
           //1.先删除当前日期数据 shiftDate为yyyyMMdd
           //格式为yyyy-MM-dd,可以使用不同的格式来比较日期,是因MySQL在执行比较时会将字符串类型的日期转换为日期时间类型
           Boolean deleteResetShift = stockAnalysisMapper.deleteResetShift(shiftDate);
           //2.再重新加载转档数据至表中
           List<AscendingNineTurnsShiftDTO> nineTurnsShiftList = stockAnalysisService.getAscendingNineTurnsShiftList(shiftDate, userId);
           Boolean result = stockAnalysisService.insertShiftList(nineTurnsShiftList);
           log.info("nineTurnsShiftList.size()={},insertNineTurnListResult={}", nineTurnsShiftList.size(), result);
           return deleteResetShift && result;
       }
   ```





##### 定时任务

>每天下午三点收盘，等到三点半就差不多都有数据了，定时转档当前选股数据插入表中

```java
    /**
     * 清空缓存方法
     * 使用定时器0 0 0 * * ?——>每天15:30收盘结束后半小时执行一次
     */
    @Scheduled(cron = "0 30 15 * * ?")
    public void startJob() {
        //校验调度ip权限
        getJobIpFlag();
        Boolean startJobResult = insertNineTurnList(null, requestUserId);
        log.info("startJobEnd={}", startJobResult);
    }
```









## 五、总结梳理

在总结部分、主要简要的回顾该功能的重要前和亮点。强调改功能的优势、适用场景和实际价值。提供一些使用该功能后带来的成果和效益。例如性能提升、减少错误率等。

![image-20230703145036235](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202307031450619.png)





### 1、核心亮点



#### 交易成功率高

在所提供的数据中，反转信号的胜率较高，即交易成功的次数占总交易次数的比例较大。大部分的交易都以获利为结果，这显示了反转信号作为一个交易策略的潜力。



#### 总收益率正向

反转信号的总收益率为正数，这意味着该策略在一段时间内能够实现资金的增长。尽管在某些日期可能会有较小的亏损，但总体上，反转信号对于投资组合的增长是积极的。



#### 灵活性和可适应性

反转信号策略在不同的日期有不同的交易次数。这表明该策略可以适应市场变化，根据市场条件做出相应的决策。这种灵活性是一个亮点，因为它允许策略在不同市场环境下保持稳健。



#### 交易次数较少

反转信号的交易次数相对较少。在给定的时间段内，总交易次数不是很高。这可能是一个优点，因为减少了频繁交易的风险和交易成本。



#### 简单性和易于执行

反转信号策略相对简单，可以较容易地执行。它不需要复杂的分析或技术指标，并且可以应用于各种市场。这使得它适用于广大投资者，无论他们的经验水平如何。





### 2、成果

该功能相关的一些成果和效益的示例：



#### 提高交易胜率

根据测试数据，反转信号功能在大部分交易日期上展现了较高的胜率，例如胜率为1（100%）或接近1。这意味着该功能在选择买入和卖出时的信号方面表现良好，能够捕捉到市场趋势的反转点，从而提高交易胜率。



#### 实现正收益率

根据测试数据，期末资金相对于初始资金呈现了正收益率，这意味着通过反转信号功能进行交易，整体上实现了盈利。尽管不同交易日期的收益率有所波动，但总体上保持正向增长趋势。



#### 控制交易次数

测试数据显示，每个交易日期的交易次数在1至8之间变化。通过反转信号功能，您可以根据特定的信号条件进行买入和卖出决策，从而在适当的时机进行交易，并避免频繁的交易。



#### 自动化交易决策

通过将反转信号功能嵌入到自动化交易系统中，您可以实现对交易决策的自动化处理。这意味着您不必手动分析市场情况和执行交易指令，而是依靠算法和信号来自动执行交易操作，提高交易效率并降低情绪干扰。





> 注意

以上成果和效益仅基于今年以来部分实际回测数据，并仅用于示例目的。实际结果可能会因市场情况、策略参数和其他因素而有所不同。在使用该功能时，建议综合考虑市场风险、策略稳定性和个人投资目标，同时定期评估和优化策略以适应不断变化的市场条件。









### 3、不足



#### 开发中存在的不足



##### 1.测试不够全面

###### 举例佐证

- 在开发获取选股列表接口中，增加筛选逻辑时，存在遗漏导致高位风险池筛选逻辑未生效
- 反转信号获取数据命令需获取内地股票，但实际获取的为港台股票bug流出。
- 测试报告数据异常bug存在
- ……

###### 解决办法

以后测试需要实际以用户身份带入，编写测试用例，并商讨测试流程以及测试边界问题。





##### 2.编写代码不够细心

###### 举例佐证

- 在获取eqs选股请求参数接口中：
  - 请求xml命令为eqs关于红九命令，确遗漏其中一个交易日的数据复权情况与其它交易日数据不一致，导致算法失效。
  - 最终生成的股票列表数据错误！
- 选股列表在次日集合竞价期间符合需剔除条件，且未剔除bug
  - 筛选功能需要理解并不贴合实际，导致遗留此bug。业务知识薄弱



###### 解决办法

以后在需求理解的时候，尽量全部弄懂理解。并能够最后更加细节的叙述出来。以确认实际开发思路。







##### 3.知其然不知其所以然



###### 举例佐证

- 在获取选股列表中增加趋势筛选逻辑时，错误的把当日涨跌幅筛选计算为选股列表的上一个交易日的涨跌幅
- 导致筛选数据异常
- 本身此筛选的增加，更多的是用于筛选当前股票列表第二天趋势明显异常的股票
- 而达成的需求。在开发过程中只是埋头去按照理解的思路去开发。却根本不懂，也没有尝试去多了解需求背后的含义。导致开发代码需重新修改！



###### 确认需求

确认需求不但是理解了需求，而是要在更深层面去理解掌握需求

> 为什么会有这样的需求？



>如果完全符合需求需要怎么开发？



>已经开发出来一定能满足现实需求吗？



>可能会有后续衍生的需求存在吗？






































