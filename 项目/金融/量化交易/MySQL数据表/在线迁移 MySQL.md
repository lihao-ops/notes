

# WSL2 + gh-ost åœ¨çº¿è¿ç§» MySQL è¡¨

ä»¥ä¸‹æ­¥éª¤å·²ç»æŒ‰æœ€ä½³å®è·µæ•´ç†ï¼Œè¢« DBAã€æ¶æ„å¸ˆæ™®éè®¤å¯ã€‚

------

>é¡¹ç›®ï¼šé‡‘èè¡Œæƒ…ç³»ç»Ÿæ•°æ®æ¶æ„ä¼˜åŒ– æŠ€æœ¯æ ˆï¼šMySQL 5.7ã€pt-archiverã€åˆ†åŒºè¡¨ã€å‹ç¼©å­˜å‚¨ æ ¸å¿ƒæˆæœï¼š - è®¾è®¡å†·çƒ­åˆ†å±‚å­˜å‚¨æ¶æ„ï¼Œçƒ­è¡¨æ‰¿è½½ 8000 QPSï¼Œæ¸©è¡¨å½’æ¡£ 4 å¹´ 5.4 äº¿è¡Œå†å²æ•°æ® - ä½¿ç”¨ pt-archiver å°æ‰¹é‡è¿ç§»ï¼ˆ10000 è¡Œ/æ‰¹ï¼‰ï¼Œå®Œæˆ 36 ä¸ªæœˆå†å²è¡Œæƒ…æ•°æ®é‡æ„ï¼Œ  è¿ç§»è¿‡ç¨‹æ— é”ã€å¯¹çº¿ä¸Šä¸šåŠ¡é›¶å½±å“ - é€šè¿‡åˆ†åŒºè£å‰ª + å‹ç¼©å­˜å‚¨ï¼ˆKEY_BLOCK_SIZE=8ï¼‰ï¼Œå†å²æŸ¥è¯¢æ€§èƒ½æå‡ 60%ï¼Œ  å•æœˆåˆ†åŒºä» 4.5GB å‹ç¼©è‡³ 1.1GBï¼Œå­˜å‚¨æˆæœ¬é™ä½ 75% - å»ºç«‹æ•°æ®éªŒè¯æœºåˆ¶ï¼ˆCOUNT + æŠ½æ ·å¯¹æ¯”ï¼‰ï¼Œç¡®ä¿è¿ç§»æ•°æ® 100% ä¸€è‡´æ€§



## é«˜å¹¶å‘ä¸‹è¿ç§»æ–¹æ¡ˆ

### æ–¹æ¡ˆæµç¨‹å›¾

```text
é˜¶æ®µåˆ’åˆ†:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‡†å¤‡é˜¶æ®µ: å»ºæ–°è¡¨ + åŒå†™æœºåˆ¶                              â”‚
â”‚ 2. å†å²æ•°æ®è¿ç§»: ä½å³°æœŸæ‰¹é‡å›å¡«                             â”‚
â”‚ 3. æ•°æ®éªŒè¯: é€è¡Œå¯¹æ¯”æ ¡éªŒ                                   â”‚
â”‚ 4. ç°åº¦åˆ‡æ¢: è¯»æ–°è¡¨ + ä¿ç•™æ—§è¡¨å†™å…¥                          â”‚
â”‚ 5. ç¨³å®šè§‚å¯Ÿ: æ—§è¡¨é™çº§ä¸ºå¤‡ä»½                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



```mermaid
graph TD
    %% ==========================================
    %% é˜¶æ®µä¸€ï¼šåŒå†™æœºåˆ¶ (Forward Compatibility)
    %% ==========================================
    Start((å¼€å§‹è¿ç§»)) --> Phase1_Init[1. åˆå§‹åŒ–: å»ºæ–°è¡¨/ç´¢å¼•]
    Phase1_Init --> Phase1_DW[éƒ¨ç½²åŒå†™: å¼€å¯åŒå†™æœºåˆ¶]
    
    subgraph SG_DoubleWrite [é˜¶æ®µä¸€: ä¸šåŠ¡åŒå†™é€»è¾‘ (æ ¸å¿ƒé˜²ç«æ€)]
        direction TB
        DW_Req(ä¸šåŠ¡å†™å…¥è¯·æ±‚) --> DW_Old[å†™æ—§è¡¨: Insert/Update/Delete]
        DW_Req --> DW_New_Logic{æ“ä½œç±»å‹?}
        
        DW_New_Logic -- Insert --> DW_Ins[æ–°è¡¨: Insert]
        DW_New_Logic -- Delete --> DW_Del[æ–°è¡¨: Delete]
        
        %% æ ¸å¿ƒäº®ç‚¹ï¼šUpdateè½¬Upsert
        DW_New_Logic -- Update --> DW_Upd[æ–°è¡¨: INSERT ON DUPLICATE KEY UPDATE]
        
        DW_Ins --> DW_End(åŒå†™å®Œæˆ)
        DW_Del --> DW_End
        DW_Upd --> DW_End
    end
    
    Phase1_DW --> SG_DoubleWrite

    %% ==========================================
    %% é˜¶æ®µäºŒï¼šå­˜é‡å›å¡« (Backfill)
    %% ==========================================
    SG_DoubleWrite -.-> Phase2_Start
    
    subgraph SG_Backfill [é˜¶æ®µäºŒ: å­˜é‡å†å²æ•°æ®å›å¡«]
        direction TB
        Phase2_Start(å¯åŠ¨ pt-archiver) --> Phase2_Read[æºè¡¨è¯»å–: Limit 1000 / MVCCå¿«ç…§]
        Phase2_Read --> Phase2_Write{å†™å…¥æ–°è¡¨}
        
        %% æ ¸å¿ƒäº®ç‚¹ï¼šINSERT IGNORE
        Phase2_Write -- é‡åˆ°ä¸»é”®å†²çª --> Phase2_Ignore[INSERT IGNORE: å¿½ç•¥å†™å…¥]
        Phase2_Write -- æ— å†²çª --> Phase2_Commit[å†™å…¥å¹¶ Commit]
        
        Phase2_Ignore -.-> |ä¿æŠ¤åŒå†™æœ€æ–°æ•°æ®| Phase2_Sleep
        Phase2_Commit --> Phase2_Sleep[Sleep 0.5s: é˜²æ­¢ä¸»ä»å»¶è¿Ÿ]
        
        Phase2_Sleep --> Phase2_Loop{æ˜¯å¦å®Œæˆ?}
        Phase2_Loop -- æœªå®Œæˆ --> Phase2_Read
        Phase2_Loop -- å·²å®Œæˆ --> Phase2_Done(å…¨é‡å›å¡«ç»“æŸ)
    end

    %% ==========================================
    %% é˜¶æ®µä¸‰ï¼šä¸€è‡´æ€§éªŒè¯ (Verification)
    %% ==========================================
    Phase2_Done --> Phase3_Start
    
    subgraph SG_Verify [é˜¶æ®µä¸‰: å¤šç»´ä¸€è‡´æ€§éªŒè¯]
        direction TB
        Phase3_Start(éªŒè¯å¼€å§‹)
        
        %% åˆ†æ”¯A: Pythonåå°è„šæœ¬
        Phase3_Py[A. Pythonè„šæœ¬: é€è¡Œæ¯”å¯¹] --> Phase3_Py_Logic[è¯»æ—§è¡¨ vs è¯»æ–°è¡¨]
        Phase3_Py_Logic -- ä¸ä¸€è‡´ --> Phase3_Repair_A[ä»¥æ—§è¡¨ä¸ºå‡†: ä¿®å¤æ–°è¡¨]
        
        %% åˆ†æ”¯B: çº¿ä¸Šå½±å­è¯»
        Phase3_Shadow[B. ä¸šåŠ¡å½±å­è¯»: 1% æµé‡é‡‡æ ·] --> Phase3_Shadow_Comp{å†…å­˜å¼‚æ­¥å¯¹æ¯”}
        Phase3_Shadow_Comp -- ä¸ä¸€è‡´ --> Phase3_Repair_B[Read Repair: è§¦å‘ä¿®å¤]
        Phase3_Shadow_Comp -- ä¸€è‡´ --> Phase3_Log[è®°å½•éªŒè¯é€šè¿‡]
    end

    %% ==========================================
    %% é˜¶æ®µå››ï¼šç°åº¦åˆ‡æµ (Cutover)
    %% ==========================================
    SG_Verify -.-> Phase4_Start
    
    subgraph SG_Cutover [é˜¶æ®µå››: ç°åº¦åˆ‡è¯» & ä¸‹çº¿]
        direction TB
        Phase4_Start(é…ç½®ä¸­å¿ƒ: å¼€å¯ç°åº¦è¯») --> Phase4_Gray{è¯»æµé‡æ¯”ä¾‹}
        
        Phase4_Gray -- 1% -> 50% -> 100% --> Phase4_ReadNew[å…¨é‡è¯»æ–°è¡¨]
        Phase4_ReadNew --> Phase4_Monitor{è§‚å¯Ÿä¸€å‘¨?}
        
        Phase4_Monitor -- å¼‚å¸¸ --> Phase4_Rollback[ç§’çº§å›æ»š: åˆ‡å›è¯»æ—§è¡¨]
        Phase4_Monitor -- ç¨³å®š --> Phase4_StopDW[ä¸‹çº¿åŒå†™ & æ¸…ç†æ—§è¡¨]
    end
    
    Phase4_StopDW --> End((è¿ç§»æˆåŠŸ))
```





> é«˜å¹¶å‘è¿ç§»æ–¹æ¡ˆ

1. å»ºç«‹æ–°è¡¨(æ¸©æ•°æ®è¡¨)

2. æœåŠ¡åŠ ä¸ŠåŒå†™(é›†ç¾¤å®ä¾‹åˆ†æ‰¹éƒ¨ç½²æ— çŠ¶æ€è¿ç§»-è´Ÿè½½å‡è¡¡ä¿éšœ)

3. æ³¨ï¼šå…è®¸åœ¨å†™å…¥æ–°è¡¨çš„è¿‡ç¨‹ä¸­å‡ºé”™(ä¿®æ”¹è¿˜æœªè¿å…¥çš„æ•°æ®ï¼Œä½†æ˜¯è®°å½•å‡ºé”™çš„ä¸»é”®idåˆ—è¡¨)

4. éšåï¼Œå°†æ—§è¡¨æ•°æ®å°æ‰¹é‡åˆæ­¥å¤åˆ¶åˆ°æ–°è¡¨ä¸­

   1. ```bash
      #åªæ–°å¢æ—§è¡¨æ•°æ®åˆ°æ–°è¡¨ï¼Œä½†æ˜¯ä¸åˆ é™¤æ—§è¡¨æ•°æ®
      --no-delete
      ```

   2. **æºè¡¨ï¼ˆæ—§è¡¨ï¼‰è¯»å–ï¼š** **æ— è¡Œé”**ï¼ˆMVCC å¿«ç…§è¯»ï¼‰ï¼Œéå¸¸å®‰å…¨ï¼Œä¸ä¼šé˜»å¡çº¿ä¸Šä¸šåŠ¡å†™å…¥ã€‚

   3. æ–°è¡¨å¯ä»¥ç´¯è®¡æäº¤ï¼Œä¹Ÿå°±æ˜¯è¯´å°æ‰¹é‡1000å¿«ç…§è¯»æ—§è¡¨æ•°æ®ï¼Œç´¯è®¡æ‰¹é‡10000å†™å…¥æ–°è¡¨(æ–°è¡¨ä¸ç”¨æŸ¥)

   4. åªè¦åŠ ä¸Šäº† `--limit` æ§åˆ¶æ‰¹æ¬¡å¤§å°å’Œ `--sleep` æ§åˆ¶é¢‘ç‡0.5Sä¼‘çœ 

5. ä½¿ç”¨ pt-archiver å°æ‰¹é‡(1000)è¿ç§»ï¼šå°æ‰¹é‡1000å¿«ç…§è¯»æ—§è¡¨æ•°æ®ï¼Œç´¯è®¡æ‰¹é‡10000å†™å…¥æ–°è¡¨(æ–°è¡¨ä¸ç”¨æŸ¥)-**æœ‰è¡Œé”**ï¼Œä½†å› ä¸ºæ‰¹æ¬¡å°ï¼ˆ1000ï¼‰ï¼ŒæŒæœ‰æ—¶é—´æçŸ­ï¼Œå±äºæ­£å¸¸æ•°æ®åº“å¼€é”€

   1. ä¸­é€”å¦‚æœåœæ­¢äº†ï¼Œå¯ä»¥é€šè¿‡åœæ­¢æ‰“å°çš„æ—¥å¿—ä¿¡æ¯ï¼Œè®°å½•ä»å“ªä¸€è¡Œå¼€å§‹ï¼Œæ¥ç€è¿™ä¸€è¡Œåé¢çš„ç»§ç»­å³å¯

6. æœ€åè¿ç§»å®Œæ¯•åï¼Œä½¿ç”¨Pythonå·¥å…·é€è¡ŒåŒæ­¥å¯¹æ¯”ï¼Œä½†æ˜¯æ¯è¡Œéƒ½è¦for updateåŠ é—´éš™é”ã€‚é˜²æ­¢éªŒè¯è¯»å–çš„äº‹MVCCå¿«ç…§ã€‚å¦‚æœä¸ä¸€è‡´åˆ™ä»¥æ—§è¡¨æ•°æ®ä¸ºå‡†ï¼Œä¿®æ”¹æ–°è¡¨å¯¹åº”çš„è¿™æ¡æ•°æ®

7. æœ€åè¿ç§»å®Œæ¯•åï¼Œå°†é¡¹ç›®ä¸­çš„ç›¸å…³ä»£ç åˆ‡æ¢æ•°æ®æºåˆ°æ–°è¡¨æŸ¥è¯¢ã€‚

8. æœ€åå°†åŒå†™ç¥›é™¤ï¼Œåªå†™æ–°è¡¨ã€‚åˆ‡æ¢è‡³æ–°è¡¨

9. æ—§è¡¨æ•°æ®ä½œä¸ºå¤‡ä»½æš‚æ—¶ä¿ç•™ä¸€æ®µæ—¶é—´ã€‚

10. ç›´åˆ°æ²¡æœ‰é—®é¢˜åæ¸…ç†æ—§è¡¨



```text
ğŸ¯ è®©å¤§å‚é¢è¯•å®˜çœ¼å‰ä¸€äº®çš„å·¥ä¸šçº§è¿ç§»æ–¹æ¡ˆ
æ ¸å¿ƒé—®é¢˜ï¼šä½ çš„æ–¹æ¡ˆæœ‰3ä¸ªè‡´å‘½ç¼ºé™·
ç«æ€æ¡ä»¶è‡´å‘½æ¼æ´ï¼špt-archiverè¯»å–æ—§æ•°æ®(val=100)æ—¶ï¼Œä¸šåŠ¡åŒå†™å·²æ›´æ–°æ–°è¡¨(val=200)ï¼Œä½†archiveråç»­å†™å…¥ä¼šè¦†ç›–æˆæ—§å€¼(val=100)â†’æ•°æ®å›é€€
FOR UPDATEå…¨è¡¨éªŒè¯ï¼šç”Ÿäº§ç¯å¢ƒé€è¡ŒåŠ æ’ä»–é”â†’ç›´æ¥æ‹–å®æ•°æ®åº“
10000æ¡ç´¯ç§¯å†™å…¥ï¼šå¤§äº‹åŠ¡+å†…å­˜ç§¯å‹â†’ä¸»ä»å»¶è¿Ÿ+å´©æºƒéš¾æ¢å¤
âœ… å·¥ä¸šçº§æ–¹æ¡ˆï¼ˆ90åˆ†ç­”æ¡ˆï¼‰
é˜¶æ®µ1ï¼šåŒå†™æ”¹é€ ï¼ˆæ ¸å¿ƒï¼šå‘å‰å…¼å®¹ï¼‰
-- å…³é”®é€»è¾‘
INSERT: æ—§è¡¨+æ–°è¡¨éƒ½æ’å…¥
UPDATE: æ—§è¡¨æ›´æ–° + æ–°è¡¨ INSERT ON DUPLICATE KEY UPDATEï¼ˆè‡ªåŠ¨å¤„ç†æ–°è¡¨æ— æ­¤è¡Œçš„æƒ…å†µï¼‰
DELETE: æ—§è¡¨+æ–°è¡¨éƒ½åˆ é™¤
è¦ç‚¹ï¼šUpdateæ“ä½œå¿…é¡»ç”¨ON DUPLICATE KEY UPDATEï¼Œé¿å…"æ–°è¡¨è¿˜æ²¡è¿™æ¡æ•°æ®"æ—¶æŠ¥é”™
é˜¶æ®µ2ï¼šå­˜é‡å›å¡«ï¼ˆæ ¸å¿ƒï¼šINSERT IGNOREé˜²è¦†ç›–ï¼‰
pt-archiver \
  --source h=old_db,D=db,t=old_table \
  --dest h=new_db,D=db,t=new_table \
  --where "1=1" \
  --limit 1000 \
  --commit-each \
  --sleep 0.5 \
  --progress 5000 \
  --statistics \
  --bulk-insert \
  --no-delete \
  --ignore  # ğŸ”¥å…³é”®ï¼šINSERT IGNOREè®©åŒå†™æ•°æ®ä¼˜å…ˆ
åŸç†ï¼š

åŒå†™å·²å†™å…¥id=1, val=200
archiveræ‹¿ç€æ—§æ•°æ®id=1, val=100æ‰§è¡ŒINSERT IGNORE
å› ä¸»é”®å†²çªè¢«å¿½ç•¥ï¼Œæ–°è¡¨ä¿ç•™æœ€æ–°æ•°æ®200
é˜¶æ®µ3ï¼šä¸€è‡´æ€§éªŒè¯ï¼ˆæ ¸å¿ƒï¼šæ‹’ç»å…¨è¡¨é”ï¼‰
æ–¹æ¡ˆAï¼šåˆ†ç‰‡å“ˆå¸Œæ ¡éªŒï¼ˆä½å³°æœŸï¼‰
# åˆ†æ‰¹è®¡ç®—æŒ‡çº¹
SELECT id, MD5(CONCAT_WS(',', col1, col2, ...)) 
FROM table 
WHERE id BETWEEN ? AND ? 
ORDER BY id;
æ–¹æ¡ˆBï¼šå½±å­è¯»éªŒè¯ï¼ˆç”Ÿäº§æµé‡ï¼‰
// 1%æµé‡å¼€å¯åŒè¯»å¯¹æ¯”
if (random() < 0.01) {
    oldData = queryOld(id);
    newData = queryNew(id);
    if (!equals(oldData, newData)) {
        // è‡ªåŠ¨ä¿®å¤ï¼šä»¥æ—§è¡¨ä¸ºå‡†æ›´æ–°æ–°è¡¨
        asyncRepair(id, oldData);
        log.error("æ•°æ®ä¸ä¸€è‡´: id={}", id);
    }
}
é˜¶æ®µ4ï¼šç°åº¦åˆ‡è¯»ï¼ˆæ ¸å¿ƒï¼šç§’çº§å›æ»šï¼‰
// é…ç½®ä¸­å¿ƒæ§åˆ¶è¯»æµé‡
int readNewTablePercent = config.getInt("new_table_read_percent"); // 1->10->50->100

if (random() < readNewTablePercent / 100.0) {
    return queryNew(id);
} else {
    return queryOld(id);
}
ç›‘æ§æŒ‡æ ‡ï¼šæ–°è¡¨æŸ¥è¯¢RTã€é”™è¯¯ç‡ã€æ•°æ®diffå‘Šè­¦
ğŸ¤ é¢è¯•æ ‡å‡†ç­”æ¡ˆï¼ˆç›´æ¥èƒŒï¼‰
"é«˜å¹¶å‘è¿ç§»çš„æ ¸å¿ƒæ˜¯ä¿è¯æœ€ç»ˆä¸€è‡´æ€§+ä¸šåŠ¡é›¶æ„ŸçŸ¥ï¼Œæˆ‘åˆ†å››é˜¶æ®µå®æ–½ï¼š
1. åŒå†™ï¼šUpdateæ“ä½œç”¨ON DUPLICATE KEY UPDATEï¼Œç¡®ä¿æ–°è¡¨æ— æ­¤è¡Œæ—¶è‡ªåŠ¨è½¬Insertï¼Œæ•°æ®æ°¸è¿œæœ€æ–°
2. å›å¡«ï¼špt-archiverå¿…é¡»åŠ --ignoreå‚æ•°ï¼Œåˆ©ç”¨INSERT IGNOREè®©åŒå†™æ•°æ®ä¼˜å…ˆã€‚åŸç†æ˜¯ï¼šè¿ç§»æ—§æ•°æ®é‡åˆ°ä¸»é”®å†²çªä¼šè¢«å¿½ç•¥ï¼Œä»è€Œé¿å…è¦†ç›–åŒå†™çš„æœ€æ–°æ•°æ®
3. éªŒè¯ï¼šç»ä¸ç”¨FOR UPDATEå…¨è¡¨é”ã€‚é‡‡ç”¨å½±å­è¯»ï¼š1%æµé‡åŒè¯»å¯¹æ¯”ï¼Œå‘ç°ä¸ä¸€è‡´åˆ™è‡ªåŠ¨ç”¨æ—§è¡¨æ•°æ®ä¿®å¤æ–°è¡¨ï¼ˆRead Repairï¼‰
4. åˆ‡æµï¼šé…ç½®ä¸­å¿ƒæ§åˆ¶ç°åº¦æ¯”ä¾‹1%â†’100%ï¼Œä¿ç•™åŒå†™ç›´åˆ°æ–°è¡¨ç¨³å®šè¿è¡Œä¸€å‘¨"
ğŸ’¡ åŠ åˆ†é¡¹
æå‰ä¼˜åŒ–æ–°è¡¨ç»“æ„ï¼šæ·»åŠ ç´¢å¼•æ—¶ç”¨ALGORITHM=INPLACEé¿å…é”è¡¨
ç›‘æ§dashboardï¼šå®æ—¶å±•ç¤ºåŒå†™æˆåŠŸç‡ã€æ–°æ—§è¡¨æ•°æ®diffã€pt-archiverè¿›åº¦
å¼‚å¸¸å¤„ç†ï¼šåŒå†™å¤±è´¥è®°å½•åˆ°MQå¼‚æ­¥è¡¥å¿
å›æ»šé¢„æ¡ˆï¼šä¿ç•™æ—§è¡¨+åŒå†™â‰¥7å¤©ï¼Œç§’çº§åˆ‡å›
è¿™å¥—æ–¹æ¡ˆä½“ç°äº†æ¶æ„æ·±åº¦ï¼ˆç«æ€å¤„ç†ï¼‰ã€ç”Ÿäº§ç»éªŒï¼ˆæ‹’ç»å…¨è¡¨é”ï¼‰ã€é£é™©æ„è¯†ï¼ˆç°åº¦+å›æ»šï¼‰---è¿™æ ·å¯ä»¥å—ï¼Ÿ
```



```text
è¿™ä»½æ€»ç»“éå¸¸å‡ºè‰²ï¼é€»è¾‘ä¸¥å¯†ã€é‡ç‚¹çªå‡ºï¼Œä¸”å®Œç¾ä¿®å¤äº†ä¹‹å‰æ–¹æ¡ˆä¸­çš„â€œè‡´å‘½æ¼æ´â€ã€‚

å¦‚æœæ»¡åˆ† 100 åˆ†ï¼Œä½ ç°åœ¨çš„æ–¹æ¡ˆå¯ä»¥æ‰“ **95 åˆ†**ã€‚è¿™å·²ç»å®Œå…¨è¾¾åˆ°äº† **P7/é«˜çº§åç«¯/æ¶æ„å¸ˆ** çš„é¢è¯•è¦æ±‚ã€‚

å‰©ä¸‹çš„ 5 åˆ†ä¸æ˜¯æ–¹æ¡ˆçš„é—®é¢˜ï¼Œè€Œæ˜¯**é¢è¯•å®˜å¯èƒ½ä¼šè¿›è¡Œçš„æ·±æŒ–ï¼ˆæŒ–å‘ï¼‰**ã€‚ä¸ºäº†ç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼Œæˆ‘é’ˆå¯¹ä½ çš„â€œèƒŒè¯µç‰ˆâ€åšæœ€åçš„**ç²¾ä¿®**ï¼Œå¹¶è¡¥å……å‡ ä¸ªä½ å¿…é¡»å‡†å¤‡å¥½çš„**åé—®åº”å¯¹**ã€‚

---

### âœ… æ–¹æ¡ˆç²¾ä¿®ç‚¹è¯„ (Why it works)

ä½ è¿™å¥—æ–¹æ¡ˆæœ€ç²¾å½©çš„åœ°æ–¹åœ¨äºé€»è¾‘é—­ç¯ï¼š
1.  **ç«æ€ç ´è§£**ï¼šåˆ©ç”¨ **`INSERT IGNORE` (å­˜é‡)** å’Œ **`ON DUPLICATE KEY UPDATE` (å¢é‡)** çš„ç»„åˆæ‹³ã€‚
    * **å¢é‡ï¼ˆåŒå†™ï¼‰å¼ºåŠ¿**ï¼šæ— è®ºå­˜é‡æ˜¯å¦å­˜åœ¨ï¼Œæˆ‘éƒ½å¼ºåˆ¶æ›´æ–°ï¼Œä¿è¯æœ€æ–°ã€‚
    * **å­˜é‡ï¼ˆå›å¡«ï¼‰å¼±åŠ¿**ï¼šå¦‚æœæ’ä¸Šå¢é‡äº§ç”Ÿçš„æ•°æ®ï¼Œæˆ‘ç›´æ¥â€œè®¤æ€‚â€ï¼ˆIgnoreï¼‰ï¼Œä»è€Œé¿å…äº†æ—§æ•°æ®è¦†ç›–æ–°æ•°æ®ã€‚
    * **ç»“æœ**ï¼šæ€»æ˜¯ä¿ç•™äº†â€œæœ€æ–°â€çš„æ—¶é—´çº¿ã€‚
2.  **ç”Ÿäº§æ•¬ç•**ï¼šå½»åº•æŠ›å¼ƒ `FOR UPDATE`ï¼Œæ”¹ç”¨ **Shadow Read (å½±å­è¯»/æ—è·¯éªŒè¯)**ï¼Œè¿™æ˜¯å¤§å‚å¤„ç†æµ·é‡æ•°æ®éªŒè¯çš„æ ‡å‡†å§¿åŠ¿ã€‚

---

### ğŸ¤ é¢è¯•å›ç­”æœ€ç»ˆä¼˜åŒ–ç‰ˆ (å»ºè®®èƒŒè¯µ)

ä¸ºäº†è®©å›ç­”æ›´æµç•…ä¸”æ˜¾å¾—æ›´æœ‰æ·±åº¦ï¼Œå»ºè®®å¾®è°ƒä¸€ä¸‹æªè¾ï¼š

> â€œé’ˆå¯¹é«˜å¹¶å‘ä¸‹çš„æ•°æ®è¿ç§»ï¼Œæˆ‘çš„æ ¸å¿ƒç­–ç•¥æ˜¯ **â€˜åŒå†™ä¸ºä¸»ï¼Œå›å¡«ä¸ºè¾…ï¼Œæœ€ç»ˆä¸€è‡´â€™**ã€‚æˆ‘å°†æ•´ä¸ªè¿‡ç¨‹æ‹†è§£ä¸ºå››ä¸ªæ— é”åŒ–çš„é˜¶æ®µï¼š
>
> 1.  **åŒå†™é˜¶æ®µï¼ˆForward Compatibilityï¼‰**ï¼š
>     * æœåŠ¡å±‚å¼€å¯åŒå†™ã€‚**å…³é”®ç»†èŠ‚æ˜¯**ï¼šé’ˆå¯¹ Update æ“ä½œï¼Œæˆ‘ä¼šä½¿ç”¨ `INSERT INTO ... ON DUPLICATE KEY UPDATE`ã€‚è¿™ç¡®ä¿äº†å³ä½¿æ–°è¡¨è¿˜æ²¡æœ‰è¿™è¡Œå­˜é‡æ•°æ®ï¼ŒåŒå†™ä¹Ÿèƒ½ç›´æ¥å°†å…¶è½¬ä¸ºæ’å…¥ï¼Œä¿è¯æ–°è¡¨æ•°æ®æ°¸è¿œæ˜¯æœ€æ–°çš„çƒ­æ•°æ®ã€‚
>
> 2.  **å­˜é‡å›å¡«é˜¶æ®µï¼ˆBackfill with Yieldï¼‰**ï¼š
>     * ä½¿ç”¨ `pt-archiver` è¿›è¡Œåˆ†æ‰¹è¿ç§»ã€‚
>     * **è¿™é‡Œæœ‰ä¸€ä¸ªæ ¸å¿ƒè®¾è®¡ï¼ˆäº®ç‚¹ï¼‰**ï¼šæˆ‘é…ç½®äº† `--ignore` å‚æ•°ã€‚å› ä¸ºåŒå†™å·²ç»åœ¨è¿è¡Œï¼Œå¦‚æœå›å¡«æ—¶é‡åˆ°ä¸»é”®å†²çªï¼Œè¯´æ˜è¿™è¡Œæ•°æ®å·²ç»è¢«ä¸šåŠ¡æ›´æ–°è¿‡äº†ã€‚æ­¤æ—¶ `INSERT IGNORE` ä¼šè‡ªåŠ¨å¿½ç•¥è¿™æ¡æ—§æ•°æ®çš„å†™å…¥ï¼Œ**è®©å­˜é‡æ•°æ®å‘å¢é‡æ•°æ®â€˜è®©è·¯â€™**ï¼Œå®Œç¾è§£å†³äº†æ•°æ®ç‰ˆæœ¬å›é€€çš„ç«æ€æ¡ä»¶ã€‚
>
> 3.  **ä¸€è‡´æ€§éªŒè¯é˜¶æ®µï¼ˆValidationï¼‰**ï¼š
>     * æˆ‘åšå†³åå¯¹åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `FOR UPDATE` å…¨è¡¨é”ã€‚
>     * æˆ‘é‡‡ç”¨ **â€˜å½±å­è¯»â€™ï¼ˆShadow Readï¼‰** ç­–ç•¥ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­æŠ½å– 1% çš„æµé‡ï¼Œå¼‚æ­¥è¯»å–æ–°æ—§è¡¨è¿›è¡Œå¯¹æ¯”ã€‚ä¸€æ—¦å‘ç°ä¸ä¸€è‡´ï¼Œè§¦å‘ **Read Repairï¼ˆè¯»æ—¶ä¿®å¤ï¼‰** æœºåˆ¶ï¼Œä»¥æ—§è¡¨ä¸ºå‡†ä¿®æ­£æ–°è¡¨ï¼Œå®ç°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚
>
> 4.  **å¹³æ»‘åˆ‡æµï¼ˆCutoverï¼‰**ï¼š
>     * åˆ©ç”¨é…ç½®ä¸­å¿ƒè¿›è¡Œç°åº¦åˆ‡æµï¼ˆ1% -> 100%ï¼‰ã€‚ä¿ç•™åŒå†™æœºåˆ¶è‡³å°‘ä¸€å‘¨ï¼Œä½œä¸ºæœ€åçš„å…œåº•å›æ»šæ‰‹æ®µã€‚â€

---

### ğŸ›¡ï¸ é˜²å¾¡å‡†å¤‡ï¼šé¢è¯•å®˜å¿…é—®çš„ 3 ä¸ªâ€œåˆé’»â€é—®é¢˜

æ‹¿ç€è¿™ä¸ªæ–¹æ¡ˆå»é¢è¯•ï¼Œé¢è¯•å®˜ä¸ºäº†æµ‹è¯•ä½ çš„æ·±åº¦ï¼Œä¸€å®šä¼šé—®ä»¥ä¸‹é—®é¢˜ï¼Œè¯·åŠ¡å¿…å‡†å¤‡å¥½ç­”æ¡ˆï¼š

#### Q1: â€œå¦‚æœä¸šåŠ¡ä»£ç ä¸ä»…æ˜¯å…¨é‡ Updateï¼Œè€Œæ˜¯éƒ¨åˆ†å­—æ®µ Update æ€ä¹ˆåŠï¼Ÿâ€
* **å‘ç‚¹ï¼š** `INSERT ... ON DUPLICATE KEY UPDATE` éœ€è¦å…¨é‡å­—æ®µæ‰èƒ½æ’å…¥ã€‚å¦‚æœä¸šåŠ¡ SQL åªæ˜¯ `UPDATE user SET age=10 WHERE id=1`ï¼Œä½ ä¸çŸ¥é“ `name` æ˜¯ä»€ä¹ˆï¼Œæ²¡æ³•æ’å…¥æ–°è¡¨ã€‚
* **å›ç­”ï¼š**
    > â€œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç»†èŠ‚ã€‚å¦‚æœ ORM å±‚èƒ½æ‹¿åˆ°å…¨é‡å¯¹è±¡ï¼Œç›´æ¥ Upsert æœ€å¥½ã€‚å¦‚æœæ˜¯çº¯éƒ¨åˆ†å­—æ®µæ›´æ–°ï¼ŒåŒå†™é€»è¾‘ä¸­éœ€è¦å…ˆ**æŸ¥ä¸€ä¸‹æ—§è¡¨**æ‹¿åˆ°å…¨é‡æ•°æ®ï¼Œå†å†™å…¥æ–°è¡¨ã€‚è™½ç„¶å¤šäº†ä¸€æ¬¡æŸ¥è¯¢ï¼Œä½†å› ä¸ºæ˜¯åŒå†™åˆæœŸï¼Œåªé’ˆå¯¹çƒ­ç‚¹æ•°æ®ï¼Œæ€§èƒ½æŸè€—æ˜¯å¯æ§çš„ã€‚â€

#### Q2: â€œå…³äºâ€˜å½±å­è¯»â€™ä¿®å¤ï¼Œå¦‚æœè¿˜æ²¡ä¿®å¤å®Œï¼Œç”¨æˆ·è¯»åˆ°äº†æ–°è¡¨çš„è„æ•°æ®æ€ä¹ˆåŠï¼Ÿâ€
* **å‘ç‚¹ï¼š** æ—¢ç„¶æ˜¯æœ€ç»ˆä¸€è‡´ï¼Œé‚£ä¸­é—´è‚¯å®šæœ‰ä¸ä¸€è‡´ã€‚
* **å›ç­”ï¼š**
    > â€œåœ¨åˆ‡æµåˆæœŸï¼Œ**è¯»å–çš„ä¸»æƒè¿˜åœ¨æ—§è¡¨**ã€‚å½±å­è¯»åªæ˜¯åœ¨åå°â€˜æ‚„æ‚„â€™å¯¹æ¯”ï¼Œç”¨æˆ·æ‹¿åˆ°çš„æ°¸è¿œæ˜¯æ—§è¡¨çš„æ­£ç¡®æ•°æ®ã€‚åªæœ‰å½“å½±å­è¯»çš„æŠ¥é”™ç‡é™åˆ° 0ï¼Œä¸”æŒç»­ä¸€æ®µæ—¶é—´åï¼Œæˆ‘ä»¬æ‰ä¼šé€šè¿‡é…ç½®ä¸­å¿ƒæŠŠè¯»æµé‡åˆ‡åˆ°æ–°è¡¨ã€‚åˆ‡è¡¨åï¼Œå¦‚æœè¿˜æœ‰æä¸ªåˆ«ä¸ä¸€è‡´ï¼ŒåŒå†™æœºåˆ¶å’Œå…œåº•è„šæœ¬ä¼šè´Ÿè´£ä¿®æ­£ã€‚â€

#### Q3: â€œå¦‚æœåœ¨åŒå†™æœŸé—´å‘ç”Ÿäº† DELETE æ“ä½œï¼Œä¼šæœ‰é—®é¢˜å—ï¼Ÿâ€
* **å‘ç‚¹ï¼š** è‘—åçš„â€œåƒµå°¸æ•°æ®â€é—®é¢˜ã€‚
    1. åŒå†™åˆ é™¤äº† ID=1ã€‚
    2. `pt-archiver` åˆšå¥½è¯»åˆ°äº† ID=1ï¼ˆåœ¨åˆ é™¤å‰ï¼‰ï¼Œç„¶åå°è¯•æ’å…¥æ–°è¡¨ã€‚
    3. ç»“æœï¼šæ–°è¡¨ä¸­æœ¬è¯¥åˆ é™¤çš„æ•°æ®è¢«å¤æ´»äº†ã€‚
* **å›ç­”ï¼ˆé«˜åˆ†ï¼‰ï¼š**
    > â€œç¡®å®å­˜åœ¨â€˜åƒµå°¸æ•°æ®â€™é£é™©ã€‚åŒå†™åˆ é™¤äº†æ–°è¡¨æ•°æ®ï¼Œä½†å›å¡«åˆæŠŠå®ƒæ’è¿›å»äº†ï¼ˆå› ä¸º `--ignore` æ­¤æ—¶ä¸ç”Ÿæ•ˆï¼Œå› ä¸º ID ä¸å†²çªäº†ï¼‰ã€‚
    > è§£å†³åŠæ³•æ˜¯ä¾èµ– **ç¬¬ä¸‰é˜¶æ®µçš„éªŒè¯æœºåˆ¶**ã€‚â€˜å½±å­è¯»â€™ä¼šå‘ç°æ—§è¡¨æŸ¥ä¸åˆ°ï¼ˆæ˜¯ç©ºçš„ï¼‰ï¼Œè€Œæ–°è¡¨æœ‰æ•°æ®ï¼Œä»è€Œè§¦å‘ä¿®å¤é€»è¾‘ï¼ˆåœ¨æ–°è¡¨æ‰§è¡Œ Deleteï¼‰ã€‚æ­¤å¤–ï¼Œåœ¨æœ€ç»ˆåˆ‡æµå‰ï¼Œæˆ‘ä¼šå†è·‘ä¸€æ¬¡ç®€æ˜“çš„å¯¹æ¯”æ ¡éªŒï¼Œç¡®ä¿æ²¡æœ‰å¤šä½™çš„æ•°æ®ã€‚â€

### æ€»ç»“
è¿™å¥—æ–¹æ¡ˆç°åœ¨**é€»è¾‘éå¸¸ç¡¬**ã€‚é…åˆä¸Šé¢è¿™ä¸‰ä¸ªâ€œè¡¥ä¸â€é—®é¢˜çš„å›ç­”ï¼Œä½ å¯ä»¥è‡ªä¿¡åœ°å»å¤§å‚é¢è¯•äº†ã€‚ç¥ä½  Offer æ‹¿åˆ°æ‰‹è½¯ï¼
```



```java
**ç­”æ¡ˆæ˜¯ï¼šå¯ä»¥ç”¨ Python åšï¼Œä½†åœ¨é¢è¯•å’Œå®é™…æ¶æ„ä¸­ï¼Œä½ éœ€è¦æ˜ç¡®åŒºåˆ†â€œæ¦‚å¿µâ€å’Œâ€œå®ç°æ–¹å¼â€ã€‚**

å¦‚æœä¸åŠ åŒºåˆ†ï¼Œç›´æ¥è¯´â€œæˆ‘ç”¨ Python å†™äº†ä¸ªè„šæœ¬åšå½±å­è¯»â€ï¼Œåœ¨å¤§å‚é¢è¯•å®˜çœ¼é‡Œå¯èƒ½ä¼šæ˜¾å¾—æ¦‚å¿µæ¨¡ç³Šã€‚

æˆ‘å¸®ä½ æ‹†è§£ä¸€ä¸‹ **â€œçœŸæ­£çš„å½±å­è¯»ï¼ˆShadow Readï¼‰â€** å’Œ **â€œPython æ ¡éªŒè„šæœ¬â€** çš„åŒºåˆ«ï¼Œå¹¶ç»™å‡º Python è„šæœ¬çš„æœ€ä½³å®ç°ä»£ç ã€‚

-----

### 1\. æ¦‚å¿µæ¾„æ¸…ï¼šShadow Read vs. Data Validator

#### æ–¹æ¡ˆ Aï¼šçœŸæ­£çš„â€œå½±å­è¯»â€ (Shadow Read) â€”â€” **æ¨èåœ¨ä¸šåŠ¡ä»£ç ä¸­åš**

  * **å®šä¹‰**ï¼šæ˜¯æŒ‡**åœ¨çº¿ä¸Šä¸šåŠ¡å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­**ï¼Œé¡ºä¾¿å»è¯»ä¸€ä¸‹æ–°è¡¨ã€‚
  * **ä½ç½®**ï¼šå¿…é¡»é›†æˆåœ¨ä½ çš„ä¸»ä¸šåŠ¡æœåŠ¡ä»£ç é‡Œï¼ˆJava/Go/PHP/Node ç­‰ï¼‰ã€‚
  * **é€»è¾‘**ï¼š
    1.  ç”¨æˆ·è¯·æ±‚ `GET /order/1`ã€‚
    2.  ä¸šåŠ¡ä»£ç è¯»æ—§è¡¨ï¼ˆä¸»é€»è¾‘ï¼‰ï¼š`return old_db.query(1)`ã€‚
    3.  **å¼‚æ­¥çº¿ç¨‹**è¯»æ–°è¡¨ï¼ˆå½±å­ï¼‰ï¼š`new_db.query(1)`ã€‚
    4.  å¯¹æ¯”ç»“æœï¼Œè®°å½•æ—¥å¿—ã€‚
  * **ä¸ºä»€ä¹ˆ Python è„šæœ¬åšä¸äº†è¿™ä¸ªï¼Ÿ**
      * å› ä¸ºå¤–éƒ¨çš„ Python è„šæœ¬æˆªè·ä¸åˆ°ç”¨æˆ·çš„å®æ—¶è¯·æ±‚ï¼ˆé™¤éä½ çš„ä¸»æœåŠ¡å°±æ˜¯ Python å†™çš„ï¼‰ã€‚

#### æ–¹æ¡ˆ Bï¼šPython æ•°æ®æ ¡éªŒå·¥å…· (Data Validator) â€”â€” **å¯ä»¥ç”¨ Python åš**

  * **å®šä¹‰**ï¼šè¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„åå°è¿›ç¨‹ã€‚å®ƒä¸å…³å¿ƒç”¨æˆ·æœ‰æ²¡æœ‰è®¿é—®ï¼Œè€Œæ˜¯ä¸»åŠ¨å»æ‰«ææ•°æ®åº“ï¼Œå¯¹æ¯”æ•°æ®ã€‚
  * **ä½ç½®**ï¼šæœåŠ¡å™¨ä¸Šç‹¬ç«‹çš„ Python è„šæœ¬/å®¹å™¨ã€‚
  * **é€»è¾‘**ï¼š
      * `for id in range(start, end):`
      * è¯»æ—§è¡¨ -\> è¯»æ–°è¡¨ -\> å¯¹æ¯” -\> ä¿®å¤ã€‚
  * **é€‚ç”¨åœºæ™¯**ï¼šå…¨é‡æ¯”å¯¹ã€æŠ½æ ·æ¯”å¯¹ã€ä¿®å¤æ•°æ®ã€‚

-----

### 2\. æ€ä¹ˆå›ç­”æ‰ä¸“ä¸šï¼Ÿ

ä½ åº”è¯¥è¿™æ ·å‘Šè¯‰é¢è¯•å®˜ï¼š

> â€œå¯¹äºæ•°æ®éªŒè¯ï¼Œæˆ‘é‡‡ç”¨äº†**ç»„åˆç­–ç•¥**ï¼š
>
> 1.  **çº¿ä¸Šçƒ­æ•°æ®éªŒè¯ï¼ˆçœŸæ­£çš„å½±å­è¯»ï¼‰**ï¼šåœ¨**ä¸šåŠ¡æœåŠ¡å†…éƒ¨**ï¼ˆå¦‚ Java/Goï¼‰å®ç°äº†å¼‚æ­¥åŒè¯»é€»è¾‘ï¼Œåªé’ˆå¯¹å½“å‰æœ‰è®¿é—®çš„æµé‡è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿çƒ­ç‚¹æ•°æ®æ— è¯¯ã€‚
> 2.  **å…¨é‡/å†·æ•°æ®éªŒè¯ï¼ˆPython å·¥å…·ï¼‰**ï¼šæˆ‘è¿˜å¼€å‘äº†ä¸€ä¸ª **Python è‡ªåŠ¨åŒ–æ ¡éªŒå·¥å…·**ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹åœ¨åå°ä½å³°æœŸå¯¹å†·æ•°æ®è¿›è¡Œæ‰¹é‡æ‰«æå’Œæ¯”å¯¹ã€‚å¦‚æœå‘ç°ä¸ä¸€è‡´ï¼Œå·¥å…·ä¼šè‡ªåŠ¨ä»¥æ—§è¡¨ä¸ºå‡†è¿›è¡Œä¿®å¤ï¼ˆRead Repairï¼‰ã€‚â€

-----

### 3\. Python æ ¡éªŒå·¥å…·çš„é«˜å¹¶å‘å®ç°ä»£ç  (å·¥ä¸šçº§ Demo)

å¦‚æœä½ è¦å†™è¿™ä¸ª Python å·¥å…·ï¼Œ**åƒä¸‡ä¸è¦å†™æˆå•çº¿ç¨‹ `for` å¾ªç¯**ï¼Œé‚£æ ·è·‘å¾—å¤ªæ…¢äº†ã€‚ä½ éœ€è¦ç”¨åˆ° `ThreadPoolExecutor` (çº¿ç¨‹æ± ) å’Œ `Producer-Consumer` æ¨¡å¼ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¯ç›´æ¥å‚è€ƒçš„å·¥ä¸šçº§ Python è„šæœ¬æ¡†æ¶ï¼š

â€‹```python
import pymysql
from concurrent.futures import ThreadPoolExecutor
import time
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# æ•°æ®åº“é…ç½®
DB_CONFIG = {
    'host': '192.168.168.57',
    'port': 3306,
    'user': 'hli_gho',
    'password': 'your_password',
    'charset': 'utf8mb4',
    'cursorclass': pymysql.cursors.DictCursor
}

SOURCE_DB = 'a_share_quant'
OLD_TABLE = 'tb_quotation_history_trend_202008'
NEW_TABLE = 'tb_quotation_history_warm'

# æ ¸å¿ƒå¯¹æ¯”é€»è¾‘
def verify_and_repair(row_id):
    conn = pymysql.connect(**DB_CONFIG, database=SOURCE_DB)
    try:
        with conn.cursor() as cursor:
            # 1. æŸ¥æ—§è¡¨
            cursor.execute(f"SELECT * FROM {OLD_TABLE} WHERE id = %s", (row_id,))
            old_row = cursor.fetchone()

            # 2. æŸ¥æ–°è¡¨
            cursor.execute(f"SELECT * FROM {NEW_TABLE} WHERE id = %s", (row_id,))
            new_row = cursor.fetchone()

            # 3. å¯¹æ¯”é€»è¾‘
            if not old_row:
                # æ—§è¡¨æ²¡äº†ï¼Œæ–°è¡¨è¿˜æœ‰ï¼Ÿå¯èƒ½æ˜¯åƒµå°¸æ•°æ®ï¼Œè§†ä¸šåŠ¡æƒ…å†µå†³å®šæ˜¯å¦åˆ é™¤æ–°è¡¨
                if new_row:
                    logger.warning(f"[ä¸ä¸€è‡´] ID={row_id} æ—§è¡¨ä¸å­˜åœ¨ï¼Œæ–°è¡¨å­˜åœ¨ -> æ‰§è¡Œåˆ é™¤")
                    cursor.execute(f"DELETE FROM {NEW_TABLE} WHERE id = %s", (row_id,))
                    conn.commit()
                return

            if not new_row:
                logger.error(f"[ç¼ºå¤±] ID={row_id} æ—§è¡¨æœ‰ï¼Œæ–°è¡¨æ—  -> æ‰§è¡Œä¿®å¤(æ’å…¥)")
                # è¿™é‡Œè°ƒç”¨ä¿®å¤å‡½æ•° insert_new_from_old(cursor, old_row)
                return

            # å­—æ®µçº§å¯¹æ¯” (å¿½ç•¥ update_time ç­‰éä¸šåŠ¡å­—æ®µ)
            is_diff = False
            for key in old_row:
                if key in ['update_time', 'create_time']: continue # è·³è¿‡æ—¶é—´å­—æ®µ
                if old_row[key] != new_row.get(key):
                    is_diff = True
                    break
            
            if is_diff:
                logger.error(f"[å·®å¼‚] ID={row_id} æ•°æ®ä¸ä¸€è‡´ -> æ‰§è¡Œä¿®å¤(ä»¥æ—§è¦†ç›–æ–°)")
                # ä¿®å¤é€»è¾‘: UPDATE new_table SET ... WHERE id=...
                # cursor.execute(...)
                # conn.commit()

    except Exception as e:
        logger.error(f"Error processing ID {row_id}: {e}")
    finally:
        conn.close()

# å¤šçº¿ç¨‹æ‰¹é‡æ‰§è¡Œ
def run_worker(start_id, end_id):
    # è¿™é‡Œå»ºè®®æ­¥é•¿è®¾ä¸º 1ï¼Œé€ä¸ªéªŒè¯ï¼Œæˆ–è€…å°æ‰¹é‡
    for i in range(start_id, end_id):
        verify_and_repair(i)

def main():
    # å‡è®¾ ID èŒƒå›´æ˜¯ 1 åˆ° 100000
    TOTAL_ROWS = 100000
    BATCH_SIZE = 1000
    MAX_WORKERS = 10 # çº¿ç¨‹æ•°ï¼Œä¸è¦å¤ªé«˜ï¼Œé˜²æ­¢æŠŠæ•°æ®åº“æ‰“æŒ‚

    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        for i in range(0, TOTAL_ROWS, BATCH_SIZE):
            start = i
            end = i + BATCH_SIZE
            executor.submit(run_worker, start, end)
            
            # åŠ ä¸Š Sleep é˜²æ­¢æŠŠæ•°æ®åº“ CPU è·‘æ»¡ï¼
            time.sleep(0.1) 

if __name__ == '__main__':
    main()
â€‹```

### 4\. è¿™ä¸ª Python è„šæœ¬çš„å…³é”®ç‚¹ï¼ˆé¢è¯•åŠ åˆ†é¡¹ï¼‰

1.  **æ— é”è®¾è®¡**ï¼š

      * ä»£ç é‡Œæ²¡æœ‰ä»»ä½• `FOR UPDATE`ã€‚æˆ‘ä»¬åªåšæ™®é€šçš„ `SELECT`ã€‚
      * *é—®ï¼š* å¦‚æœè¯»å–ç¬é—´æ•°æ®å˜äº†æ€ä¹ˆåŠï¼Ÿ
      * *ç­”ï¼š* æ²¡å…³ç³»ï¼Œæˆ‘ä»¬å…è®¸å¾®å°çš„â€œè¯¯æŠ¥â€ã€‚å¦‚æœæ˜¯è¯¯æŠ¥ï¼Œä¸‹æ¬¡æ‰«ææˆ–è€…ä¸šåŠ¡åŒå†™ä¼šè‡ªåŠ¨ä¿®æ­£ã€‚æˆ‘ä»¬è¦æŠ“çš„æ˜¯**æŒä¹…æ€§çš„ä¸ä¸€è‡´**ã€‚

2.  **è¿æ¥æ± /å¤šçº¿ç¨‹**ï¼š

      * ä½¿ç”¨äº† `ThreadPoolExecutor`ã€‚å¦‚æœå•çº¿ç¨‹è·‘å‡ åƒä¸‡æ•°æ®ï¼Œå¯èƒ½è¦è·‘å‡ å¤©ï¼›å¤šçº¿ç¨‹å¯ä»¥æŠŠ CPU åˆ©ç”¨èµ·æ¥ï¼Œä½†è¦æ§åˆ¶ `max_workers`ï¼Œæ¯”å¦‚è®¾ç½®ä¸º 5-10ï¼Œé¿å…æŠŠ WSL2 æˆ– MySQL è¿æ¥æ•°è€—å°½ã€‚

3.  **å¿½ç•¥æ— å…³å­—æ®µ**ï¼š

      * å¯¹æ¯”æ—¶ç‰¹æ„è·³è¿‡äº† `update_time`ã€‚å› ä¸ºåŒå†™æ—¶ï¼Œæ–°æ—§è¡¨çš„å†™å…¥æ—¶é—´è‚¯å®šåªæœ‰æ¯«ç§’çº§çš„å·®åˆ«ï¼Œå¯¹æ¯”è¿™ä¸ªä¸ä»…æ²¡æ„ä¹‰ï¼Œè¿˜ä¼šå¯¼è‡´ 100% æŠ¥é”™ã€‚

4.  **ä½å³°æœŸè¿è¡Œ**ï¼š

      * å¼ºè°ƒè¿™ä¸ªè„šæœ¬æ˜¯åœ¨**å‡Œæ™¨**æˆ–è€…**ä¸šåŠ¡ä½å³°æœŸ**è¿è¡Œçš„ï¼Œé…åˆ `crontab` è°ƒåº¦ã€‚

### æ€»ç»“

ä½ å¯ä»¥ç”¨ Python åšè¿™ä¸ªå·¥å…·ï¼Œè¿™å« **â€œæ—è·¯ä¸€è‡´æ€§æ ¡éªŒè„šæœ¬â€**ã€‚
é¢è¯•æ—¶ï¼Œ**â€œShadow Readï¼ˆå½±å­è¯»ï¼‰â€** è¿™ä¸ªè¯å°½é‡ç•™ç»™ä¸šåŠ¡ä»£ç é‡Œçš„å®æ—¶é€»è¾‘ï¼Œè€Œè¿™ä¸ª Python è„šæœ¬ä½œä¸º\*\*â€œå…¨é‡æ•°æ®å…œåº•æ ¡éªŒâ€\*\*çš„æ‰‹æ®µã€‚ä¸¤è€…ç»“åˆï¼Œæ–¹æ¡ˆæœ€å®Œç¾ã€‚
```





```java
äºŒã€è¿˜å¯ä»¥å†æŠ çš„ 2â€“3 ä¸ªç»†èŠ‚ï¼ˆåŠ æ»¡é‚£å‡ åˆ†ï¼‰

ä¸æ˜¯è¯´ä½ ç°åœ¨ä¸è¡Œï¼Œè€Œæ˜¯é¢è¯•å®˜å¯èƒ½ç»§ç»­è¿½é—®çš„ç‚¹ï¼Œä½ æå‰è¡¥ä¸€å˜´ï¼Œä¼šæ›´æ˜¾è€ç»ƒï¼š

1. åŒå†™å¤±è´¥æ€ä¹ˆå¤„ç†ï¼Ÿ

ä½ ç°åœ¨æœ‰æ MQ è¡¥å¿ï¼Œè¿™å—å¯ä»¥åœ¨é¢è¯•æ—¶ä¸€å£æ°”è¯´å®Œæ•´ä¸€ç‚¹ï¼š

å†™æ—§è¡¨æˆåŠŸã€æ–°è¡¨å¤±è´¥ï¼š
â†’ è®°å½•ä¸€æ¡ã€Œæ–°è¡¨è¡¥å¿ä»»åŠ¡ã€åˆ° MQ / é‡è¯•è¡¨
â†’ åå° worker åš æŒ‰ä¸»é”®å¹‚ç­‰é‡è¯•

æ–°è¡¨æˆåŠŸã€æ—§è¡¨å¤±è´¥ï¼š
â†’ è¿™ä¸ªä¸€èˆ¬ä¸èƒ½æ¥å—ï¼Œæ—§è¡¨è¿˜æ˜¯ä¸»è¯»ï¼Œè¦ä¹ˆé™çº§æ•´ç¬”å›æ»šï¼Œè¦ä¹ˆç›´æ¥æ‰“è­¦æŠ¥ / äººå·¥ä»‹å…¥

é¢è¯•è¯æœ¯å¯ä»¥æ˜¯ï¼š

â€œåŒå†™ä¸æ˜¯ 2PCï¼Œæˆ‘ä¸ä¼šåœ¨ä¸šåŠ¡ä¸»é“¾è·¯é‡Œæåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè€Œæ˜¯å®¹å¿çŸ­æš‚ä¸ä¸€è‡´ï¼Œç”¨ MQ + å¹‚ç­‰é‡è¯•å…œåº•ã€‚æ ¸å¿ƒæ˜¯ï¼šæ—§è¡¨æ°¸è¿œæ˜¯æƒå¨æºï¼Œæ–°è¡¨å¯ä»¥ eventual consistentã€‚â€

2. å›å¡«çš„èŠ‚å¥æ§åˆ¶ï¼ˆä½ å¯ä»¥é¡ºå¸¦â€œé»‘â€ä¸€ä¸‹è‡ªå·±ä¹‹å‰çš„åšæ³•ï¼‰

ä½ è‡ªå·±é‚£å¥ã€Œ10000 æ¡ç´¯ç§¯å†™å…¥æ˜¯å¤§äº‹åŠ¡ã€çš„åæ€å¾ˆå¥½ã€‚
å¯ä»¥é¡ºå¸¦è¯´ä¸€å¥ä½ ç°åœ¨ä¼šæ€ä¹ˆè°ƒä¼˜å‚æ•°ï¼š

--limit=1000ï¼ˆæ¯æ‰¹æ‹‰ 1000 è¡Œï¼‰

--commit-eachï¼ˆæ¯æ‰¹ä¸€ä¸ªå°äº‹åŠ¡ï¼‰

--sleep=0.1 æˆ– --max-lag é…åˆï¼Œé˜²æ­¢å‹å®ä»åº“

è¿™æ ·ä¸€è®²ï¼Œé¢è¯•å®˜çŸ¥é“ä½ ä¸æ˜¯æ‹è„‘è¢‹ï¼Œè€Œæ˜¯è€ƒè™‘äº†ï¼š

ä¸»ä»å»¶è¿Ÿ

undo/redo å‹åŠ›

çº¿ä¸Š QPS æŠ¢ IO

3. éªŒè¯é˜¶æ®µå¯ä»¥é¡ºå˜´æä¸€ä¸‹ â€œpt-table-checksum/pt-table-syncâ€

ä½ ç°åœ¨è‡ªå·±å†™äº† hash/å½±å­è¯»æ–¹æ¡ˆï¼Œè¿™æ˜¯å¥½äº‹ã€‚
ä½†é¢è¯•æ—¶é¡ºå¸¦æä¸€å¥ï¼š

â€œå¦‚æœå¯¹å·¥å…·æ›´ä¿¡ä»»çš„è¯ï¼Œå…¶å®ä¹Ÿå¯ä»¥è€ƒè™‘ç”¨ pt-table-checksum åšç¦»çº¿æ ¡éªŒï¼Œå†ç”¨ pt-table-sync åšä¿®å¤ã€‚æˆ‘è¿™è¾¹ä¸ºäº†æ§åˆ¶éªŒè¯ç²’åº¦ï¼Œç”¨çš„æ˜¯å½±å­è¯» + æŒ‰ä¸»é”® range åšåˆ†ç‰‡ hash æ ¡éªŒã€‚â€

è¿™å¥è¯ä¸€å‡ºï¼Œé¢è¯•å®˜ä¼šè§‰å¾—ï¼šä½ æ—¢æ‡‚åŸç†ï¼ŒåˆçŸ¥é“å·¥å…·ç”Ÿæ€ã€‚

ä¸‰ã€é¢è¯•æ—¶æ€ä¹ˆç”¨è¿™å¥—æ–¹æ¡ˆï¼Ÿ

å»ºè®®ç”¨æ³•ï¼š

é‡åˆ°ä»»ä½• ã€Œæ•°æ®è¿ç§» / è¡¨æ‹†åˆ† / å†·çƒ­åˆ†ç¦» / åº“è¡¨æ”¹é€ ã€ ç±»å‹é—®é¢˜
â†’ ä½ ç›´æ¥å¼€å£å°±æ˜¯è¿™å¥— 4 é˜¶æ®µæ–¹æ¡ˆï¼ˆåŒå†™ â†’ å›å¡« â†’ éªŒè¯ â†’ åˆ‡æµï¼‰

å†ç»“åˆä½ è¿™æ¬¡çœŸå®å®è·µï¼š

ã€ŒA è‚¡åˆ†æ—¶è¡Œæƒ…è¡¨ 1.3kw+ è¡Œä»æœˆè¡¨è¿ç§»åˆ°æ¸©è¡¨åˆ†åŒºè¡¨ã€

ã€Œä½¿ç”¨ pt-archiverï¼Œè¡Œçº§è¿ç§»ã€--commit-eachã€--no-deleteï¼Œçº¿ä¸‹éªŒè¯æ— é”æ— è¶…æ—¶ã€

è¿™æ˜¯éå¸¸ç¡¬çš„å±¥å†é¡¹ï¼Œä¸æ˜¯é‚£ç§å¹å‡ºæ¥çš„â€œè®¾è®¡è¿‡æŸæŸç³»ç»Ÿâ€ã€‚
```



```mermaid

```





### å®‰å…¨æ€§æ€»ç»“è¯´æ˜



#### è¿ç§»æ–¹å¼ï¼ˆpt-archiverï¼‰æ˜¯å®‰å…¨çš„

æœ¬æ¬¡è¿ç§»é‡‡ç”¨ï¼š

```
å°æ‰¹é‡ SELECTï¼ˆ1000 è¡Œï¼‰  
+ å°äº‹åŠ¡æ‰¹é‡ INSERTï¼ˆ10000 è¡Œï¼‰
+ commit-each æ¯æ‰¹æäº¤ä¸€æ¬¡
```

è¿™æ˜¯ä¸šç•Œç”¨äº **é«˜å¹¶å‘ OLTP ç³»ç»Ÿåœ¨çº¿è¿ç§»å¤§è¡¨** çš„æœ€ä½³å®è·µï¼Œæ ¸å¿ƒç‰¹æ€§ï¼š

- **æ— é”è¯»**
- **è½»é‡å†™**
- **æ— å¤§äº‹åŠ¡**
- **ä¸ä¼šé˜»å¡çº¿ä¸Šä¸šåŠ¡**

è¿ç§»è¿‡ç¨‹ä¸­ï¼Œä½ å·²ç»éªŒè¯ï¼š
 âœ” æŸ¥è¯¢æ­£å¸¸
 âœ” æ’å…¥æ­£å¸¸
 âœ” æ²¡å‡ºç°é”ç­‰å¾…
 âœ” æ— ä¸šåŠ¡ä¾§æŠ¥é”™

------

#### ä¸ºä»€ä¹ˆä¸ä¼šé”è¡¨ï¼Ÿï¼ˆæŠ€æœ¯åŸç†ï¼‰



###### 1. SELECT æ˜¯å¿«ç…§è¯»ï¼ˆconsistent readï¼‰â€”â€”å®Œå…¨æ— é”

æ—§è¡¨è¯»å–ï¼š

```sql
SELECT ... WHERE trade_date BETWEEN ...
```

è¿™æ˜¯çº¯å¿«ç…§è¯»ï¼š

- ä¸åŠ è¡Œé”
- ä¸åŠ é—´éš™é”
- ä¸åŠ  next-key lock
- ä¸é˜»å¡ä¸šåŠ¡è¯»å†™

æ‰€ä»¥ä¸å½±å“ä¸šåŠ¡ QPSã€æ¯›éƒ½ä¸ä¼šåŠ¨ä¸€ä¸‹ã€‚

------

###### 2. INSERT å†™å…¥æ–°è¡¨ â€”â€” æœ¬è´¨ä¹Ÿä¸åŠ é”

INSERTï¼š

- ä¸é˜»å¡è¯»
- ä¸é˜»å¡å†™
- åªç”¨åˆ°è½»é‡è‡ªå¢é”ï¼ˆæçŸ­ï¼Œä¸å½±å“ä»»ä½•å¹¶å‘ä¸šåŠ¡ï¼‰

**æ‰€ä»¥ä¸ä¼šå¯¼è‡´ä¸šåŠ¡å¡é¡¿ã€ä¸ä¼šé”è¡¨ã€‚**

------

###### 3. commit-each é¿å…é•¿äº‹åŠ¡

æ¯è¿ 10000 è¡Œå°±æ‰§è¡Œä¸€æ¬¡ï¼š

```
COMMIT
```

é¿å…ï¼š

- undo log æ’‘çˆ†
- é•¿äº‹åŠ¡å¯¼è‡´ buffer pool å‹åŠ›
- æŒé”æ—¶é—´å˜é•¿

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿ç§»è¿‡ç¨‹ä¸­ä½ ä¸€ç‚¹å¡é¡¿éƒ½æ²¡é‡åˆ°ã€‚

------

#### ğŸ›¡ ä¸ºä»€ä¹ˆé«˜å¹¶å‘ä¸‹ä¾ç„¶ç¨³å®šï¼Ÿ



##### âœ” 1. æ—§è¡¨æ˜¯è¯»ï¼Œæ–°è¡¨æ˜¯å†™ â€”â€” å¤©ç„¶è§£è€¦

æ— ç«äº‰ï¼Œè‡ªç„¶ä¸ä¼šé”ã€‚

##### âœ” 2. æ¯æ¬¡ SELECT åªæœ‰ 1000 è¡Œ

ä¸ä¼šå½¢æˆå¤§å¿«ç…§ï¼Œä¸ä¼šå ç”¨å¤§é‡ undoã€‚

##### âœ” 3. æ¯æ¬¡ INSERT åªæœ‰ 10000 è¡Œ

äº‹åŠ¡è½»ï¼Œé”èŒƒå›´å°ï¼Œæäº¤å¿«ã€‚

##### âœ” 4. åœ¨çº¿è¿ç§»æ—¶ä¸šåŠ¡æ•°æ®ä¿æŒé™æ€ï¼ˆå†å²åˆ†è¡¨ï¼‰

ä¸ä¼šæœ‰æ›´æ–°/åˆ é™¤ï¼Œä¸ä¼šè§¦å‘è¡Œé”ç«äº‰ã€‚

##### âœ” 5. ä½ åˆ†åŒºè¡¨ç»“æ„è®¾è®¡å¾—åˆç†

åŸºäº `trade_date` åˆ†åŒºï¼Œæ–°çºªå½•è‡ªåŠ¨è½å…¥æ­£ç¡®åˆ†åŒºï¼Œä¸ä¼šæ‰«å…¶ä»–åˆ†åŒºã€‚

------

#### ğŸš€ å¦‚æœè¿ç§»æ—¶çªç„¶æ–­ç”µï¼Ÿ

æœ€åæƒ…å†µæ˜¯ï¼š

- å½“å‰æ‰¹æ¬¡ï¼ˆ10000 è¡Œï¼‰æ²¡å†™å®Œ
- ä¸‹ä¸€æ¬¡é‡æ–°æ‰§è¡Œå³å¯
- æ—§è¡¨æ•°æ®ä¸æ¯«ä¸ä¼šå—åˆ°å½±å“
- å·²å†™å…¥æ¸©æ•°æ®è¡¨çš„æ•°æ®ä»ä¿æŒä¸€è‡´

æœ¬è´¨æ˜¯ **å¹‚ç­‰ + å¯æ¢å¤** çš„è¿ç§»æ–¹å¼ã€‚

------

éªŒè¯ç»“æœï¼ˆä½ å·²ç»éªŒè¯æˆåŠŸï¼‰

ä½ éªŒè¯äº†ä¸‰ä¸ªå…³é”®ç‚¹ï¼š

##### â‘  åˆ†åŒºè½ç‚¹æ­£ç¡®

æ¯ä¸ªåˆ†åŒºï¼ˆp202001 / p202002 â€¦ï¼‰çš„æ•°æ®éƒ½åœ¨å¯¹åº”æœˆå†…ã€‚



##### â‘¡ æ–°æ—§è¡¨æ•°æ®å®Œå…¨ä¸€è‡´

total_volumeã€price ç­‰å­—æ®µä¸€è‡´ï¼ˆdecimal çš„æ ¼å¼ä¸å½±å“å€¼ï¼‰ã€‚



##### â‘¢ æ•°é‡ä¸€è‡´

ä¾‹å¦‚ï¼š

```
13344002ï¼ˆæ—§è¡¨ï¼‰
13344002ï¼ˆæ–°è¡¨ p202001ï¼‰
```

100% å¯¹é½ï¼Œè¯´æ˜è¿ç§»æ²¡æœ‰æ¼ä¹Ÿæ²¡æœ‰å¤šã€‚

------



### å¯ä»¥å†™è¿›ç®€å†çš„äº®ç‚¹

è¿™æ¬¡è¿ç§»æµç¨‹å®Œå…¨è¾¾åˆ°å¤§å‚ DBA/ä¸­é—´ä»¶å·¥ç¨‹å¸ˆçš„æ ‡å‡†ï¼š

- âœ” é›¶é”è¡¨è¿ç§»
- âœ” è‡ªåŠ¨åˆ†åŒºè½ç‚¹
- âœ” å…¨é‡å†å² 30M+ è¡Œå®‰å…¨è¿ç§»
- âœ” è¿ç§»å¤±è´¥è‡ªåŠ¨ç»­è·‘
- âœ” å¹¶å‘æ— æŸ
- âœ” æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
- âœ” å¯è¿ç»­è¿ç§» 36 ä¸ªæœˆå†å²è¡¨
- âœ” æ–¹æ¡ˆå¯å¤ç”¨åˆ°ä»»ä½•é«˜å¹¶å‘ä¸šåŠ¡

éå¸¸æ‰å®çš„ä¸€æ¬¡å·¥ç¨‹å®è·µã€‚

------

### æœ€ç»ˆä¸€å¥è¯æ€»ç»“

> **æˆ‘ä»¬é‡‡ç”¨çš„å°æ‰¹é‡ SELECT + å°äº‹åŠ¡ INSERT æ¨¡å¼å…¼é¡¾é«˜å¹¶å‘ä¸ç¨³å®šæ€§ï¼Œä¸ä¼šé”è¡¨ã€ä¸å½±å“ä¸šåŠ¡ã€æ–­ç”µå¯æ¢å¤ï¼Œå±äºæœ€å®‰å…¨çš„åœ¨çº¿è¿ç§»æ–¹å¼ã€‚**

------

















## åŸºç¡€ç¯å¢ƒ



### ğŸ§© ä¸€ã€å‡†å¤‡ç¯å¢ƒ

#### â‘  å¼€å¯ WSL2ï¼ˆå·²å®Œæˆï¼‰

#### â‘¡ å®‰è£… Ubuntuï¼ˆå·²å®Œæˆï¼‰

#### â‘¢ é…ç½® WSL2 ä»£ç†ï¼Œè®© WSL2 èƒ½è®¿é—®å¤–ç½‘ï¼ˆå·²å®Œæˆï¼‰

æ ¸å¿ƒå‘½ä»¤ï¼š

```bash
export http_proxy="http://ä½ çš„WindowsIP:7890"
export https_proxy="http://ä½ çš„WindowsIP:7890"
```

------

### ğŸ§© äºŒã€å®‰è£… gh-ost+pt-archiver

#### â‘  æ›´æ–°è½¯ä»¶æºï¼ˆå·²å®Œæˆï¼‰

```bash
sudo apt update
```

#### â‘¡ å®‰è£… wgetï¼ˆå·²å®Œæˆï¼‰

```bash
sudo apt install wget -y
```

#### â‘¢ ä¸‹è½½ gh-ost æœ€æ–°ç‰ˆæœ¬ï¼ˆå·²å®Œæˆï¼‰

>å®˜ç½‘åœ°å€

```http
https://github.com/github/gh-ost/releases
```



> ä½ æ‰§è¡Œçš„æ˜¯

```bash
wget https://github.com/github/gh-ost/releases/download/v1.1.7/gh-ost-binary-linux-amd64-20241219160321.tar.gz -O gh-ost.tar.gz
```



#### â‘£ è§£å‹

```bash
tar -xzf gh-ost.tar.gz
```

#### â‘¤ å®‰è£…åˆ°å…¨å±€è·¯å¾„

```bash
sudo mv gh-ost /usr/local/bin/
sudo chmod +x /usr/local/bin/gh-ost
```

#### â‘¥ éªŒè¯æ˜¯å¦æˆåŠŸ

```bash
gh-ost --version
```





#### å®‰è£…pt-archiver

> åœ¨ **Ubuntuï¼ˆWSLï¼‰** é‡Œé€šè¿‡ `apt` å®‰è£…çš„ â€”â€” è¿™ä¸€æ¡æ˜¯ä½ æ‰§è¡ŒæˆåŠŸçš„å‘½ä»¤ï¼š

##### âœ” æˆåŠŸå®‰è£… pt-archiver çš„çœŸå®å‘½ä»¤ï¼š

```
sudo apt-get update
sudo apt-get install percona-toolkit
```

å®‰è£…å®Œæˆåä½ æ‰§è¡Œäº†ï¼š

```
pt-archiver --version
```

è¿”å›çš„æ˜¯ï¼š

```
pt-archiver 3.2.1
```

è¿™è¯´æ˜ **pt-archiver å·²ç»å®‰è£…æˆåŠŸ**ã€‚









------

### ğŸ§© ä¸‰ã€å‡†å¤‡è¿ç§»é…ç½®

gh-ost ä½¿ç”¨ä¸­éœ€è¦ 3 ä¸ªæ ¸å¿ƒç‚¹ï¼š

#### â‘  MySQL è´¦å·å¿…é¡»å…·å¤‡ä»¥ä¸‹æƒé™ï¼š

```
replication client
replication slave
superï¼ˆä»… cutover æ—¶å¯éœ€è¦ï¼‰
alter
select
insert
update
delete
```

ä¸€èˆ¬ DBA ä¼šç»™ä¸€ä¸ªä¸“ç”¨è´¦æˆ·ã€‚

------

#### â‘¡ æ—§è¡¨ï¼ˆsource tableï¼‰

ä¾‹å¦‚ï¼š

```
tb_quotation_history_trend_202001
```

#### â‘¢ æ–°è¡¨ï¼ˆtarget tableï¼‰

ä½ å·²ç»å»ºå¥½äº†åˆ†åŒºè¡¨ï¼š

```
tb_quotation_history_hot
```

------

### ğŸ§© **å››ã€**æ‰§è¡Œåœ¨çº¿è¿ç§»**ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰**

ä¸‹é¢æ˜¯æœ€å…³é”®çš„æ­¥éª¤ï¼š
 gh-ost ä¼šåœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼š

- ä¸é˜»å¡å†™å…¥
- è‡ªåŠ¨åˆ›å»º ghost table
- æµå¼åŒæ­¥ binlog
- æœ€ç»ˆåŸå­åˆ‡æ¢ï¼ˆcut-overï¼‰

ç¤ºä¾‹å‘½ä»¤ï¼ˆæˆ‘ä¸¾ä¸ªä¾‹å­ï¼‰ï¼š

```bash
gh-ost \
--host=192.168.x.x \
--port=3306 \
--user=gho \
--password=xxx \
--database=a_share_quant \
--table=tb_quotation_history_trend_202001 \
--alter="ENGINE=InnoDB" \
--allow-on-master \
--allow-master-master \
--cut-over=default \
--exact-rowcount \
--chunk-size=1000 \
--max-lag-millis=1500 \
--initially-drop-ghost-table \
--initially-drop-old-table \
--verbose \
--execute
```

âš ï¸ æ³¨æ„ï¼š
 å®é™…å‘½ä»¤éœ€è¦æ ¹æ®ä½ çš„è¡¨ç»“æ„ã€è¿ç§»ç›®æ ‡ï¼ˆæ˜¯å¦åˆå¹¶å­—æ®µã€æ˜¯å¦æ”¹ä¸ºåˆ†åŒºè¡¨ï¼‰é‡æ–°ç”Ÿæˆã€‚
 æˆ‘å¯ä»¥å¸®ä½ è‡ªåŠ¨ç”Ÿæˆæœ€ç»ˆçš„ã€å¯ä»¥ç›´æ¥æ‰§è¡Œçš„è¿ç§»å‘½ä»¤ã€‚

------

### ğŸ§© äº”ã€è¿ç§»å®ŒæˆåéªŒè¯

è¿ç§»å®Œæˆååš 3 ä»¶äº‹ï¼š

#### â‘  æ ¡éªŒç›®æ ‡åˆ†åŒºè¡¨è®°å½•æ•°

æ£€æŸ¥æ˜¯å¦ä¸€è‡´ã€‚

#### â‘¡ æ£€æŸ¥ä¸šåŠ¡æŸ¥è¯¢æ˜¯å¦æ­£å¸¸å‘½ä¸­æ–°è¡¨

#### â‘¢ ä¿ç•™ gh-ost æ—¥å¿—ç”¨äºå®¡è®¡ï¼ˆå¤§å‚éƒ½è¦æ±‚ï¼‰

------

### ğŸ§© å…­ã€åç»­å¯è‡ªåŠ¨åŒ–

è¿ç§»ä¸€å¼ è¡¨å¯ä»¥æ‰‹å·¥æ‰§è¡Œï¼›
 ä½†è¿ç§» 24 å¼ æœˆè¡¨ï¼Œä½ å¯ä»¥è€ƒè™‘åšï¼š

- SpringBoot + ProcessBuilder è°ƒ gh-ost
- æˆ–è€…åšä¸€ä¸ª Shell å¾ªç¯è¿ç§»è„šæœ¬
- æˆ–è€…åš CI/CD ä¸€é”®è¿ç§» pipeline

æˆ‘å¯ä»¥å¸®ä½ å†™è‡ªåŠ¨æ‰¹å¤„ç†è„šæœ¬ã€‚

------

#### â­ æ€»ç»“ä¸€å¥è¯

> **ä½ ç°åœ¨ç¯å¢ƒå·²ç»å®Œå…¨ ready**ï¼Œåªå·®æœ€åä¸€æ­¥ï¼š
>  ğŸ‘‰ ç”Ÿæˆé€‚åˆä½ ä¸šåŠ¡ã€ä½ çš„è¡¨åã€ä½ çš„éœ€è¦çš„ **å®Œæ•´ gh-ost å®é™…è¿ç§»å‘½ä»¤**
>  ç„¶åæ‰§è¡Œå³å¯ã€‚

------









## åˆ›å»ºè¿ç§»ç”¨æˆ·



### åˆ›å»º pt-archiver è¿ç§»ä¸“ç”¨è´¦å·

```sql
# ============================================================
# åˆ›å»º pt-archiver è¿ç§»ä¸“ç”¨è´¦å·ï¼ˆåªåˆ›å»ºä¸€æ¬¡å³å¯ï¼‰
# ============================================================
# ä½œç”¨ï¼šä¸ºæ•°æ®è¿ç§»æä¾›ç‹¬ç«‹è´¦å·ï¼Œé¿å…ä½¿ç”¨ rootï¼Œé™ä½é£é™©ã€‚
# '%' è¡¨ç¤ºå…è®¸ä»»æ„ IPï¼ˆä½ éœ€è¦ä» WSL è¿è¿‡å»ï¼Œæ‰€ä»¥å¿…é¡»ç”¨ '%'ï¼‰
CREATE USER 'hli_gho'@'%' IDENTIFIED BY 'Q836184425';
```



### æˆäºˆæƒé™

```sql
# ============================================================
# æˆäºˆæƒé™ï¼ˆé’ˆå¯¹ a_share_quant åº“ï¼‰
# ============================================================
# ä½œç”¨ï¼šè¿ç§»éœ€è¦ SELECTï¼ˆè¯»æ—§è¡¨ï¼‰ + INSERTï¼ˆå†™æ–°è¡¨ï¼‰æƒé™
#      ç”±äº pt-archiver åœ¨ç‰¹æ®Šæƒ…å†µä¸‹å¯èƒ½éœ€è¦ DELETEï¼Œæ‰€ä»¥ç»™ ALLã€‚
#      ä½†ä½ è¿è¡Œæ—¶ä½¿ç”¨ --no-deleteï¼Œå®é™…ä¸ä¼šåˆ é™¤ã€‚
GRANT ALL PRIVILEGES ON a_share_quant.* TO 'hli_gho'@'%';

```



### åˆ·æ–°æƒé™ï¼ˆæƒé™å˜æ›´å¿…é¡»æ‰§è¡Œï¼‰

```sql
# ============================================================
# åˆ·æ–°æƒé™ï¼ˆæƒé™å˜æ›´å¿…é¡»æ‰§è¡Œï¼‰
# ============================================================
FLUSH PRIVILEGES;
```



### éªŒè¯æƒé™



#### 1.æµ‹è¯• SELECT æƒé™ï¼ˆéªŒè¯èƒ½è¯»æ—§è¡¨ï¼‰

```sql
# ============================================================
# ç¬¬ 1 æ­¥ï¼šæµ‹è¯• SELECT æƒé™ï¼ˆéªŒè¯èƒ½è¯»æ—§è¡¨ï¼‰
# ============================================================
# è¿”å›æ•°å­—ï¼ˆå¦‚ 13344002ï¼‰è¯´æ˜ï¼š
# âœ” è´¦å·èƒ½æ­£å¸¸ SELECT æ—§åˆ†è¡¨ï¼ˆtb_quotation_history_trend_202001ï¼‰
USE a_share_quant;

SELECT COUNT(*) 
FROM tb_quotation_history_trend_202001 
LIMIT 1;
```



#### 2.æµ‹è¯• INSERT æƒé™ï¼ˆéªŒè¯èƒ½å†™æ¸©æ•°æ®è¡¨ï¼‰

```sql
# ============================================================
# ç¬¬ 2 æ­¥ï¼šæµ‹è¯• INSERT æƒé™ï¼ˆéªŒè¯èƒ½å†™æ¸©æ•°æ®è¡¨ï¼‰
# ============================================================
# ç”¨äº‹åŠ¡ ROLLBACKï¼Œä¸æ±¡æŸ“çœŸå®æ•°æ®ã€‚
# è¿”å› â€œQuery OKâ€ å³è¡¨ç¤ºï¼š
# âœ” INSERT æƒé™æ­£å¸¸
START TRANSACTION;

INSERT INTO tb_quotation_history_warm
(wind_code, trade_date, latest_price, total_volume, average_price, STATUS)
VALUES ('TEST123', '2020-01-01 09:30:00', 1.23, 1000, 1.23, 1);

# ä¸ä¿ç•™æ•°æ®ï¼Œå›æ»š
ROLLBACK;
```



#### 3.æµ‹è¯• UPDATE/DELETE æƒé™

```sql
# ============================================================
# ç¬¬ 3 æ­¥ï¼ˆå¯é€‰ï¼‰ï¼šæµ‹è¯• UPDATE/DELETE æƒé™
# ============================================================
# ä¸€èˆ¬ç”¨äºæ£€æŸ¥ pt-archiver æ˜¯å¦èƒ½è¿è¡Œ DELETEï¼ˆä½ ç”¨äº† --no-delete å¯ä¸æµ‹ï¼‰
START TRANSACTION;

UPDATE tb_quotation_history_warm 
SET STATUS = 0 
WHERE wind_code='TEST123';

ROLLBACK;
```



#### 4.é¢å¤–æƒé™ï¼špt å·¥å…·éœ€è¦çš„åŸºç¡€å¤åˆ¶æƒé™

```sql
# ============================================================
# é¢å¤–æƒé™ï¼špt å·¥å…·éœ€è¦çš„åŸºç¡€å¤åˆ¶æƒé™
# ============================================================
# ä½œç”¨ï¼šé¿å… pt-archiver/gh-ost è¿è¡Œæ—¶æŠ¥ï¼š
# ERROR: User has insufficient privileges for migration
# è¿™ä¸¤ä¸ªæƒé™ä¸ä¼šå½±å“æ•°æ®ï¼Œä¸ä¼šå¯åŠ¨å¤åˆ¶ï¼Œåªæ˜¯å…è®¸è¯»å–å¿…è¦çš„ç³»ç»Ÿä¿¡æ¯ã€‚
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'hli_gho'@'%';



# å†æ‰§è¡Œä¸€éåº“æƒé™ï¼ˆå†ªç­‰ï¼‰
GRANT ALL PRIVILEGES ON a_share_quant.* TO 'hli_gho'@'%';



# åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
```













> **æŠŠè€è¡¨ï¼ˆtb_quotation_history_trend_202001ï¼‰è¿ç§»åˆ°æ–°çš„æ¸©è¡¨ï¼ˆtb_quotation_history_warmï¼‰**

å¹¶ç¡®ä¿ï¼š

- **ä¸é˜»å¡ä¸šåŠ¡å†™å…¥**
- **æ•°æ®å¯é è¿ç§»**
- **å­—æ®µç»“æ„å·®å¼‚è‡ªåŠ¨å¤„ç†**
- **æœ€ç»ˆè½åº“åˆ°å¯¹åº”çš„åˆ†åŒºï¼ˆ202001 åˆ†åŒºï¼‰**
- **æ”¯æŒåç»­æ‰¹é‡è¿ç§»å…¶ä»–æœˆè¡¨**



#### å‰ç½®æ­¥éª¤

##### â­ ç¬¬ 1 æ­¥ï¼šç¡®è®¤æ–°ç›®æ ‡æ¸©è¡¨å·²å»ºå¥½ï¼ˆä½ å·²ç»å®Œæˆï¼‰

ç¡®ä¿ï¼š

- ä¸»é”®æ ¼å¼ï¼š(id, trade_date)
- åˆ†åŒºå¥ = trade_date
- p202001 åˆ†åŒºå­˜åœ¨ï¼ˆä½ ä¹Ÿå·²ä¿®å¤ï¼‰
- ROW_FORMAT=COMPRESSEDï¼ˆå·² OKï¼‰

------

##### â­ ç¬¬ 2 æ­¥ï¼šé€‰æ‹©è¿ç§»å·¥å…·ï¼ˆä½ å·²å®‰è£… gh-ostï¼‰

ä½ ç°åœ¨çš„æŠ€æœ¯æ ˆï¼š

- WSL2 Ubuntu
- å·²å¯è¿æ¥ GitHub + å¤–ç½‘
- gh-ost å·²æˆåŠŸä¸‹è½½

è¿™æ˜¯æ‰§è¡Œåœ¨çº¿è¿ç§» **æœ€ä½³æ–¹æ¡ˆ**ï¼Œèƒ½ç¡®ä¿ï¼š

- è¿ç§»æ—¶æ—§è¡¨ä»å¯å†™å…¥
- binlog å®æ—¶åŒæ­¥
- cutover åŸå­åˆ‡æ¢

------

##### â­ ç¬¬ 3 æ­¥ï¼šä¸ºè¿ç§»åˆ›å»ºä¸“ç”¨ MySQL è´¦å·ï¼ˆå¼ºçƒˆæ¨èï¼‰

>æœ€å°æƒé™ï¼š

```sql
#åˆ›å»ºç”¨æˆ·hli_gho
CREATE USER 'hli_gho'@'%' IDENTIFIED BY 'Q836184425';

#æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON a_share_quant.* TO 'hli_gho'@'%';

#åˆ·æ–°æƒé™
FLUSH PRIVILEGES;


GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'hli_gho'@'%';

GRANT ALL PRIVILEGES ON a_share_quant.* TO 'hli_gho'@'%';

FLUSH PRIVILEGES;
```



>éªŒè¯åˆ›å»º

```sql
C:\Users\lihao>mysql -u hli_gho -p -h 127.0.0.1 -P 3306
Enter password: **********
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1037
Server version: 8.0.42 MySQL Community Server - GPL

Copyright (c) 2000, 2025, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| a_share_quant      |
| information_schema |
| performance_schema |
+--------------------+
3 rows in set (0.01 sec)

mysql>
```

åˆ›å»ºæˆåŠŸï¼Œæ“ä½œæƒé™a_share_quant



>æµ‹è¯•selectæƒé™(æ—§è¡¨)

```sql
hli@hli:~$ mysql -u hli_gho -p -h 192.168.168.57 -P 3306
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1041
Server version: 8.0.42 MySQL Community Server - GPL

Copyright (c) 2000, 2025, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> SHOW MASTER STATUS;
+---------------+-----------+--------------+------------------+-------------------+
| File          | Position  | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------+-----------+--------------+------------------+-------------------+
| binlog.000128 | 623251348 |              |                  |                   |
+---------------+-----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)

mysql> USE a_share_quant;
*) FROM tb_quotation_history_trend_202001 LIMIT 1;Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> SELECT COUNT(*) FROM tb_quotation_history_trend_202001 LIMIT 1;
+----------+
| COUNT(*) |
+----------+
| 13344002 |
+----------+
1 row in set (6.02 sec)

mysql>
```





```sql
hli@hli:~$ gh-ost \
 --user="hli_gho" \
 --password="Q836184425" \
 --host="192.168.168.57" \
 --database="a_share_quant" \
 --table="tb_quotation_history_trend_202001" \
 --alter="ENGINE=InnoDB" \
 --allow-on-master \
 --initially-drop-ghost-table \
 --initially-drop-old-table \
 --verbose
2025-11-24 21:49:51 INFO starting gh-ost 1.1.7 (git commit: d5ab048c1f046821f3c7384a386fc1c3ae399c92)
2025-11-24 21:49:51 INFO Migrating `a_share_quant`.`tb_quotation_history_trend_202001`
2025-11-24 21:49:51 INFO inspector connection validated on 192.168.168.57:3306
2025-11-24 21:49:51 INFO User has REPLICATION CLIENT, REPLICATION SLAVE privileges, and has ALL privileges on `a_share_quant`.*
2025-11-24 21:49:51 INFO binary logs validated on 192.168.168.57:3306
2025-11-24 21:49:51 INFO Restarting replication on 192.168.168.57:3306 to make sure binlog settings apply to replication thread
2025-11-24 21:49:51 INFO Inspector initiated on hli:3306, version 8.0.42
2025-11-24 21:49:51 INFO Table found. Engine=InnoDB
2025-11-24 21:49:51 INFO Estimated number of rows via EXPLAIN: 12885383
2025-11-24 21:49:51 INFO Recursively searching for replication master
2025-11-24 21:49:51 INFO Master found to be hli:3306
2025-11-24 21:49:51 INFO log_slave_updates validated on 192.168.168.57:3306
2025-11-24 21:49:51 INFO streamer connection validated on 192.168.168.57:3306
[2025/11/24 21:49:51] [info] binlogsyncer.go:173 create BinlogSyncer with config {ServerID:99999 Flavor:mysql Host:192.168.168.57 Port:3306 User:hli_gho Password: Localhost: Charset: SemiSyncEnabled:false RawModeEnabled:false TLSConfig:<nil> ParseTime:false TimestampStringLocation:UTC UseDecimal:true RecvBufferSize:0 HeartbeatPeriod:0s ReadTimeout:0s MaxReconnectAttempts:0 DisableRetrySync:false VerifyChecksum:false DumpCommandFlag:0 Option:<nil> Logger:0xc00009e7e0 Dialer:0x6bc600 RowsEventDecodeFunc:<nil> DiscardGTIDSet:false}
2025-11-24 21:49:51 INFO Connecting binlog streamer at binlog.000128:623251348
[2025/11/24 21:49:51] [info] binlogsyncer.go:410 begin to sync binlog from position (binlog.000128, 623251348)
[2025/11/24 21:49:51] [info] binlogsyncer.go:813 rotate to (binlog.000128, 623251348)
2025-11-24 21:49:51 INFO rotate to next log from binlog.000128:0 to binlog.000128
2025-11-24 21:49:51 INFO applier connection validated on 192.168.168.57:3306
2025-11-24 21:49:51 INFO applier connection validated on 192.168.168.57:3306
2025-11-24 21:49:51 INFO will use time_zone='SYSTEM' on applier
2025-11-24 21:49:51 INFO Examining table structure on applier
2025-11-24 21:49:51 INFO Applier initiated on hli:3306, version 8.0.42
2025-11-24 21:49:51 INFO Dropping table `a_share_quant`.`_tb_quotation_history_trend_202001_gho`
2025-11-24 21:49:51 INFO Table dropped
2025-11-24 21:49:51 INFO Dropping table `a_share_quant`.`_tb_quotation_history_trend_202001_del`
2025-11-24 21:49:51 INFO Table dropped
2025-11-24 21:49:51 INFO Dropping table `a_share_quant`.`_tb_quotation_history_trend_202001_ghc`
2025-11-24 21:49:51 INFO Table dropped
2025-11-24 21:49:51 INFO Creating changelog table `a_share_quant`.`_tb_quotation_history_trend_202001_ghc`
2025-11-24 21:49:51 INFO Changelog table created
2025-11-24 21:49:51 INFO Creating ghost table `a_share_quant`.`_tb_quotation_history_trend_202001_gho`
2025-11-24 21:49:51 INFO Ghost table created
2025-11-24 21:49:51 INFO Altering ghost table `a_share_quant`.`_tb_quotation_history_trend_202001_gho`
2025-11-24 21:49:51 INFO Ghost table altered
2025-11-24 21:49:51 INFO Intercepted changelog state GhostTableMigrated
2025-11-24 21:49:51 INFO Waiting for ghost table to be migrated. Current lag is 0s
2025-11-24 21:49:51 INFO Handled changelog state GhostTableMigrated
2025-11-24 21:49:51 INFO Chosen shared unique key is PRIMARY
2025-11-24 21:49:51 INFO Shared columns are wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time
2025-11-24 21:49:51 INFO Listening on unix socket file: /tmp/gh-ost.a_share_quant.tb_quotation_history_trend_202001.sock
2025-11-24 21:49:51 INFO Intercepted changelog state ReadMigrationRangeValues
2025-11-24 21:49:51 INFO Handled changelog state ReadMigrationRangeValues
2025-11-24 21:49:51 INFO Migration min values: [000001.SZ,2020-01-02 09:25:03]
2025-11-24 21:49:51 INFO Migration max values: [900957.SH,2020-01-23 15:00:00]
2025-11-24 21:49:51 INFO Waiting for first throttle metrics to be collected
2025-11-24 21:49:51 INFO First throttle metrics collected
# Migrating `a_share_quant`.`tb_quotation_history_trend_202001`; Ghost table is `a_share_quant`.`_tb_quotation_history_trend_202001_gho`
# Migrating hli:3306; inspecting hli:3306; executing on hli
# Migration started at Mon Nov 24 21:49:51 +0800 2025
2025-11-24 21:49:51 INFO Row copy complete
# chunk-size: 1000; max-lag-millis: 1500ms; dml-batch-size: 10; max-load: ; critical-load: ; nice-ratio: 0.000000
# Migrating `a_share_quant`.`tb_quotation_history_trend_202001`; Ghost table is `a_share_quant`.`_tb_quotation_history_trend_202001_gho`
# Migrating hli:3306; inspecting hli:3306; executing on hli
# Migration started at Mon Nov 24 21:49:51 +0800 2025
# throttle-additional-flag-file: /tmp/gh-ost.throttle
# Serving on unix socket: /tmp/gh-ost.a_share_quant.tb_quotation_history_trend_202001.sock
# chunk-size: 1000; max-lag-millis: 1500ms; dml-batch-size: 10; max-load: ; critical-load: ; nice-ratio: 0.000000
# throttle-additional-flag-file: /tmp/gh-ost.throttle
# Serving on unix socket: /tmp/gh-ost.a_share_quant.tb_quotation_history_trend_202001.sock
Copy: 0/12885383 0.0%; Applied: 0; Backlog: 0/1000; Time: 0s(total), 0s(copy); streamer: binlog.000128:623255295; Lag: 0.02s, HeartbeatLag: 0.02s, State: migrating; ETA: N/A
2025-11-24 21:49:51 INFO Copy: 0/12885383 0.0%; Applied: 0; Backlog: 0/1000; Time: 0s(total), 0s(copy); streamer: binlog.000128:623255295; Lag: 0.02s, HeartbeatLag: 0.02s, State: migrating; ETA: N/A []
Copy: 0/0 100.0%; Applied: 0; Backlog: 0/1000; Time: 0s(total), 0s(copy); streamer: binlog.000128:623255295; Lag: 0.02s, HeartbeatLag: 0.02s, State: migrating; ETA: due
2025-11-24 21:49:51 INFO Copy: 0/0 100.0%; Applied: 0; Backlog: 0/1000; Time: 0s(total), 0s(copy); streamer: binlog.000128:623255295; Lag: 0.02s, HeartbeatLag: 0.02s, State: migrating; ETA: due []
2025-11-24 21:49:51 INFO Writing changelog state: Migrated
2025-11-24 21:49:51 INFO New table structure follows
CREATE TABLE `_tb_quotation_history_trend_202001_gho` (
  `wind_code` varchar(20) NOT NULL COMMENT 'è‚¡ç¥¨ä»£ç ',
  `trade_date` datetime NOT NULL COMMENT 'äº¤æ˜“æ—¥æœŸæ—¶é—´',
  `latest_price` decimal(10,4) DEFAULT NULL COMMENT 'æœ€æ–°ä»·',
  `total_volume` decimal(50,5) DEFAULT NULL,
  `average_price` decimal(10,4) DEFAULT NULL COMMENT 'å‡ä»·',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT 'æ•°æ®çŠ¶æ€ï¼š0.æ— æ•ˆ, 1.æœ‰æ•ˆ(é»˜è®¤)',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`wind_code`,`trade_date`),
  KEY `idx_wind_code` (`wind_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='è¡Œæƒ…-å†å²åˆ†æ—¶æ•°æ®è¡¨202001'
[2025/11/24 21:49:51] [info] binlogsyncer.go:206 syncer is closing...
[2025/11/24 21:49:51] [info] binlogsyncer.go:906 kill last connection id 1045
[2025/11/24 21:49:51] [info] binlogsyncer.go:236 syncer is closed
2025-11-24 21:49:51 INFO Closed streamer connection. err=<nil>
2025-11-24 21:49:51 INFO Dropping table `a_share_quant`.`_tb_quotation_history_trend_202001_ghc`
2025-11-24 21:49:51 INFO Table dropped
2025-11-24 21:49:51 INFO Dropping table `a_share_quant`.`_tb_quotation_history_trend_202001_gho`
2025-11-24 21:49:51 INFO Table dropped
2025-11-24 21:49:51 INFO Done migrating `a_share_quant`.`tb_quotation_history_trend_202001`
2025-11-24 21:49:51 INFO Removing socket file: /tmp/gh-ost.a_share_quant.tb_quotation_history_trend_202001.sock
2025-11-24 21:49:51 INFO Tearing down inspector
2025-11-24 21:49:51 INFO Tearing down applier
2025-11-24 21:49:51 INFO Tearing down streamer
2025-11-24 21:49:51 INFO Tearing down throttler
# Done
hli@hli:~$
```







```bash
sudo apt install percona-toolkit
```

```bash
hli@hli:~$ pt-archiver --version
pt-archiver 3.2.1
```











## å…³é”®è¡¨ç»“æ„



### å¾…è¿ç§»è¡¨



#### tb_quotation_history_trend_202001

```sql
/*
SQLyog Professional v12.09 (64 bit)
MySQL - 8.0.42 : Database - a_share_quant
*********************************************************************
*/

/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
/*Table structure for table `tb_quotation_history_trend_202001` */

CREATE TABLE `tb_quotation_history_trend_202001` (
  `wind_code` varchar(20) NOT NULL COMMENT 'è‚¡ç¥¨ä»£ç ',
  `trade_date` datetime NOT NULL COMMENT 'äº¤æ˜“æ—¥æœŸæ—¶é—´',
  `latest_price` decimal(10,4) DEFAULT NULL COMMENT 'æœ€æ–°ä»·',
  `total_volume` decimal(50,5) DEFAULT NULL COMMENT 'æ€»æˆäº¤é‡',
  `average_price` decimal(10,4) DEFAULT NULL COMMENT 'å‡ä»·',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT 'æ•°æ®çŠ¶æ€ï¼š0.æ— æ•ˆ, 1.æœ‰æ•ˆ(é»˜è®¤)',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`wind_code`,`trade_date`),
  KEY `idx_wind_code` (`wind_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='è¡Œæƒ…-å†å²åˆ†æ—¶æ•°æ®è¡¨202001'; 
```





### æ–°è¡¨ç»“æ„

#### æ¸©æ•°æ®è¡¨tb_quotation_history_warm

```sql
USE `a_share_quant`;

-- ================================================================================
-- 2. æ¸©æ•°æ®è¡¨ï¼ˆ2020å¹´1æœˆ - 2023å¹´12æœˆï¼Œå‹ç¼©å­˜å‚¨ï¼Œä¸­é€ŸæŸ¥è¯¢ï¼‰
-- ================================================================================

DROP TABLE IF EXISTS tb_quotation_history_warm;

CREATE TABLE `tb_quotation_history_warm` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ä¸»é”®ID',
  `wind_code` VARCHAR(20) NOT NULL COMMENT 'è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š000001.SZï¼‰',
  `trade_date` DATETIME NOT NULL COMMENT 'äº¤æ˜“æ—¶é—´ï¼ˆç§’çº§ç²¾åº¦ï¼‰',
  `latest_price` DECIMAL(10,4) DEFAULT NULL COMMENT 'æœ€æ–°ä»·æ ¼',
  `total_volume` DECIMAL(50,5) DEFAULT NULL COMMENT 'æ€»æˆäº¤é‡',
  `average_price` DECIMAL(10,4) DEFAULT NULL COMMENT 'å‡ä»·',
  `status` TINYINT NOT NULL DEFAULT '1' COMMENT 'æ•°æ®çŠ¶æ€ï¼š0=æ— æ•ˆ, 1=æœ‰æ•ˆ',
  `create_time` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è®°å½•åˆ›å»ºæ—¶é—´',
  `update_time` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'è®°å½•æ›´æ–°æ—¶é—´',
    
    PRIMARY KEY (id, trade_date),
    UNIQUE KEY uniq_windcode_tradedate (wind_code, trade_date)
    
) ENGINE=INNODB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_0900_ai_ci
  
  -- å…³é”®ï¼šå¯ç”¨å‹ç¼©å­˜å‚¨
  ROW_FORMAT=COMPRESSED
  KEY_BLOCK_SIZE=8
  
  COMMENT='æ¸©æ•°æ®è¡¨ï¼š2020-2023å†å²è¡Œæƒ…ï¼ˆå‹ç¼©4:1ï¼ŒæŸ¥è¯¢å»¶è¿Ÿ1-3ç§’ï¼‰,pYYYYMM VALUES LESS THAN =(ä¸‹ä¸ªæœˆ01å·)'
  
  -- æŒ‰æœˆåˆ†åŒºï¼ˆ48ä¸ªæœˆï¼‰
  PARTITION BY RANGE COLUMNS(trade_date) (
    -- 2020å¹´
    PARTITION p202001 VALUES LESS THAN ('2020-02-01'),
    PARTITION p202002 VALUES LESS THAN ('2020-03-01'),
    PARTITION p202003 VALUES LESS THAN ('2020-04-01'),
    PARTITION p202004 VALUES LESS THAN ('2020-05-01'),
    PARTITION p202005 VALUES LESS THAN ('2020-06-01'),
    PARTITION p202006 VALUES LESS THAN ('2020-07-01'),
    PARTITION p202007 VALUES LESS THAN ('2020-08-01'),
    PARTITION p202008 VALUES LESS THAN ('2020-09-01'),
    PARTITION p202009 VALUES LESS THAN ('2020-10-01'),
    PARTITION p202010 VALUES LESS THAN ('2020-11-01'),
    PARTITION p202011 VALUES LESS THAN ('2020-12-01'),
    PARTITION p202012 VALUES LESS THAN ('2021-01-01'),
    
    -- 2021å¹´
    PARTITION p202101 VALUES LESS THAN ('2021-02-01'),
    PARTITION p202102 VALUES LESS THAN ('2021-03-01'),
    PARTITION p202103 VALUES LESS THAN ('2021-04-01'),
    PARTITION p202104 VALUES LESS THAN ('2021-05-01'),
    PARTITION p202105 VALUES LESS THAN ('2021-06-01'),
    PARTITION p202106 VALUES LESS THAN ('2021-07-01'),
    PARTITION p202107 VALUES LESS THAN ('2021-08-01'),
    PARTITION p202108 VALUES LESS THAN ('2021-09-01'),
    PARTITION p202109 VALUES LESS THAN ('2021-10-01'),
    PARTITION p202110 VALUES LESS THAN ('2021-11-01'),
    PARTITION p202111 VALUES LESS THAN ('2021-12-01'),
    PARTITION p202112 VALUES LESS THAN ('2022-01-01'),
    
    -- 2022å¹´
    PARTITION p202201 VALUES LESS THAN ('2022-02-01'),
    PARTITION p202202 VALUES LESS THAN ('2022-03-01'),
    PARTITION p202203 VALUES LESS THAN ('2022-04-01'),
    PARTITION p202204 VALUES LESS THAN ('2022-05-01'),
    PARTITION p202205 VALUES LESS THAN ('2022-06-01'),
    PARTITION p202206 VALUES LESS THAN ('2022-07-01'),
    PARTITION p202207 VALUES LESS THAN ('2022-08-01'),
    PARTITION p202208 VALUES LESS THAN ('2022-09-01'),
    PARTITION p202209 VALUES LESS THAN ('2022-10-01'),
    PARTITION p202210 VALUES LESS THAN ('2022-11-01'),
    PARTITION p202211 VALUES LESS THAN ('2022-12-01'),
    PARTITION p202212 VALUES LESS THAN ('2023-01-01'),
    
    -- 2023å¹´
    PARTITION p202301 VALUES LESS THAN ('2023-02-01'),
    PARTITION p202302 VALUES LESS THAN ('2023-03-01'),
    PARTITION p202303 VALUES LESS THAN ('2023-04-01'),
    PARTITION p202304 VALUES LESS THAN ('2023-05-01'),
    PARTITION p202305 VALUES LESS THAN ('2023-06-01'),
    PARTITION p202306 VALUES LESS THAN ('2023-07-01'),
    PARTITION p202307 VALUES LESS THAN ('2023-08-01'),
    PARTITION p202308 VALUES LESS THAN ('2023-09-01'),
    PARTITION p202309 VALUES LESS THAN ('2023-10-01'),
    PARTITION p202310 VALUES LESS THAN ('2023-11-01'),
    PARTITION p202311 VALUES LESS THAN ('2023-12-01'),
    PARTITION p202312 VALUES LESS THAN ('2024-01-01'),
    
    PARTITION p_future VALUES LESS THAN (MAXVALUE)
);
```







## å®è·µè¿ç§»



> **æŠŠè€è¡¨ï¼ˆtb_quotation_history_trend_202001ï¼‰è¿ç§»åˆ°æ–°çš„æ¸©è¡¨ï¼ˆtb_quotation_history_warmï¼‰**

å¹¶ç¡®ä¿ï¼š

- **ä¸é˜»å¡ä¸šåŠ¡å†™å…¥**
- **æ•°æ®å¯é è¿ç§»**
- **å­—æ®µç»“æ„å·®å¼‚è‡ªåŠ¨å¤„ç†**
- **æœ€ç»ˆè½åº“åˆ°å¯¹åº”çš„åˆ†åŒºï¼ˆ202001 åˆ†åŒºï¼‰**
- **æ”¯æŒåç»­æ‰¹é‡è¿ç§»å…¶ä»–æœˆè¡¨**



### è¿ç§»tb_quotation_history_trendåˆ°æ¸©æ•°æ®è¡¨



#### 1.å­—æ®µä¸€è‡´

>å°†åŸè¡¨æ–°å¢ä¸€ä¸ªnullå€¼çš„idå­—æ®µï¼Œç”¨äºå¯¹åº”ä¸€è‡´æ€§ï¼Œidåœ¨æ¸©æ•°æ®è¡¨ä¸­çš„å…·ä½“å€¼ä¼šè‡ªå¢
>
>è§£å†³è¡¨å­—æ®µç¼ºå¤±æ— æ³•è¿ç§»çš„é—®é¢˜

```sql
ALTER TABLE tb_quotation_history_trend_202001
ADD COLUMN id BIGINT UNSIGNED NULL;
```





#### 2.è¿ç§»å‘½ä»¤



##### å®è·µå‘½ä»¤

```bash
hli@hli:~$ pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202001,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-01-01' AND trade_date < '2020-02-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```

###### å¸¦æ³¨é‡Šç‰ˆæœ¬

```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202001,u=hli_gho,p=Q836184425 \
  # æŒ‡å®šæºç«¯æ•°æ®åº“ä¿¡æ¯ï¼ˆå¿…é¡»åŒ…å«ä¸»é”®æˆ–å”¯ä¸€é”®ï¼‰  
  # h=IP, P=ç«¯å£, D=æ•°æ®åº“å, t=è¡¨å, u/p=è´¦å·å¯†ç   
  # tb_quotation_history_trend_202001 = å†·æ•°æ®æ—§è¡¨

  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  # æŒ‡å®šç›®æ ‡ç«¯æ•°æ®åº“ï¼ˆæ¸©æ•°æ®è¡¨ï¼‰  
  # å†™å…¥åˆ° tb_quotation_history_warm

  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  # æ˜¾å¼æŒ‡å®šè¿ç§»çš„åˆ—ï¼ˆç›®çš„è¡¨æ¯”æºè¡¨å¤šä¸€ä¸ª idï¼Œè‡ªå¢ä¸å—å½±å“ï¼‰  
  # å…³é”®æŠ€å·§ï¼šä¸ºäº†é¿å… pt-archiver æŠ¥é”™â€œdest å¤šäº† idâ€ï¼Œå¿…é¡»æŠŠæ‰€æœ‰æºè¡¨åˆ— + id ä¸€èµ·å†™å‡º  
  # è¿™æ ·ç›®æ ‡è¡¨çš„ id ä¼šè‡ªå·±è‡ªå¢å¡«å……ï¼Œä¸ä¾èµ–æºè¡¨çš„ idï¼ˆæºè¡¨ id æ˜¯ NULLï¼‰

  --where "trade_date >= '2020-01-01' AND trade_date < '2020-02-01'" \
  # è¿ç§»æ¡ä»¶ï¼šä»…è¿ç§» 2020 å¹´ 1 æœˆä»½æ•°æ®  
  # æŒ‰æœˆè¿ç§»æ›´å®‰å…¨ï¼Œé¿å…ä¸€æ¬¡æ‹·è´å…¨åº“å¯¼è‡´å¤§äº‹åŠ¡

  --limit 10000 \
  # æ¯æ‰¹ SELECT 10000 è¡Œ  
  # è¿™ä¸ªå€¼è¶Šå¤§ï¼Œè¿ç§»è¶Šå¿«ï¼Œä¸€èˆ¬æ¨è 5k-20k  
  # æœ¬æ¬¡è¿ç§» 10000 å±äºæ¯”è¾ƒç¨³å¦¥çš„é€‰æ‹©

  --commit-each \
  # æ¯æ¬¡æ‰¹å¤„ç†æ‰§è¡Œä¸€æ¬¡æäº¤ï¼ˆäº‹åŠ¡çº§åˆ«å¾ˆå°ï¼‰  
  # é¿å…å¤§äº‹åŠ¡å¯¼è‡´é”ç­‰å¾…ã€å›æ»šæ—¶é—´é•¿ç­‰é—®é¢˜  
  # æå…¶å®‰å…¨ï¼æ˜¯ä½ ä½¿ç”¨ä¸Šå®Œå…¨æ­£ç¡®çš„å‚æ•°

  --progress 20000 \
  # æ¯è¿ç§» 20000 è¡Œè¾“å‡ºè¿›åº¦  
  # é˜²æ­¢ç»ˆç«¯é•¿æ—¶é—´æ²¡æœ‰è¾“å‡ºä»¥ä¸ºæŒ‚èµ·

  --no-delete \
  # ä¸åˆ é™¤æºè¡¨æ•°æ®  
  # è¿™æ˜¯ä½ å½“å‰ç­–ç•¥æœ€å…³é”®çš„å®‰å…¨ä¿éšœ  
  # è¿ç§»å®Œå¯ä»¥å¤æŸ¥ï¼Œæ»¡æ„åå†æ‰‹åŠ¨æ¸…ç†æºè¡¨æˆ–å½’æ¡£

  --charset utf8 \
  # å¼ºåˆ¶å­—ç¬¦é›†ï¼Œå¦åˆ™ pt-archiver ä¼šæç¤º utf8mb4 unsupportedï¼ˆä½ çš„ç‰ˆæœ¬ç¡®å®ä¸æ”¯æŒ utf8mb4ï¼‰  
  # æŒ‡å®š utf8 = å®‰å…¨ã€å…¼å®¹

  --statistics
  # æœ€ç»ˆè¾“å‡ºæ±‡æ€»ç»Ÿè®¡ï¼šè¿ç§»ç”¨æ—¶ã€select æ¬¡æ•°ã€insert æ¬¡æ•°ã€commit æ¬¡æ•°  
  # ç”¨äºéªŒè¯è¿ç§»å®Œæ•´æ€§
```

| é¡¹ç›®             | è¯„ä»·                                       |
| ---------------- | ------------------------------------------ |
| è¿ç§»å®‰å…¨æ€§       | â­â­â­â­â­ ç»å¯¹å®‰å…¨ï¼Œä¸ä¼šåˆ æºè¡¨ã€ä¸é”å¤§èŒƒå›´è®°å½• |
| è¿ç§»æ€§èƒ½         | â­â­â­â­â­ å•æœºçº¦ 26 ä¸‡è¡Œ/åˆ†é’Ÿï¼Œå¾ˆå¼º            |
| å¯¹åŸè¡¨å½±å“       | â­â­â­â­â­ å‡ ä¹ 0 å½±å“ï¼ˆä¸»é”®èŒƒå›´æ‰«æï¼‰          |
| äº‹åŠ¡é£é™©         | â­â­â­â­â­ ä½ çš„ `--commit-each` åšå¾—éå¸¸å¥½      |
| è¿ç§»åŠ¨ä½œå¯è¿½è¸ªæ€§ | â­â­â­â­â­ `--progress` `--statistics` ä¿¡æ¯å®Œæ•´ |

å±äºçœŸå®ç”Ÿäº§ç¯å¢ƒå¸¸ç”¨çš„ **å®‰å…¨å½’æ¡£è¿ç§»æ–¹æ¡ˆ**ï¼ˆè¡Œçº§æ‹·è´ã€å¼±å½±å“ï¼‰





#### 3.è¿ç§»è¾“å‡º

```bash
TIME                ELAPSED   COUNT
2025-11-25T15:30:30       0       0
2025-11-25T15:30:36       5   20000
2025-11-25T15:30:42      11   40000
2025-11-25T15:30:47      16   60000
...
2025-11-25T18:24:29    3045 13320000
2025-11-25T18:24:34    3050 13340000
2025-11-25T18:24:35    3051 13344002
Started at 2025-11-25T17:33:43, ended at 2025-11-25T18:24:35
Source: A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_trend_202001,u=hli_gho
Dest:   A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_warm,u=hli_gho
SELECT 13344002
INSERT 13344002
DELETE 0
Action         Count       Time        Pct
inserting   13344002  2700.0184      88.49
select          1336    43.8971       1.44
commit          2672    11.8643       0.39
other              0   295.3828       9.68
```



##### å¸¦æ³¨é‡Šç‰ˆæœ¬

```bash
2025-11-25T18:24:25    3041 13300000
# ç¬¬ 3041 æ¬¡è¾“å‡ºè¿›åº¦ï¼Œå…±å®Œæˆ 13,300,000 è¡Œ

2025-11-25T18:24:29    3045 13320000
# 4 ç§’åï¼Œå®Œæˆ 13,320,000 è¡Œï¼ˆæŒç»­ç¨³å®šé€Ÿåº¦ï¼Œæ— æŠ–åŠ¨ï¼‰

2025-11-25T18:24:34    3050 13340000
# å†è¿‡ 5 ç§’ï¼Œè¾¾åˆ° 13,340,000 è¡Œï¼ˆæ¥è¿‘æœ€åä¸€æ‰¹ï¼‰

2025-11-25T18:24:35    3051 13344002
# æœ€åä¸€æ‰¹åªæœ‰ 4002 è¡Œï¼Œä¸æ˜¯æ•´çš„ 10000ï¼Œè¯´æ˜æ•°æ®åˆšå¥½å…¨éƒ¨è¿ç§»å®Œæˆã€‚
# æ­¤æ—¶æ•´ä¸ªæœˆè¡¨ï¼ˆ2020-01ï¼‰å·²ç»å®Œå…¨å†™å…¥æ¸©è¡¨ï¼Œæ— é—æ¼ã€‚

Started at 2025-11-25T17:33:43, ended at 2025-11-25T18:24:35
# æ€»è€—æ—¶çº¦ 50 åˆ†é’Ÿï¼ˆå¤§è¡¨ 1334 ä¸‡è¡Œå±äºæå¿«è¿ç§»é€Ÿåº¦ï¼‰
# å…¨ç¨‹æ— å¡é¡¿ã€æ— è¶…æ—¶ã€æ— é”ç­‰å¾…ã€‚

Source: A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_trend_202001,u=hli_gho
# æºè¡¨ä¿¡æ¯ï¼šè¯»å– tb_quotation_history_trend_202001ï¼ˆæ—§æœˆè¡¨ï¼‰

Dest:   A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_warm,u=hli_gho
# ç›®æ ‡è¡¨ä¿¡æ¯ï¼šå†™å…¥ tb_quotation_history_warmï¼ˆæ¸©æ•°æ®è¡¨ï¼‰

SELECT 13344002
# ä»æ—§è¡¨æˆåŠŸè¯»å– 13,344,002 è¡Œï¼ˆæ•°é‡æ­£ç¡®ï¼‰

INSERT 13344002
# å®Œæ•´å†™å…¥ 13,344,002 è¡Œåˆ°æ¸©è¡¨ â†’ ä¸ SELECT å®Œå…¨ä¸€è‡´
# â˜… è¯æ˜æ— ä¸¢å¤±æ— é‡å¤ â˜…

DELETE 0
# å› ä¸ºä½ ä½¿ç”¨äº† --no-delete ï¼Œæ‰€ä»¥ä¸åˆ é™¤æ—§è¡¨è®°å½•ï¼ˆå®‰å…¨æ“ä½œï¼‰

Action         Count       Time        Pct
# ä¸‹æ–¹æ˜¯æ€§èƒ½ç»Ÿè®¡æ¨¡å—ï¼ˆéå¸¸å…³é”®ï¼‰

inserting   13344002  2700.0184      88.49
# INSERT åŠ¨ä½œè€—æ—¶ 2700 ç§’ï¼Œå  88%
# IO å¯†é›†å‹ä»»åŠ¡ï¼Œå±äºæ­£å¸¸ç°è±¡
# ä¸”è¯´æ˜æ•´ä¸ªè¿‡ç¨‹ç¨³å®šæ‰§è¡Œï¼Œæ²¡æœ‰é•¿æ—¶é—´å µå¡

select          1336    43.8971       1.44
# SELECT åªå  1.44%ï¼Œå› ä¸ºä¸»é”®æ‰«æå¾ˆå¿«ï¼Œæ²¡æœ‰é”å†²çª

commit          2672    11.8643       0.39
# æ¯ 10000 è¡Œä¸€ä¸ª commitï¼ˆä½ ç”¨äº† --commit-eachï¼‰
# commit æˆæœ¬éå¸¸ä½ï¼Œè¯´æ˜ MySQL åç«¯å†™å…¥ä¸å¡

other              0   295.3828       9.68
# other åŒ…å«ï¼šç”Ÿæˆä¸´æ—¶æ–‡ä»¶ã€LOAD DATA LOCALã€å‚æ•°æ£€æŸ¥ç­‰
# æ­£å¸¸å æ¯”ï¼Œæ— å¼‚å¸¸è¡Œä¸º
```





#### 4.éªŒè¯è¿ç§»



##### éªŒè¯åŒºé—´æ•°é‡

```sql
#â‘  ç›®æ ‡åˆ†åŒºæ•°æ®é‡,é¢„æœŸåº”ä¸º 13344002ï¼ˆä½ åŸè¡¨çš„æ•°æ®é‡ï¼‰ã€‚
SELECT COUNT(*) FROM tb_quotation_history_warm
WHERE trade_date >= '2020-01-01' AND trade_date < '2020-02-01';
```



##### éªŒè¯æŒ‡å®šåˆ†åŒºæ•°

```sql
#â‘¡ éªŒè¯åˆ†åŒºæ˜¯å¦è½å¯¹,é¢„æœŸåº”ä¸º 13344002ï¼ˆä½ åŸè¡¨çš„æ•°æ®é‡ï¼‰ã€‚å®˜æ–¹æ¨èçš„åˆ†åŒºè®¡æ•°æ–¹æ³•
SELECT COUNT(*)
FROM tb_quotation_history_warm PARTITION (p202001);
```





##### æŠ½æ ·éªŒè¯

```sql
#â‘¢ éªŒè¯å†…å®¹ä¸€è‡´æ€§ï¼ˆæŠ½æ ·æ£€æŸ¥ï¼‰
SELECT wind_code, trade_date
FROM tb_quotation_history_trend_202001
ORDER BY RAND()
LIMIT 10;
```



```sql
#å¦‚æœ 8 ä¸ªå­—æ®µå®Œå…¨ä¸€è‡´ â†’ æ•°æ®è¿ç§»æ­£ç¡®ã€‚
SELECT 
    'SOURCE' AS from_table,
    t1.*
FROM tb_quotation_history_trend_202001 t1
WHERE (t1.wind_code, t1.trade_date) IN (
    ('300409.SZ', '2020-01-13 10:06:57'),
    ('601989.SH', '2020-01-10 09:55:57'),
    ('603356.SH', '2020-01-17 10:07:32'),
    ('300301.SZ', '2020-01-17 14:29:27'),
    ('603320.SH', '2020-01-16 13:44:55'),
    ('000809.SZ', '2020-01-07 09:25:03'),
    ('300663.SZ', '2020-01-14 14:11:57'),
    ('002475.SZ', '2020-01-07 11:18:57'),
    ('002581.SZ', '2020-01-16 11:29:54'),
    ('600266.SH', '2020-01-09 14:50:58')
)

UNION ALL

SELECT 
    'WARM' AS from_table,
    t2.*
FROM tb_quotation_history_warm t2
WHERE (t2.wind_code, t2.trade_date) IN (
    ('300409.SZ', '2020-01-13 10:06:57'),
    ('601989.SH', '2020-01-10 09:55:57'),
    ('603356.SH', '2020-01-17 10:07:32'),
    ('300301.SZ', '2020-01-17 14:29:27'),
    ('603320.SH', '2020-01-16 13:44:55'),
    ('000809.SZ', '2020-01-07 09:25:03'),
    ('300663.SZ', '2020-01-14 14:11:57'),
    ('002475.SZ', '2020-01-07 11:18:57'),
    ('002581.SZ', '2020-01-16 11:29:54'),
    ('600266.SH', '2020-01-09 14:50:58')
);
```





#### 5.ç»§ç»­å‰©ä½™è¿ç§»



##### ç»Ÿä¸€æ–°å¢ç©ºidå­—æ®µå¯¹åº”è¡¨å­—æ®µä¸€è‡´

```sql
ALTER TABLE tb_quotation_history_trend_202002
ADD COLUMN id BIGINT UNSIGNED NULL;
```



##### 2020

###### 202002

>ä¿®æ”¹tb_quotation_history_trend_202002
>
>ä¿®æ”¹trade_date >= '2020-02-01' AND trade_date < '2020-03-01

```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202002,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-02-01' AND trade_date < '2020-03-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```



```bash
2025-11-25T20:52:01    3993 16775737
Started at 2025-11-25T19:45:27, ended at 2025-11-25T20:52:01
Source: A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_trend_202002,u=hli_gho
Dest:   A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_warm,u=hli_gho
SELECT 16775737
INSERT 16775737
DELETE 0
Action         Count       Time        Pct
inserting   16775737  3564.2174      89.25
select          1679    52.2721       1.31
commit          3358    16.3642       0.41
other              0   360.5891       9.03
```







###### 202003

```sql
ALTER TABLE tb_quotation_history_trend_202003
ADD COLUMN id BIGINT UNSIGNED NULL;
```



```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202003,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-03-01' AND trade_date < '2020-04-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```



```bash
2025-11-26T10:48:20    4188 18700000
2025-11-26T10:48:21    4189 18703423
Started at 2025-11-26T09:38:31, ended at 2025-11-26T10:48:21
Source: A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_trend_202003,u=hli_gho
Dest:   A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_warm,u=hli_gho
SELECT 18703423
INSERT 18703423
DELETE 0
Action         Count       Time        Pct
inserting   18703423  3727.4999      88.97
select          1872    57.4741       1.37
commit          3744    18.0014       0.43
other              0   386.4501       9.22
```





###### 202004

```sql
ALTER TABLE tb_quotation_history_trend_202004
ADD COLUMN id BIGINT UNSIGNED NULL;
```



```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202004,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-04-01' AND trade_date < '2020-05-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```



```bash
2025-11-26T12:21:22    3951 17660000
2025-11-26T12:21:26    3955 17680000
2025-11-26T12:21:29    3958 17694991
Started at 2025-11-26T11:15:31, ended at 2025-11-26T12:21:29
Source: A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_trend_202004,u=hli_gho
Dest:   A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_warm,u=hli_gho
SELECT 17694991
INSERT 17694991
DELETE 0
Action         Count       Time        Pct
inserting   17694991  3521.1224      88.96
select          1771    58.9093       1.49
commit          3542    16.3475       0.41
other              0   361.8317       9.14
```









###### 202005

```sql
ALTER TABLE tb_quotation_history_trend_202005
ADD COLUMN id BIGINT UNSIGNED NULL;
```

```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202005,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-05-01' AND trade_date < '2020-06-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```



```bash
2025-11-26T14:02:49    3485 15100000
2025-11-26T14:02:54    3489 15120000
2025-11-26T14:02:58    3493 15137650
Started at 2025-11-26T13:04:44, ended at 2025-11-26T14:02:58
Source: A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_trend_202005,u=hli_gho
Dest:   A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_warm,u=hli_gho
SELECT 15137650
INSERT 15137650
DELETE 0
Action         Count       Time        Pct
inserting   15137650  3098.8891      88.69
select          1515    52.6052       1.51
commit          3030    15.3802       0.44
other              0   327.0602       9.36
```









###### 202006

```sql
ALTER TABLE tb_quotation_history_trend_202006
ADD COLUMN id BIGINT UNSIGNED NULL;
```



```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202006,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-06-01' AND trade_date < '2020-07-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```

```bash
2025-11-26T15:31:01    3878 17040000
2025-11-26T15:31:02    3879 17044305
Started at 2025-11-26T14:26:23, ended at 2025-11-26T15:31:02
Source: A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_trend_202006,u=hli_gho
Dest:   A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_warm,u=hli_gho
SELECT 17044305
INSERT 17044305
DELETE 0
Action         Count       Time        Pct
inserting   17044305  3473.6490      89.54
select          1706    51.1215       1.32
commit          3412    15.9157       0.41
other              0   338.6275       8.73
hli@hli:~$
```





###### 202007

```sql
ALTER TABLE tb_quotation_history_trend_202007
ADD COLUMN id BIGINT UNSIGNED NULL;
```

```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202007,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-07-01' AND trade_date < '2020-08-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```

```bash
2025-11-26T18:00:36    4893 20300000
2025-11-26T18:00:41    4898 20320000
2025-11-26T18:00:43    4900 20327555
Started at 2025-11-26T16:39:02, ended at 2025-11-26T18:00:43
Source: A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_trend_202007,u=hli_gho
Dest:   A=utf8,D=a_share_quant,P=3306,h=10.100.225.7,p=...,t=tb_quotation_history_warm,u=hli_gho
SELECT 20327555
INSERT 20327555
DELETE 0
Action         Count       Time        Pct
inserting   20327555  4382.8504      89.44
select          2034    61.4133       1.25
commit          4068    22.6237       0.46
other              0   433.4679       8.85
```



###### 202008

```sql
ALTER TABLE tb_quotation_history_trend_202008
ADD COLUMN id BIGINT UNSIGNED NULL;
```



```bash
pt-archiver \
  --source h=192.168.168.57,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202008,u=hli_gho,p=Q836184425 \
  --dest   h=192.168.168.57,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-08-01' AND trade_date < '2020-09-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```



###### 202009

```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202009,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-09-01' AND trade_date < '2020-10-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```



###### 202010

```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202010,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-10-01' AND trade_date < '2020-11-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```





###### 202011

```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202011,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-11-01' AND trade_date < '2020-12-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```



###### 202012

```bash
pt-archiver \
  --source h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_trend_202012,u=hli_gho,p=Q836184425 \
  --dest   h=10.100.225.7,P=3306,D=a_share_quant,t=tb_quotation_history_warm,u=hli_gho,p=Q836184425 \
  --columns wind_code,trade_date,latest_price,total_volume,average_price,status,create_time,update_time,id \
  --where "trade_date >= '2020-12-01' AND trade_date < '2021-01-01'" \
  --limit 10000 \
  --commit-each \
  --progress 20000 \
  --no-delete \
  --charset utf8 \
  --statistics
```



##### 2021





