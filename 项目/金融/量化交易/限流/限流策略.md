# 互联网大厂限流方案设计

## 一、整体架构（三层防御）

```
网关层（粗粒度）→ 服务层集群限流（精细化）→ 单机兜底（容灾）
```

**核心亮点**：多维度 + 动态配置 + 故障自愈

------

## 二、限流维度设计（体现业务理解）

### 2.1 四大维度组合

- **全局维度**：`rl:global` - 集群总 QPS 上限
- **接口维度**：`rl:uri:/api/strategy/execute` - 按 API 粒度
- **调用方维度**：`rl:user:{userId}` - 防单用户打爆
- **业务热点维度**：`rl:strategy:{strategyId}` / `rl:stock:{code}` - 防热点击穿

### 2.2 为什么这样设计

- 量化交易场景：策略回测、股票查询是高频热点
- 保护核心依赖：MySQL/Redis/策略引擎
- 目标：**宁可慢而稳，不要雪崩**

------

## 三、技术方案（分层讲清楚）

### 第一层：网关限流（Spring Cloud Gateway + Sentinel）

- **职责**：IP 级拦截、恶意流量过滤
- **算法**：滑动窗口 + 自适应降级
- **策略**：对外接口严格，内部调用宽松

### 第二层：集群限流（Redis + Lua）

**核心方案**：

- 用 Redis 做分布式计数器，Lua 保证原子性
- 支持固定窗口/滑动窗口切换
- 多维度 key 组合检查（串行拦截）

**伪代码逻辑**：

```
1. 检查 rl:global → 不通过直接拒绝
2. 检查 rl:uri:{path} → 不通过拒绝
3. 检查 rl:user:{id} → 不通过拒绝
4. 检查 rl:strategy:{id} → 不通过拒绝
5. 全部通过 → 放行
```

**容量规划**：

- Redis 集群水平扩展
- 单次限流判断 < 5ms

### 第三层：本地兜底（Guava RateLimiter）

**触发场景**：

- Redis 超时/宕机
- 网络抖动导致延迟飙升

**降级策略**：

- 熔断检测：连续 N 次 Redis 失败 → 开启降级
- 降级期间：只走本地令牌桶（每台机器独立限流）
- 恢复探测：后台线程定期检测 Redis 健康度

**关键优势**：限流本身不是单点

------

## 四、业务场景结合（这是加分项）

### 场景 1：策略引擎防刷

- **问题**：某个热门策略被疯狂回测

- 方案

  ：

  - `rl:strategy:{id}` 限制单策略 QPS
  - 超限后返回缓存结果或排队提示
  - Kafka 异步记录限流事件做风控分析

### 场景 2：股票列表保护

- **问题**：MySQL 被稳定股票查询打爆

- 方案

  ：

  - 限流 + 多级缓存 + 布隆过滤器组合拳
  - 按交易日维度限流：`rl:tradeDate:20250521`
  - 限流拦截在缓存之前，减轻后端压力

------

## 五、动态配置 + 可观测性（体现工程能力）

### 5.1 Nacos 动态配置

```yaml
rate-limit:
  global: 2000
  uri:
    /api/strategy/execute: 500
  strategy:
    dragonTwo: 100
  user-default: 50
```

- 配置变更 → 服务实时感知 → 热更新阈值
- 支持灰度：按集群/机器标签分批下发

### 5.2 Prometheus 监控

**核心指标**：

- `requests_total{uri, result}` - 总请求数
- `requests_blocked_total{dimension}` - 被限流数
- `redis_limiter_latency_ms` - Redis 限流耗时
- `local_fallback_active` - 降级状态

**告警规则**：

- 限流率 > 20% 持续 5min → 可能攻击或配置过严
- Redis 失败率 > 10% → 触发降级告警

### 5.3 压测验证

- JMeter 模拟 10000 QPS 打入
- 对比三组数据：无限流 vs 集群限流 vs 降级限流
- 验证：RT P99 < 200ms，错误率 < 0.1%

------

## 六、面试回答框架（30 秒电梯演讲）

> "我的限流方案是三层架构：网关粗过滤、Redis 集群精细限流、本地令牌桶兜底。
>
> 维度上做了全局、接口、用户、业务热点四个层级，用 Lua 保证原子性。
>
> 核心亮点有三个：
>
> 1. **多维度组合**：能精准控制热点策略和股票的流量
> 2. **故障自愈**：Redis 挂了自动降级到本地限流，不裸奔
> 3. **动态可调**：Nacos 配置实时生效，配合 Prometheus 监控形成闭环
>
> 在我们的量化交易项目里，这套方案保护了策略引擎和 MySQL，限流后 P99 延迟从 800ms 降到 150ms。"

------

## 七、追问准备（面试官可能会问）

1. **为什么不用令牌桶做集群限流？**
   - 答：分布式令牌桶需要中心化调度，复杂度高；固定窗口+滑动窗口已满足 99% 场景
2. **Redis 限流的 QPS 瓶颈在哪？**
   - 答：单个 Redis 节点 10w+ QPS，集群可水平扩展；若还不够，可用本地预分配令牌减少 Redis 调用
3. **如何防止恶意用户频繁切换账号绕过限流？**
   - 答：加 IP 维度限流 + 设备指纹 + 行为风控模型
4. **限流和熔断的区别？**
   - 答：限流是"进水阀"控流量，熔断是"漏电保护"防故障扩散；两者配合使用

------

**这套方案的优势**：既有理论深度（算法选型），又有工程落地（监控/降级），还结合了你的业务场景（量化交易），面试官会觉得你是真正解决过生产问题的人。