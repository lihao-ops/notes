# çº¿ç¨‹æ± 



## ä¸€ã€å®æµ‹é…ç½®





>å‚è€ƒæ­£å¼çº¿ç¨‹æ± é…ç½®

### 1.çº¿ç¨‹æ± é…ç½®ä¼˜åŒ–æ–¹æ¡ˆ

#### æœ€ç»ˆé…ç½®å®ç°
```java
    //CPUæ ¸æ•°12,å®æµ‹æœ€ä¼˜é…ç½®51
    //CPUæ ¸æ•°24,å®æµ‹æœ€ä¼˜é…ç½®102
    //todo å®æµ‹æ¨æµ‹,è´´åˆIOå¯†é›†,è°ƒç”¨æ•°æ®åº“æœ€ä¼˜
    @Bean("dataBaseLocalExecutor")
    public ThreadPoolTaskExecutor taskDataBaseLocalExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();

        // æ ¸å¿ƒå‚æ•°é…ç½®ï¼ˆåŸºäºæ€§èƒ½æµ‹è¯•ä¼˜åŒ–ï¼‰
        executor.setCorePoolSize(102);      // åŸºå‡†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆ24æ ¸Ã—4.25å€ï¼‰
        executor.setMaxPoolSize(120);       // å¼¹æ€§ä¸Šé™ï¼ˆé¿å¼€æ€§èƒ½æ–­å´–ç‚¹ï¼‰
        executor.setQueueCapacity(200);     // ç¼“å†²é˜Ÿåˆ—ï¼ˆé¿å…ç›´æ¥æ‹’ç»ï¼‰
        executor.setKeepAliveSeconds(120);  // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼ˆå¹³è¡¡èµ„æºå¼€é”€ï¼‰
        executor.setThreadNamePrefix("ai-service-");
        // æ‹’ç»ç­–ç•¥ä¸ä¼˜é›…åœæœº
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.setWaitForTasksToCompleteOnShutdown(true);
        executor.setAwaitTerminationSeconds(180);
        // èµ„æºä¼˜åŒ–é…ç½®
        executor.setAllowCoreThreadTimeOut(true);  // å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶å›æ”¶
        executor.initialize();
        return executor;
    }
```

#### é…ç½®åˆç†æ€§åˆ†æ

##### âœ… æ­£ç¡®é…ç½®é¡¹
| å‚æ•°                 | å€¼   | è®¾è®¡ä¾æ®                                               |
| -------------------- | ---- | ------------------------------------------------------ |
| **corePoolSize**     | 102  | åŸºäº24æ ¸Ã—4.25å€æ¯”ä¾‹ï¼ˆæ€§èƒ½æµ‹è¯•æœ€ä¼˜å€¼ï¼‰                  |
| **maxPoolSize**      | 120  | é¢„ç•™18%å¼¹æ€§ç©ºé—´ï¼ˆ<æ€§èƒ½æ–­å´–ç‚¹52çº¿ç¨‹çš„230%ï¼‰             |
| **queueCapacity**    | 200  | å°ç¼“å†²é˜Ÿåˆ—ï¼ˆé¿å…OOMåŒæ—¶å¹³æ»‘æµé‡æ³¢åŠ¨ï¼‰                  |
| **CallerRunsPolicy** | -    | ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µï¼ˆè§¦å‘æ—¶ç”±è°ƒç”¨çº¿ç¨‹æ‰§è¡Œï¼Œé¿å…æœåŠ¡é›ªå´©ï¼‰ |
| **allowCoreTimeout** | true | æé«˜èµ„æºåˆ©ç”¨ç‡ï¼ˆä½å³°æœŸå›æ”¶æ ¸å¿ƒçº¿ç¨‹ï¼‰                   |

##### âš ï¸ éœ€æ³¨æ„äº‹é¡¹
1. **æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶å›æ”¶é£é™©**  
   ```java
   executor.setAllowCoreThreadTimeOut(true);
   ```
   - **ä¼˜ç‚¹**ï¼šä½æµé‡æ—¶æ®µèŠ‚çœèµ„æº  
   - **é£é™©**ï¼šçªå‘è¯·æ±‚éœ€é‡æ–°åˆ›å»ºçº¿ç¨‹ï¼ˆå¢åŠ å»¶è¿Ÿï¼‰  
   - **å»ºè®®**ï¼šæµé‡ç¨³å®šåœºæ™¯è®¾ä¸º`false`ä¿æŒé¢„çƒ­

2. **é˜Ÿåˆ—å®¹é‡æƒè¡¡**  
   - 200å®¹é‡åœ¨102æ ¸å¿ƒçº¿ç¨‹ä¸‹ â‰ˆ **2ç§’ç¼“å†²**ï¼ˆæŒ‰50ms/ä»»åŠ¡è®¡ç®—ï¼‰  
   - éœ€ç›‘æ§é˜Ÿåˆ—å †ç§¯æƒ…å†µï¼Œé˜²æ­¢é•¿æ—¶é—´ç§¯å‹

#### ç”Ÿäº§ç¯å¢ƒå¢å¼ºå»ºè®®

##### 1. åŠ¨æ€å‚æ•°è°ƒæ•´ï¼ˆSpring Cloudé…ç½®ä¸­å¿ƒï¼‰
```java
// æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´
@RefreshScope
@Bean("taskExecutor")
public ThreadPoolTaskExecutor executor(
    @Value("${thread.pool.core:102}") int core,
    @Value("${thread.pool.max:120}") int max) {
    //...
}
```

##### 2. ç›‘æ§åŸ‹ç‚¹ï¼ˆMicrometerå®ç°ï¼‰
```java
executor.setTaskDecorator(task -> {
    // è®°å½•ä»»åŠ¡å¼€å§‹æ—¶é—´
    long start = System.currentTimeMillis();
    return () -> {
        try {
            task.run();
        } finally {
            // ä¸ŠæŠ¥ä»»åŠ¡è€—æ—¶
            metrics.record(System.currentTimeMillis() - start);
        }
    };
});
```

##### 3. å¥åº·æ£€æŸ¥ç«¯ç‚¹
```java
@RestController
public class PoolHealthController {
    
    @Autowired
    private ThreadPoolTaskExecutor executor;
    
    @GetMapping("/health/threadpool")
    public Map<String, Object> poolHealth() {
        return Map.of(
            "active", executor.getActiveCount(),
            "queue", executor.getThreadPoolExecutor().getQueue().size(),
            "completed", executor.getThreadPoolExecutor().getCompletedTaskCount()
        );
    }
}
```

#### é…ç½®ä¼˜åŒ–å¯¹æ¯”è¡¨
| å‚æ•°             | åˆå§‹é…ç½® | é£é™©ç‚¹     | ä¼˜åŒ–æ–¹æ¡ˆ             |
| ---------------- | -------- | ---------- | -------------------- |
| **æœ€å¤§çº¿ç¨‹æ•°**   | âˆ        | èµ„æºè€—å°½   | è®¾ç½®120ä¸Šé™          |
| **é˜Ÿåˆ—ç±»å‹**     | æ— ç•Œé˜Ÿåˆ— | OOMé£é™©    | æœ‰ç•Œé˜Ÿåˆ—(200)        |
| **æ ¸å¿ƒçº¿ç¨‹å›æ”¶** | æ°¸ä¸å›æ”¶ | èµ„æºæµªè´¹   | å…è®¸è¶…æ—¶å›æ”¶         |
| **æ‹’ç»ç­–ç•¥**     | Abort    | ä»»åŠ¡ä¸¢å¤±   | CallerRunsPolicyé™çº§ |
| **åœæœºç­–ç•¥**     | ç«‹å³åœæ­¢ | æ•°æ®ä¸ä¸€è‡´ | ç­‰å¾…180ç§’ä¼˜é›…å…³é—­    |

> **é…ç½®æ€»ç»“**ï¼šå½“å‰é…ç½®æ–¹æ¡ˆåœ¨æ€§èƒ½ã€èµ„æºåˆ©ç”¨å’Œç¨³å®šæ€§ä¹‹é—´å–å¾—è‰¯å¥½å¹³è¡¡ï¼Œç¬¦åˆI/Oå¯†é›†å‹AIæœåŠ¡çš„éœ€æ±‚ã€‚å»ºè®®é…åˆç›‘æ§ç³»ç»ŸæŒç»­è§‚å¯Ÿæ ¸å¿ƒæŒ‡æ ‡ï¼š`æ´»è·ƒçº¿ç¨‹æ•° > 100æŒç»­5åˆ†é’Ÿ`æ—¶åº”è€ƒè™‘æ‰©å®¹ã€‚



---





### åŸºäºæµ‹è¯•ç»“æœçš„æœ€ä¼˜çº¿ç¨‹æ± é…ç½®


æ ¹æ®æ‚¨çš„æ€§èƒ½æµ‹è¯•ç»“æœï¼ˆ51çº¿ç¨‹ä¸ºæœ€ä¼˜ç‚¹ï¼‰ï¼Œä»¥ä¸‹æ˜¯è´¨é‡æœ€é«˜çš„é…ç½®ä»£ç ï¼š

```java
    //CPUæ ¸æ•°12,å®æµ‹æœ€ä¼˜é…ç½®
    @Bean("taskExecutor")
    public ThreadPoolTaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šåŸºäºæµ‹è¯•ç»“æœçš„æœ€ä¼˜å€¼
        executor.setCorePoolSize(51);
        // æœ€å¤§çº¿ç¨‹æ•°ï¼šé¢„ç•™å¼¹æ€§ç©ºé—´ï¼Œä½†ä¸è¶…è¿‡æ€§èƒ½æ–­å´–ç‚¹
        executor.setMaxPoolSize(60);
        // é˜Ÿåˆ—å®¹é‡ï¼šå°å®¹é‡ç¼“å†²ï¼Œé¿å…ä»»åŠ¡å †ç§¯
        executor.setQueueCapacity(100);
        // çº¿ç¨‹ç©ºé—²æ—¶é—´ï¼šé€‚å½“å»¶é•¿ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºé”€æ¯å¼€é”€
        executor.setKeepAliveSeconds(120);
        // çº¿ç¨‹åå‰ç¼€ï¼šä¾¿äºç›‘æ§å’Œè°ƒè¯•
        executor.setThreadNamePrefix("ai-service-");
        // æ‹’ç»ç­–ç•¥ï¼šæ™ºèƒ½é™çº§å¤„ç†
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        // ä¼˜é›…å…³é—­é…ç½®
        executor.setWaitForTasksToCompleteOnShutdown(true);
        executor.setAwaitTerminationSeconds(180);
        // å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡
        executor.setAllowCoreThreadTimeOut(true);
        // åˆå§‹åŒ–çº¿ç¨‹æ± 
        executor.initialize();
        return executor;
    }
```


> é…ç½®ä¼˜åŒ–è¯´æ˜


1. æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆ51ï¼‰ï¼šåŸºäºæ€§èƒ½æµ‹è¯•çš„æœ€ä¼˜å€¼ç¡®ä¿å¸¸é©»çº¿ç¨‹æ•°è¾¾åˆ°æœ€ä½³æ€§èƒ½ç‚¹


2. æœ€å¤§çº¿ç¨‹æ•°ï¼ˆ60ï¼‰ï¼šé¢„ç•™9ä¸ªçº¿ç¨‹çš„å¼¹æ€§ç©ºé—´é¿å…è¾¾åˆ°52çº¿ç¨‹çš„æ€§èƒ½æ–­å´–ç‚¹


3. é˜Ÿåˆ—å®¹é‡ï¼ˆ100ï¼‰ï¼šæä¾›é€‚åº¦ç¼“å†²ï¼Œå¹³æ»‘æµé‡æ³¢åŠ¨é¿å…è¿‡å¤§é˜Ÿåˆ—å¯¼è‡´ä»»åŠ¡å †ç§¯


4. ç©ºé—²æ—¶é—´ï¼ˆ120ç§’ï¼‰ï¼šå»¶é•¿çº¿ç¨‹å­˜æ´»æ—¶é—´å‡å°‘é¢‘ç¹åˆ›å»ºé”€æ¯çš„å¼€é”€


5. æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼ˆtrueï¼‰ï¼šå…è®¸æ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²æ—¶å›æ”¶æé«˜èµ„æºåˆ©ç”¨æ•ˆç‡

> æ€§èƒ½é¢„æœŸ

æœ€ä¼˜åœºæ™¯ï¼š5.2ç§’å®Œæˆ5200ä¸ªä»»åŠ¡

å¼¹æ€§å¤„ç†ï¼šæµé‡å³°å€¼æ—¶è‡ªåŠ¨æ‰©å®¹è‡³60çº¿ç¨‹

èµ„æºæ•ˆç‡ï¼šç©ºé—²æ—¶è‡ªåŠ¨æ”¶ç¼©ï¼ŒèŠ‚çº¦ç³»ç»Ÿèµ„æº


è¿™ä¸ªé…ç½®æ—¢ä¿è¯äº†æœ€ä½³æ€§èƒ½ï¼Œåˆå…·å¤‡è‰¯å¥½çš„å¼¹æ€§å’Œèµ„æºç®¡ç†èƒ½åŠ›ã€‚









## äºŒã€æ‹’ç»ç­–ç•¥ï¼ˆRejectedExecutionHandlerï¼‰

### å››ç§æ ‡å‡†æ‹’ç»ç­–ç•¥

#### 1. CallerRunsPolicyï¼ˆè°ƒç”¨è€…è¿è¡Œç­–ç•¥ï¼‰
```java
executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
```
- **æœºåˆ¶**ï¼šç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹ç›´æ¥æ‰§è¡Œè¢«æ‹’ç»çš„ä»»åŠ¡
- **ä¼˜ç‚¹**ï¼šä¸ä¼šä¸¢å¤±ä»»åŠ¡ï¼Œæä¾›è‡ªç„¶çš„èƒŒå‹æœºåˆ¶
- **ç¼ºç‚¹**ï¼šå¯èƒ½é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œå½±å“æäº¤é€Ÿåº¦
- **é€‚ç”¨åœºæ™¯**ï¼šä»»åŠ¡ä¸èƒ½ä¸¢å¤±ï¼Œå¯ä»¥å®¹å¿è°ƒç”¨çº¿ç¨‹é˜»å¡

#### 2. AbortPolicyï¼ˆä¸­æ­¢ç­–ç•¥ï¼‰- é»˜è®¤ç­–ç•¥
```java
executor.setRejectedExecutionHandler(new ThreadPoolExecutor.AbortPolicy());
```
- **æœºåˆ¶**ï¼šç›´æ¥æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸
- **ä¼˜ç‚¹**ï¼šå¿«é€Ÿå¤±è´¥ï¼Œä¾¿äºå‘ç°é—®é¢˜
- **ç¼ºç‚¹**ï¼šä»»åŠ¡ä¼šä¸¢å¤±ï¼Œéœ€è¦å¼‚å¸¸å¤„ç†
- **é€‚ç”¨åœºæ™¯**ï¼šä¸¥æ ¼æ§åˆ¶èµ„æºä½¿ç”¨ï¼Œå¯ä»¥æ¥å—ä»»åŠ¡ä¸¢å¤±

#### 3. DiscardPolicyï¼ˆä¸¢å¼ƒç­–ç•¥ï¼‰
```java
executor.setRejectedExecutionHandler(new ThreadPoolExecutor.DiscardPolicy());
```
- **æœºåˆ¶**ï¼šé™é»˜ä¸¢å¼ƒè¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œä¸æŠ›å¼‚å¸¸
- **ä¼˜ç‚¹**ï¼šä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œä¸ä¼šæŠ›å¼‚å¸¸
- **ç¼ºç‚¹**ï¼šä»»åŠ¡é™é»˜ä¸¢å¤±ï¼Œéš¾ä»¥å‘ç°é—®é¢˜
- **é€‚ç”¨åœºæ™¯**ï¼šå¯¹ä»»åŠ¡ä¸¢å¤±ä¸æ•æ„Ÿçš„åœºæ™¯

#### 4. DiscardOldestPolicyï¼ˆä¸¢å¼ƒæœ€è€ç­–ç•¥ï¼‰
```java
executor.setRejectedExecutionHandler(new ThreadPoolExecutor.DiscardOldestPolicy());
```
- **æœºåˆ¶**ï¼šä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°æäº¤å½“å‰ä»»åŠ¡
- **ä¼˜ç‚¹**ï¼šä¿è¯æœ€æ–°ä»»åŠ¡å¾—åˆ°å¤„ç†
- **ç¼ºç‚¹**ï¼šè€ä»»åŠ¡ä¼šä¸¢å¤±ï¼Œå¯èƒ½ç ´åä»»åŠ¡é¡ºåº
- **é€‚ç”¨åœºæ™¯**ï¼šä¼˜å…ˆå¤„ç†æœ€æ–°ä»»åŠ¡çš„åœºæ™¯

### è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥

#### è®°å½•æ—¥å¿—ç­–ç•¥
```java
executor.setRejectedExecutionHandler((r, executor) -> {
    log.warn("ä»»åŠ¡è¢«æ‹’ç»æ‰§è¡Œ: {}, çº¿ç¨‹æ± çŠ¶æ€: {}", r.toString(), executor.toString());
    // å¯ä»¥é€‰æ‹©å…¶ä»–å¤„ç†æ–¹å¼
});
```

#### é™çº§å¤„ç†ç­–ç•¥
```java
executor.setRejectedExecutionHandler((r, executor) -> {
    // é™çº§åˆ°å¤‡ç”¨å¤„ç†æ–¹å¼
    fallbackService.handleTask(r);
    log.info("ä»»åŠ¡å·²é™çº§å¤„ç†");
});
```

### ç­–ç•¥é€‰æ‹©å»ºè®®
- **é«˜å¯é æ€§åœºæ™¯**ï¼šä½¿ç”¨CallerRunsPolicy
- **å¿«é€Ÿå¤±è´¥åœºæ™¯**ï¼šä½¿ç”¨AbortPolicyï¼ˆé»˜è®¤ï¼‰
- **å…è®¸ä¸¢å¤±åœºæ™¯**ï¼šä½¿ç”¨DiscardPolicy
- **å®æ—¶æ€§ä¼˜å…ˆåœºæ™¯**ï¼šä½¿ç”¨DiscardOldestPolicy
- **å¤æ‚ä¸šåŠ¡åœºæ™¯**ï¼šè‡ªå®šä¹‰æ‹’ç»ç­–ç•¥

## ä¸‰ã€é˜Ÿåˆ—ç±»å‹ï¼ˆBlockingQueueï¼‰

### ä¸‰å¤§ä¸»è¦é˜Ÿåˆ—ç±»å‹

#### 1. æœ‰ç•Œé˜Ÿåˆ—ï¼ˆBounded Queueï¼‰
```java
// ArrayBlockingQueue - æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—
executor.setQueueCapacity(1000); // SpringBooté»˜è®¤ä½¿ç”¨LinkedBlockingQueue

// æ‰‹åŠ¨æŒ‡å®šArrayBlockingQueue
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    coreSize, maxSize, keepAlive, TimeUnit.SECONDS,
    new ArrayBlockingQueue<>(1000)
);
```
- **ç‰¹ç‚¹**ï¼šå›ºå®šå®¹é‡ï¼Œè¶…å‡ºå®¹é‡è§¦å‘æ‹’ç»ç­–ç•¥
- **ä¼˜ç‚¹**ï¼šå†…å­˜å¯æ§ï¼Œé˜²æ­¢OOM
- **ç¼ºç‚¹**ï¼šå¯èƒ½é¢‘ç¹è§¦å‘æ‹’ç»ç­–ç•¥
- **é€‚ç”¨åœºæ™¯**ï¼šå†…å­˜æ•æ„Ÿï¼Œéœ€è¦ä¸¥æ ¼æ§åˆ¶é˜Ÿåˆ—å¤§å°

#### 2. æ— ç•Œé˜Ÿåˆ—ï¼ˆUnbounded Queueï¼‰
```java
// LinkedBlockingQueue - é“¾è¡¨å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    coreSize, maxSize, keepAlive, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>() // æ— å‚æ„é€ ä¸ºæ— ç•Œ
);
```
- **ç‰¹ç‚¹**ï¼šç†è®ºä¸Šæ— é™å®¹é‡ï¼ˆå®é™…å—å†…å­˜é™åˆ¶ï¼‰
- **ä¼˜ç‚¹**ï¼šä»»åŠ¡ä¸ä¼šè¢«æ‹’ç»ï¼ŒmaxPoolSizeå¤±æ•ˆ
- **ç¼ºç‚¹**ï¼šå¯èƒ½å¯¼è‡´OOMï¼Œä»»åŠ¡å †ç§¯
- **é€‚ç”¨åœºæ™¯**ï¼šä»»åŠ¡ä¸èƒ½ä¸¢å¤±ï¼Œå†…å­˜å……è¶³

#### 3. ç›´æ¥äº¤æ¥é˜Ÿåˆ—ï¼ˆDirect Handoffï¼‰
```java
// SynchronousQueue - é›¶å®¹é‡åŒæ­¥é˜Ÿåˆ—
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    coreSize, maxSize, keepAlive, TimeUnit.SECONDS,
    new SynchronousQueue<>()
);

// SpringBootä¸­è®¾ç½®é˜Ÿåˆ—å®¹é‡ä¸º0å®ç°ç±»ä¼¼æ•ˆæœ
executor.setQueueCapacity(0);
```
- **ç‰¹ç‚¹**ï¼šä¸å­˜å‚¨ä»»åŠ¡ï¼Œç›´æ¥å°†ä»»åŠ¡äº¤ç»™çº¿ç¨‹
- **ä¼˜ç‚¹**ï¼šå¿«é€Ÿå“åº”ï¼Œé¿å…ä»»åŠ¡å †ç§¯
- **ç¼ºç‚¹**ï¼šå®¹æ˜“è§¦å‘æ‹’ç»ç­–ç•¥
- **é€‚ç”¨åœºæ™¯**ï¼šè¦æ±‚å¿«é€Ÿå¤„ç†ï¼Œä¸å…è®¸æ’é˜Ÿ

### å…¶ä»–ç‰¹æ®Šé˜Ÿåˆ—ç±»å‹

#### 4. ä¼˜å…ˆçº§é˜Ÿåˆ—
```java
// PriorityBlockingQueue - ä¼˜å…ˆçº§æ— ç•Œé˜»å¡é˜Ÿåˆ—
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    coreSize, maxSize, keepAlive, TimeUnit.SECONDS,
    new PriorityBlockingQueue<>()
);
```
- **ç‰¹ç‚¹**ï¼šæŒ‰ä¼˜å…ˆçº§å¤„ç†ä»»åŠ¡
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦ä»»åŠ¡ä¼˜å…ˆçº§æ’åº

#### 5. å»¶è¿Ÿé˜Ÿåˆ—
```java
// DelayQueue - å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    coreSize, maxSize, keepAlive, TimeUnit.SECONDS,
    new DelayQueue<>()
);
```
- **ç‰¹ç‚¹**ï¼šä»»åŠ¡åˆ°è¾¾æŒ‡å®šæ—¶é—´æ‰èƒ½è¢«å–å‡º
- **é€‚ç”¨åœºæ™¯**ï¼šå®šæ—¶ä»»åŠ¡ï¼Œå»¶è¿Ÿæ‰§è¡Œ

### SpringBootä¸­çš„é˜Ÿåˆ—é…ç½®
```java
executor.setQueueCapacity(100); // æœ‰ç•ŒLinkedBlockingQueue
executor.setQueueCapacity(0);   // ç±»ä¼¼SynchronousQueueæ•ˆæœ
// ä¸è®¾ç½®queueCapacity        // æ— ç•ŒLinkedBlockingQueue
```

### é˜Ÿåˆ—é€‰æ‹©å»ºè®®
- **å†…å­˜æœ‰é™**ï¼šé€‰æ‹©æœ‰ç•Œé˜Ÿåˆ—ï¼ˆArrayBlockingQueueï¼‰
- **ä»»åŠ¡ä¸èƒ½ä¸¢å¤±**ï¼šé€‰æ‹©æ— ç•Œé˜Ÿåˆ—ï¼ˆLinkedBlockingQueueï¼‰
- **è¦æ±‚å¿«é€Ÿå“åº”**ï¼šé€‰æ‹©ç›´æ¥äº¤æ¥ï¼ˆSynchronousQueueï¼‰
- **éœ€è¦ä¼˜å…ˆçº§**ï¼šé€‰æ‹©ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆPriorityBlockingQueueï¼‰









## å››ã€é…ç½®ç±»å‹

### 1. FixedThreadPoolï¼ˆå›ºå®šçº¿ç¨‹æ± ï¼‰
```java
Executors.newFixedThreadPool(10);
```

- **ç‰¹ç‚¹**ï¼š  
  - å›ºå®šçº¿ç¨‹æ•°é‡ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•° = æœ€å¤§çº¿ç¨‹æ•°ï¼‰  
  - çº¿ç¨‹ç©ºé—²æ—¶ä¸ä¼šå›æ”¶  
- **é˜Ÿåˆ—**ï¼šæ— ç•ŒLinkedBlockingQueue  
- **é€‚ç”¨åœºæ™¯**ï¼šè´Ÿè½½ç¨³å®šçš„é«˜å¹¶å‘åœºæ™¯  
- **é£é™©**ï¼šä»»åŠ¡å †ç§¯å¯èƒ½å¯¼è‡´OOMï¼ˆOutOfMemoryErrorï¼‰  

### 2. CachedThreadPoolï¼ˆç¼“å­˜çº¿ç¨‹æ± ï¼‰
```java
Executors.newCachedThreadPool();
```
- **ç‰¹ç‚¹**ï¼š  
  - æ ¸å¿ƒçº¿ç¨‹æ•°=0ï¼Œæœ€å¤§çº¿ç¨‹æ•°=Integer.MAX_VALUE  
  - ç©ºé—²çº¿ç¨‹60ç§’è‡ªåŠ¨å›æ”¶  
- **é˜Ÿåˆ—**ï¼šSynchronousQueueï¼ˆç›´æ¥ä¼ é€’é˜Ÿåˆ—ï¼‰  
- **é€‚ç”¨åœºæ™¯**ï¼šçŸ­æœŸå¼‚æ­¥ä»»åŠ¡æˆ–è½»è´Ÿè½½åœºæ™¯  
- **é£é™©**ï¼šçº¿ç¨‹æ— é™åˆ›å»ºå¯èƒ½å¯¼è‡´èµ„æºè€—å°½  

### 3. SingleThreadExecutorï¼ˆå•çº¿ç¨‹æ± ï¼‰
```java
Executors.newSingleThreadExecutor();
```
- **ç‰¹ç‚¹**ï¼š  
  - å•å·¥ä½œçº¿ç¨‹æ‰§è¡Œ  
  - ä¿è¯ä»»åŠ¡é¡ºåºæ‰§è¡Œ  
- **é˜Ÿåˆ—**ï¼šæ— ç•ŒLinkedBlockingQueue  
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€é¡ºåºæ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡  

### 4. ScheduledThreadPoolï¼ˆå®šæ—¶çº¿ç¨‹æ± ï¼‰
```java
Executors.newScheduledThreadPool(5);
```
- **ç‰¹ç‚¹**ï¼š  
  - æ”¯æŒå®šæ—¶/å‘¨æœŸæ€§ä»»åŠ¡  
  - æ ¸å¿ƒçº¿ç¨‹æ•°å¯é…ç½®  
- **é˜Ÿåˆ—**ï¼šDelayedWorkQueueï¼ˆå»¶è¿Ÿä»»åŠ¡ä¸“ç”¨é˜Ÿåˆ—ï¼‰  
- **é€‚ç”¨åœºæ™¯**ï¼šå®šæ—¶ä»»åŠ¡ã€å‘¨æœŸä»»åŠ¡è°ƒåº¦  

### 5. è‡ªå®šä¹‰ThreadPoolExecutorï¼ˆæ¨èæ–¹æ¡ˆï¼‰
```java
new ThreadPoolExecutor(
    corePoolSize,    // æ ¸å¿ƒçº¿ç¨‹æ•°
    maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•°
    keepAliveTime,   // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
    TimeUnit.SECONDS,
    workQueue,       // å·¥ä½œé˜Ÿåˆ—
    threadFactory,   // çº¿ç¨‹å·¥å‚ï¼ˆå¯è‡ªå®šä¹‰çº¿ç¨‹å/ä¼˜å…ˆçº§ï¼‰
    handler          // æ‹’ç»ç­–ç•¥
);
```

### æ ¸å¿ƒé…ç½®å·®å¼‚å¯¹æ¯”
| é…ç½®ç±»å‹         | çº¿ç¨‹ç®¡ç†  | é˜Ÿåˆ—ç±»å‹                | å®šæ—¶ä»»åŠ¡ | èµ„æºæ§åˆ¶ |
| ---------------- | --------- | ----------------------- | -------- | -------- |
| FixedThreadPool  | å›ºå®šæ•°é‡  | æ— ç•ŒLinkedBlockingQueue | âŒ        | âš ï¸å¼±      |
| CachedThreadPool | åŠ¨æ€ä¼¸ç¼©  | SynchronousQueue        | âŒ        | âš ï¸å¼±      |
| SingleThread     | å•çº¿ç¨‹    | æ— ç•ŒLinkedBlockingQueue | âŒ        | âš ï¸å¼±      |
| ScheduledPool    | å›ºå®š+æ‰©å±• | DelayedWorkQueue        | âœ…        | âš ï¸ä¸­      |
| è‡ªå®šä¹‰çº¿ç¨‹æ±      | ç²¾å‡†æ§åˆ¶  | å¯æŒ‡å®šï¼ˆæ¨èæœ‰ç•Œé˜Ÿåˆ—ï¼‰  | âŒ*       | âœ…å¼º      |

> *æ³¨ï¼šå®šæ—¶åŠŸèƒ½éœ€æ”¹ç”¨`ScheduledThreadPoolExecutor`

### ç”Ÿäº§ç¯å¢ƒå»ºè®®
âœ… **å¼ºåˆ¶ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± **  
- é€šè¿‡`ThreadPoolExecutor`æ˜¾å¼æ§åˆ¶æ ¸å¿ƒå‚æ•°  
- å·¥ä½œé˜Ÿåˆ—**å¿…é¡»è®¾ç½®è¾¹ç•Œ**ï¼ˆå¦‚ArrayBlockingQueueï¼‰  
- é…ç½®åˆç†çš„æ‹’ç»ç­–ç•¥ï¼ˆå¦‚AbortPolicy/CallerRunsPolicyï¼‰  

âš ï¸ **ç¦æ­¢ä½¿ç”¨Executorså¿«æ·æ–¹æ³•**  
- `newFixedThreadPool`/`newSingleThreadExecutor`ï¼šæ— ç•Œé˜Ÿåˆ—å¯¼è‡´OOMé£é™©  
- `newCachedThreadPool`ï¼šæœ€å¤§çº¿ç¨‹æ•°æ— ä¸Šé™é£é™©









## äº”ã€æ€§èƒ½æµ‹è¯•

### 1.å®æµ‹ä»£ç 

```java
	@Bean("taskExecutor")
    public ThreadPoolTaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šè®¾ç½®ä¸ºè¾ƒå¤§å€¼ï¼Œé¿å…é˜Ÿåˆ—ç­‰å¾…
        executor.setCorePoolSize(50);
        // æœ€å¤§çº¿ç¨‹æ•°ï¼šè®¾ç½®ä¸ºè¾ƒå¤§å€¼
        executor.setMaxPoolSize(50);
        // é˜Ÿåˆ—å®¹é‡ï¼šè®¾ç½®ä¸º0ï¼Œå¼ºåˆ¶ç«‹å³åˆ›å»ºçº¿ç¨‹
        executor.setQueueCapacity(0);
        // çº¿ç¨‹ç©ºé—²æ—¶é—´ï¼š60ç§’
        executor.setKeepAliveSeconds(60);
        // çº¿ç¨‹åå‰ç¼€
        executor.setThreadNamePrefix("async-task-");
        // æ‹’ç»ç­–ç•¥ï¼šè°ƒç”¨è€…è¿è¡Œç­–ç•¥
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡ç»“æŸåå†å…³é—­çº¿ç¨‹æ± 
        executor.setWaitForTasksToCompleteOnShutdown(true);
        // ç­‰å¾…æ—¶é—´
        executor.setAwaitTerminationSeconds(60);
        // åˆå§‹åŒ–
        executor.initialize();
        return executor;
    }
```

> é…ç½®å…³é”®ç‚¹è§£æ

| å‚æ•°                           | å€¼   | ä½œç”¨è¯´æ˜                                                   |
| :----------------------------- | :--- | :--------------------------------------------------------- |
| `corePoolSize` & `maxPoolSize` | 50   | åˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼ˆæ ¸å¿ƒçº¿ç¨‹=æœ€å¤§çº¿ç¨‹ï¼‰                  |
| `queueCapacity`                | 0    | **é›¶é˜Ÿåˆ—ç­–ç•¥**ï¼šä»»åŠ¡ä¸æ’é˜Ÿç›´æ¥åˆ›å»ºæ–°çº¿ç¨‹                   |
| `keepAliveSeconds`             | 60   | éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²60ç§’åå›æ”¶ï¼ˆæœ¬é…ç½®ä¸­å®é™…ä¸ä¼šäº§ç”Ÿéæ ¸å¿ƒçº¿ç¨‹ï¼‰ |
| `CallerRunsPolicy`             | -    | æ‹’ç»ç­–ç•¥ï¼šå½“çº¿ç¨‹å…¨å¿™æ—¶ï¼Œç”±**è°ƒç”¨è€…çº¿ç¨‹**ç›´æ¥æ‰§è¡Œä»»åŠ¡       |
| `waitForTasks...Shutdown`      | true | åº”ç”¨å…³é—­æ—¶ç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å®Œæˆ                           |

> âš ï¸ **ç‰¹æ®Šè®¾è®¡è¯´æ˜**ï¼š`queueCapacity=0` ç¡®ä¿ä»»åŠ¡ç«‹å³æ‰§è¡Œï¼Œé¿å…é˜Ÿåˆ—ç¼“å†²å¯¼è‡´çš„å»¶è¿Ÿï¼Œé€‚ç”¨äºå¯¹å“åº”å»¶è¿Ÿæ•æ„Ÿçš„åœºæ™¯



---



```java
	@Autowired(required = false)
    @Qualifier("taskExecutor")
    private ThreadPoolTaskExecutor taskThreadPools;

    @Test
    void processByBatch() throws InterruptedException {
        //key=çº¿ç¨‹æ•°,value=è€—æ—¶s
        Map<Integer, Double> timeMap = new HashMap<Integer, Double>();

        for (int f = 1; f < 30; f++) {
            //CPUæ ¸æ•°ä¸º12,æœ€å¥½æ˜¯ä¸è¶…è¿‡2N+1
            int threadCount = f; // æˆ–è€…18ã€20
            Thread.sleep(1000); // è®©çº¿ç¨‹æ± ç¨³å®š
            long startTime = System.currentTimeMillis(); // è®°å½•å¼€å§‹æ—¶é—´
            // æ¨¡æ‹Ÿ5000+æ¡æ•°æ®
            List<String> dataList = new ArrayList<>();
            for (int j = 0; j < 5200; j++) {
                dataList.add("data-" + j);
            }
            int batchSize = (dataList.size() + threadCount - 1) / threadCount; // 1300
            CountDownLatch latch = new CountDownLatch(threadCount);
            log.info("æ€»æ•°æ®é‡ï¼š{}ï¼Œçº¿ç¨‹æ•°ï¼š{}ï¼Œæ¯çº¿ç¨‹å¤„ç†ï¼š{}æ¡", dataList.size(), threadCount, batchSize);
            for (int i = 0; i < threadCount; i++) {
                final int startIndex = i * batchSize;
                final int endIndex = Math.min(startIndex + batchSize, dataList.size());
                final int threadId = i;

                if (startIndex < dataList.size()) {
                    taskThreadPools.execute(() -> {
                        try {
                            log.info("çº¿ç¨‹{}å¼€å§‹å¤„ç†ï¼ŒèŒƒå›´ï¼š{}-{}", Thread.currentThread().getName(), startIndex, endIndex - 1);
                            for (int j = startIndex; j < endIndex; j++) {
                                processData(dataList.get(j), threadId);
                            }
                            log.info("çº¿ç¨‹{}å®Œæˆå¤„ç†", Thread.currentThread().getName());
                        } finally {
                            latch.countDown();
                        }
                    });
                }
            }
            latch.await();

            long endTime = System.currentTimeMillis(); // è®°å½•ç»“æŸæ—¶é—´
            long totalTime = endTime - startTime; // è®¡ç®—æ€»è€—æ—¶
            log.info("æ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶ï¼š{}msï¼Œçº¦{}ç§’", totalTime, totalTime / 1000.0);
            timeMap.put(threadCount, totalTime / 1000.0);
        }
        for (Map.Entry<Integer, Double> entry : timeMap.entrySet()) {
            log.error("çº¿ç¨‹æ•°={},æ‰§è¡Œè€—æ—¶={}s", entry.getKey(), entry.getValue());
        }
    }

    private void processData(String data, int threadId) {
        try {
            Thread.sleep(50);
            log.info("ThreadId={}, ThreadName={}, å¤„ç†æ•°æ®: {}",
                    threadId, Thread.currentThread().getName(), data);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
```

> æµ‹è¯•é€»è¾‘è§£æ

1. **åŠ¨æ€çº¿ç¨‹æ•°æµ‹è¯•**

   - å¾ªç¯æµ‹è¯•1-29ä¸ªçº¿ç¨‹é…ç½®ï¼ˆå¯¹åº”12æ ¸CPUçš„0.08x-2.4xé…ç½®ï¼‰
   - æ¯æ¬¡æµ‹è¯•å‰ä¼‘çœ 1ç§’ç¡®ä¿çº¿ç¨‹æ± çŠ¶æ€ç¨³å®š

2. **ä»»åŠ¡åˆ†é…æœºåˆ¶**

   ```java
   // è®¡ç®—æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„æ•°æ®é‡
   int batchSize = (æ•°æ®æ€»é‡ + çº¿ç¨‹æ•° - 1) / threadCount; 
   
   // æ•°æ®åˆ†æ®µå¤„ç†
   for (int i=0; i<threadCount; i++) {
     int start = i * batchSize;
     int end = Math.min(start + batchSize, æ€»æ•°æ®é‡);
   }
   ```

3. **åŒæ­¥æ§åˆ¶**

   - ä½¿ç”¨`CountDownLatch(threadCount)`ç¡®ä¿æ‰€æœ‰ä»»åŠ¡å®Œæˆåæ‰è®°å½•è€—æ—¶
   - `latch.await()`é˜»å¡ä¸»çº¿ç¨‹ç›´åˆ°æ‰€æœ‰å­ä»»åŠ¡å®Œæˆ

4. **å»¶è¿Ÿæ¨¡æ‹Ÿ**

   - `processData()`ä¸­å›ºå®šä¼‘çœ 50msæ¨¡æ‹ŸçœŸå®ä»»åŠ¡å»¶è¿Ÿ
   - ç²¾ç¡®æ§åˆ¶å•ä»»åŠ¡å¤„ç†æ—¶é—´ï¼Œæ’é™¤å…¶ä»–å¹²æ‰°å› ç´ 



> æµ‹è¯•è®¾è®¡ç‰¹ç‚¹

| ç‰¹æ€§             | è¯´æ˜                                     |
| :--------------- | :--------------------------------------- |
| **åŠ¨æ€çº¿ç¨‹èŒƒå›´** | 1-29çº¿ç¨‹è¦†ç›–ä¸è¶³/é¥±å’Œ/è¿‡è½½ä¸‰ç§çŠ¶æ€       |
| **å›ºå®šä»»åŠ¡å»¶è¿Ÿ** | 50mså»¶è¿Ÿæ¨¡æ‹ŸçœŸå®IOæ“ä½œ                   |
| **åˆ†æ‰¹è´Ÿè½½å‡è¡¡** | æ•°æ®å‡åŒ€åˆ†æ®µç¡®ä¿å„çº¿ç¨‹è´Ÿè½½ä¸€è‡´           |
| **éš”ç¦»å¼æµ‹è¯•**   | æ¯æ¬¡å¾ªç¯é‡å»ºæ•°æ®ï¼Œé¿å…ç¼“å­˜å¹²æ‰°           |
| **ç²¾ç¡®è®¡æ—¶**     | System.currentTimeMillis()è®°å½•ç«¯åˆ°ç«¯è€—æ—¶ |



---





### 2.æ€»ç»“æŠ¥å‘Š

##### æµ‹è¯•ç¯å¢ƒé…ç½®
- **CPUæ ¸æ•°**ï¼š12æ ¸  
- **ä»»åŠ¡æ€»æ•°**ï¼š5200ä¸ª  
- **ä»»åŠ¡åˆ†é…ç­–ç•¥**ï¼šå¹³å‡åˆ†é…ç»™å„çº¿ç¨‹  
- **æ¨¡æ‹Ÿå»¶è¿Ÿ**ï¼šThread.sleep(50ms)  
- **æµ‹è¯•èŒƒå›´**ï¼š10-69çº¿ç¨‹  







##### å®Œæ•´æ€§èƒ½æµ‹è¯•æ•°æ®è¡¨
| çº¿ç¨‹æ•° | æ‰§è¡Œè€—æ—¶(s) | æ¯çº¿ç¨‹ä»»åŠ¡æ•° | æ€§èƒ½æå‡ç‡ | å¤‡æ³¨         |
| ------ | ----------- | ------------ | ---------- | ------------ |
| 10     | 17.824      | 520          | åŸºå‡†       | èµ·å§‹ç‚¹       |
| 20     | 13.054      | 260          | 26.8%      | æ˜¾è‘—æå‡     |
| 30     | 8.952       | 173          | 49.8%      | æŒç»­ä¼˜åŒ–     |
| 39     | 6.824       | 133          | 61.7%      | é˜¶æ®µæœ€ä¼˜     |
| 40     | 6.636       | 130          | 62.8%      | ç»§ç»­æ”¹å–„     |
| 49     | 5.455       | 106          | 69.4%      | æ¥è¿‘å³°å€¼     |
| 50     | 5.380       | 104          | 69.8%      | é€¼è¿‘æœ€ä¼˜     |
| 51     | 5.199       | 102          | 70.8%      | **æœ€ä¼˜ç‚¹**   |
| 52     | 10.185      | 100          | 42.9%      | **æ€§èƒ½æ–­å´–** |
| 60     | 8.873       | 87           | 50.2%      | ç¼“æ…¢æ¢å¤     |
| 69     | 7.752       | 75           | 56.5%      | æ¢å¤ä¸­       |





##### å…³é”®æ€§èƒ½èŠ‚ç‚¹åˆ†æ

###### æœ€ä¼˜é…ç½®ç‚¹
- **çº¿ç¨‹æ•°**ï¼š51çº¿ç¨‹  
- **æ‰§è¡Œè€—æ—¶**ï¼š5.199ç§’  
- **æ¯çº¿ç¨‹è´Ÿè½½**ï¼š102ä¸ªä»»åŠ¡  
- **çº¿ç¨‹-CPUæ¯”ä¾‹**ï¼š4.25:1 (51çº¿ç¨‹/12æ ¸)  

---



###### æ€§èƒ½æ–­å´–ç‚¹
- **ä¸´ç•Œçº¿ç¨‹æ•°**ï¼š52çº¿ç¨‹  
- **æ€§èƒ½è·³è·ƒ**ï¼š5.199s â†’ 10.185s (+95.9%)  
- **é€€åŒ–å¹…åº¦**ï¼š95.9%

---



###### æ ¸å¿ƒå‘ç°
1. **æœ€ä¼˜çº¿ç¨‹é…ç½®**ï¼š51çº¿ç¨‹å®ç°70.8%æ€§èƒ½æå‡ï¼ˆç»å¯¹æœ€ä¼˜ç‚¹ï¼‰  
2. **çº¿ç¨‹-CPUæ¯”ä¾‹**ï¼šæœ€ä½³æ¯”ä¾‹ â‰ˆ 4.25:1 (51çº¿ç¨‹/12æ ¸)  
3. **ä»»åŠ¡åˆ†é…æ•ˆç‡**ï¼šæ¯çº¿ç¨‹102ä»»åŠ¡æ—¶è´Ÿè½½å‡è¡¡æœ€ä¼˜  
4. **æ€§èƒ½è¾¹ç•Œ**ï¼š>51çº¿ç¨‹åå‡ºç°ä¸¥é‡èµ„æºç«äº‰ï¼Œæ€§èƒ½æ–­å´–å¼ä¸‹é™  

---



##### ç”Ÿäº§ç¯å¢ƒå»ºè®®
**æ¨èçº¿ç¨‹æ± å¤§å°**ï¼š51çº¿ç¨‹  

- âœ… åœ¨12æ ¸CPUå¤„ç†5200ä¸ª50mså»¶è¿Ÿä»»åŠ¡çš„æœ€ä¼˜é…ç½®  
- âœ… å……åˆ†å‹æ¦¨CPUèµ„æºï¼ŒåŒæ—¶è§„é¿ç«äº‰å¯¼è‡´çš„æ€§èƒ½æŸå¤±  
- âš¡ ç›¸æ¯”å•çº¿ç¨‹ä¸²è¡Œå¤„ç†ï¼Œæ€§èƒ½æå‡ >70%  







## å…­ã€æœ€ä½³å®è·µæ€»ç»“

1. **æ‹’ç»ç­–ç•¥**ï¼šCallerRunsPolicyé€‚åˆAIæœåŠ¡ç­‰ä¸èƒ½ä¸¢å¤±ä»»åŠ¡çš„åœºæ™¯
2. **é˜Ÿåˆ—ç±»å‹**ï¼šæœ‰ç•ŒLinkedBlockingQueueï¼ˆqueueCapacity=100ï¼‰æ˜¯æœ€ä½³å¹³è¡¡é€‰æ‹©
3. **é…ç½®åŸåˆ™**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹æ€§é€‰æ‹©åˆé€‚çš„æ‹’ç»ç­–ç•¥å’Œé˜Ÿåˆ—ç±»å‹
4. **ç›‘æ§é‡è¦**ï¼šå»ºè®®æ·»åŠ çº¿ç¨‹æ± ç›‘æ§ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜







## ä¸ƒã€CPUæ ¸æ•°ä¸çº¿ç¨‹æ± é…ç½®å…³ç³»åˆ†æ

### å½“å‰é…ç½®åˆ†æ
| å‚æ•°         | å€¼    | è®¡ç®—å…³ç³»        |
| ------------ | ----- | --------------- |
| CPUæ ¸æ•°      | 24æ ¸  | åŸºå‡†å€¼          |
| æ ¸å¿ƒçº¿ç¨‹æ•°   | 102   | åŠ¨æ€é…ç½®        |
| **çº¿ç¨‹æ¯”ä¾‹** | 4.25x | 102 Ã· 24 = 4.25 |

### çº¿ç¨‹æ•°é…ç½®åŸåˆ™
#### 1. CPUå¯†é›†å‹ä»»åŠ¡
```java
// è®¡ç®—å…¬å¼
æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•° + 1 

// 24æ ¸CPUç¤ºä¾‹
24 + 1 = 25
```

**åŸç†**ï¼š  
- ä¸»è¦æ¶ˆè€—CPUè®¡ç®—èµ„æº  
- `+1`è®¾è®¡ï¼šå½“çº¿ç¨‹å› é¡µé¢é”™è¯¯æš‚åœæ—¶ï¼Œå¤‡ç”¨çº¿ç¨‹ç»´æŒCPUåˆ©ç”¨ç‡  

#### 2. I/Oå¯†é›†å‹ä»»åŠ¡
```java
// è®¡ç®—å…¬å¼
æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•° Ã— (1 + I/Oç­‰å¾…æ—¶é—´/CPUä½¿ç”¨æ—¶é—´)

// ç¤ºä¾‹ï¼ˆI/Oç­‰å¾…=3å€CPUæ—¶é—´ï¼‰
24 Ã— (1 + 3) = 96
```
**åŸç†**ï¼š  
- çº¿ç¨‹å¸¸å¤„äºI/Oé˜»å¡çŠ¶æ€ï¼ˆç½‘ç»œ/ç£ç›˜æ“ä½œï¼‰  
- æ›´é«˜çº¿ç¨‹æ•°å¯å……åˆ†åˆ©ç”¨ç­‰å¾…æ—¶é—´  

#### 3. æ··åˆå‹ä»»åŠ¡ï¼ˆæ¨èé€šç”¨æ–¹æ¡ˆï¼‰
```java
// è®¡ç®—å…¬å¼
æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•° Ã— [2, 4] 

// 24æ ¸CPUç¤ºä¾‹
24 Ã— 2 = 48  // ä¿å®ˆé…ç½®
24 Ã— 4 = 96  // å‡è¡¡é…ç½®
```

### é…ç½®åˆç†æ€§è¯„ä¼°
#### å½“å‰é…ç½®åˆ†æ
- **102çº¿ç¨‹**åœ¨24æ ¸ç¯å¢ƒï¼ˆ4.25xï¼‰  
- **é€‚åˆåœºæ™¯**ï¼š  
  âœ… I/Oå¯†é›†å‹AIæœåŠ¡ï¼ˆæ¨¡å‹æ¨ç†/ç½‘ç»œè¯·æ±‚ç­‰å¾…ï¼‰  
  âœ… å«å¤–éƒ¨APIè°ƒç”¨çš„ä¸šåŠ¡ç³»ç»Ÿ  
  âœ… æ•°æ®åº“æ“ä½œé¢‘ç¹çš„åº”ç”¨  

#### ä¼˜åŒ–å»ºè®®æ–¹æ¡ˆ
| åœºæ™¯          | è®¡ç®—å…¬å¼   | æ¨èå€¼ | è¯´æ˜             |
| ------------- | ---------- | ------ | ---------------- |
| ä¿å®ˆå‹AIæœåŠ¡  | 24 Ã— 3     | 72     | ä½é£é™©èµ·æ­¥       |
| **å½“å‰é…ç½®**  | 24 Ã— 4.25  | 102    | æ¥è¿‘æ¨èä¸Šé™     |
| æ¿€è¿›å‹APIæœåŠ¡ | 24 Ã— 5     | 120    | é«˜å¹¶å‘åœºæ™¯       |
| é‡æ•°æ®åº“æ“ä½œ  | 24 Ã— [4,6] | 96-144 | æ ¹æ®DBè¿æ¥æ± è°ƒæ•´ |

**åŠ¨æ€è°ƒæ•´ç­–ç•¥**ï¼š  
```java
// åŸºäºCPUæ ¸æ•°è‡ªåŠ¨è®¡ç®—ï¼ˆSpring Bootç¤ºä¾‹ï¼‰
@Value("${thread.pool.core-size:#{T(java.lang.Runtime).getRuntime().availableProcessors() * 4}}")
private int corePoolSize;
```

#### å…³é”®ç›‘æ§æŒ‡æ ‡
| æŒ‡æ ‡             | å¥åº·èŒƒå›´    | å‘Šè­¦é˜ˆå€¼         | ä¼˜åŒ–åŠ¨ä½œ               |
| ---------------- | ----------- | ---------------- | ---------------------- |
| CPUä½¿ç”¨ç‡        | 70%-80%     | >90%æŒç»­5åˆ†é’Ÿ    | é™ä½çº¿ç¨‹æ•°æˆ–æ‰©å®¹CPU    |
| æ´»è·ƒçº¿ç¨‹æ•°       | â‰ˆæ ¸å¿ƒçº¿ç¨‹æ•° | æŒç»­=maxPoolSize | å¢å¤§æ ¸å¿ƒçº¿ç¨‹æ•°         |
| ä»»åŠ¡é˜Ÿåˆ—å †ç§¯é•¿åº¦ | <10         | >100             | ä¼˜åŒ–ä»»åŠ¡æˆ–è°ƒæ•´é˜Ÿåˆ—ç­–ç•¥ |
| å¹³å‡ä»»åŠ¡æ‰§è¡Œæ—¶é—´ | ç¨³å®šæ³¢åŠ¨    | çªå¢50%          | æ£€æŸ¥I/Oä¾èµ–ç³»ç»Ÿ        |

### ç»“è®ºä¸å»ºè®®
1. **å½“å‰102çº¿ç¨‹é…ç½®åˆç†**ï¼Œç¬¦åˆI/Oå¯†é›†å‹æœåŠ¡çš„æœ€ä½³å®è·µ  
2. **æ¨èè°ƒæ•´çª—å£**ï¼š96-120çº¿ç¨‹ï¼ˆæ ¹æ®å®é™…ç›‘æ§æ•°æ®å¾®è°ƒï¼‰  
3. **ä¼˜åŒ–è·¯å¾„**ï¼š  
   - ä¿æŒ102ä½œä¸ºåŸºå‡†é…ç½®  
   - é€šè¿‡ç›‘æ§æŒ‡æ ‡åŠ¨æ€è°ƒä¼˜  
   - åœ¨96/108/120ä¸‰ä¸ªèŠ‚ç‚¹è¿›è¡Œå‹æµ‹å¯¹æ¯”  

> ğŸ“Œ **é»„é‡‘æ³•åˆ™**ï¼šæœ€ä¼˜çº¿ç¨‹æ•° = CPUæ ¸æ•° Ã— (1 + å¹³å‡ç­‰å¾…æ—¶é—´/å¹³å‡è®¡ç®—æ—¶é—´)













## å…«ã€24æ ¸CPUæ ‡å‡†çº¿ç¨‹æ± é…ç½®

### I/Oå¯†é›†å‹çº¿ç¨‹æ± é…ç½®

#### æ ‡å‡†é…ç½®

```yaml
spring:
  task:
    execution:
      pool:
        core-size: 100          # çº¦4å€CPUæ ¸æ•°
        max-size: 200           # I/Oå¯†é›†å‹å¯è®¾ç½®æ›´å¤§
        queue-capacity: 1000    # å¤§é˜Ÿåˆ—ç¼“å†²çªå‘è¯·æ±‚
        keep-alive: 120s        # è¾ƒé•¿ç©ºé—²æ—¶é—´
        thread-name-prefix: "io-task-"
        allow-core-thread-timeout: true
```



#### Javaä»£ç é…ç½®

```java
@Configuration
public class IOThreadPoolConfig {
    
    @Bean("ioTaskExecutor")
    public ThreadPoolTaskExecutor ioTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(100);        // 4 Ã— 24
        executor.setMaxPoolSize(200);         // 8 Ã— 24
        executor.setQueueCapacity(1000);      // å¤§é˜Ÿåˆ—
        executor.setKeepAliveSeconds(120);
        executor.setThreadNamePrefix("io-task-");
        executor.setAllowCoreThreadTimeOut(true);
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```



#### è®¡ç®—ä¾æ®

```
I/Oå¯†é›†å‹å…¬å¼: CPUæ ¸æ•° Ã— (1 + I/Oç­‰å¾…æ—¶é—´/CPUå¤„ç†æ—¶é—´)
- 24æ ¸ Ã— (1 + 50ms/1ms) = 24 Ã— 51 = 1224 (ç†è®ºå€¼)
- å®é™…è€ƒè™‘ç³»ç»Ÿå¼€é”€: 100-200ä¸ªçº¿ç¨‹ (åˆç†èŒƒå›´)
```





---



### è™šæ‹Ÿçº¿ç¨‹æ± (JDK21)



> **JDK21è™šæ‹Ÿçº¿ç¨‹å®Œæ•´é…ç½®å’Œè°ƒç”¨æ¢³ç†ï¼š**

#### **1. åŸºç¡€é…ç½®**

##### **å¯ç”¨è™šæ‹Ÿçº¿ç¨‹ï¼ˆSpring Boot 3.2+ï¼‰ï¼š**

```yaml
spring:
  threads:
    virtual:
      enabled: true
```

##### **Javaé…ç½®ç±»ï¼š**

```java
@Configuration
@EnableAsync
public class VirtualThreadConfig {
    
    @Bean("virtualThreadExecutor")
    public Executor virtualThreadExecutor() {
        return Executors.newVirtualThreadPerTaskExecutor();
    }
    
    @Override
    public Executor getAsyncExecutor() {
        return virtualThreadExecutor();
    }
}
```

#### **2. WebæœåŠ¡å™¨é…ç½®**

##### **Tomcatè™šæ‹Ÿçº¿ç¨‹ï¼š**

```yaml
server:
  tomcat:
    threads:
      max: 1000  # è™šæ‹Ÿçº¿ç¨‹å¯ä»¥è®¾ç½®æ›´é«˜
    accept-count: 100
```

##### **Undertowé…ç½®ï¼š**

```yaml
server:
  undertow:
    threads:
      io: 4
      worker: 200
```

#### **3. æ•°æ®åº“ç›¸å…³é…ç½®**

**è¿æ¥æ± é…ç½®ï¼š**

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 100  # è™šæ‹Ÿçº¿ç¨‹æ”¯æŒæ›´å¤šè¿æ¥
      connection-timeout: 30000
      idle-timeout: 600000
```

**JPAé…ç½®ï¼š**

```yaml
spring:
  jpa:
    properties:
      hibernate:
        connection:
          provider_disables_autocommit: true
```

#### **4. è°ƒç”¨æ–¹å¼**

**ç›´æ¥åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼š**

```java
// æ–¹å¼1ï¼šThread.ofVirtual()
Thread.ofVirtual().start(() -> {
    // IOå¯†é›†å‹ä»»åŠ¡
    processIoTask();
});

// æ–¹å¼2ï¼šä½¿ç”¨ExecutorService
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    executor.submit(() -> {
        return callDatabase();
    });
}
```

**Springå¼‚æ­¥è°ƒç”¨ï¼š**

```java
@Service
public class IoService {
    
    @Async("virtualThreadExecutor")
    public CompletableFuture<String> asyncTask() {
        // æ•°æ®åº“æ“ä½œ
        return CompletableFuture.completedFuture(queryData());
    }
    
    @Async
    public void fireAndForget() {
        // HTTPè°ƒç”¨
        callExternalApi();
    }
}
```

**CompletableFutureä½¿ç”¨ï¼š**

```java
@Service
public class BusinessService {
    
    public String processData() {
        CompletableFuture<String> future1 = CompletableFuture
            .supplyAsync(this::callApi1, Executors.newVirtualThreadPerTaskExecutor());
            
        CompletableFuture<String> future2 = CompletableFuture
            .supplyAsync(this::callApi2, Executors.newVirtualThreadPerTaskExecutor());
            
        return future1.thenCombine(future2, (r1, r2) -> r1 + r2).join();
    }
}
```

#### **5. Webæ§åˆ¶å™¨ä¸­ä½¿ç”¨**

```java
@RestController
public class ApiController {
    
    @Autowired
    private IoService ioService;
    
    @GetMapping("/async")
    public CompletableFuture<ResponseEntity<String>> asyncEndpoint() {
        return ioService.asyncTask()
            .thenApply(result -> ResponseEntity.ok(result));
    }
    
    @GetMapping("/parallel")
    public String parallelCalls() {
        try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
            var futures = IntStream.range(0, 10)
                .mapToObj(i -> executor.submit(() -> callExternalService(i)))
                .toList();
                
            return futures.stream()
                .map(f -> {
                    try { return f.get(); } 
                    catch (Exception e) { return "error"; }
                })
                .collect(Collectors.joining(","));
        }
    }
}
```

#### **6. ç›‘æ§å’Œè°ƒè¯•**

**JVMå‚æ•°ï¼š**

```bash
-XX:+UnlockExperimentalVMOptions
--enable-preview  # JDK19-20éœ€è¦
-Djdk.virtualThreadScheduler.parallelism=4  # è½½ä½“çº¿ç¨‹æ•°
```

**ç›‘æ§é…ç½®ï¼š**

```java
@Component
public class VirtualThreadMonitor {
    
    @EventListener
    public void handleVirtualThreadEvent(VirtualThreadEvent event) {
        log.info("Virtual thread: {}", event.getThreadName());
    }
}
```



#### **7. æœ€ä½³å®è·µ**

**é€‚ç”¨åœºæ™¯ï¼š**

- HTTPå®¢æˆ·ç«¯è°ƒç”¨
- æ•°æ®åº“æŸ¥è¯¢æ“ä½œ
- æ–‡ä»¶IOæ“ä½œ
- æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†

**æ³¨æ„äº‹é¡¹ï¼š**

- é¿å…ä½¿ç”¨synchronizedï¼ˆä¼šå›ºå®šåˆ°è½½ä½“çº¿ç¨‹ï¼‰
- ä½¿ç”¨ReentrantLockæ›¿ä»£synchronized
- CPUå¯†é›†å‹ä»»åŠ¡ä»ä½¿ç”¨ä¼ ç»Ÿçº¿ç¨‹æ± 
- ä¸è¦æ‰‹åŠ¨ç®¡ç†è™šæ‹Ÿçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ



---





### CPUå¯†é›†å‹çº¿ç¨‹æ± é…ç½®

#### æ ‡å‡†é…ç½®
```yaml
spring:
  task:
    execution:
      pool:
        core-size: 25           # CPUæ ¸æ•°+1
        max-size: 48            # 2å€CPUæ ¸æ•°
        queue-capacity: 100     # å°é˜Ÿåˆ—é¿å…å †ç§¯
        keep-alive: 60s         # è¾ƒçŸ­ç©ºé—²æ—¶é—´
        thread-name-prefix: "cpu-task-"
        allow-core-thread-timeout: false
```

#### Javaä»£ç é…ç½®
```java
@Configuration
public class CPUThreadPoolConfig {
    
    @Bean("cpuTaskExecutor")
    public ThreadPoolTaskExecutor cpuTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(25);         // 24 + 1
        executor.setMaxPoolSize(48);          // 2 Ã— 24
        executor.setQueueCapacity(100);       // å°é˜Ÿåˆ—
        executor.setKeepAliveSeconds(60);
        executor.setThreadNamePrefix("cpu-task-");
        executor.setAllowCoreThreadTimeOut(false);
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.AbortPolicy());
        executor.initialize();
        return executor;
    }
}
```

#### è®¡ç®—ä¾æ®
```
CPUå¯†é›†å‹å…¬å¼: CPUæ ¸æ•° + 1
- æ ¸å¿ƒçº¿ç¨‹æ•°: 24 + 1 = 25
- æœ€å¤§çº¿ç¨‹æ•°: 24 Ã— 2 = 48 (å¤„ç†çªå‘)
- å°é˜Ÿåˆ—: é¿å…ä»»åŠ¡å †ç§¯å½±å“å“åº”æ—¶é—´
```

### é…ç½®å¯¹æ¯”è¡¨

| é…ç½®é¡¹           | I/Oå¯†é›†å‹        | CPUå¯†é›†å‹   | è¯´æ˜                          |
| ---------------- | ---------------- | ----------- | ----------------------------- |
| **æ ¸å¿ƒçº¿ç¨‹æ•°**   | 100              | 25          | I/Oå¯†é›†å‹éœ€è¦æ›´å¤šçº¿ç¨‹å¤„ç†ç­‰å¾… |
| **æœ€å¤§çº¿ç¨‹æ•°**   | 200              | 48          | I/Oå¯†é›†å‹å¯ä»¥è®¾ç½®æ›´å¤§         |
| **é˜Ÿåˆ—å®¹é‡**     | 1000             | 100         | I/Oå¯†é›†å‹ç”¨å¤§é˜Ÿåˆ—ç¼“å†²         |
| **ç©ºé—²æ—¶é—´**     | 120s             | 60s         | I/Oå¯†é›†å‹çº¿ç¨‹å¯ä»¥ä¿æŒæ›´ä¹…     |
| **æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶** | true             | false       | I/Oå¯†é›†å‹å…è®¸æ ¸å¿ƒçº¿ç¨‹å›æ”¶     |
| **æ‹’ç»ç­–ç•¥**     | CallerRunsPolicy | AbortPolicy | I/Oå¯†é›†å‹ç”¨è°ƒç”¨è€…æ‰§è¡Œ         |





### æ··åˆå‹ä»»åŠ¡çº¿ç¨‹æ± é…ç½®

#### é€šç”¨é…ç½® (æ—¢æœ‰I/Oåˆæœ‰CPUè®¡ç®—)
```yaml
spring:
  task:
    execution:
      pool:
        core-size: 50           # 2å€CPUæ ¸æ•°
        max-size: 100           # 4å€CPUæ ¸æ•°
        queue-capacity: 500     # ä¸­ç­‰é˜Ÿåˆ—
        keep-alive: 90s         # ä¸­ç­‰ç©ºé—²æ—¶é—´
        thread-name-prefix: "mixed-task-"
```

```java
@Bean("mixedTaskExecutor")
public ThreadPoolTaskExecutor mixedTaskExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(50);          // 2 Ã— 24
    executor.setMaxPoolSize(100);          // 4 Ã— 24
    executor.setQueueCapacity(500);        // ä¸­ç­‰é˜Ÿåˆ—
    executor.setKeepAliveSeconds(90);
    executor.setThreadNamePrefix("mixed-task-");
    executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
    executor.initialize();
    return executor;
}
```



### ä¸šåŠ¡åœºæ™¯é€‰æ‹©æŒ‡å—

#### I/Oå¯†é›†å‹åœºæ™¯
```java
// æ•°æ®åº“æ“ä½œ
@Async("ioTaskExecutor")
public CompletableFuture<List<User>> findUsers() {
    return CompletableFuture.completedFuture(userRepository.findAll());
}

// æ–‡ä»¶æ“ä½œ
@Async("ioTaskExecutor") 
public CompletableFuture<String> readFile(String path) {
    return CompletableFuture.completedFuture(Files.readString(Paths.get(path)));
}

// HTTPè°ƒç”¨
@Async("ioTaskExecutor")
public CompletableFuture<String> callExternalApi() {
    return CompletableFuture.completedFuture(restTemplate.getForObject(url, String.class));
}
```



### CPUå¯†é›†å‹åœºæ™¯
```java
// æ•°å­¦è®¡ç®—
@Async("cpuTaskExecutor")
public CompletableFuture<BigInteger> calculateFactorial(int n) {
    BigInteger result = BigInteger.ONE;
    for (int i = 2; i <= n; i++) {
        result = result.multiply(BigInteger.valueOf(i));
    }
    return CompletableFuture.completedFuture(result);
}

// å›¾åƒå¤„ç†
@Async("cpuTaskExecutor")
public CompletableFuture<BufferedImage> processImage(BufferedImage image) {
    // CPUå¯†é›†çš„å›¾åƒå¤„ç†é€»è¾‘
    return CompletableFuture.completedFuture(processedImage);
}

// æ•°æ®åŠ å¯†
@Async("cpuTaskExecutor")
public CompletableFuture<String> encryptData(String data) {
    // CPUå¯†é›†çš„åŠ å¯†ç®—æ³•
    return CompletableFuture.completedFuture(encryptedData);
}
```



### JVMè°ƒä¼˜å»ºè®®

#### I/Oå¯†é›†å‹JVMå‚æ•°
```bash
-Xms4g -Xmx8g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:+UseStringDeduplication
```

#### CPUå¯†é›†å‹JVMå‚æ•°
```bash
-Xms6g -Xmx12g
-XX:+UseParallelGC
-XX:ParallelGCThreads=24
-XX:+UseCompressedOops
```



### ç›‘æ§é…ç½®

#### çº¿ç¨‹æ± ç›‘æ§
```java
@Component
public class ThreadPoolMonitor {
    
    @Autowired
    @Qualifier("ioTaskExecutor")
    private ThreadPoolTaskExecutor ioExecutor;
    
    @Autowired
    @Qualifier("cpuTaskExecutor") 
    private ThreadPoolTaskExecutor cpuExecutor;
    
    @Scheduled(fixedRate = 30000)
    public void monitorThreadPools() {
        logThreadPoolStats("IO", ioExecutor);
        logThreadPoolStats("CPU", cpuExecutor);
    }
    
    private void logThreadPoolStats(String type, ThreadPoolTaskExecutor executor) {
        ThreadPoolExecutor pool = executor.getThreadPoolExecutor();
        log.info("{} ThreadPool - Active: {}, Pool: {}, Queue: {}, Completed: {}", 
                type,
                pool.getActiveCount(),
                pool.getPoolSize(), 
                pool.getQueue().size(),
                pool.getCompletedTaskCount());
    }
}
```



### æ€»ç»“

#### **24æ ¸CPUæœ€ä¼˜é…ç½®**:

- **I/Oå¯†é›†å‹**: 100æ ¸å¿ƒçº¿ç¨‹ï¼Œ200æœ€å¤§çº¿ç¨‹ï¼Œ1000é˜Ÿåˆ—
- **CPUå¯†é›†å‹**: 25æ ¸å¿ƒçº¿ç¨‹ï¼Œ48æœ€å¤§çº¿ç¨‹ï¼Œ100é˜Ÿåˆ—
- **é€‰æ‹©ä¾æ®**: æ ¹æ®ä»»åŠ¡ç‰¹æ€§é€‰æ‹©å¯¹åº”é…ç½®
- **ç›‘æ§é‡ç‚¹**: çº¿ç¨‹æ´»è·ƒåº¦ã€é˜Ÿåˆ—é•¿åº¦ã€å®Œæˆä»»åŠ¡æ•°









# ä»»åŠ¡å¯†é›†å‹åˆ†ç±»ä¸åˆ¤æ–­æ–¹æ³•

## ä»»åŠ¡å¯†é›†å‹åˆ†ç±»

### 1. I/Oå¯†é›†å‹ (I/O Intensive)
**ç‰¹å¾**:
- å¤§é‡æ—¶é—´èŠ±è´¹åœ¨ç­‰å¾…I/Oæ“ä½œä¸Š
- CPUä½¿ç”¨ç‡ç›¸å¯¹è¾ƒä½
- çº¿ç¨‹ç»å¸¸å¤„äºé˜»å¡çŠ¶æ€

**å…¸å‹åœºæ™¯**:
```java
// æ•°æ®åº“æ“ä½œ
userRepository.findAll();
// æ–‡ä»¶è¯»å†™
Files.readAllLines(path);
// ç½‘ç»œè¯·æ±‚
restTemplate.getForObject(url, String.class);
// æ¶ˆæ¯é˜Ÿåˆ—
rabbitTemplate.send(queue, message);
```

### 2. CPUå¯†é›†å‹ (CPU Intensive)
**ç‰¹å¾**:
- å¤§é‡æ—¶é—´èŠ±è´¹åœ¨CPUè®¡ç®—ä¸Š
- CPUä½¿ç”¨ç‡é«˜
- å¾ˆå°‘æœ‰I/Oç­‰å¾…

**å…¸å‹åœºæ™¯**:
```java
// æ•°å­¦è®¡ç®—
BigInteger.valueOf(n).pow(1000);
// å›¾åƒå¤„ç†
BufferedImage processed = processImage(image);
// åŠ å¯†è§£å¯†
cipher.doFinal(data);
// æ•°æ®å‹ç¼©
gzip.compress(data);
```

### 3. å†…å­˜å¯†é›†å‹ (Memory Intensive)
**ç‰¹å¾**:
- éœ€è¦å¤§é‡å†…å­˜ç©ºé—´
- é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œå›æ”¶
- å¯èƒ½å¯¼è‡´GCå‹åŠ›

**å…¸å‹åœºæ™¯**:
```java
// å¤§æ•°æ®é›†å¤„ç†
List<BigData> bigDataList = new ArrayList<>(1000000);
// ç¼“å­˜æ“ä½œ
Map<String, Object> cache = new HashMap<>(500000);
// å›¾åƒ/è§†é¢‘å¤„ç†
byte[] imageData = new byte[1024 * 1024 * 100]; // 100MB
// å¤§æ–‡ä»¶åŠ è½½
String content = Files.readString(bigFilePath);
```

### 4. ç½‘ç»œå¯†é›†å‹ (Network Intensive)
**ç‰¹å¾**:
- å¤§é‡ç½‘ç»œé€šä¿¡
- å—ç½‘ç»œå»¶è¿Ÿå’Œå¸¦å®½å½±å“
- å¯èƒ½æœ‰è¿æ¥æ± é™åˆ¶

**å…¸å‹åœºæ™¯**:

```java
// å¾®æœåŠ¡è°ƒç”¨
feignClient.getUserInfo(userId);
// çˆ¬è™«ä»»åŠ¡
webClient.get().uri(url).retrieve();
// æ–‡ä»¶ä¸Šä¼ ä¸‹è½½
ftpClient.upload(file);
// å®æ—¶é€šä¿¡
websocketSession.sendMessage(message);
```

### 5. ç£ç›˜å¯†é›†å‹ (Disk Intensive)
**ç‰¹å¾**:
- é¢‘ç¹çš„ç£ç›˜è¯»å†™æ“ä½œ
- å—ç£ç›˜I/Oæ€§èƒ½é™åˆ¶
- å¯èƒ½æœ‰æ–‡ä»¶é”ç«äº‰

**å…¸å‹åœºæ™¯**:
```java
// æ—¥å¿—å†™å…¥
logger.info("å¤§é‡æ—¥å¿—ä¿¡æ¯");
// æ–‡ä»¶æ‰¹å¤„ç†
Files.copy(source, target);
// æ•°æ®å¤‡ä»½
backup.createBackup(database);
// ç´¢å¼•æ„å»º
lucene.buildIndex(documents);
```

## åˆ¤æ–­æ–¹æ³•

### 1. æ€§èƒ½åˆ†æå·¥å…·åˆ¤æ–­

#### JProfileråˆ†æ
```java
// CPUä½¿ç”¨ç‡åˆ†æ
if (cpuUsage > 80% && ioWaitTime < 20%) {
    // CPUå¯†é›†å‹
} else if (cpuUsage < 50% && ioWaitTime > 60%) {
    // I/Oå¯†é›†å‹
}
```





#### ç³»ç»Ÿç›‘æ§æŒ‡æ ‡
```bash
# Linuxç³»ç»Ÿç›‘æ§
top -p <pid>        # CPUä½¿ç”¨ç‡
iotop -p <pid>      # I/Oä½¿ç”¨ç‡
free -h             # å†…å­˜ä½¿ç”¨æƒ…å†µ
netstat -i          # ç½‘ç»œæµé‡
```

### 2. ä»£ç ç‰¹å¾åˆ¤æ–­

#### I/Oå¯†é›†å‹è¯†åˆ«
```java
public class IOIntensiveDetector {
    
    public boolean isIOIntensive(Method method) {
        // æ£€æŸ¥æ˜¯å¦åŒ…å«I/Oæ“ä½œ
        return containsFileOperation(method) ||
               containsNetworkOperation(method) ||
               containsDatabaseOperation(method) ||
               containsMessageQueueOperation(method);
    }
    
    private boolean containsFileOperation(Method method) {
        // æ£€æŸ¥æ–‡ä»¶æ“ä½œ: Files.*, FileInputStream, etc.
        return scanForClasses(method, "java.nio.file", "java.io");
    }
    
    private boolean containsNetworkOperation(Method method) {
        // æ£€æŸ¥ç½‘ç»œæ“ä½œ: RestTemplate, WebClient, etc.
        return scanForClasses(method, "org.springframework.web.client", 
                             "org.springframework.webflux");
    }
}
```

#### CPUå¯†é›†å‹è¯†åˆ«
```java
public class CPUIntensiveDetector {
    
    public boolean isCPUIntensive(Method method) {
        return containsMathOperation(method) ||
               containsEncryptionOperation(method) ||
               containsCompressionOperation(method) ||
               containsComplexAlgorithm(method);
    }
    
    private boolean containsMathOperation(Method method) {
        // æ£€æŸ¥æ•°å­¦è®¡ç®—: BigInteger, Math.*, å¾ªç¯è®¡ç®—
        return scanForPatterns(method, "BigInteger", "Math\\.", "for\\s*\\(.*\\d+.*\\)");
    }
}
```

### 3. è¿è¡Œæ—¶åŠ¨æ€åˆ¤æ–­

#### æ€§èƒ½æŒ‡æ ‡ç›‘æ§
```java
@Component
public class TaskTypeDetector {
    
    public TaskType detectTaskType(Runnable task) {
        long startTime = System.nanoTime();
        long startCpuTime = getCurrentThreadCpuTime();
        long startMemory = getUsedMemory();
        
        // æ‰§è¡Œä»»åŠ¡
        task.run();
        
        long endTime = System.nanoTime();
        long endCpuTime = getCurrentThreadCpuTime();
        long endMemory = getUsedMemory();
        
        // è®¡ç®—æŒ‡æ ‡
        long totalTime = endTime - startTime;
        long cpuTime = endCpuTime - startCpuTime;
        long memoryUsed = endMemory - startMemory;
        
        double cpuRatio = (double) cpuTime / totalTime;
        double memoryRatio = (double) memoryUsed / (1024 * 1024); // MB
        
        return classifyTask(cpuRatio, memoryRatio, totalTime);
    }
    
    private TaskType classifyTask(double cpuRatio, double memoryRatio, long totalTime) {
        if (cpuRatio > 0.8) {
            return TaskType.CPU_INTENSIVE;
        } else if (cpuRatio < 0.3 && totalTime > 100_000_000) { // 100ms
            return TaskType.IO_INTENSIVE;
        } else if (memoryRatio > 100) { // 100MB
            return TaskType.MEMORY_INTENSIVE;
        } else {
            return TaskType.MIXED;
        }
    }
}
```





### 4. ä¸šåŠ¡åœºæ™¯åˆ¤æ–­è¡¨

| ä¸šåŠ¡åœºæ™¯         | ä»»åŠ¡ç±»å‹        | åˆ¤æ–­ä¾æ®             |
| ---------------- | --------------- | -------------------- |
| **æ•°æ®åº“æŸ¥è¯¢**   | I/Oå¯†é›†å‹       | ç­‰å¾…æ•°æ®åº“å“åº”æ—¶é—´é•¿ |
| **æ–‡ä»¶ä¸Šä¼ ä¸‹è½½** | ç½‘ç»œ+ç£ç›˜å¯†é›†å‹ | ç½‘ç»œä¼ è¾“+ç£ç›˜å†™å…¥    |
| **å›¾åƒå¤„ç†**     | CPU+å†…å­˜å¯†é›†å‹  | åƒç´ è®¡ç®—+å¤§å†…å­˜å ç”¨  |
| **æ—¥å¿—å†™å…¥**     | ç£ç›˜å¯†é›†å‹      | é¢‘ç¹ç£ç›˜å†™æ“ä½œ       |
| **åŠ å¯†è§£å¯†**     | CPUå¯†é›†å‹       | å¤§é‡æ•°å­¦è¿ç®—         |
| **ç¼“å­˜æ“ä½œ**     | å†…å­˜å¯†é›†å‹      | å¤§é‡å†…å­˜è¯»å†™         |
| **APIè°ƒç”¨**      | ç½‘ç»œå¯†é›†å‹      | ç½‘ç»œå»¶è¿Ÿå ä¸»è¦æ—¶é—´   |
| **æ•°æ®åˆ†æ**     | CPU+å†…å­˜å¯†é›†å‹  | å¤æ‚è®¡ç®—+å¤§æ•°æ®é›†    |

## ç»¼åˆåˆ¤æ–­æ¡†æ¶

### è‡ªåŠ¨åŒ–åˆ¤æ–­å·¥å…·
```java
@Service
public class TaskAnalyzer {
    
    public TaskProfile analyzeTask(String taskName, Runnable task) {
        TaskProfile profile = new TaskProfile();
        
        // 1. é™æ€ä»£ç åˆ†æ
        profile.setStaticAnalysis(analyzeCode(task));
        
        // 2. è¿è¡Œæ—¶æ€§èƒ½åˆ†æ
        profile.setRuntimeAnalysis(analyzeRuntime(task));
        
        // 3. èµ„æºä½¿ç”¨åˆ†æ
        profile.setResourceAnalysis(analyzeResource(task));
        
        // 4. ç»¼åˆåˆ¤æ–­
        TaskType finalType = determineTaskType(profile);
        profile.setTaskType(finalType);
        
        return profile;
    }
    
    private TaskType determineTaskType(TaskProfile profile) {
        // æƒé‡è®¡ç®—
        double cpuWeight = profile.getCpuUsage() * 0.4;
        double ioWeight = profile.getIoWaitTime() * 0.3;
        double memoryWeight = profile.getMemoryUsage() * 0.2;
        double networkWeight = profile.getNetworkUsage() * 0.1;
        
        // ç»¼åˆåˆ¤æ–­é€»è¾‘
        if (cpuWeight > 0.6) return TaskType.CPU_INTENSIVE;
        if (ioWeight > 0.5) return TaskType.IO_INTENSIVE;
        if (memoryWeight > 0.4) return TaskType.MEMORY_INTENSIVE;
        if (networkWeight > 0.3) return TaskType.NETWORK_INTENSIVE;
        
        return TaskType.MIXED;
    }
}
```



## é’ˆå¯¹æ€§ä¼˜åŒ–ç­–ç•¥

### ä¸åŒç±»å‹ä»»åŠ¡çš„çº¿ç¨‹æ± é…ç½®
```java
@Configuration
public class TaskTypeThreadPoolConfig {
    
    // I/Oå¯†é›†å‹: å¤§çº¿ç¨‹æ± 
    @Bean("ioExecutor")
    public ThreadPoolTaskExecutor ioExecutor() {
        return createExecutor(100, 200, 1000, "io-");
    }
    
    // CPUå¯†é›†å‹: å°çº¿ç¨‹æ± 
    @Bean("cpuExecutor") 
    public ThreadPoolTaskExecutor cpuExecutor() {
        return createExecutor(25, 48, 100, "cpu-");
    }
    
    // å†…å­˜å¯†é›†å‹: ä¸­ç­‰çº¿ç¨‹æ± +å¤§å †å†…å­˜
    @Bean("memoryExecutor")
    public ThreadPoolTaskExecutor memoryExecutor() {
        return createExecutor(50, 100, 500, "memory-");
    }
    
    // ç½‘ç»œå¯†é›†å‹: å¤§çº¿ç¨‹æ± +è¿æ¥æ± ä¼˜åŒ–
    @Bean("networkExecutor")
    public ThreadPoolTaskExecutor networkExecutor() {
        return createExecutor(80, 160, 800, "network-");
    }
}
```

## æ€»ç»“

**ä»»åŠ¡å¯†é›†å‹åˆ†ç±»**:
1. **I/Oå¯†é›†å‹** - ç­‰å¾…I/Oæ“ä½œ
2. **CPUå¯†é›†å‹** - å¤§é‡è®¡ç®—å¤„ç†
3. **å†…å­˜å¯†é›†å‹** - å¤§é‡å†…å­˜æ“ä½œ
4. **ç½‘ç»œå¯†é›†å‹** - é¢‘ç¹ç½‘ç»œé€šä¿¡
5. **ç£ç›˜å¯†é›†å‹** - é¢‘ç¹ç£ç›˜è¯»å†™

**åˆ¤æ–­æ–¹æ³•**:
- **é™æ€åˆ†æ**: ä»£ç ç‰¹å¾è¯†åˆ«
- **åŠ¨æ€åˆ†æ**: è¿è¡Œæ—¶æ€§èƒ½ç›‘æ§
- **å·¥å…·åˆ†æ**: æ€§èƒ½åˆ†æå·¥å…·
- **ç»éªŒåˆ¤æ–­**: ä¸šåŠ¡åœºæ™¯ç‰¹å¾

**å…³é”®åŸåˆ™**: æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©åˆé€‚çš„çº¿ç¨‹æ± é…ç½®å’Œä¼˜åŒ–ç­–ç•¥ã€‚















