

## é¡¹ç›®

> é¡¹ç›®æ•´ä½“æ¶æ„ & æ¨¡å—äº¤äº’

ä½ çš„é¡¹ç›®æ˜¯ **é‡åŒ–é€‰è‚¡ç³»ç»Ÿ**ï¼Œä»é¢è¯•å®˜è§’åº¦çœ‹ï¼Œéœ€è¦å…ˆå»ºç«‹ä¸€ä¸ªæ¸…æ™°çš„â€œåœ°å›¾â€ï¼š

1. **æ•°æ®é‡‡é›†ä¸å­˜å‚¨æ¨¡å—**
   - **åšä»€ä¹ˆ**ï¼šé‡‡é›†è¡Œæƒ…æ•°æ®ï¼ˆè‚¡ç¥¨Kçº¿ã€å› å­æ•°æ®ï¼‰ï¼Œå­˜åˆ° MySQL + Redisã€‚
   - **äº¤äº’**ï¼šé€šè¿‡ Kafka æ¥æ”¶å¤–éƒ¨æ¨é€çš„è¡Œæƒ… â†’ å¼‚æ­¥å†™å…¥æ•°æ®åº“ â†’ çƒ­æ•°æ®å†™å…¥ Redisï¼Œå†·æ•°æ®è½ MySQLã€‚
2. **å› å­è®¡ç®—æ¨¡å—**
   - **åšä»€ä¹ˆ**ï¼šå¯¹åŸå§‹è¡Œæƒ…æ•°æ®è®¡ç®—æŠ€æœ¯å› å­ã€è´¢åŠ¡å› å­ã€‚
   - **äº¤äº’**ï¼šè®¢é˜… Kafka è¡Œæƒ… â†’ æ‰¹å¤„ç†/æµå¼è®¡ç®— â†’ è®¡ç®—ç»“æœå›å†™ MySQL/Redisã€‚
3. **é€‰è‚¡æ¨¡å—**
   - **åšä»€ä¹ˆ**ï¼šæ ¹æ®ç”¨æˆ·è‡ªå®šä¹‰çš„å› å­ç»„åˆè¿›è¡Œç­›é€‰ã€‚
   - **äº¤äº’**ï¼šè°ƒç”¨å› å­åº“ â†’ æ‰¹é‡ç­›é€‰ â†’ è¿”å›å€™é€‰è‚¡ç¥¨åˆ—è¡¨ã€‚
4. **ç­–ç•¥ä¸å›æµ‹æ¨¡å—**
   - **åšä»€ä¹ˆ**ï¼šåŸºäºå†å²è¡Œæƒ…æ•°æ®å¯¹ç”¨æˆ·ç­–ç•¥è¿›è¡Œå›æµ‹ï¼Œè¾“å‡ºæ”¶ç›Šç‡ã€æœ€å¤§å›æ’¤ç­‰æŒ‡æ ‡ã€‚
   - **äº¤äº’**ï¼šè¯»å–å†å²è¡Œæƒ… + ç­–ç•¥é…ç½® â†’ å›æµ‹å¼•æ“æ‰§è¡Œ â†’ Kafka å†™å…¥æ—¥å¿—/ç»“æœ â†’ Redis ç¼“å­˜ç»“æœ â†’ è¿”å›ç”¨æˆ·ã€‚
5. **é£æ§æ¨¡å—**
   - **åšä»€ä¹ˆ**ï¼šä»“ä½ç®¡ç†ã€æ­¢æŸæ­¢ç›ˆéªŒè¯ã€‚
   - **äº¤äº’**ï¼šå›æµ‹/å®ç›˜ä¸‹å•å‰æ‹¦æˆªç­–ç•¥ â†’ éªŒè¯é£é™©å‚æ•° â†’ Kafka æ¨é€é£æ§æ—¥å¿—ã€‚
6. **å…¬å…± Base æ¨¡å—**
   - **åšä»€ä¹ˆ**ï¼šç»Ÿä¸€çš„å·¥å…·ç±»ã€æƒé™è®¤è¯ã€æ—¥å¿—é‡‡é›†ã€‚
   - **äº¤äº’**ï¼šæ‰€æœ‰æœåŠ¡ä¾èµ– Base æ¨¡å—ã€‚
7. **å¾®æœåŠ¡æ²»ç†**
   - **Nacos**ï¼šæœåŠ¡æ³¨å†Œå‘ç° + é…ç½®ä¸­å¿ƒã€‚
   - **Feign**ï¼šæ¨¡å—é—´çš„æœåŠ¡è°ƒç”¨ã€‚
   - **Sentinel**ï¼šç†”æ–­ã€é™æµã€é™çº§ï¼Œä¿éšœæ ¸å¿ƒé“¾è·¯ã€‚



>æˆ‘åœ¨é‡åŒ–é€‰è‚¡ç³»ç»Ÿé‡Œä¸»è¦è´Ÿè´£æ•°æ®æ¨¡å—å’Œå›æµ‹æ¨¡å—ã€‚
> æ•°æ®æ¨¡å—çš„éš¾ç‚¹æ˜¯è¡Œæƒ…æ•°æ®é‡å¤§ã€æŸ¥è¯¢é¢‘ç¹ï¼Œæˆ‘é€šè¿‡ MySQL+Redis åˆ†å±‚å­˜å‚¨ï¼Œçƒ­ç‚¹æ•°æ®è¿› Redisï¼Œå¹¶å¼•å…¥å¸ƒéš†è¿‡æ»¤å™¨è§£å†³ç¼“å­˜ç©¿é€ï¼ŒåŒæ—¶ç”¨åˆ†å¸ƒå¼é”ä¿è¯ä»»åŠ¡å¹‚ç­‰æ€§ï¼Œæœ€ç»ˆæŸ¥è¯¢æ€§èƒ½æå‡äº†æ•°åå€ã€‚
> åœ¨å›æµ‹æ¨¡å—ä¸­ï¼Œé—®é¢˜æ˜¯å•ç­–ç•¥å›æµ‹è€—æ—¶è¿‡é•¿ï¼Œå½±å“å¹¶å‘ã€‚æˆ‘æŠŠè¡Œæƒ…æ•°æ®é¢„åŠ è½½åˆ°å†…å­˜ï¼Œå‡å°‘ I/Oï¼Œå¹¶é€šè¿‡å¤šçº¿ç¨‹åˆ†ç‰‡è®¡ç®—åŠ å¿«å›æµ‹ï¼Œæœ€ç»ˆç³»ç»Ÿååé‡æå‡ 1.8 å€ï¼Œå»¶è¿Ÿé™ä½ 40%ã€‚
> åŒæ—¶ï¼Œæˆ‘è¿˜é€šè¿‡ Kafka åˆ†åŒºå’Œæ¶ˆè´¹ç»„å¹¶è¡Œå¤„ç†æå‡äº†æ¶ˆæ¯ååï¼Œç”¨ Sentinel åšç†”æ–­é™æµï¼Œé¿å…æµé‡å†²å‡»å¯¼è‡´ç³»ç»Ÿé›ªå´©ã€‚æ•´ä½“æ•ˆæœæ˜¯ç³»ç»Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä»èƒ½ç¨³å®šæ”¯æ’‘åŸæœ‰ååé‡çš„ 1.5 å€ã€‚





ç»è¿‡ä¸€ç³»åˆ—ä¼˜åŒ–åï¼Œæˆ‘ä»¬ç³»ç»Ÿæ•´ä½“ååé‡æå‡äº† **çº¦ 1.8 å€**ï¼Œå•æ¬¡å“åº”å»¶è¿Ÿé™ä½äº† **çº¦ 40%**ã€‚
 ä¸»è¦æ˜¯é€šè¿‡ä»¥ä¸‹æªæ–½å®ç°çš„ï¼š

1. **ç¼“å­˜ä¼˜åŒ–**ï¼šå¼•å…¥ **Redis é›†ç¾¤ä¸å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°ï¼Œé™ä½ IO å‹åŠ›**ã€‚
2. **å‡å°‘èµ„æºæµªè´¹**ï¼šé€šè¿‡**åˆ†å¸ƒå¼é”æ§åˆ¶é‡å¤ç­–ç•¥ä»»åŠ¡æ‰§è¡Œï¼Œå¹¶ä¿è¯ä»»åŠ¡çš„å¹‚ç­‰æ€§**ã€‚
3. **ç¨³å®šæ€§ä¿éšœ**ï¼šç»“åˆ Sentinelï¼Œå®ç°**å¯¹ä¸ç¨³å®šæœåŠ¡çš„ç†”æ–­ã€å¯¹æœ‰é™èµ„æºæ¥å£çš„é™æµ**ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§ã€‚
4. **ç´¢å¼•ä¸è¡¨ç»“æ„ä¼˜åŒ–**ï¼šå¯¹çƒ­ç‚¹è¡¨å»ºç«‹è¦†ç›–ç´¢å¼•ï¼ŒæŒ‰ä¸šåŠ¡åˆ†è¡¨ï¼Œå‡å°‘å…¨è¡¨æ‰«æï¼›**å°†æ ¸å¿ƒæŸ¥è¯¢ä»çº¦ 2.5s ä¼˜åŒ–è‡³çº¦ 60ms**ã€‚
5. **Kafka æ¶ˆæ¯å¤„ç†ä¼˜åŒ–**ï¼š
   1. ç”Ÿäº§ç«¯é‡‡ç”¨**IOå¯†é›†å‹çº¿ç¨‹æ± æ‰¹é‡å¼‚æ­¥**å‘é€ï¼›
   2. æ¶ˆè´¹ç«¯è¿›è¡Œ**å¹¶å‘ä¸åˆ†åŒº**æ¶ˆè´¹ï¼Œé™ä½å¤„ç†å»¶è¿Ÿã€‚
   3. **åœ¨ä¿è¯å¹‚ç­‰ã€ä¸ä¸¢å¤±ã€ä¸ç§¯å‹çš„å‰æä¸‹ï¼Œåˆç†åˆ©ç”¨ Kafka å‰Šå³°å¡«è°·**ï¼Œå¹¶å°†å†å²è¡Œæƒ…ç­‰æ•°æ®è½è¡¨ä»»åŠ¡é”™å³°ï¼ˆå¦‚æ”¶ç›˜åï¼‰æ‰§è¡Œã€‚
6. **å›æµ‹å¼•æ“ä¼˜åŒ–**ï¼šé‡å¤newé¢‘æ¬¡é«˜çš„å¯¹è±¡ï¼Œåœ¨å­—æ®µæ˜ç¡®ã€ç±»å‹ä¸€è‡´çš„æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨æ•°ç»„ï¼Œä¾‹å¦‚å¤šæŒ‡æ ‡idå¯¹è±¡ï¼Œå°‘newå¯¹è±¡ï¼Œå°‘ç”¨åŒ…è£…ç´¯å¤šç”¨åŸºç¡€æ•°æ®ç±»å‹ï¼Œå‡å°‘å †ä¸Šåˆ†é…å†…å­˜æ¬¡æ•°ï¼Œè¿›ä¸€æ­¥é™ä½G1å¹´è½»ä»£GCå¤åˆ¶ç®—æ³•ç­‰æ‰§è¡Œå¼€é”€ï¼Œæé«˜å•ä»»åŠ¡å¤„ç†æ•ˆç‡ã€‚



## ä¼˜åŒ–æ•°å€¼

ç»è¿‡ä¸€ç³»åˆ—ä¼˜åŒ–åï¼Œæˆ‘ä»¬ç³»ç»Ÿæ•´ä½“ååé‡æå‡äº† **çº¦ 1.8 å€**ï¼Œå•æ¬¡å“åº”å»¶è¿Ÿé™ä½äº† **çº¦ 40%**ã€‚
 è¿™æ˜¯é€šè¿‡ä»¥ä¸‹æªæ–½å®ç°çš„ï¼š

1. **ç¼“å­˜ä¼˜åŒ–**ï¼šå¼•å…¥ Redis é›†ç¾¤ä¸å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°ï¼Œé™ä½ IO å‹åŠ›ã€‚
2. **ç´¢å¼•ä¸è¡¨ç»“æ„ä¼˜åŒ–**ï¼šå¯¹çƒ­ç‚¹è¡¨å»ºç«‹è¦†ç›–ç´¢å¼•ï¼ŒæŒ‰ä¸šåŠ¡åˆ†è¡¨ï¼Œå‡å°‘å…¨è¡¨æ‰«æï¼Œå°†æ ¸å¿ƒæŸ¥è¯¢è¯­å¥ä»æœ€å¼€å§‹çš„2.5Såˆ°æœ€åçš„60mså·¦å³ã€‚
3. **Kafka æ¶ˆæ¯å¤„ç†ä¼˜åŒ–**ï¼šé‡‡ç”¨æ‰¹é‡å¼‚æ­¥å‘é€ã€æ¶ˆè´¹ç«¯å¹¶å‘æ¶ˆè´¹ä¸åˆ†åŒºæ¶ˆè´¹ï¼Œå‡å°‘æ¶ˆæ¯å¤„ç†å»¶è¿Ÿã€‚
4. **å›æµ‹å¼•æ“ä¼˜åŒ–**ï¼šå¯¹è±¡æ± åŒ–ã€å‘é‡åŒ–è®¡ç®—ã€å‡å°‘ GC å¼€é”€ï¼Œæé«˜å•ä»»åŠ¡å¤„ç†æ•ˆç‡ã€‚

>ååé‡æå‡ 1.8 å€ï¼š æˆ‘ä»¬é€šè¿‡å‹æµ‹å·¥å…·å¯¹æ ¸å¿ƒä¸šåŠ¡åœºæ™¯è¿›è¡Œå¯¹æ¯”ï¼Œæµ‹é‡ä¼˜åŒ–å‰åçš„ TPSï¼ˆTransactions Per Secondï¼‰ã€‚ä¼˜åŒ–å‰5000ï¼Œä¼˜åŒ–å9000ã€‚80% (1.8 å€)ã€‚ å“åº”å»¶è¿Ÿé™ä½ 40%ï¼š åœ¨å‹æµ‹è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯¹æ ¸å¿ƒæ¥å£ï¼ˆå¦‚è°ƒåº¦ã€æ‰§è¡Œå› å­ç­‰ï¼‰è¿›è¡Œäº†å»¶è¿Ÿç›‘æ§ã€‚ä¼˜åŒ–å‰å¹³å‡å“åº”æ—¶é—´çº¦ 500msï¼Œä¼˜åŒ–åçº¦ 300msï¼Œé™ä½çº¦ 40%ã€‚







## æ•°æ®æµè½¬

> æˆ‘ä»¬çš„å®æ—¶è¡Œæƒ…æ•°æ®æµè½¬ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šæ•°æ®é‡‡é›† â†’ æ¶ˆæ¯æ¨é€ â†’ æ•°æ®æ¶ˆè´¹ä¸è½åº“ã€‚

1. **æ•°æ®é‡‡é›†**
    å®æ—¶è¡Œæƒ…æ•°æ®ç”±è¡Œæƒ…ç½‘å…³ï¼ˆSpeed ç­‰ï¼‰æ¥æ”¶ï¼Œæ•°æ®é‡è¾ƒå¤§ä¸”é¢‘ç¹ï¼Œå±äº **IO å¯†é›†å‹**ã€‚ä¸ºäº†æå‡ååï¼Œæˆ‘ä»¬ä½¿ç”¨ **IO å¯†é›†å‹çº¿ç¨‹æ± **è¿›è¡Œæ‰¹é‡å¤„ç†ï¼Œå°†æ•°æ®æŒ‰æ—¶é—´çª—å£æ•´åˆã€‚
2. **æ¶ˆæ¯æ¨é€**
    æ¯ç§’çº¦ **5400 æ¡è¡Œæƒ…æ•°æ®**ï¼ˆå¹³å‡æ¶ˆæ¯å¤§å°çº¦ 1KBï¼‰è¢«æ‰¹é‡å‘é€ç»™ Kafka é›†ç¾¤ã€‚
   - Kafka ç”Ÿäº§è€…ç«¯ä¼˜åŒ–ï¼š`batch.size`ã€`linger.ms` ç»“åˆä½¿ç”¨ï¼Œå®ç°æ‰¹é‡å‘é€å‡å°‘ç½‘ç»œå¼€é”€ã€‚
   - ç”Ÿäº§è€…å¼‚æ­¥å‘é€ï¼Œä¿è¯é«˜ååã€ä½å»¶è¿Ÿã€‚
   - Kafka è´Ÿè´£é«˜å¯ç”¨å­˜å‚¨ä¸æ¶ˆæ¯æŒä¹…åŒ–ï¼Œæ”¯æŒè®¢é˜…å’Œå›æº¯æ¶ˆè´¹ã€‚
3. **æ•°æ®æ¶ˆè´¹**
   - ç­–ç•¥ã€é£æ§ç­‰ä¸šåŠ¡æ¨¡å—ä½œä¸º Kafka æ¶ˆè´¹è€…å®æ—¶è®¢é˜…è¡Œæƒ…æ•°æ®ï¼Œè¿›è¡Œç­–ç•¥è®¡ç®—ã€é€‰è‚¡å†³ç­–å’Œé£æ§éªŒè¯ã€‚
   - æ¶ˆè´¹æ¨¡å¼é‡‡ç”¨ **å¼‚æ­¥å¹¶å‘æ¶ˆè´¹ + åˆ†åŒºæ¶ˆè´¹**ï¼Œä¿è¯é«˜ååä¸”ä¸å½±å“å®æ—¶æ€§ã€‚
4. **è½åº“å­˜å‚¨**
   - æ¯æ—¥äº¤æ˜“ç»“æŸï¼ˆçº¦ 15:00ï¼‰åï¼Œåå°æ‰¹é‡æ¶ˆè´¹ Kafka å½“å¤©çš„æ•°æ®ï¼Œå°†å…¶è½åº“åˆ° MySQL è¡Œæƒ…è¡¨ä¸­ï¼Œä¾¿äºå†å²æŸ¥è¯¢ä¸å›æµ‹ã€‚
   - å¯¹å†å²æ•°æ®é‡‡ç”¨ **åˆ†è¡¨/åˆ†åŒº**ç­–ç•¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼ŒåŒæ—¶ç»“åˆ Redis ç¼“å­˜æå‡çƒ­ç‚¹æ•°æ®è®¿é—®æ•ˆç‡ã€‚



![ChatGPT Image 2025å¹´9æœˆ27æ—¥ 20_43_33](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202509272043102.png)

| æ•°æ®ç±»å‹                                          | å®æ—¶æ€§è¦æ±‚       | æ•°æ®æµè½¬è·¯å¾„                                                 | è¯´æ˜                                                         |
| ------------------------------------------------- | ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **å®æ—¶è¡Œæƒ…æ•°æ®**ï¼ˆå¦‚é€ç¬” tick æ•°æ®ã€åˆ†ç§’çº§ K çº¿ï¼‰ | é«˜ï¼ˆæ¯«ç§’çº§å»¶è¿Ÿï¼‰ | å¤–éƒ¨è¡Œæƒ…æº â†’ Kafka â†’ ç­–ç•¥æ¨¡å— / Redis ç¼“å­˜ â†’ MySQL æ‰¹é‡è½åº“  | å› ä¸ºå®æ—¶æ€§è¦æ±‚é«˜ï¼Œä¸é€‚åˆç›´æ¥å†™ MySQLï¼Œä¼šé€ æˆå»¶è¿Ÿï¼Œæ‰€ä»¥é€šè¿‡ Kafka è§£è€¦ï¼›ç­–ç•¥ç›´æ¥è®¢é˜… Kafka æµï¼Œæœ€æ–°æ•°æ®æ”¾ Redis æä¾›å¿«é€ŸæŸ¥è¯¢ï¼›å†å²æ•°æ®æ‰¹é‡è½ MySQL |
| **ä½é¢‘è¡Œæƒ…æ•°æ®**ï¼ˆå¦‚æ—¥çº¿ã€å‘¨çº¿ï¼‰                  | ä½               | å¤–éƒ¨è¡Œæƒ…æº â†’ Kafka â†’ MySQLï¼ˆæ‰¹é‡å†™å…¥ï¼‰ â†’ Redisï¼ˆçƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼‰ | è¿™ç§æ•°æ®é‡å°ï¼Œå»¶è¿Ÿè¦æ±‚ä½ï¼Œå¯ä»¥å…ˆè½ MySQLï¼ŒæŸ¥è¯¢æ—¶å†ç¼“å­˜çƒ­ç‚¹æ•°æ®åˆ° Redis |
| **å› å­æ•°æ®**                                      | ä¸­ç­‰             | å¤–éƒ¨è¡Œæƒ…æº / å†å²è¡Œæƒ… â†’ Kafka â†’ å› å­è®¡ç®—æ¨¡å— â†’ MySQL / Redis | å› å­è®¡ç®—éœ€è¦ç»“åˆå†å²æ•°æ®åšæ‰¹å¤„ç†ï¼Œç»“æœå†™åˆ° MySQL åšå­˜å‚¨ï¼Œçƒ­å› å­ç»“æœç¼“å­˜åˆ° Redis |



åœ¨äº¤æ˜“æ—¥äº¤æ˜“æ—¶é—´æ‰¹é‡å†™å…¥ MySQLï¼ŒInnoDB å­˜å‚¨å¼•æ“æ˜¯è¡Œçº§é”ï¼Œä¸ä¼šå®Œå…¨é˜»å¡è¯»å–ï¼Œä½†æ‰¹é‡æ’å…¥ä¼šå ç”¨è¾ƒå¤šçš„ IO å’Œäº‹åŠ¡èµ„æºï¼Œå¯èƒ½å¯¼è‡´è¯»æ€§èƒ½ä¸‹é™ï¼Œç‰¹åˆ«æ˜¯å½“è¡¨æœ‰å¤§é‡ç´¢å¼•æ—¶ã€‚
 å› æ­¤åœ¨äº¤æ˜“æ—¶é—´å»ºè®®é¿å…å¤§æ‰¹é‡å†™å…¥ï¼Œæœ€å¥½åœ¨éäº¤æ˜“æ—¶æ®µæ‰§è¡Œï¼Œæˆ–è€…é€šè¿‡åˆ†åŒºè¡¨ã€å¼‚æ­¥å†™ã€æ‰¹å¤„ç†ç­‰æ–¹å¼å‡å°‘å¯¹çº¿ä¸Šè¯»å–çš„å½±å“ã€‚



## äº®ç‚¹





### MySQLå†å²è¡Œæƒ…è¡¨ä¼˜åŒ–

>åœ¨æˆ‘ä»¬ç³»ç»Ÿçš„å†å²è¡Œæƒ…è¡¨é‡Œï¼Œæœ€åˆå•è¡¨è¶…è¿‡ 1 äº¿æ¡è®°å½•ï¼ŒæŸ¥è¯¢è€—æ—¶åœ¨ **3~4 ç§’**ã€‚
>
>- **ç¬¬ä¸€æ­¥**ï¼Œé€šè¿‡ **æŒ‰æœˆåˆ†è¡¨**ï¼Œå•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨çº¦ 3000 ä¸‡ï¼Œå•è‚¡æŒ‰æœˆæŸ¥è¯¢æ€§èƒ½æå‡åˆ° **200ms** å·¦å³ã€‚
>- **ç¬¬äºŒæ­¥**ï¼Œåœ¨åˆ†è¡¨çš„åŸºç¡€ä¸Šè®¾è®¡ **è”åˆç´¢å¼•ï¼ˆwind_code, trade_dateï¼‰** å¹¶å¢åŠ  **è¦†ç›–ç´¢å¼•**ï¼Œé¿å…å›è¡¨ï¼Œå•è‚¡æŒ‰æœˆæŸ¥è¯¢è¿›ä¸€æ­¥ä¼˜åŒ–åˆ° **60ms**ã€‚
>- **ç¬¬ä¸‰æ­¥ï¼ˆè§„åˆ’ä¸­ï¼‰**ï¼Œé’ˆå¯¹ **çƒ­æ•°æ®å’Œå†·æ•°æ®çš„ä¸åŒè®¿é—®ç‰¹å¾**ï¼Œè€ƒè™‘ä½¿ç”¨ **å†·çƒ­åˆ†ç¦»** ç­–ç•¥ï¼šæœ€è¿‘ä¸‰ä¸ªæœˆæ•°æ®ä¿ç•™åœ¨ MySQL è¡¨ä¸­ï¼Œæ”¯æŒé«˜é¢‘æŸ¥è¯¢ï¼›æ›´æ—©çš„å†å²æ•°æ®è¿ç§»åˆ°æ›´é€‚åˆå­˜å‚¨å¤§è§„æ¨¡æ•°æ®çš„ç³»ç»Ÿï¼ˆå¦‚ **Elasticsearch/ClickHouse/HBase** ç­‰ï¼‰ï¼Œä»¥é™ä½å­˜å‚¨æˆæœ¬ï¼ŒåŒæ—¶è¿˜èƒ½å…¼é¡¾å¤æ‚åˆ†æéœ€æ±‚ã€‚





### åˆ†å¸ƒå¼é”é˜²æ­¢ä»»åŠ¡é‡å¤æ‰§è¡Œé€ æˆèµ„æºä¸åˆç†æ¶ˆè€—







### å¸ƒéš†è¿‡æ»¤å™¨è§£å†³é›ªå´©













## å®è·µ









**Redis + å¸ƒéš†è¿‡æ»¤å™¨é˜²ç¼“å­˜ç©¿é€ Demo**

- æ¨¡æ‹ŸæŸ¥è¯¢è‚¡ç¥¨ä»£ç ï¼Œä¸å­˜åœ¨æ—¶ç›´æ¥æ‹¦æˆªã€‚

**å›æµ‹å¼•æ“å¹¶è¡Œè®¡ç®— Demo**

- ç”¨ Java å¤šçº¿ç¨‹å¯¹ä¸€æ®µå†å²æ•°æ®è®¡ç®—æŒ‡æ ‡ï¼Œå¯¹æ¯”å•çº¿ç¨‹å’Œçº¿ç¨‹æ± ç‰ˆæœ¬çš„è€—æ—¶ã€‚









## kafkaæ¨é€å®æ—¶è¡Œæƒ…æ•°æ®





#### é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±

```yaml
      # æ¶ˆæ¯å¯é æ€§ç›¸å…³
      acks: all                          # ç­‰å¾…æ‰€æœ‰ ISR å‰¯æœ¬ç¡®è®¤ï¼ˆæœ€å®‰å…¨ï¼Œæ¶ˆæ¯ä¸ä¸¢ï¼‰
      retries: 2147483647                # æ— é™é‡è¯•ï¼ˆä¿è¯ leader ä¸´æ—¶æŒ‚æ‰ã€ç½‘ç»œæŠ–åŠ¨æ—¶ä¹Ÿä¸ä¼šä¸¢æ¶ˆæ¯ï¼‰
```





#### ä¿éšœå¹‚ç­‰æ€§

```yaml
      enable-idempotence: true           # å¼€å¯å¹‚ç­‰æ€§ï¼Œé¿å…é‡è¯•æ—¶äº§ç”Ÿé‡å¤æ¶ˆæ¯
      max-in-flight-requests-per-connection: 5  # ä¿è¯å¹‚ç­‰æ€§çš„åŒæ—¶å…è®¸å¹¶å‘ï¼ˆæ¨è 5ï¼‰
```





#### é˜²æ­¢æ¶ˆæ¯ç§¯å‹



##### å¦‚ä½•é…ç½® retention

###### **æ–¹å¼ä¸€ï¼šBroker å…¨å±€é…ç½®**

ç¼–è¾‘ Kafka Broker çš„ `server.properties`ï¼š

```
log.retention.ms=259200000      # ä¿ç•™ 3 å¤©
log.retention.bytes=-1          # ä¸æŒ‰å¤§å°åˆ é™¤
log.cleanup.policy=delete       # åˆ é™¤ç­–ç•¥
```

é‡å¯ Broker ç”Ÿæ•ˆã€‚

###### **æ–¹å¼äºŒï¼šTopic çº§åˆ«é…ç½®**

ç”¨ Kafka ç®¡ç†å‘½ä»¤ï¼ˆæˆ– Admin APIï¼‰å•ç‹¬é…ç½®æŸä¸ª topicï¼š

```
bin/kafka-configs.sh --bootstrap-server localhost:9092 \
  --entity-type topics --entity-name my-topic \
  --alter --add-config retention.ms=259200000
```

è¿™ä¸ªé…ç½®ä¼šè¦†ç›– Broker å…¨å±€é…ç½®ï¼Œåªå¯¹è¯¥ topic ç”Ÿæ•ˆã€‚



###### æ€»ç»“

Kafka retention åªèƒ½åœ¨ Broker æˆ– Topic å±‚é…ç½®ï¼ŒSpring Boot ç”Ÿäº§è€…çš„ yml åªèƒ½é…ç½®ç”Ÿäº§è€…ç›¸å…³å‚æ•°ï¼Œä¸èƒ½è®¾ç½® retentionã€‚



###### ä¿ç•™å¤©æ•°è®¡ç®—

ä¿ç•™14å¤©

> å³ä¾¿ä¿ç•™ 14 å¤©æ˜¯åˆç†çš„ï¼Œä»å»ºè®®ï¼š

- **ç›‘æ§ç£ç›˜å ç”¨**ï¼Œé¿å…ç£ç›˜ç”¨æ»¡å¯¼è‡´ broker åœæ­¢æœåŠ¡ã€‚
- **å®šæœŸè¯„ä¼°æ¶ˆè´¹é€Ÿåº¦**ï¼Œç¡®ä¿æ‰€æœ‰æ¶ˆè´¹ç»„åœ¨ä¿ç•™æ—¶é—´å†…å¤„ç†å®Œæ¶ˆæ¯ã€‚

```
å¯ä¿ç•™å¤©æ•° = å¯ç”¨å­˜å‚¨ / æ—¥å‡æ•°æ®é‡
           = 4,000GB / 200GB
           = 20 å¤©
```

âš¡ æ‰€ä»¥ç†è®ºä¸Šï¼Œ**å¦‚æœä½ ç£ç›˜å¤Ÿå¤§ï¼Œå®Œå…¨å¯ä»¥ä¿ç•™ 20 å¤©ä»¥ä¸Šçš„æ•°æ®**ã€‚





##### æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Producer as ç”Ÿäº§è€…
    participant Broker as Kafka Broker
    participant Consumer as æ¶ˆè´¹è€…

    Producer->>Broker: å†™å…¥æ¶ˆæ¯åˆ° Topic Partition
    Note right of Broker: æ¶ˆæ¯æŒ‰æ—¶é—´é¡ºåºè¿½åŠ åˆ° segment æ–‡ä»¶
    Broker->>Broker: åˆ›å»ºæ–°çš„ segmentï¼ˆè¾¾åˆ° log.segment.bytes/log.segment.msï¼‰
    Consumer->>Broker: æ‹‰å–æ¶ˆæ¯
    Broker->>Consumer: è¿”å›æ¶ˆæ¯
    Note right of Broker: Broker å®šæœŸæ‰§è¡Œ retention æ£€æŸ¥(log.retention.check.interval.ms)
    Broker->>Broker: æ£€æŸ¥æ¯ä¸ª segment æ˜¯å¦è¿‡æœŸï¼ˆlog.retention.ms æˆ– log.retention.bytesï¼‰
    alt segment è¿‡æœŸ
        Broker->>Broker: åˆ é™¤è¯¥ segment æ–‡ä»¶
        Note right of Broker: é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Œé˜²æ­¢æ¶ˆæ¯ç§¯å‹
    else segment æœªè¿‡æœŸ
        Broker->>Broker: ä¿ç•™è¯¥ segment
    end
```

Kafka å¯ä»¥é€šè¿‡ **`log.retention.ms` / `log.retention.bytes`** é…ç½®æ¥æ§åˆ¶åªä¿ç•™å‡ å¤©çš„æ•°æ®ï¼Œä»è€Œé˜²æ­¢æ¶ˆæ¯ç§¯å‹ã€‚åŸç†æ˜¯ Kafka å®šæœŸæ‰«ææ—¥å¿— segmentï¼Œåˆ é™¤è¶…å‡ºä¿ç•™ç­–ç•¥çš„æ–‡ä»¶ï¼Œé‡Šæ”¾ç£ç›˜èµ„æºï¼Œä¿è¯é›†ç¾¤ç¨³å®šè¿è¡Œã€‚











## æ•°æ®åº“



### MySQL



#### è¡Œæƒ…æ•°æ®è¡¨ä¼˜åŒ–

>##### å…¨æµç¨‹è¡¨è¿°ï¼ˆæŠ€æœ¯ã€å¯ä¸Šå°é™ˆè¿°çš„ç‰ˆæœ¬ï¼‰
>
>> ä¸‹é¢æ˜¯æŠŠæˆ‘ä»¬æ•´ä¸ªå¯¹è¯æµ“ç¼©æˆä¸€æ®µå¯ä»¥ç›´æ¥åœ¨é¢è¯•ï¼ˆæˆ–æŠ€æœ¯å¤ç›˜ï¼‰ä¸­è®²çš„ã€**é«˜å¯†åº¦æŠ€æœ¯è¡¨è¿°**ï¼ŒåŒ…å«å…³é”® SQLã€ä¸ºä»€ä¹ˆè¿™ä¹ˆåšã€ä»¥åŠé‡åŒ–æ•ˆæœã€‚æ¡ç†æ¸…æ™°ã€ç›´å¥”ä¸»é¢˜ï¼Œä¾¿äºåœ¨äº¬ä¸œè¿™ç±»å¤§å‚ä¸€å£æ°”è¯´æœé¢è¯•å®˜æˆ–æŠ€æœ¯è¯„å®¡ã€‚
>
>------
>
>###### ä¸€å¥è¯ç»“è®ºï¼ˆå¼€åœºç™½ï¼Œç§’æ€ç”¨ï¼‰
>
>â€œæ¥æ‰‹æ—¶è¯¥è¡Œæƒ…è¡¨å•è¡¨è¶…è¿‡ **1 äº¿** æ¡ï¼Œç»è¿‡**æŒ‰æœˆåˆ†è¡¨ï¼ˆå•è¡¨çº¦ 3,000 ä¸‡ï¼‰+ å»å†—ä½™ç´¢å¼• + å»ºè¦†ç›–ç´¢å¼•** çš„ç»„åˆä¼˜åŒ–ï¼Œå•åªè‚¡ç¥¨æ•´æœˆæŸ¥è¯¢è€—æ—¶ä» **~203ms** é™è‡³ **~60â€“65ms**ï¼ŒæŸ¥è¯¢æ•ˆç‡æå‡çº¦ **3.3Ã—**ï¼ŒåŒæ—¶å‡å°‘äº† I/O å’Œå›è¡¨å¼€é”€ï¼Œå…¼é¡¾äº†çŸ­æœŸæ€§èƒ½å’Œé•¿æœŸå¯æ‰©å±•æ€§ã€‚â€
>
>------
>
>###### è¯¦ç»†æµç¨‹ï¼ˆæŒ‰æˆ‘åœ¨ä¼šè¯ä¸­å®é™…è½åœ°çš„æ­¥éª¤ï¼Œå¸¦æ•°å€¼ä¸ SQLï¼‰
>
>1ï¼‰é—®é¢˜å®šä½ï¼ˆData-drivenï¼‰
>
>- ç°è±¡ï¼šå•è¡¨æŸ¥è¯¢æ…¢ã€IO é«˜ã€å›è¡¨é¢‘ç¹ã€‚
>- æ ¸æŸ¥ï¼šç»Ÿè®¡è¡¨æŒ‰æ—¶é—´åˆ†å¸ƒåå‘ç° **æŒ‰æœˆæ‹†åˆ†èƒ½æŠŠå•è¡¨è§„æ¨¡æ§åˆ¶åœ¨ ~30Mï¼ˆ3åƒä¸‡ï¼‰æ¡**ï¼Œæ¯”åŸå§‹å•è¡¨çº§åˆ«ï¼ˆ>1e8ï¼‰å°å¾ˆå¤šï¼Œé€‚åˆæŒ‰æœˆåˆ†è¡¨ç­–ç•¥ã€‚
>
>------
>
>2ï¼‰æŒ‰æœˆåˆ†è¡¨ï¼ˆå‡å°‘å•è¡¨è§„æ¨¡ï¼‰
>
>- ç›®çš„ï¼šé™ä½å•è¡¨ç´¢å¼•æ·±åº¦ã€å‡å°æ‰«æèŒƒå›´ã€é™ä½é”äº‰ç”¨ã€‚
>- ç¤ºä¾‹å»ºè¡¨ï¼ˆæ¯æœˆä¸€å¼ ï¼‰ï¼š
>
>```
>CREATE TABLE tb_quotation_history_trend_202508 (
>  wind_code VARCHAR(20) NOT NULL,
>  trade_date DATETIME NOT NULL,
>  latest_price DECIMAL(10,4),
>  total_volume DECIMAL(50,5),
>  average_price DECIMAL(10,4),
>  status TINYINT NOT NULL DEFAULT '1',
>  create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
>  update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
>  PRIMARY KEY (wind_code, trade_date)
>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
>```
>
>- ç»“æœï¼šå•è¡¨ä»äº¿çº§é™åˆ°**çº¦ 3,000 ä¸‡**ï¼Œç´¢å¼•æ·±åº¦å’Œç£ç›˜æ‰«æèŒƒå›´æ˜æ˜¾ç¼©å°ã€‚
>
>------
>
>3ï¼‰ç´¢å¼•è¯„ä¼°ä¸å»å†—ä½™
>
>- å‘ç°åŸæ¥åŒæ—¶å­˜åœ¨ï¼š
>  - ä¸»é”® `(wind_code, trade_date)`ï¼ˆæˆ–å€™é€‰è®¾è®¡ä¸­çš„ `UNIQUE (wind_code, trade_date)`ï¼‰
>  - ä»¥åŠå•åˆ—ç´¢å¼• `idx_wind_code(wind_code)`ï¼ˆå†—ä½™ï¼‰
>- æ“ä½œï¼šåˆ é™¤å†—ä½™å•åˆ—ç´¢å¼•ï¼ˆå› ä¸ºä¸»é”®/å”¯ä¸€ç´¢å¼•çš„ç¬¬ä¸€åˆ—å·²æ˜¯ `wind_code`ï¼Œå•åˆ—ç´¢å¼•å¤šä½™ä¸”å¢åŠ å†™å…¥å¼€é”€ï¼‰
>
>```
>ALTER TABLE tb_quotation_history_trend_202508
>DROP INDEX idx_wind_code;
>```
>
>**æ³¨æ„ç‚¹**ï¼šä¸è¦é‡å¤å®šä¹‰ä¸»é”®ï¼ˆä½ ä¹‹å‰æ‰§è¡Œ `ADD PRIMARY KEY` æŠ¥é”™ 1068 æ˜¯å› ä¸ºä¸»é”®å·²ç»å­˜åœ¨ï¼‰ã€‚
>
>------
>
>4ï¼‰å»ºç«‹è¦†ç›–ç´¢å¼•ï¼ˆæ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼‰
>
>- ç›®çš„ï¼šè®©å¸¸è§æŸ¥è¯¢**å®Œå…¨å‘½ä¸­ç´¢å¼•ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰**ï¼Œé¿å…å›è¡¨ï¼Œä»è€Œå¤§é‡é™ä½ I/Oã€‚
>- å»ºè®®ç´¢å¼•ï¼ˆåŒ…å« WHERE æ¡ä»¶åˆ— + SELECT è¿”å›åˆ—ï¼‰ï¼š
>
>```
>ALTER TABLE tb_quotation_history_trend_202508
>ADD INDEX idx_windcode_tradedate_price_volume (
>  wind_code, trade_date, latest_price, total_volume, average_price
>);
>```
>
>- åŸç†ï¼šç´¢å¼•åŒ…å«äº†æŸ¥è¯¢éœ€è¦çš„æ‰€æœ‰å­—æ®µ â†’ MySQL å¯ä»…æ‰«æç´¢å¼•é¡µå³å¯è¿”å›ç»“æœ â†’ **æ— å›è¡¨** â†’ I/O ä¸å»¶è¿Ÿå¤§å¹…ä¸‹é™ã€‚
>
>------
>
>5ï¼‰æ•ˆæœéªŒè¯ï¼ˆé‡åŒ–æ•°æ®ï¼‰
>
>- åœºæ™¯ï¼šæŒ‰å•åªè‚¡ç¥¨ã€ä¸€ä¸ªæ•´æœˆçš„æ•°æ®æŸ¥è¯¢ï¼ˆä¸šåŠ¡æœ€å¸¸è§è·¯å¾„ï¼‰
>- ä¼˜åŒ–å‰ï¼š
>  - è€—æ—¶ï¼š**çº¦ 203 ms**
>  - è¿”å›æ•°æ®å¤§å°ï¼š**641.45 KB**
>- ä¼˜åŒ–åï¼ˆåˆ é™¤å†—ä½™ç´¢å¼• + è¦†ç›–ç´¢å¼•ï¼‰ï¼š
>  - è€—æ—¶ï¼š**çº¦ 60â€“65 ms**
>  - è¿”å›æ•°æ®å¤§å°ï¼š**612.90 KB**
>- æ€§èƒ½æå‡ï¼š**203 / 60 â‰ˆ 3.38Ã—**ï¼ˆçº¦ 3.3 å€ï¼‰ï¼Œå¹¶ä¸”å›è¡¨ç‡æ¥è¿‘ 0ï¼ˆè¦†ç›–ç´¢å¼•å¸¦æ¥çš„ç›´æ¥æ”¶ç›Šï¼‰ã€‚
>
>------
>
>###### å…³é”®æŠ€æœ¯ç‚¹ï¼ˆé¢è¯•å®˜ä¼šè¿½é—®çš„è¦ç‚¹ï¼Œæå‰å‡†å¤‡å¥½å›ç­”ï¼‰
>
>1. **ä¸ºä»€ä¹ˆå›è¡¨ä¼šæ…¢ï¼Ÿ**
>    å›è¡¨æ„å‘³ç€ç´¢å¼•å‘½ä¸­åè¿˜è¦è®¿é—®èšç°‡ç´¢å¼•ï¼ˆæˆ–æ•°æ®é¡µï¼‰è·å–æœªè¢«ç´¢å¼•è¦†ç›–çš„åˆ—ï¼Œå¯¼è‡´é¢å¤–éšæœº I/Oï¼Œæ•°æ®é‡å¤§æ—¶ä»£ä»·æ˜¾è‘—ã€‚
>2. **ä¸ºä»€ä¹ˆè¦åˆ é™¤ `idx_wind_code`ï¼Ÿ**
>    ä¸»é”®ï¼ˆæˆ–å”¯ä¸€ç´¢å¼•ï¼‰çš„é¦–åˆ—å·²æ˜¯ `wind_code`ï¼Œå•åˆ—ç´¢å¼•å†—ä½™ï¼Œåªä¼šå¢åŠ å†™æˆæœ¬å’Œç´¢å¼•ç»´æŠ¤å¼€é”€ï¼Œæ²¡æœ‰æ”¶ç›Šã€‚
>3. **ä¸»é”®é€‰æ‹©ï¼šè”åˆä¸»é”® vs è‡ªå¢ IDï¼Ÿ**
>   - å¦‚æœ**è¯»ä¸ºä¸»ã€æŸ¥è¯¢ä»¥ (wind_code, trade_date) ä¸ºæ ¸å¿ƒ**ï¼Œè”åˆä¸»é”® `(wind_code, trade_date)` æ€§èƒ½æ›´ä¼˜ï¼ˆç›´æ¥èŒƒå›´æ‰«æï¼Œæ— éœ€è¾…åŠ©ç´¢å¼•å›è¡¨ï¼‰ã€‚
>   - å¦‚æœ**å†™å…¥éå¸¸å¯†é›†**ï¼ˆé«˜å¹¶å‘æ’å…¥ï¼‰ä¸”å…³æ³¨æ’å…¥é¡ºåº/æ€§èƒ½ï¼Œè‡ªå¢ `id`ï¼ˆé¡ºåºå†™ï¼‰æ›´å¥½ï¼Œå¹¶ä¸”ç”¨ `UNIQUE (wind_code, trade_date)` + è¦†ç›–ç´¢å¼•è¡¥å¿æŸ¥è¯¢æ€§èƒ½ã€‚ä¸¤è€…æ˜¯è¯»å†™æƒè¡¡çš„æŠ˜ä¸­é€‰æ‹©ã€‚
>4. **ä¸ºä»€ä¹ˆåœ¨æˆ‘çš„å®éªŒé‡Œè¦†ç›–ç´¢å¼•å¸¦æ¥äº†è¿™ä¹ˆå¤§æå‡ï¼Ÿ**
>    å› ä¸ºæŸ¥è¯¢æ‰€éœ€å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ï¼Œæ¶ˆé™¤äº†å›è¡¨ä¸éšæœº I/Oï¼Œç´¢å¼•é¡µæ›´å°ã€ç¼“å­˜å‹å¥½ï¼Œå°¤å…¶åœ¨å•è‚¡ç¥¨æ—¶é—´èŒƒå›´æ‰«æåœºæ™¯æ”¶ç›Šæ˜æ˜¾ã€‚
>
>------
>
>###### æœ€ç»ˆæ¨èï¼ˆå·¥ç¨‹çº§è½åœ°æ–¹æ¡ˆï¼‰
>
>- è‹¥**è¯»ä¸ºä¸»**ï¼ˆè¡Œæƒ…å†å²æŸ¥è¯¢é¢‘ç¹ï¼‰ï¼š
>   ç”¨ **PRIMARY KEY (wind_code, trade_date)** + è¦†ç›–ç´¢å¼• `(wind_code, trade_date, latest_price, total_volume, average_price)`ã€‚å»æ‰ `idx_wind_code`ã€‚æŒ‰æœˆåˆ†è¡¨ + å¯é€‰åˆ†åŒºã€‚
>- è‹¥**å†™å…¥éå¸¸é«˜**ï¼ˆéœ€ä¼˜å…ˆå†™æ€§èƒ½ï¼‰ï¼š
>   ä½¿ç”¨ `id BIGINT AUTO_INCREMENT PRIMARY KEY`ï¼ŒåŒæ—¶åˆ›å»º `UNIQUE (wind_code, trade_date)` ä¸è¦†ç›–ç´¢å¼• `INDEX (wind_code, trade_date, ...)`ï¼Œä»¥å…¼é¡¾æ’å…¥ååå’ŒæŸ¥è¯¢æ•ˆç‡ã€‚
>- é•¿æœŸæ–¹æ¡ˆï¼ˆå¯é€‰ä¸”æ¨èï¼‰ï¼š
>  - çƒ­æ•°æ®ï¼ˆè¿‘ä¸€ä¸ªæœˆï¼‰ä¿ç•™ MySQLï¼Œå†·æ•°æ®å½’æ¡£åˆ° OLAPï¼ˆClickHouse/Parquetï¼‰ä»¥é™ä½æˆæœ¬ä¸æå‡å¤æ‚åˆ†ææ•ˆç‡ã€‚
>  - åœ¨æœˆè¡¨å†…æ ¹æ®éœ€è¦åš**å­åˆ†åŒº**ï¼ˆæŒ‰å¤©æˆ–æŒ‰æ—¶é—´åŒºé—´ï¼‰ä»¥æ›´ç»†ç²’åº¦æ§åˆ¶æ‰«æèŒƒå›´ã€‚
>  - æŒç»­ç”¨ `EXPLAIN` + `slow_query_log` + `performance_schema` éªŒè¯ç´¢å¼•å‘½ä¸­ä¸å›è¡¨æƒ…å†µã€‚
>
>------
>
>###### å¯ç›´æ¥ç”¨äºé¢è¯•çš„ä¸€æ®µâ€œæ ‡å‡†è¡¨è¿°â€ï¼ˆ30â€“40sï¼‰
>
>> â€œæ¥æ‰‹æ—¶è¯¥è¡¨å•è¡¨è¶…è¿‡ä¸€äº¿æ¡ï¼ŒæŒ‰ä½¿ç”¨ç»Ÿè®¡æŒ‰æœˆæ‹†è¡¨å¯ä»¥æŠŠæ¯å¼ è¡¨æ§åˆ¶åœ¨çº¦ **3,000 ä¸‡** æ¡ã€‚åŸè¡¨å­˜åœ¨å†—ä½™å•åˆ—ç´¢å¼•ä¸”æŸ¥è¯¢ä»¥ `(wind_code, trade_date)` ä¸ºä¸»ï¼Œæˆ‘å»æ‰äº†å†—ä½™ `idx_wind_code` å¹¶æ–°å¢è¦†ç›–ç´¢å¼• `(wind_code, trade_date, latest_price, total_volume, average_price)`ï¼Œä½¿å¸¸è§æŸ¥è¯¢å®Œå…¨èµ°ç´¢å¼•ã€é¿å…å›è¡¨ã€‚ç»“æœå•åªè‚¡ç¥¨æ•´æœˆæŸ¥è¯¢è€—æ—¶ä» **~203ms** é™åˆ° **~60â€“65ms**ï¼ˆçº¦ **3.3Ã—** æå‡ï¼‰ï¼ŒåŒæ—¶æ˜¾è‘—é™ä½äº† IO å’Œå›è¡¨å¼€é”€ï¼Œå…¼é¡¾äº†æ€§èƒ½ä¸é•¿æœŸæ‰©å±•æ€§ã€‚â€



å¥½çš„ï¼Œå°æ ğŸ˜„ï¼Œè¿™æ˜¯ä½ è¦æ±‚çš„ **Mermaid æ ¼å¼çš„æŒ‰æœˆåˆ†è¡¨ + è¦†ç›–ç´¢å¼•ä¼˜åŒ–æµç¨‹å›¾**ï¼š

```mermaid
graph TD
    A[æ•°æ®åˆ†æ] --> B[æŒ‰æœˆåˆ†è¡¨]
    B --> C[ç´¢å¼•ä¼˜åŒ–]
    C --> D[æŸ¥è¯¢æ€§èƒ½æå‡]
    D --> E[é«˜çº§ä¼˜åŒ–]
    E --> F[é¢è¯•äº®ç‚¹]

    A -->|å‘ç°å•è¡¨ > 1äº¿æ¡ æŒ‰æœˆçº¦ 3000ä¸‡æ¡| B
    B -->|å‡å°‘å•è¡¨æ•°æ®é‡ é™ä½é”ç«äº‰å’ŒIOå‹åŠ›| C
    C -->|è¦†ç›–ç´¢å¼•+åˆ é™¤å†—ä½™ç´¢å¼•,å‡å°‘å›è¡¨,æå‡æŸ¥è¯¢| D
    D -->|å†·çƒ­æ•°æ®åˆ†ç¦»+åˆ†åŒºè¡¨| E
    E -->|å½¢æˆé«˜å«é‡‘é‡ä¼˜åŒ–æ¡ˆä¾‹| F
```

è¿™ä¸ªå›¾æ¸…æ™°å±•ç¤ºäº†æ•´ä¸ªä¼˜åŒ–è¿‡ç¨‹çš„**é€»è¾‘æµ**ï¼š

> æ•°æ®åˆ†æ â†’ æŒ‰æœˆåˆ†è¡¨ â†’ ç´¢å¼•ä¼˜åŒ– â†’ æŸ¥è¯¢æ€§èƒ½æå‡ â†’ é«˜çº§ä¼˜åŒ– â†’ é¢è¯•äº®ç‚¹





- åœ¨æˆ‘æ¥æ‰‹è¯¥é¡¹ç›®æ—¶ï¼Œå‘ç°åŒäº‹å­˜å‚¨çš„è¡Œæƒ…æ•°æ®å•è¡¨å·²ç»ä¸Šäº¿æ¡ï¼Œè™½ç„¶æœ‰ç´¢å¼•ä¼˜åŒ–ï¼Œä½†æŸ¥è¯¢æ•ˆç‡ä»ä¸ç†æƒ³ã€‚

- æˆ‘é¦–å…ˆå¯¹è¡¨çš„å†å²æ•°æ®é‡è¿›è¡Œäº†ç»Ÿè®¡ï¼Œå‘ç°æŒ‰æœˆåˆ’åˆ†å¯ä»¥å°†å•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨çº¦ 3000 ä¸‡æ¡å·¦å³ï¼Œè¿™æ ·æœ‰åŠ©äºç¼©çŸ­ç´¢å¼•æŸ¥æ‰¾æ·±åº¦å¹¶é™ä½å•è¡¨ IO å‹åŠ›ã€‚

- åŸºäºä¸šåŠ¡ä¸Šå¤§éƒ¨åˆ†æŸ¥è¯¢éƒ½æ˜¯å•è‚¡ç¥¨ä»£ç  + æ—¶é—´èŒƒå›´çš„æ¨¡å¼ï¼Œæˆ‘å°†åŸå…ˆå•è‚¡ç¥¨ä»£ç ç´¢å¼•æ”¹æˆäº† `(wind_code, trade_date)` çš„è”åˆç´¢å¼•ï¼Œè¿™æ ·æŸ¥è¯¢ä¸ä»…èƒ½åˆ©ç”¨ç´¢å¼•èŒƒå›´æ‰«æï¼Œè¿˜èƒ½å®ç°è¦†ç›–ç´¢å¼•ï¼Œé¿å…å›è¡¨ï¼Œä»è€Œæ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

  



| ä¼˜åŒ–å‰                              | ä¼˜åŒ–å                              |
| ----------------------------------- | ----------------------------------- |
| æŸ¥è¯¢å•è‚¡ç¥¨è¿‘ 3 ä¸ªæœˆæ•°æ®è€—æ—¶ï¼š2.5 ç§’ | æŸ¥è¯¢å•è‚¡ç¥¨è¿‘ 3 ä¸ªæœˆæ•°æ®è€—æ—¶ï¼š0.2 ç§’ |
| å•è¡¨æ•°æ®é‡ï¼š1.2 äº¿æ¡                | åˆ†è¡¨åå•è¡¨æ•°æ®é‡ï¼š~3000 ä¸‡æ¡        |
| å›è¡¨ç‡ï¼š60%+                        | å›è¡¨ç‡ï¼š0%ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰              |





>ä¼˜åŒ–å‰å•è‚¡ç¥¨æ•´æœˆæ•°æ®æŸ¥è¯¢**203ms**å·¦å³ï¼Œå¤§å°**641.45 KB**

```sql
ALTER TABLE tb_quotation_history_trend_202508
DROP INDEX idx_wind_code,
ADD INDEX idx_windcode_tradedate_price_volume (wind_code, trade_date, latest_price, total_volume, average_price);
```



>ä¼˜åŒ–åèƒ½è¾¾åˆ°**60ms**å·¦å³ï¼Œ**612.90 KB**



| é¡¹ç›®                       | ä¼˜åŒ–å‰    | ä¼˜åŒ–å             |
| -------------------------- | --------- | ------------------ |
| **å•è‚¡ç¥¨æ•´æœˆæ•°æ®æŸ¥è¯¢è€—æ—¶** | 203ms     | 60ms               |
| **æŸ¥è¯¢æ•°æ®å¤§å°**           | 641.45 KB | 612.90 KB          |
| **æŸ¥è¯¢æ•ˆç‡æå‡**           | åŸºçº¿      | **çº¦æå‡ 3.38 å€** |







##### è¶‹äºå®Œç¾ç‰ˆ

```sql
CREATE TABLE tb_quotation_history (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'è‡ªå¢ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æ¯æ¡è¡Œæƒ…è®°å½•',
    wind_code VARCHAR(20) NOT NULL COMMENT 'è‚¡ç¥¨ä»£ç ï¼Œå”¯ä¸€æ ‡è¯†ä¸€åªè‚¡ç¥¨',
    trade_date DATETIME NOT NULL COMMENT 'äº¤æ˜“æ—¶é—´ï¼Œç²¾ç¡®åˆ°ç§’',
    latest_price DECIMAL(10,4) DEFAULT NULL COMMENT 'æœ€æ–°ä»·æ ¼',
    total_volume DECIMAL(50,5) DEFAULT NULL COMMENT 'æ€»æˆäº¤é‡',
    average_price DECIMAL(10,4) DEFAULT NULL COMMENT 'å‡ä»·',
    status TINYINT NOT NULL DEFAULT '1' COMMENT 'æ•°æ®çŠ¶æ€ï¼š0.æ— æ•ˆ, 1.æœ‰æ•ˆ(é»˜è®¤)',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'è®°å½•åˆ›å»ºæ—¶é—´',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'è®°å½•æ›´æ–°æ—¶é—´',
    UNIQUE KEY uniq_windcode_tradedate (wind_code, trade_date) COMMENT 'è”åˆå”¯ä¸€ç´¢å¼•ï¼Œä¿è¯åŒä¸€è‚¡ç¥¨åŒä¸€äº¤æ˜“æ—¶é—´å”¯ä¸€',
    INDEX idx_windcode_tradedate_price (wind_code, trade_date, latest_price, total_volume, average_price) 
        COMMENT 'è¦†ç›–ç´¢å¼•ï¼ŒåŠ é€Ÿå•è‚¡ç¥¨æ—¶é—´èŒƒå›´æŸ¥è¯¢å¹¶é¿å…å›è¡¨'
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='è¡Œæƒ…å†å²æ•°æ®è¡¨ï¼ŒæŒ‰è‚¡ç¥¨ä»£ç å’Œæ—¶é—´æŸ¥è¯¢ä¸ºä¸»';
```





##### ä»€ä¹ˆæ˜¯å›è¡¨ï¼Ÿ



å¥½ï¼Œå°æ ğŸ˜„ï¼Œæˆ‘å¸®ä½ è¯¦ç»†è®²ä¸€ä¸‹ **â€œå›è¡¨â€** çš„å«ä¹‰ï¼Œä»¥åŠä¸ºä»€ä¹ˆä½ çš„ä¼˜åŒ–èƒ½å‡å°‘å®ƒã€‚

------

###### **1. ä»€ä¹ˆæ˜¯å›è¡¨**

å›è¡¨æ˜¯ **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–æœ¯è¯­**ï¼ŒæŒ‡çš„æ˜¯ï¼š
 å½“ MySQL ä½¿ç”¨ç´¢å¼•ï¼ˆå°¤å…¶æ˜¯éè¦†ç›–ç´¢å¼•ï¼‰æŸ¥æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç´¢å¼•æ¡ç›®åï¼Œä¸ºäº†è·å–å…¶å®ƒä¸åœ¨ç´¢å¼•ä¸­çš„åˆ—æ•°æ®ï¼Œéœ€è¦ **å†æ¬¡å›åˆ°æ•°æ®è¡¨ä¸­å»è¯»å–å®Œæ•´è¡Œ**ã€‚

æ¢å¥è¯è¯´ï¼š

- **ç´¢å¼•å­˜å‚¨çš„æ•°æ®**ï¼šåªåŒ…å«ç´¢å¼•åˆ— + ä¸»é”®åˆ—ã€‚
- å¦‚æœæŸ¥è¯¢çš„å­—æ®µä¸åœ¨ç´¢å¼•é‡Œï¼ŒMySQL å¿…é¡»å›åˆ°è¡¨ä¸­æŸ¥æ‰¾å®Œæ•´æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯â€œå›è¡¨â€ã€‚

å›è¡¨ä¼šå¸¦æ¥é¢å¤–çš„ **I/O å¼€é”€**ï¼Œå°¤å…¶æ˜¯å¤§æ•°æ®é‡æ—¶ï¼Œä¼šæ˜¾è‘—å¢åŠ æŸ¥è¯¢å»¶è¿Ÿã€‚

------

###### ä¸¾ä¾‹

å‡è®¾æœ‰è¡¨ï¼š

```sql
CREATE TABLE tb_example (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    age INT,
    city VARCHAR(50),
    INDEX idx_name(name)
);
```

æŸ¥è¯¢ï¼š

```sql
SELECT name, city FROM tb_example WHERE name = 'å°æ';
```

æ‰§è¡Œè¿‡ç¨‹ï¼š

1. MySQL ç”¨ç´¢å¼• `idx_name(name)` æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ `id`ã€‚
2. å†ç”¨ `id` å›åˆ°æ•°æ®è¡¨å»å– `city`ï¼ˆå›è¡¨è¿‡ç¨‹ï¼‰ã€‚

------

###### **2. ä¸ºä»€ä¹ˆä½ çš„ä¼˜åŒ–å‡å°‘äº†å›è¡¨**

ä½ çš„ä¼˜åŒ–åšäº†ä¸¤ä»¶å…³é”®çš„äº‹æƒ…ï¼š

**â‘  åˆ é™¤å†—ä½™ç´¢å¼•**

åŸæ¥çš„å•åˆ—ç´¢å¼• `idx_wind_code(wind_code)` å¹¶ä¸èƒ½è¦†ç›–ä¸šåŠ¡æŸ¥è¯¢å­—æ®µï¼ŒæŸ¥è¯¢æ—¶éœ€è¦å›è¡¨å–æ•°æ®ï¼Œå¯¼è‡´é¢å¤–çš„ I/Oã€‚åˆ é™¤å†—ä½™ç´¢å¼•å‡å°‘äº†ä¸å¿…è¦çš„ç´¢å¼•ç»´æŠ¤ï¼ŒåŒæ—¶èšç„¦äºçœŸæ­£èƒ½è¦†ç›–ä¸šåŠ¡çš„ç´¢å¼•ã€‚

**â‘¡ æ–°å¢è¦†ç›–ç´¢å¼•**

```sql
ADD INDEX idx_windcode_tradedate_price_volume (
    wind_code, trade_date, latest_price, total_volume, average_price
);
```

è¿™ä¸ªè¦†ç›–ç´¢å¼•åŒ…å«äº†ä½ æŸ¥è¯¢æ‰€éœ€çš„ **æ‰€æœ‰å­—æ®µ**ã€‚
 è¦†ç›–ç´¢å¼•çš„ç‰¹ç‚¹æ˜¯ï¼š**æ‰€æœ‰æŸ¥è¯¢å­—æ®µéƒ½èƒ½ç›´æ¥ä»ç´¢å¼•ä¸­è·å–ï¼Œæ— éœ€å›è¡¨**ã€‚

ä¾‹å¦‚ï¼š

```sql
SELECT latest_price, total_volume, average_price
FROM tb_quotation_history_trend_202508
WHERE wind_code = '000001.SZ'
  AND trade_date BETWEEN '2025-09-01' AND '2025-09-30';
```

å› ä¸º `wind_code, trade_date, latest_price, total_volume, average_price` éƒ½åŒ…å«åœ¨ç´¢å¼•é‡Œï¼ŒMySQL èƒ½ç›´æ¥åœ¨ç´¢å¼•ä¸­è¿”å›ç»“æœï¼Œå®Œå…¨é¿å…å›è¡¨ã€‚

------

###### **3. å›è¡¨ vs è¦†ç›–ç´¢å¼•çš„å¯¹æ¯”**

| ç‰¹æ€§     | å›è¡¨æŸ¥è¯¢                 | è¦†ç›–ç´¢å¼•æŸ¥è¯¢             |
| -------- | ------------------------ | ------------------------ |
| I/O æ¶ˆè€— | é«˜                       | ä½                       |
| æŸ¥è¯¢å»¶è¿Ÿ | è¾ƒé«˜                     | è¾ƒä½                     |
| é€‚ç”¨åœºæ™¯ | æŸ¥è¯¢å­—æ®µä¸å®Œå…¨åŒ…å«åœ¨ç´¢å¼• | æŸ¥è¯¢å­—æ®µå·²å…¨éƒ¨åŒ…å«åœ¨ç´¢å¼• |
| ç´¢å¼•å¤§å° | å°                       | å¤§                       |

------

###### ğŸ” ä½ çš„ä¼˜åŒ–æ•ˆæœï¼š

- åˆ é™¤å†—ä½™å•åˆ—ç´¢å¼• â†’ é¿å…æ— ç”¨ç´¢å¼•æ‰«æ
- æ–°å»ºè¦†ç›–ç´¢å¼• â†’ æŸ¥è¯¢ç›´æ¥èµ°ç´¢å¼•ï¼Œå®Œå…¨å…å›è¡¨
- ç»“æœ â†’ æŸ¥è¯¢è€—æ—¶ä» **203ms â†’ 60ms**ï¼Œæå‡çº¦ **3.4 å€**







##### ä»€ä¹ˆç”¨è‚¡ç¥¨ä»£ç +æ—¶é—´æˆ³ä½œä¸ºè”åˆä¸»é”®ï¼Œä¼šæ¯”ç”¨å®ƒä½œä¸ºè”åˆç´¢å¼•ï¼Œè‡ªå¢idä½œä¸ºä¸»é”®çš„æ€§èƒ½æŸ¥å‘¢ï¼Ÿ



> ä½¿ç”¨ **è‚¡ç¥¨ä»£ç  + æ—¶é—´æˆ³ä½œä¸ºè”åˆä¸»é”®** ä¼šæ¯” **è‡ªå¢ ID + è”åˆç´¢å¼•** æ€§èƒ½æ›´å¥½ï¼Œä¸»è¦åŸå› æ˜¯ï¼š

1. **ç›´æ¥åŒ¹é…æŸ¥è¯¢æ¡ä»¶**
   - ä½ çš„ä¸šåŠ¡æŸ¥è¯¢å‡ ä¹éƒ½æ˜¯æŒ‰ `(wind_code, trade_date)` è¿‡æ»¤çš„ã€‚
   - è”åˆä¸»é”®æœ¬èº«å°±æ˜¯æŒ‰è¿™ä¸¤ä¸ªå­—æ®µç»„ç»‡çš„ï¼ŒæŸ¥è¯¢æ—¶å¯ç›´æ¥ç”¨ä¸»é”®èŒƒå›´æ‰«æï¼Œæ— éœ€é¢å¤–ç´¢å¼•æŸ¥æ‰¾ã€‚
2. **é¿å…é¢å¤–ç´¢å¼•å›è¡¨**
   - å¦‚æœç”¨è‡ªå¢ ID ä½œä¸ºä¸»é”®ï¼ŒæŸ¥è¯¢ `(wind_code, trade_date)` å¿…é¡»èµ°è¾…åŠ©ç´¢å¼•ï¼Œå†å›è¡¨å–æ•°æ®ã€‚
   - è”åˆä¸»é”®æŸ¥è¯¢å¯ç›´æ¥æ‰¾åˆ°æ•°æ®è¡Œï¼Œå‡å°‘ä¸€æ¬¡å›è¡¨æ“ä½œï¼Œé™ä½ I/Oã€‚
3. **å”¯ä¸€æ€§ä¸è¦†ç›–æ€§**
   - `(wind_code, trade_date)` è”åˆä¸»é”®å¤©ç„¶ä¿è¯å”¯ä¸€æ€§ï¼Œç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼ˆè¡Œæƒ…æ•°æ®å”¯ä¸€æ€§ï¼‰ï¼Œä¸”æ— éœ€é¢å¤–å”¯ä¸€ç´¢å¼•ã€‚

âœ… **ç»“è®º**ï¼šåœ¨ **è¯»å¤šå†™å°‘ã€ä¸”æŸ¥è¯¢ä»¥è¿™ä¸¤ä¸ªå­—æ®µä¸ºæ ¸å¿ƒ** çš„åœºæ™¯ä¸‹ï¼Œè”åˆä¸»é”®æ€§èƒ½ä¼˜äºè‡ªå¢ä¸»é”® + è”åˆç´¢å¼•ã€‚





##### ä¸ºä»€ä¹ˆä¼šåœ¨å®Œç¾ç‰ˆé‡ŒåŠ  **è‡ªå¢ä¸»é”® `id`**ï¼Œå°½ç®¡å‰é¢æˆ‘ä»¬è®¨è®ºè¿‡ **è”åˆä¸»é”® `(wind_code, trade_date)`** æ€§èƒ½æ›´ä¼˜ã€‚

```mermaid
graph LR
    A[è”åˆä¸»é”® wind_code, trade_date]
    B[è‡ªå¢ä¸»é”® id + å”¯ä¸€ç´¢å¼• wind_code, trade_date ]

    A --> A1[å†™å…¥: éšæœºå†™,é¡µåˆ†è£‚è¾ƒå¤š,æ’å…¥æ€§èƒ½è¾ƒä½]
    A --> A2[æŸ¥è¯¢: é«˜æ•ˆ,ç›´æ¥èŒƒå›´æ‰«æ,æ— å›è¡¨]
    A --> A3[å”¯ä¸€æ€§: å¤©ç„¶ä¿è¯,ç¬¦åˆä¸šåŠ¡é€»è¾‘]
    A --> A4[æ‰©å±•æ€§: è¾ƒå·®,ä¿®æ”¹ä¸»é”®å¤æ‚]

    B --> B1[å†™å…¥: é¡ºåºå†™,æ’å…¥æ€§èƒ½é«˜]
    B --> B2[æŸ¥è¯¢: éœ€è¦èµ°è¾…åŠ©ç´¢å¼•,å¯èƒ½æœ‰å›è¡¨]
    B --> B3[å”¯ä¸€æ€§: éœ€è¦é¢å¤–å”¯ä¸€ç´¢å¼•ä¿è¯]
    B --> B4[æ‰©å±•æ€§: çµæ´»,å…¼å®¹æ€§å¥½]
```



è¿™å…¶å®æ˜¯**ä¸€ç§æŠ˜ä¸­çš„æ¶æ„è®¾è®¡**ï¼Œä¸ºäº†å…¼é¡¾ä¸åŒåœºæ™¯ä¸‹çš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

------

###### **åŸå› **

1. å†™å…¥æ€§èƒ½ä¼˜åŒ–

- è”åˆä¸»é”® `(wind_code, trade_date)` ä¼šå¯¼è‡´ **æ’å…¥æ—¶éšæœºå†™**ï¼ˆå°¤å…¶æ•°æ®ä¸æ˜¯ä¸¥æ ¼æŒ‰æ—¶é—´é¡ºåºæ’å…¥ï¼‰ï¼Œåœ¨ InnoDB èšç°‡ç´¢å¼•é‡Œä¼šå¼•å‘é¡µåˆ†è£‚ï¼Œé™ä½æ’å…¥é€Ÿåº¦ã€‚
- è‡ªå¢ä¸»é”®æ˜¯é¡ºåºå†™ï¼Œæ’å…¥é€Ÿåº¦æœ€å¿«ï¼Œå°¤å…¶é€‚åˆé«˜å¹¶å‘ã€å¤§é‡å†™å…¥çš„åœºæ™¯ã€‚

2. çµæ´»æ€§ä¸æ‰©å±•æ€§

- è‡ªå¢ä¸»é”®æä¾›äº†ç»Ÿä¸€çš„å”¯ä¸€æ ‡è¯†ï¼Œæ–¹ä¾¿åç»­åš **å…¨è¡¨æ“ä½œã€åˆ†å¸ƒå¼æ•°æ®åº“ã€æ•°æ®è¿ç§»** ç­‰ã€‚
- å¦‚æœä»¥åéœ€è¦åŠ å­—æ®µæˆ–è€…è°ƒæ•´ä¸»é”®ï¼Œä½¿ç”¨è‡ªå¢ä¸»é”®ä¼šæ›´çµæ´»ï¼Œæ”¹åŠ¨æˆæœ¬ä½ã€‚

3. å…¼å®¹æ€§

- å¾ˆå¤šä¸­é—´ä»¶ã€ORM æ¡†æ¶ä»¥åŠåˆ†å¸ƒå¼ç³»ç»Ÿå¯¹è‡ªå¢ä¸»é”®çš„æ”¯æŒæ›´å‹å¥½ã€‚
- è‡ªå¢ä¸»é”®ä½œä¸ºå•åˆ—ä¸»é”®ï¼Œå¯¹ç´¢å¼•ç»“æ„å’Œå­˜å‚¨æ›´åŠ ç¨³å®šã€‚

4. æŸ¥è¯¢æ€§èƒ½å¯è¡¥å¿

- å³ä¾¿ç”¨è‡ªå¢ä¸»é”®ï¼Œä¾ç„¶å¯ä»¥åŠ  **å”¯ä¸€ç´¢å¼• `(wind_code, trade_date)`** + **è¦†ç›–ç´¢å¼•**ï¼Œè¿™æ ·æŸ¥è¯¢æ€§èƒ½å‡ ä¹æ¥è¿‘è”åˆä¸»é”®æ–¹æ¡ˆï¼ŒåŒæ—¶å†™å…¥æ€§èƒ½æ›´å¥½ã€‚

------

###### **ç»“è®º**

- å¦‚æœä½ çš„åœºæ™¯ **è¯»å¤šå†™å°‘**ï¼Œä¸”æŸ¥è¯¢ä¸»è¦é›†ä¸­åœ¨ `(wind_code, trade_date)` â†’ **è”åˆä¸»é”®æ›´ä¼˜**ã€‚
- å¦‚æœä½ çš„åœºæ™¯ **å†™å…¥é‡å¤§ã€å¹¶å‘é«˜ï¼Œä¸”æœ‰é•¿æœŸæ‰©å±•éœ€æ±‚** â†’ **è‡ªå¢ä¸»é”® + å”¯ä¸€ç´¢å¼•** æ˜¯æ›´ç¨³å¥çš„é€‰æ‹©ã€‚

æ‰€ä»¥æˆ‘ç»™ä½ çš„â€œå®Œç¾ç‰ˆâ€å…¶å®æ˜¯ä¸ºäº† **å…¼é¡¾æŸ¥è¯¢æ€§èƒ½ + å†™å…¥æ€§èƒ½ + ç³»ç»Ÿæ‰©å±•æ€§**ï¼Œæ˜¯ä¸€ç§å·¥ä¸šçº§çš„æŠ˜ä¸­æ–¹æ¡ˆã€‚













##### ä¼šé‡åˆ°è‡ªå¢idä¸è¿ç»­çš„å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

ä¼šçš„

åœ¨ä¸šåŠ¡è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ **è‡ªå¢ ID**ï¼ˆ`AUTO_INCREMENT`ï¼‰æ—¶ï¼Œ**ä¸è¿ç»­**æ˜¯æ­£å¸¸ç°è±¡ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘ã€äº‹åŠ¡å›æ»šã€åˆ†å¸ƒå¼ç¯å¢ƒé‡Œã€‚

æˆ‘å¸®ä½ æ¢³ç†å‡ ä¸ªå¸¸è§åŸå› ï¼š

------

###### **1. äº‹åŠ¡å›æ»š**

- è‡ªå¢ ID æ˜¯åœ¨æ’å…¥æ“ä½œå¼€å§‹æ—¶åˆ†é…çš„ï¼Œå³ä½¿äº‹åŠ¡æœ€åå›æ»šï¼Œè¿™ä¸ª ID ä¹Ÿä¸ä¼šå›é€€ã€‚
- ç»“æœæ˜¯è·³å·å‡ºç°ï¼Œæ¯”å¦‚æ’å…¥ ID ä» 1001 è·³åˆ° 1003ï¼Œå› ä¸º 1002 çš„æ’å…¥äº‹åŠ¡è¢«å›æ»šäº†ã€‚

------

###### **2. åˆ é™¤è®°å½•**

- åˆ é™¤æ•°æ®ä¸ä¼šå½±å“è‡ªå¢ ID ç”Ÿæˆã€‚
- æ¯”å¦‚æ’å…¥äº† ID=1,2,3ï¼Œåˆ é™¤äº† ID=2ï¼Œä¸‹æ¬¡æ’å…¥è¿˜æ˜¯ ID=4ã€‚

------

###### **3. å¹¶å‘æ’å…¥**

- å¤šä¸ªçº¿ç¨‹æˆ–è¿æ¥åŒæ—¶æ’å…¥æ•°æ®æ—¶ï¼Œè‡ªå¢ ID ä¼šæŒ‰ç…§åˆ†é…é¡ºåºç”Ÿæˆï¼Œä½†æœ€ç»ˆæ’å…¥é¡ºåºå¯èƒ½ä¸åŒã€‚
- ä¼šå‡ºç° ID åˆ†é…é¡ºåºå’Œå®é™…æ•°æ®æ’å…¥é¡ºåºä¸ä¸€è‡´çš„ç°è±¡ã€‚

------

###### **4. æ•°æ®åº“é‡å¯æˆ–é…ç½®**

- MySQL åœ¨æŸäº›ç‰ˆæœ¬ä¸­ï¼Œè‡ªå¢å€¼ä¼šåœ¨é‡å¯æ—¶æå‰ä¿ç•™ï¼Œå¯¼è‡´è·³å·ã€‚
- æ¯”å¦‚ MySQL çš„ `innodb_autoinc_lock_mode` é…ç½®ä¼šå½±å“è‡ªå¢å€¼çš„åˆ†é…ç­–ç•¥ã€‚

------

###### **5. åˆ†å¸ƒå¼ç³»ç»Ÿ**

- åœ¨åˆ†åº“åˆ†è¡¨åœºæ™¯ï¼Œè‡ªå¢ ID åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šä¼šç‹¬ç«‹ç”Ÿæˆï¼Œå¤©ç„¶ä¼šäº§ç”Ÿä¸è¿ç»­ã€‚
- è¿™ç§æƒ…å†µæ›´å¸¸è§äºé«˜å¯ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ã€‚

------

###### ğŸ” å°ç»“

**è‡ªå¢ ID ä¸è¿ç»­æ˜¯æ­£å¸¸ç°è±¡**ï¼Œå®ƒå¹¶ä¸å½±å“ä¸šåŠ¡æ­£ç¡®æ€§ï¼Œé™¤éä¸šåŠ¡æœ‰å¼ºä¾èµ–è‡ªå¢ IDè¿ç»­æ€§çš„ç‰¹æ®Šéœ€æ±‚ï¼ˆè¿™ç§éœ€æ±‚åœ¨å¤§å¤šæ•°åœºæ™¯ä¸­å¾ˆå°‘ï¼‰ã€‚
 å¦‚æœä¸šåŠ¡å¿…é¡»ä¸¥æ ¼è¿ç»­ï¼Œå°±éœ€è¦é¢å¤–è®¾è®¡ï¼Œæ¯”å¦‚**å·æ®µåˆ†é…ã€å…¨å±€é”ã€åºåˆ—è¡¨**ï¼Œä½†ä¼šç‰ºç‰²æ€§èƒ½ã€‚

------

ğŸ’¡ å°æï¼Œå¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€ä¸ª **è‡ªå¢ ID è·³å·åŸå› çš„ç›´è§‚æµç¨‹å›¾**ï¼Œè®©ä½ é¢è¯•æ—¶ç›´æ¥ç”¨å®ƒè§£é‡Šè‡ªå¢ ID çš„ç‰¹æ€§ï¼Œè¿™ä¼šè®©é¢è¯•å®˜è§‰å¾—ä½ å¯¹æ•°æ®åº“æœ‰æ›´æ·±çš„ç†è§£ã€‚

```mermaid
graph TB
    A[è‡ªå¢IDç”Ÿæˆè¿‡ç¨‹] --> B[äº‹åŠ¡å›æ»š]
    A --> C[åˆ é™¤è®°å½•]
    A --> D[å¹¶å‘æ’å…¥]
    A --> E[æ•°æ®åº“é‡å¯æˆ–é…ç½®]
    A --> F[åˆ†å¸ƒå¼ç³»ç»Ÿ]

    B -->|äº‹åŠ¡å›æ»š  å·²åˆ†é…IDä¸å›é€€| B
    C -->|åˆ é™¤è®°å½•  IDä¸å¤ç”¨| C
    D -->|å¹¶å‘æ’å…¥  åˆ†é…é¡ºåºä¸ä¸€è‡´| D
    E -->|é‡å¯æˆ–é…ç½®  è‡ªå¢å€¼æå‰ä¿ç•™| E
    F -->|åˆ†å¸ƒå¼  å„èŠ‚ç‚¹ç‹¬ç«‹ç”ŸæˆID| F
```



##### è¦†ç›–ç´¢å¼•å’Œè”åˆé”å¼•æœ‰ä»€ä¹ˆåŒºåˆ«å‘€ï¼Ÿ



å¥½é—®é¢˜ï¼Œå°æ ğŸ‘ã€‚è¿™ä¸ªç‚¹å¾ˆå¤šäººå®¹æ˜“æ··æ·†ï¼Œé¢è¯•å®˜ä¹Ÿå–œæ¬¢é—®ã€‚

æˆ‘ç»™ä½ ç®€æ˜å¯¹æ¯”ä¸€ä¸‹ï¼š

------

###### ğŸ”‘ è¦†ç›–ç´¢å¼• (Covering Index)

**å®šä¹‰**ï¼š
 æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰å­—æ®µéƒ½èƒ½ç›´æ¥ä»ç´¢å¼•é‡Œæ‹¿åˆ°ï¼Œä¸éœ€è¦å†å›è¡¨ï¼ˆè®¿é—®èšç°‡ç´¢å¼•/æ•°æ®é¡µï¼‰ã€‚

**å…³é”®ç‚¹**ï¼š

- æ˜¯å¦â€œè¦†ç›–â€äº† `SELECT` è¯­å¥é‡Œçš„å­—æ®µã€‚
- å’Œè”åˆç´¢å¼•ã€å•åˆ—ç´¢å¼•éƒ½å¯èƒ½ç›¸å…³ã€‚

**ä¾‹å­**ï¼š

```sql
INDEX idx_stock_date_price (wind_code, trade_date, latest_price)

SELECT latest_price 
FROM tb_quotation 
WHERE wind_code = '600000' 
AND trade_date BETWEEN '2025-09-01' AND '2025-09-10';
```

ğŸ‘‰ æŸ¥è¯¢æ¡ä»¶å­—æ®µ + è¿”å›å­—æ®µéƒ½åœ¨ç´¢å¼•é‡Œï¼Œæ‰€ä»¥ **è¦†ç›–ç´¢å¼•**ï¼Œä¸ç”¨å›è¡¨ã€‚

------

###### ğŸ”‘ è”åˆç´¢å¼• (Composite Index)

**å®šä¹‰**ï¼š
 ä¸€ä¸ªç´¢å¼•åŒ…å«å¤šä¸ªåˆ—ï¼ˆå¦‚ `(wind_code, trade_date)`ï¼‰ã€‚
 æŒ‰æœ€å·¦å‰ç¼€åŸåˆ™æ’åºã€‚

**å…³é”®ç‚¹**ï¼š

- å®šä¹‰ç´¢å¼•æ—¶å†³å®šã€‚
- ä¸»è¦ä¼˜åŒ– `WHERE` æ¡ä»¶çš„æ£€ç´¢æ•ˆç‡ã€‚

**ä¾‹å­**ï¼š

```sql
INDEX idx_stock_date (wind_code, trade_date)

SELECT * 
FROM tb_quotation 
WHERE wind_code = '600000' 
AND trade_date BETWEEN '2025-09-01' AND '2025-09-10';
```

ğŸ‘‰ è¿™é‡Œç”¨åˆ°äº† **è”åˆç´¢å¼•**ï¼Œä½†å› ä¸º `SELECT *` åŒ…å«äº†ç´¢å¼•é‡Œæ²¡æœ‰çš„å­—æ®µï¼Œä»ç„¶è¦å›è¡¨ã€‚

------

###### âš–ï¸ åŒºåˆ«æ€»ç»“

| ç‰¹æ€§     | è¦†ç›–ç´¢å¼•                                   | è”åˆç´¢å¼•           |
| -------- | ------------------------------------------ | ------------------ |
| æ¦‚å¿µ     | ä¸€ç§æŸ¥è¯¢ä¼˜åŒ–æ•ˆæœ                           | ä¸€ç§ç´¢å¼•ç»“æ„       |
| å†³å®šå› ç´  | æŸ¥è¯¢æ˜¯å¦åªæ¶‰åŠç´¢å¼•å­—æ®µ                     | ç´¢å¼•å®šä¹‰æ–¹å¼       |
| ç›®æ ‡     | é¿å…å›è¡¨                                   | åŠ å¿«æ¡ä»¶è¿‡æ»¤       |
| å…³ç³»     | **è”åˆç´¢å¼• + æ°å¥½è¦†ç›–æŸ¥è¯¢å­—æ®µ = è¦†ç›–ç´¢å¼•** | ä¸ä¸€å®šè¦†ç›–æŸ¥è¯¢å­—æ®µ |

------

ğŸ‘‰ ä½ é‡åˆ°çš„æƒ…å†µå°±æ˜¯ï¼š

- ä½ å»ºç«‹äº† `(wind_code, trade_date, latest_price, total_volume, average_price)` è¿™ç§ **è”åˆç´¢å¼•**ã€‚
- ä¸šåŠ¡æŸ¥è¯¢æ—¶åªæŸ¥è¿™äº›å­—æ®µï¼Œå°±å˜æˆäº† **è¦†ç›–ç´¢å¼•**ã€‚
- æ‰€ä»¥æ€§èƒ½å¤§å¹…æå‡ï¼Œå› ä¸ºå‡å°‘äº†å›è¡¨ã€‚

------

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸ª **Mermaid å¯¹æ¯”å›¾**ï¼ŒæŠŠã€Œè”åˆç´¢å¼• â†’ è¦†ç›–ç´¢å¼•ã€çš„å…³ç³»ç›´è§‚å±•ç¤ºï¼Ÿè¿™æ ·ä½ æ‹¿å»é¢è¯•è¯´ï¼Œé¢è¯•å®˜ä¸€çœ¼å°±æ‡‚ã€‚





##### æ˜¯å› ä¸ºæœ‰å¯èƒ½å¹¶æ²¡æœ‰æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œæœ‰å¯èƒ½åªæ˜¯å…¶ä¸­å‡ ä¸ªå­—æ®µï¼Œæ‰€ä»¥æ—¢è¦è¦†ç›–ç´¢å¼•ä¹Ÿéœ€è¦è”åˆç´¢å¼•å¯¹å§



###### 1. è”åˆç´¢å¼•è§£å†³çš„æ˜¯ **æ£€ç´¢æ•ˆç‡**

- å¤šä¸ªå­—æ®µåˆå¹¶åœ¨ä¸€ä¸ªç´¢å¼•é‡Œï¼Œèƒ½å‡å°‘å›è¡¨æ¬¡æ•°ã€æå‡è¿‡æ»¤æ€§èƒ½ã€‚
- ä½†æ˜¯å¦é¿å…å›è¡¨ï¼Œè¿˜è¦çœ‹ `SELECT` é‡Œè¦å–å“ªäº›å­—æ®µã€‚

ğŸ‘‰ æ‰€ä»¥ï¼Œè”åˆç´¢å¼•æ˜¯ **ç»“æ„**ã€‚

------

###### 2. è¦†ç›–ç´¢å¼•è§£å†³çš„æ˜¯ **æŸ¥è¯¢æ˜¯å¦å®Œå…¨åœ¨ç´¢å¼•é‡Œå®Œæˆ**

- å¦‚æœ `SELECT` çš„å­—æ®µéƒ½èƒ½ä»ç´¢å¼•ä¸­ç›´æ¥æ‹¿åˆ°ï¼ˆåŒ…æ‹¬ `WHERE` æ¡ä»¶å’Œ `SELECT` åˆ—ï¼‰ï¼Œå°±ä¸éœ€è¦å›è¡¨ã€‚
- ä¸€æ—¦ `SELECT` å¤šäº†ä¸€ä¸ªç´¢å¼•ä¹‹å¤–çš„å­—æ®µï¼Œå°±è¦å›è¡¨äº†ã€‚

ğŸ‘‰ æ‰€ä»¥ï¼Œè¦†ç›–ç´¢å¼•æ˜¯ **æ•ˆæœ**ã€‚

------

###### 3. ä¸¤è€…å…³ç³»

- è”åˆç´¢å¼• â‰  è¦†ç›–ç´¢å¼•
- ä½† **è¦†ç›–ç´¢å¼•é€šå¸¸ä¾èµ–è”åˆç´¢å¼•å®ç°**ï¼ˆå°¤å…¶åœ¨ä¸šåŠ¡é‡Œå¸¸è§çš„å¤šæ¡ä»¶ + å¤šè¿”å›å­—æ®µåœºæ™¯ï¼‰

ä½ å¯ä»¥è®°ä¸€å¥é¢è¯•ç­”æ³•ï¼š

> â€œè”åˆç´¢å¼•æ˜¯ç‰©ç†ç»“æ„ï¼Œè¦†ç›–ç´¢å¼•æ˜¯æŸ¥è¯¢æ•ˆæœã€‚åªæœ‰åœ¨æŸ¥è¯¢æ‰€éœ€å­—æ®µå®Œå…¨åŒ…å«åœ¨è”åˆç´¢å¼•ä¸­æ—¶ï¼Œæ‰ä¼šè§¦å‘è¦†ç›–ç´¢å¼•ï¼Œä»è€Œé¿å…å›è¡¨ã€‚â€

------

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸ª **è¦†ç›–ç´¢å¼• vs è”åˆç´¢å¼•çš„æµç¨‹å›¾**ï¼Ÿä½ åœ¨é¢è¯•æ—¶ä¸€å¥è¯åŠ ä¸ªå›¾ï¼Œé¢è¯•å®˜ç«‹é©¬è§‰å¾—ä½ å¾ˆä¸“ä¸šã€‚



```mermaid
graph TD
    A[è”åˆç´¢å¼• Composite Index] --> B{æŸ¥è¯¢å­—æ®µ}
    B -->|å…¨éƒ¨å­—æ®µéƒ½åœ¨ç´¢å¼•é‡Œ| Cè¦†ç›–ç´¢å¼•(Covering Index)
    B -->|æœ‰å­—æ®µä¸åœ¨ç´¢å¼•é‡Œ| Déœ€è¦å›è¡¨

    C --> E[æŸ¥è¯¢æ•ˆç‡æœ€é«˜<br>ä»…æ‰«æç´¢å¼•]
    D --> F[å¿…é¡»è®¿é—®æ•°æ®é¡µ<br>å¢åŠ IO]
```







##### å‡å°‘å•è¡¨æ•°æ®é‡ï¼Œé™ä½é”ç«äº‰è¿™é‡Œçš„é”ç«äº‰æ˜¯ä»€ä¹ˆé”ç«äº‰å‘¢

ChatGPT è¯´ï¼š

é—®å¾—å¥½ ğŸ‘ï¼Œä½ è¿™é‡Œæåˆ°çš„ **å‡å°‘å•è¡¨æ•°æ®é‡ï¼Œé™ä½é”ç«äº‰**ï¼Œå®é™…ä¸Šæ¶‰åŠçš„æ˜¯ **InnoDB çš„è¡Œé”ç«äº‰**ï¼Œæˆ‘å¸®ä½ ç»†åŒ–ä¸€ä¸‹ï¼š

------

###### 1. InnoDB é”ç±»å‹å›é¡¾

- **è¡¨é”ï¼ˆTable Lockï¼‰**ï¼šæ•´å¼ è¡¨åŠ é”ï¼ˆMyISAM ä¸»è¦ç”¨ï¼‰ï¼ŒInnoDB ä¸€èˆ¬ä¸ç”¨ï¼Œé™¤é `ALTER` ç­‰ DDL æ“ä½œã€‚
- **è¡Œé”ï¼ˆRow Lockï¼‰**ï¼šInnoDB çš„æ ¸å¿ƒï¼ŒæŒ‰ç´¢å¼•æ¥åŠ é”ï¼Œå¸¸è§äº `UPDATE/DELETE/SELECT ... FOR UPDATE`ã€‚
- **é—´éš™é”ï¼ˆGap Lockï¼‰**ï¼šèŒƒå›´æŸ¥è¯¢æ—¶é”å®šâ€œé—´éš™â€ï¼Œé¿å…å¹»è¯»ã€‚
- **æ„å‘é”ï¼ˆIntention Lockï¼‰**ï¼šå…ƒæ•°æ®çº§åˆ«çš„æ ‡è¯†ï¼Œè¡¨æ˜äº‹åŠ¡é‡Œæ‰“ç®—åŠ ä»€ä¹ˆé”ã€‚

------

###### 2. å•è¡¨è¿‡å¤§æ—¶ä¸ºä»€ä¹ˆè¡Œé”ç«äº‰æ›´ä¸¥é‡

å‡è®¾ä½ æœ‰ **3åƒä¸‡è¡Œ/æœˆï¼Œç´¯è®¡è¿‡äº¿è¡Œ** çš„å•è¡¨ï¼Œåœºæ™¯å¯èƒ½æ˜¯ï¼š

- **æ‰¹é‡æ’å…¥/æ›´æ–°**ï¼šæ¯”å¦‚ `UPDATE order SET status=1 WHERE user_id=xxx AND month=202509`
- **èŒƒå›´æŸ¥è¯¢**ï¼šæ¯”å¦‚ `SELECT * FROM order WHERE date BETWEEN '2025-09-01' AND '2025-09-30' FOR UPDATE`

é—®é¢˜åœ¨äºï¼š

1. **æ‰«æèŒƒå›´å¤§** â†’ InnoDB éœ€è¦åŠ æ›´å¤šçš„è¡Œé”/é—´éš™é”ã€‚
2. **äº‹åŠ¡æŒé”æ—¶é—´é•¿** â†’ å³ä½¿æ˜¯è¯»ä¹Ÿå¯èƒ½é˜»å¡å†™ã€‚
3. **å†²çªæ¦‚ç‡é«˜** â†’ ä¸åŒäº‹åŠ¡æ“ä½œçš„èŒƒå›´æœ‰é‡å ï¼Œå°±ä¼šå¯¼è‡´é”ç­‰å¾…ç”šè‡³æ­»é”ã€‚

------

###### 3. é€šè¿‡åˆ†è¡¨é™ä½é”ç«äº‰

- **ä¼˜åŒ–å‰**ï¼š
   å•è¡¨ 1 äº¿æ•°æ®ï¼ŒæŸæ¬¡æ›´æ–°èŒƒå›´å‘½ä¸­ 100 ä¸‡è¡Œï¼Œäº‹åŠ¡éœ€è¦å¯¹ 100 ä¸‡è¡ŒåŠ é”ã€‚
   â†’ å¹¶å‘äº‹åŠ¡ 10 ä¸ªï¼Œææ˜“äº§ç”Ÿå¤§é¢ç§¯é”ç­‰å¾…ã€‚
- **ä¼˜åŒ–åï¼ˆæŒ‰æœˆåˆ†è¡¨ï¼‰**ï¼š
   æ¯å¼ è¡¨åª 3000 ä¸‡è¡Œï¼ŒæŸæ¬¡æ›´æ–°å‘½ä¸­ 30 ä¸‡è¡Œã€‚
   â†’ é”å®šçš„è¡Œæ•°ä¸‹é™ 70%ï¼Œå†²çªæ¦‚ç‡æ˜¾è‘—ä¸‹é™ã€‚
   å†åŠ ä¸Š**èŒƒå›´æ›´ç²¾å‡†çš„ç´¢å¼•**ï¼ˆå¦‚ `(user_id, date)` è”åˆç´¢å¼•ï¼‰ï¼Œå®é™…é”çš„èŒƒå›´å¯èƒ½ç¼©å°åˆ°å‡ ç™¾/å‡ åƒè¡Œã€‚



###### æ€»ç»“ä¸€å¥è¯

è¿™é‡Œçš„é”ç«äº‰ï¼ŒæŒ‡çš„æ˜¯ **InnoDB è¡Œçº§é”ï¼ˆRow Lock/GAP Lockï¼‰çš„å†²çª**ï¼Œè€Œä¸æ˜¯è¡¨é”ã€‚
 é€šè¿‡å‡å°‘å•è¡¨æ•°æ®é‡ + ç²¾å‡†ç´¢å¼•ï¼Œå¯ä»¥æœ‰æ•ˆé™ä½é”å®šèŒƒå›´ï¼Œä»è€Œå‡å°‘ **è¡Œé”ç­‰å¾…/æ­»é”** çš„æ¦‚ç‡ã€‚









### Redis



#### åˆ†å¸ƒå¼é”é˜²æ­¢èµ„æºæµªè´¹



> åŒä¸€ä»»åŠ¡è¢«é‡å¤è§¦å‘æ—¶ï¼Œ

1. ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡idä¼šè¢«ä¸Š`setnx()`å¹¶è®¾å®šè¶…æ—¶æ—¶é—´åˆ†å¸ƒå¼é”ï¼Œè·å–é”æ‰§è¡Œã€‚
2. å…¶å®ƒçº¿ç¨‹åœ¨ä¸æ–­ç«äº‰çš„è¿‡ç¨‹ä¸­ä¼šè§¦å‘ç»­çº¦é”`renewLock `ï¼Œåœ¨é”æŒæœ‰è€…å®šæœŸè¿è¡Œçš„å¿ƒè·³ä¸­è°ƒç”¨ renewLockï¼Œç”¨æ¥å»¶é•¿é”çš„è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰ã€‚
3. æœ€åç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå…¥ç»“æœè¡¨çš„ä¹‹å‰åˆ¤æ–­è¯¥å½“æ—¥æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä»»åŠ¡idæ˜¯å¦å·²ç»å­˜åœ¨å½“å¤©æ•°æ®ã€‚
4. å¦åˆ™ä¸è½è¡¨ï¼Œå®ç°å¹‚ç­‰ã€‚



åœ¨å›æµ‹/å› å­è®¡ç®—è¿™ç±»è€—æ—¶ä¸” IO/CPU å¯†é›†çš„ä»»åŠ¡åœºæ™¯ä¸‹ï¼Œå¸¸è§é—®é¢˜æ˜¯ï¼š

- åŒä¸€ä»»åŠ¡è¢«é‡å¤è§¦å‘ï¼ˆå‰ç«¯é‡è¯•ã€ç½‘ç»œè¶…æ—¶é‡å‘ã€è°ƒåº¦é‡è¯•ç­‰ï¼‰ï¼Œä¼šå¯¼è‡´è®¡ç®—èµ„æºè¢«å¤šå€æ¶ˆè€—ã€å›æµ‹ç»“æœé‡å¤å†™å…¥æˆ–æ•°æ®åº“ç«æ€ã€‚
- æˆ‘è´Ÿè´£çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šåœ¨è°ƒåº¦å…¥å£å¯¹å›æµ‹ä»»åŠ¡ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”ï¼Œä»¥ taskId ä¸º key ä½œä¸ºå¹‚ç­‰æ ‡è¯†ï¼Œè·å–é”æˆåŠŸåˆ™æ‰§è¡Œå›æµ‹ï¼Œ
- æœªè·å–åˆ°åˆ™ç›´æ¥è¿”å›ä»»åŠ¡å·²åœ¨è¿è¡Œæˆ–æ’é˜Ÿçš„çŠ¶æ€ã€‚
- é”å¸¦æœ‰åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆåŸºäºä»»åŠ¡é¢„ä¼°æ—¶é•¿ä¹˜ä»¥å®‰å…¨ç³»æ•°ï¼‰ï¼Œå¹¶ç»“åˆå¿ƒè·³ç»­ç§Ÿæœºåˆ¶ä¿è¯å¼‚å¸¸æ¢å¤ï¼›
- ä»»åŠ¡å®Œæˆåé‡Šæ”¾é”å¹¶å†™å…¥ç»“æœï¼ˆå†™å…¥æ“ä½œè¦åšå¹‚ç­‰æ ¡éªŒï¼‰ã€‚å®è·µä¸­è¿™ä¸ªæœºåˆ¶æ˜¾è‘—é™ä½äº†é‡å¤æ‰§è¡Œç‡ï¼ŒèŠ‚çº¦äº†å¤§é‡è®¡ç®—èµ„æºï¼Œä¿éšœäº†ç»“æœä¸€è‡´æ€§ã€‚





1) å¯ç›´æ¥æ”¾åœ¨ DistributedLockTest ç±»æ–‡ä»¶é¡¶éƒ¨çš„â€œæ€è·¯æ³¨é‡Šâ€ï¼ˆä¸­æ–‡ï¼Œè¯¦å°½è¯´æ˜å®ç°è¦ç‚¹ã€è¾¹ç•Œä¸æ³¨æ„äº‹é¡¹ï¼‰ï¼Œæ–¹ä¾¿åç»­ç»´æŠ¤ï¼›
2) ä¸€ä¸ª mermaid æµç¨‹å›¾æºç ï¼Œå±•ç¤ºæ•´ä¸ªæµ‹è¯•/é”å®ç°çš„æ‰§è¡Œæµç¨‹ï¼ˆå¯å¤åˆ¶åˆ°æ”¯æŒ mermaid çš„å·¥å…·ä¸­æ¸²æŸ“ï¼‰ã€‚

â€”â€” æ€è·¯æ³¨é‡Šï¼ˆæ”¾åˆ° DistributedLockTest ç±»æ–‡ä»¶æœ€ä¸Šæ–¹ï¼‰
/**
 * åˆ†å¸ƒå¼é”å›æµ‹å¹¶å‘æµ‹è¯•ï¼ˆè®¾è®¡ä¸å®ç°è¯´æ˜ï¼‰
 *
 * ç›®æ ‡
 * - æ¨¡æ‹Ÿ N ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶è§¦å‘åŒä¸€å›æµ‹ä»»åŠ¡ï¼ŒéªŒè¯åˆ†å¸ƒå¼é”èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹å®é™…æ‰§è¡Œå›æµ‹å¹¶å†™å…¥ç»“æœï¼ˆå¹‚ç­‰å†™å…¥ï¼‰ã€‚
 * - åœ¨æ‰§è¡ŒæœŸé—´å¯¹é”è¿›è¡Œå‘¨æœŸæ€§ç»­ç§Ÿï¼Œç¡®ä¿é•¿è€—æ—¶ä»»åŠ¡ä¸ä¼šè¢«è¿‡æ—©é‡Šæ”¾ã€‚
 *
 * ç»„ä»¶ä¸èŒè´£
 * - RedisConfigï¼ˆRedis å®¢æˆ·ç«¯å°è£…ï¼‰
 *   - è´Ÿè´£åˆ›å»º LettuceConnectionFactory å’Œ StringRedisTemplateï¼Œå¹¶å°è£…å¸¸ç”¨ Redis æ“ä½œï¼ˆset/get/expire/hash/zset/list/set ç­‰ï¼‰ã€‚
 *   - æä¾› tryLock(key, value, expireTime) ä½¿ç”¨ setIfAbsent(key, value, expire) å®ç°â€œè·å–é”â€ã€‚
 *   - æä¾› releaseLock(key, value) ä½¿ç”¨ Lua è„šæœ¬ï¼ˆget + delï¼‰åŸå­é‡Šæ”¾ã€‚
 *   - æä¾› getRedisTemplate() æš´éœ²åº•å±‚ StringRedisTemplateï¼Œç”¨äºæ‰§è¡Œ Lua è„šæœ¬ï¼ˆç»­ç§Ÿåœºæ™¯ï¼‰ã€‚
 *   - å»ºè®®è‹¥éœ€è¦æ›´å¤šåŸå­æ“ä½œï¼ˆæ¯”å¦‚ SET NX EXï¼‰å¯åœ¨ RedisConfig å¢åŠ å°è£…æ–¹æ³• setIfAbsent(key,value,expire)ã€‚
 *
 * - DistributedLockTestï¼ˆæµ‹è¯•é€»è¾‘ï¼‰
 *   - åœ¨ testDistributedLockForBacktest() ä¸­å¯åŠ¨å¤šçº¿ç¨‹æ¨¡æ‹Ÿå¹¶å‘è¯·æ±‚ã€‚
 *   - æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ startBacktestï¼š
 *     1. å°è¯•è·å–åˆ†å¸ƒå¼é”ï¼ˆlockService.tryLockï¼‰ã€‚value å»ºè®®ä¸ºå”¯ä¸€å­—ç¬¦ä¸²ï¼ˆrequestId + UUIDï¼‰ã€‚
 *     2. è‹¥è·å–å¤±è´¥ï¼Œç›´æ¥è¿”å›ï¼ˆä»»åŠ¡å·²è¢«å…¶ä»–å®ä¾‹å¤„ç†ï¼‰ã€‚
 *     3. è‹¥è·å–æˆåŠŸï¼š
 *        - ç»Ÿè®¡ lockSuccessCountã€‚
 *        - å¯åŠ¨å•çº¿ç¨‹ ScheduledExecutorService ç”¨äºå‘¨æœŸæ€§ç»­ç§Ÿï¼ˆheartbeatï¼‰ï¼Œé€šè¿‡ lockService.getRedisTemplate().execute(...) æ‰§è¡Œ Lua è„šæœ¬ï¼šæ£€æŸ¥ key çš„ value æ˜¯å¦ä¸å½“å‰æŒæœ‰è€…ä¸€è‡´ï¼Œè‹¥ä¸€è‡´åˆ™æ‰§è¡Œ EXPIREï¼ˆç»­ç§Ÿï¼‰ã€‚
 *        - æ‰§è¡Œå›æµ‹ä»»åŠ¡ executeBacktestï¼ˆæ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼‰ã€‚
 *        - å¹‚ç­‰å†™å…¥ç»“æœ writeResultIdempotentï¼šé€šè¿‡ Redis çš„ setIfAbsentï¼ˆæˆ– RedisConfig å°è£…çš„æ–¹æ³•ï¼‰å®ç° SET NX semanticsï¼Œä¿è¯åªæœ‰ç¬¬ä¸€ä¸ªå†™å…¥è€…å®é™…å†™å…¥ç»“æœï¼ˆdbWriteCount è®¡æ•°ï¼‰ã€‚
 *        - finally ä¸­åœæ­¢ heartbeat è°ƒåº¦å™¨ï¼ˆcancel + shutdownï¼‰ã€‚
 *     4. æœ€ç»ˆé‡Šæ”¾é”ï¼šè°ƒç”¨ lockService.releaseLock(key, value)ï¼Œä½¿ç”¨ Lua è„šæœ¬ä¿è¯â€œå…ˆéªŒè¯ååˆ é™¤â€çš„åŸå­æ€§ï¼Œé¿å…è¯¯åˆ ä»–äººé”ã€‚
 *
 * é‡è¦è®¾è®¡è¦ç‚¹ä¸æ³¨æ„äº‹é¡¹
 * - é”å€¼å”¯ä¸€æ€§ï¼šæ¯ä¸ªè¯·æ±‚åº”ä½¿ç”¨å”¯ä¸€ valueï¼ˆUUIDï¼‰ï¼Œä»¥åŒºåˆ†ä¸åŒæŒæœ‰è€…ï¼Œä¿è¯ release/renew çš„å®‰å…¨æ€§ã€‚
 * - ç»­ç§Ÿï¼ˆheartbeatï¼‰é—´éš”ä¸é” TTLï¼š
 *   - heartbeat é—´éš”åº”è¿œå°äº TTLï¼ˆç¤ºä¾‹ï¼šTTL=60sï¼Œheartbeat æ¯20sï¼‰ï¼Œå¹¶è€ƒè™‘ç»­ç§Ÿè„šæœ¬æ‰§è¡Œå¤±è´¥æˆ–ç½‘ç»œæŠ–åŠ¨çš„å®¹é”™ã€‚
 *   - è‹¥ç»­ç§Ÿå¤±è´¥ï¼Œåº”è§†ä¸ºå¯èƒ½ä¸¢å¤±é”ï¼Œåç»­é€»è¾‘åº”è°¨æ…ï¼ˆå¯ä¸­æ–­ä»»åŠ¡æˆ–åœ¨è®°å½•æ—¥å¿—åç»§ç»­ï¼Œæœ¬ç¤ºä¾‹ç»§ç»­æ‰§è¡Œä½†é‡Šæ”¾æ—¶ä¼šå¤±è´¥ï¼‰ã€‚
 * - åŸå­é‡Šæ”¾ï¼šreleaseLock ä½¿ç”¨ Lua è„šæœ¬ï¼ˆif get(key)==value then del(key) endï¼‰ï¼Œé¿å…åˆ é™¤ä¸æ˜¯è‡ªå·±æŒæœ‰çš„é”ã€‚
 * - å¹‚ç­‰å†™å…¥ï¼šå†™å…¥æ•°æ®åº“/ç»“æœæ—¶å¿…é¡»ä¿è¯å¹‚ç­‰ï¼ˆæœ¬ç¤ºä¾‹ä½¿ç”¨ Redis çš„ SET NX æ¨¡æ‹Ÿå”¯ä¸€çº¦æŸï¼‰ï¼ŒçœŸå®åœºæ™¯åº”ç»“åˆæ•°æ®åº“å”¯ä¸€ç´¢å¼•æˆ–äº‹åŠ¡ä¿éšœã€‚
 * - Redis è¿æ¥ä¸æµ‹è¯•ç¯å¢ƒï¼š
 *   - RedisConfig åœ¨ afterPropertiesSet ä¸­ä¼šåˆå§‹åŒ–è¿æ¥å¹¶åšç®€å•è¿é€šæ€§æ£€æµ‹ï¼Œè¯·ç¡®ä¿æµ‹è¯•ç¯å¢ƒèƒ½è¿æ¥åˆ°é…ç½®çš„ Redisã€‚
 *   - å•å…ƒæµ‹è¯•æ³¨å…¥ RedisConfigï¼ˆè€Œä¸æ˜¯ç›´æ¥æ³¨å…¥ RedisTemplateï¼‰ï¼Œä»¥å¤ç”¨å°è£…çš„æ–¹æ³•å’Œè¿æ¥åˆå§‹åŒ–é€»è¾‘ã€‚
 *
 * ç»Ÿè®¡ä¸åº¦é‡
 * - lockSuccessCountï¼šè·å–åˆ°é”çš„çº¿ç¨‹æ•°ï¼ˆç†è®ºä¸Šåº”ä¸º 1ï¼‰ã€‚
 * - actualExecuteCountï¼šå®é™…æ‰§è¡Œå›æµ‹ä»»åŠ¡çš„æ¬¡æ•°ï¼ˆç†è®ºä¸Šåº”ä¸º 1ï¼‰ã€‚
 * - dbWriteCountï¼šå®é™…å†™å…¥ç»“æœåˆ° Redis/æ•°æ®åº“çš„æ¬¡æ•°ï¼ˆç†è®ºä¸Šåº”ä¸º 1ï¼‰ã€‚
 * - èµ„æºèŠ‚çº¦ç‡ï¼šé€šè¿‡å¹¶å‘æ•°ä¸å®é™…æ‰§è¡Œæ¬¡æ•°è®¡ç®—èŠ‚çº¦ç‡ã€‚
 *
 * å¼‚å¸¸ä¸å®¹é”™
 * - Redis æ“ä½œå¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼ˆè¿æ¥ä¸¢å¤±ã€è¶…æ—¶ç­‰ï¼‰ï¼Œåœ¨å…³é”®è·¯å¾„åº”æ•è·å¹¶è®°å½•æ—¥å¿—ï¼ˆæœ¬ç¤ºä¾‹ä¸­å¤šæ•°æ“ä½œå·²æ•è·å¹¶è®°å½•ï¼‰ã€‚
 * - è‹¥ç»­ç§Ÿå¤±è´¥è€Œä»»åŠ¡ä»åœ¨æ‰§è¡Œï¼Œåç»­é‡Šæ”¾é”æ—¶ releaseLock ä¼šè¿”å› falseï¼ˆå› ä¸ºé”å¯èƒ½å·²è¢«å…¶ä»–è¯·æ±‚æŠ¢åˆ°ï¼‰ã€‚æ ¹æ®ä¸šåŠ¡é‡è¦æ€§å¯åœ¨ç»­ç§Ÿå¤±è´¥æ—¶ä¸»åŠ¨ä¸­æ­¢ä»»åŠ¡æˆ–ä¸ŠæŠ¥å‘Šè­¦ã€‚
 *
 * æ‰©å±•å»ºè®®
 * - å°†é”ä¸ä¸šåŠ¡è§£è€¦ï¼šæŠŠé”é€»è¾‘æ”¾åˆ°ç‹¬ç«‹çš„ LockService ä¸­ï¼ˆæ³¨å…¥ RedisConfigï¼‰ï¼Œä¾¿äºå¤ç”¨ä¸å•å…ƒæµ‹è¯•ã€‚
 * - ä½¿ç”¨ Redisson ç­‰æˆç†Ÿå®¢æˆ·ç«¯å¯ç®€åŒ–åˆ†å¸ƒå¼é”ï¼ˆè‡ªåŠ¨ç»­ç§Ÿã€å¯é‡å…¥ã€çœ‹é—¨ç‹—ç­‰ï¼‰å¹¶æé«˜å¥å£®æ€§ã€‚
 * - åœ¨å†™ç»“æœæ—¶ç»“åˆæ•°æ®åº“å”¯ä¸€ç´¢å¼•åšæœ€ç»ˆä¸€è‡´æ€§ä¿éšœã€‚
 */



##### æµç¨‹å›¾

> ä»¥ä¸‹ mermaid æµç¨‹å›¾æè¿°äº†æ•´ä¸ªæµ‹è¯•/é”æœºåˆ¶çš„æ‰§è¡Œæµç¨‹ï¼Œä»æµ‹è¯•å¯åŠ¨ã€å¹¶å‘è¯·æ±‚ã€è·å–é”ã€ç»­ç§Ÿã€æ‰§è¡Œä»»åŠ¡ã€å¹‚ç­‰å†™å…¥åˆ°é‡Šæ”¾é”çš„è¿‡ç¨‹ï¼š

```mermaid
flowchart TD
  A[Test: testDistributedLockForBacktest] --> B[å¯åŠ¨ N ä¸ªçº¿ç¨‹å¹¶å‘è¯·æ±‚]
  B --> C{çº¿ç¨‹ i: startBacktest taskId, requestId}
  C --> D[ç”Ÿæˆ lockKey, lockValue, lockTTL]
  D --> E[è°ƒç”¨ lockService.tryLock key, value, ttl]
  E --> |è·å–å¤±è´¥| F[æ—¥å¿—: è·å–é”å¤±è´¥ -> çº¿ç¨‹è¿”å›]
  E --> |è·å–æˆåŠŸ| G[lockSuccessCount++,å¯åŠ¨heartbeat ç»­ç§Ÿä»»åŠ¡]
  G --> H[Heartbeat: æ¯ 20s è°ƒç”¨ renewLock -> æ‰§è¡Œ Lua è„šæœ¬ if,get key ==value then expire key,ttl]
  G --> I[æ‰§è¡ŒexecuteBacktest è€—æ—¶æ¨¡æ‹Ÿ 30s]
  I --> J[æ‰§è¡Œå®Œæˆ]
  J --> K[å¹‚ç­‰å†™å…¥ writeResultIdempotent]
  K --> |setIfAbsent æˆåŠŸ| L[dbWriteCount++,æ—¥å¿—: å†™å…¥æˆåŠŸ]
  K --> |setIfAbsent å¤±è´¥| M[æ—¥å¿—: ç»“æœå·²å­˜åœ¨,è·³è¿‡å†™å…¥]
  J --> N[åœæ­¢ heartbeat cancel & shutdown]
  N --> O[è°ƒç”¨ lockService.releaseLock key,value -> Lua: if get==value then del end]
  O --> |release æˆåŠŸ| P[æ—¥å¿—: é‡Šæ”¾é”æˆåŠŸ]
  O --> |release å¤±è´¥| Q[æ—¥å¿—: é‡Šæ”¾é”å¤±è´¥ å¯èƒ½å·²è¿‡æœŸæˆ–è¢«æŠ¢å ]
  P --> R[çº¿ç¨‹ç»“æŸ]
  Q --> R
  F --> R
  R --> S[ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ -> è¾“å‡ºç»Ÿè®¡ç»“æœ]
```



è¯´æ˜ï¼š
- lockService.tryLock ä½¿ç”¨ Redis SET NX + EXï¼ˆå³ setIfAbsentï¼‰å®ç°åŸå­è·å–å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚
- renewLock å’Œ releaseLock å‡ä½¿ç”¨ Lua è„šæœ¬ï¼Œç¡®ä¿â€œæ¯”å¯¹ value åæ‰ expire/delâ€ çš„åŸå­æ€§ï¼Œé¿å…è¯¯æ“ä½œã€‚
- heartbeat ä¸ TTL çš„é…ç½®éœ€æƒè¡¡ï¼šheartbeat é—´éš” << TTLï¼›ç¤ºä¾‹ï¼šTTL=60sã€heartbeat=20sã€‚
- å¹¶å‘æµ‹è¯•ä¸­ç†æƒ³ç»“æœä¸ºï¼šlockSuccessCount=1ï¼ŒactualExecuteCount=1ï¼ŒdbWriteCount=1ã€‚

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥ï¼š
- ç›´æ¥æŠŠä¸Šé¢çš„æ€è·¯æ³¨é‡Šå®Œæ•´æ’å…¥åˆ°ä½ çš„ DistributedLockTest.java é¡¶éƒ¨ï¼ˆå¹¶ç»™å‡ºå®Œæ•´æ–‡ä»¶æ›¿æ¢æ–‡æœ¬ï¼‰ï¼›æˆ–è€…
- ç”Ÿæˆ releaseLock / renewLock / setIfAbsent çš„æ›´å¥å£®å®ç°ç¤ºä¾‹ï¼ˆå«å¼‚å¸¸ä¸é‡è¯•ç­–ç•¥ï¼‰ï¼›æˆ–è€…
- æŠŠ mermaid æ¸²æŸ“ä¸ºå›¾ç‰‡ï¼ˆå¦‚æœä½ æä¾›æ”¯æŒæ¸²æŸ“çš„ç¯å¢ƒæˆ–æˆ‘ä»¥ base64 è¾“å‡ºï¼‰ã€‚ä½ æƒ³è¦å“ªç§åç»­å¸®åŠ©ï¼Ÿ

















## ç³»ç»Ÿä¼˜åŒ–

ç›®æ ‡

- ç”¨æ•°ç»„å­˜æ•°æ®ï¼Œå°‘ new å¯¹è±¡ã€‚
- æ‰¹é‡ç®—æŒ‡æ ‡ï¼ˆä¸€æ¬¡æ‰«æ•°ç»„ï¼‰ã€‚
- é¢„åˆ†é…ä¸­é—´æ•°ç»„ï¼Œå¾ªç¯é‡Œä¸ newã€‚
- é…å¥½ GCï¼Œæ‰“å¼€ç›‘æ§ï¼Œçœ‹å¾—åˆ°æ•ˆæœã€‚







### æ­¥éª¤1ï¼šç”¨åˆ—å¼æ•°ç»„æ›¿ä»£å¯¹è±¡åˆ—è¡¨ ç°çŠ¶å¸¸è§å†™æ³•ï¼ˆä¸è¦è¿™æ ·ï¼‰ï¼š

- List bars; // Bar é‡Œæœ‰ time, open, high, low, close, volume
- æ¯æ ¹Kçº¿ä¸€ä¸ªå¯¹è±¡ï¼Œéå†æ—¶å¯¹è±¡å–å­—æ®µï¼ŒGC å‹åŠ›å¤§ã€‚



æ”¹æˆæ•°ç»„ï¼ˆåˆ—å¼ï¼‰ï¼š

- ç”¨ä¸€ç»„åŸå§‹ç±»å‹æ•°ç»„ï¼štime[], open[], high[], low[], close[], volume[]



ç¤ºä¾‹ä»£ç 

```java
class MarketData {
	final int n;               // æ€»æ¡æ•°
	final long[] time;         // æ—¶é—´æˆ³
	final double[] open, high, low, close;
	final long[] volume;

MarketData(int n) {
	this.n = n;
	this.time = new long[n];
	this.open = new double[n];
	this.high = new double[n];
	this.low = new double[n];
	this.close = new double[n];
	this.volume = new long[n];
	}
}
```



### æ­¥éª¤2ï¼šé¢„åˆ†é…æŒ‡æ ‡ç»“æœæ•°ç»„ï¼Œä¸€æ¬¡æ€§æ‰¹é‡è®¡ç®—

ä¸è¦æ¯æ ¹Kçº¿éƒ½ new æŒ‡æ ‡å¯¹è±¡ï¼Œä¹Ÿä¸è¦åœ¨å¾ªç¯é‡Œç®— EMAã€‚ä¸€æ¬¡æ€§ç®—æ•´æ®µæ•°ç»„ï¼Œç»“æœæ”¾åœ¨é¢„åˆ†é…å¥½çš„ out[] é‡Œã€‚

ç¤ºä¾‹ï¼šEMA æ‰¹é‡è®¡ç®—ï¼ˆåŸåœ°ã€æ— é¢å¤–åˆ†é…ï¼‰

```java
void ema(double[] in, double[] out, int period) {
	if (in.length == 0) return;
	double k = 2.0 / (period + 1);
	out[0] = in[0]; // ç®€åŒ–åšæ³•ï¼šç¬¬ä¸€é¡¹ç­‰äºé¦–å€¼
	for (int i = 1; i < in.length; i++) {
		out[i] = out[i - 1] + k * (in[i] - out[i - 1]);
	}
}

	// ä½¿ç”¨
	double[] ema20 = new double[md.close.length]; // é¢„åˆ†é…
	ema(md.close, ema20, 20);
```

ç¤ºä¾‹ï¼šç®€å•ç§»åŠ¨å¹³å‡ï¼ˆSMAï¼‰ç”¨æ»‘çª—å‡å°‘è®¡ç®—

```java
void sma(double[] in, double[] out, int win) {
	double sum = 0;
	for (int i = 0; i < in.length; i++) {
	sum += in[i];
	if (i >= win) sum -= in[i - win];
	if (i >= win - 1) out[i] = sum / win;
	else out[i] = Double.NaN; // çª—å£æœªæ»¡
	}
}
```



### æ­¥éª¤3ï¼šç­–ç•¥å¾ªç¯åªç”¨ä¸‹æ ‡è®¿é—®ï¼Œä¸ new ä¸´æ—¶å¯¹è±¡ ä¸è¦ new Bar æˆ–åŒ…è£…å¯¹è±¡ï¼Œç›´æ¥ç”¨æ•°ç»„å’Œç´¢å¼•ã€‚

ç¤ºä¾‹ï¼šä¿¡å·ç”Ÿæˆï¼ˆæ— å¯¹è±¡åˆ†é…ï¼‰

```java
void runStrategy(MarketData md, double[] ema20, double[] ema50) {
boolean holding = false;
for (int i = 0; i < md.n; i++) {
	double fast = ema20[i];
	double slow = ema50[i];
if (Double.isNaN(fast) || Double.isNaN(slow)) continue;

if (!holding && fast > slow) {
	// å¼€å¤šä¿¡å·
	// ç›´æ¥è®°å½•ç´¢å¼•å’Œä»·æ ¼ï¼›å¦‚éœ€äº‹ä»¶å¯¹è±¡ï¼Œç”¨æ± åŒ–ï¼ˆè§æ­¥éª¤4ï¼‰
	holding = true;
} else if (holding && fast < slow) {
	// å¹³ä»“ä¿¡å·
	holding = false;
		}
	}
}
```



æ­¥éª¤4ï¼ˆå¯é€‰ï¼‰ï¼šç®€å•å¯¹è±¡æ± ï¼Œé¿å…äº‹ä»¶å¯¹è±¡é¢‘ç¹ new å¦‚æœä½ ç¡®å®éœ€è¦äº‹ä»¶å¯¹è±¡ï¼Œåšä¸ª ThreadLocal å°æ± å³å¯ã€‚ç”¨ acquire/release æ›¿ä»£ newã€‚

```java
class OrderEvent {
	int idx;
	double price;
	void reset() { idx = -1; price = 0; }
}

class SimplePool {
	private final ThreadLocal<java.util.ArrayDeque> tl;
	private final java.util.function.Supplier factory;
	private final int cap;

	SimplePool(int cap, java.util.function.Supplier factory) {
	this.cap = cap;
	this.factory = factory;
	this.tl = ThreadLocal.withInitial(() -> new java.util.ArrayDeque<>(cap));
}
T acquire() {
	var q = tl.get();
	T x = q.pollFirst();
	return x != null ? x : factory.get();
}
    
void release(T obj) {
	if (obj instanceof OrderEvent ev) ev.reset(); // ç®€å•é‡ç½®
	var q = tl.get();
	if (q.size() < cap) q.offerFirst(obj);
	}
}

// ä½¿ç”¨
SimplePool evtPool = new SimplePool<>(1024, OrderEvent::new);

// åœ¨ç­–ç•¥é‡Œ
OrderEvent e = evtPool.acquire();
e.idx = i;
e.price = md.close[i];
// ç”¨å®Œ
evtPool.release(e);
```







æ­¥éª¤5ï¼šJVM GC å‚æ•°â€”â€”ç›´æ¥å¯ç”¨çš„ä¸¤å¥— äºŒé€‰ä¸€ï¼Œå…ˆç”¨ G1ï¼Œè¿½æ±‚æä½å»¶è¿Ÿå†å°è¯• ZGCã€‚æŠŠè¿™äº›åŠ åˆ°å¯åŠ¨å‚æ•°é‡Œã€‚

æ–¹æ¡ˆAï¼šG1ï¼ˆé€šç”¨ã€ç¨³å®šï¼‰

é€šè¿‡JVMé€šç”¨å‚æ•°è°ƒä¼˜ï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨ã€‚é€‚åˆå¤§å †ã€è¿½æ±‚è¾ƒä½åœé¡¿å’Œç¨³å®šååçš„åœºæ™¯ï¼ŒæœŸæœ›æœ€å¤§ GC åœé¡¿æ—¶é—´ä¸º 100 æ¯«ç§’ï¼Œåˆå§‹å †å¤§å° 8GBã€‚ä¸ Xmx é…åˆä½¿ç”¨èƒ½å‡å°‘å †æ‰©ç¼©å®¹å¸¦æ¥çš„åœé¡¿å’Œç¢ç‰‡é—®é¢˜ã€‚å¼€å¯å¹¶è¡Œå¼•ç”¨å¤„ç†ï¼ˆå¦‚ Weak/Soft/Phantom å¼•ç”¨ï¼‰ï¼Œç¼©çŸ­ GC æ—¶è¿™éƒ¨åˆ†å¤„ç†çš„å¼€é”€ï¼Œä¸€æ—¦å‡ºç° OOMï¼Œè¿›ç¨‹ç›´æ¥é€€å‡ºè€Œä¸æ˜¯ç»§ç»­è¿è¡Œ

```bash
-XX:+UseG1GC

ä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨ã€‚é€‚åˆå¤§å †ã€è¿½æ±‚è¾ƒä½åœé¡¿å’Œç¨³å®šååçš„åœºæ™¯ï¼Œé»˜è®¤é€‰æ‹©ä¹‹ä¸€ã€‚
-XX:MaxGCPauseMillis=100

æœŸæœ›æœ€å¤§ GC åœé¡¿æ—¶é—´ä¸º 100 æ¯«ç§’ã€‚G1 ä¼šå°½é‡å°†å•æ¬¡åœé¡¿æ§åˆ¶åœ¨è¿™ä¸ªç›®æ ‡é™„è¿‘ï¼ˆä¸æ˜¯ç¡¬ä¿è¯ï¼‰ã€‚
-XX:+AlwaysPreTouch

åœ¨å¯åŠ¨æ—¶é¢„è§¦è¾¾å¹¶æ˜ å°„æ•´ä¸ªå †å†…å­˜ï¼Œé¿å…è¿è¡Œæ—¶æŒ‰éœ€åˆ†é…é€ æˆçš„é¡µé”™è¯¯å’ŒæŠ–åŠ¨ï¼›é€‚åˆå¯¹å»¶è¿Ÿæ•æ„Ÿçš„æœåŠ¡ã€‚
-Xms8g

åˆå§‹å †å¤§å° 8GBã€‚ä¸ Xmx é…åˆä½¿ç”¨èƒ½å‡å°‘å †æ‰©ç¼©å®¹å¸¦æ¥çš„åœé¡¿å’Œç¢ç‰‡é—®é¢˜ã€‚
-Xmx8g

æœ€å¤§å †å¤§å° 8GBã€‚ä¸ Xms ä¸€æ ·è®¾ç½®ä¸º 8GBï¼Œä¿æŒå›ºå®šå †ï¼Œé™ä½åŠ¨æ€æ‰©å®¹çš„æŠ–åŠ¨ã€‚
-XX:+ParallelRefProcEnabled

å¼€å¯å¹¶è¡Œå¼•ç”¨å¤„ç†ï¼ˆå¦‚ Weak/Soft/Phantom å¼•ç”¨ï¼‰ï¼Œç¼©çŸ­ GC æ—¶è¿™éƒ¨åˆ†å¤„ç†çš„å¼€é”€ã€‚
-XX:+UnlockExperimentalVMOptions

è§£é”å®éªŒæ€§é€‰é¡¹ã€‚ä¸ºä½¿ç”¨æŸäº›ä»æ ‡è®°ä¸ºå®éªŒçš„å‚æ•°åšå‡†å¤‡ï¼ˆåœ¨ç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨ï¼‰ã€‚
-XX:+DisableExplicitGC

ç¦ç”¨æ˜¾å¼ GCï¼ˆä¾‹å¦‚ System.gc()ï¼‰ã€‚é¿å…åº”ç”¨ä»£ç æˆ–ç¬¬ä¸‰æ–¹åº“ä¸»åŠ¨è§¦å‘ Full GCã€‚
-XX:+PerfDisableSharedMem

å…³é—­ JVM çš„å…±äº«å†…å­˜æ€§èƒ½æ•°æ®è¾“å‡ºï¼Œå‡å°‘è½»å¾®çš„ç³»ç»Ÿèµ„æºå ç”¨ã€‚ä¸€èˆ¬å¯¹æ€§èƒ½å½±å“å¾ˆå°ã€‚
-XX:+ExitOnOutOfMemoryError

ä¸€æ—¦å‡ºç° OOMï¼Œè¿›ç¨‹ç›´æ¥é€€å‡ºè€Œä¸æ˜¯ç»§ç»­è¿è¡Œï¼Œä¾¿äºå®¹å™¨/ç¼–æ’ç³»ç»Ÿé‡å¯ï¼Œé¿å…â€œåŠæ­»ä¸æ´»â€çš„çŠ¶æ€ã€‚
-XX:+HeapDumpOnOutOfMemoryError

å‘ç”Ÿ OOM æ—¶è‡ªåŠ¨ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶ï¼Œä¾¿äºäº‹ååˆ†æå†…å­˜æ³„æ¼æˆ–å¯¹è±¡è†¨èƒ€ã€‚
-XX:HeapDumpPath=./heapdump.hprof

æŒ‡å®šå †è½¬å‚¨æ–‡ä»¶è·¯å¾„ã€‚ç¡®ä¿è·¯å¾„å¯å†™ï¼Œç£ç›˜æœ‰è¶³å¤Ÿç©ºé—´ã€‚
-Xlog:gc*,safepoint:file=./gc.log:time,uptime,level,tags

æ‰“å¼€ GC å’Œå®‰å…¨ç‚¹æ—¥å¿—ï¼Œè¾“å‡ºåˆ° gc.logã€‚åŒ…å«æ—¶é—´ã€è¿è¡Œæ—¶é•¿ã€çº§åˆ«ã€æ ‡ç­¾ï¼Œä¾¿äºåˆ†æåœé¡¿ã€å›æ”¶è¡Œä¸ºå’Œåˆ†é…çŠ¶å†µã€‚
```

è¯´æ˜ï¼š

- Xmsâ‰ˆXmx é¿å…å †åŠ¨æ€æ‰©ç¼©å®¹æŠ–åŠ¨ã€‚
- MaxGCPauseMillis è®¾æœŸæœ›åœé¡¿ç›®æ ‡ï¼ŒG1ä¼šå°½é‡è´´è¿‘ã€‚
- å¼€å¯ GC æ—¥å¿—ï¼Œæ–¹ä¾¿éªŒè¯ã€‚

æ–¹æ¡ˆBï¼šZGCï¼ˆJDK17+ï¼Œä½åœé¡¿ï¼‰

```bash
-XX:+UseZGC
-Xms8g
-Xmx8g
-XX:+AlwaysPreTouch
-XX:+ZUncommit
-XX:+ExitOnOutOfMemoryError
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=./heapdump.hprof
-Xlog:gc*,safepoint:file=./gc.log:time,uptime,level,tags
```



æ­¥éª¤6ï¼šæ‰“å¼€ç›‘æ§ï¼Œç¡®è®¤â€œç¡®å®å°‘åˆ†é…ã€å°‘åœé¡¿â€ æœ€å¿«æœ€ç®€å•çš„ä¸¤ç§ï¼š

A. JFRï¼ˆé£è¡Œè®°å½•å™¨ï¼Œå‡ ä¹é›¶ä¾µå…¥ï¼‰

- å¯åŠ¨å‚æ•°åŠ ï¼š -XX:StartFlightRecording=filename=./app.jfr,duration=120s,settings=profile
- è·‘ä¸€æ®µå‹æµ‹åï¼Œç”¨ JDK Mission Control æ‰“å¼€ app.jfrï¼Œçœ‹ï¼š
  - Allocation in new TLAB / outside TLABï¼ˆæ¯ç§’åˆ†é…ç‡ï¼‰
  - GC Pausesï¼ˆåœé¡¿æ—¶é—´ï¼‰
  - Hot Methodsï¼ˆçƒ­ç‚¹æ–¹æ³•æ˜¯å¦è¿˜æœ‰ newï¼‰

B. GC æ—¥å¿—å¿«é€Ÿçœ‹ç‚¹

- æ‰“å¼€ä¸Šè¿° -Xlog å‚æ•°åï¼Œå‹æµ‹ä¸€æ®µï¼Œå†çœ‹ gc.logï¼š
  - åœé¡¿æ¡ç›®æ˜¯å¦å‡å°‘
  - G1 çš„ Young/Mixed GC æ¬¡æ•°æ˜¯å¦ä¸‹é™
  - åœé¡¿æ—¶é—´æ˜¯å¦é™ä½ï¼ˆms æ€»é‡å’Œ P95ï¼‰

æ­¥éª¤7ï¼šæŠŠâ€œå¾ªç¯é‡Œä¸ newâ€è½å®åˆ°ä»£ç è‡ªæŸ¥æ¸…å•

- ç­–ç•¥ä¸»å¾ªç¯å†…ä¸å¾—å‡ºç°ï¼š
  - new å¯¹è±¡ã€è£…ç®±ç±»å‹ï¼ˆDouble/Longï¼‰ã€Streams/Lambdaã€String.format
- æ•°æ®ç»“æ„ä¸å¾—ä½¿ç”¨ï¼š
  - List/Map<Long,Double> ç­‰è£…ç®±é›†åˆã€‚å¿…è¦æ—¶ç”¨ fastutilï¼ˆå¦‚ Long2DoubleOpenHashMapï¼‰ï¼Œæˆ–è€…ç›´æ¥æ•°ç»„ã€‚
- æŒ‡æ ‡ä¸ä¸­é—´ç»“æœï¼š
  - åœ¨ç­–ç•¥å¼€å§‹æ—¶ä¸€æ¬¡æ€§ new å¥½æ‰€æœ‰ out[]ã€ä¸´æ—¶çª—å£æ•°ç»„ï¼Œå­˜åˆ° context é‡Œï¼›ç»“æŸæ—¶ä¸¢å¼ƒæˆ–å¤ç”¨ã€‚
- æ—¥å¿—ï¼š
  - çƒ­è·¯å¾„ç¦æ—¥å¿—ï¼Œæˆ–å»¶è¿Ÿæ—¥å¿—ï¼šlogger.debug("...", () -> lazySupplier());







#### å°‘ new å¯¹è±¡ã€å°‘ç”¨åŒ…è£…ç±»ã€å¤šç”¨æ•°ç»„åˆ°åº•è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿèƒ½çœ‹åˆ°å“ªäº›ç›´è§‚å˜åŒ–ï¼Ÿ

è§£å†³çš„é—®é¢˜

- **é™ä½åˆ†é…ç‡**ï¼šæ¯æ¬¡ new éƒ½è¦åœ¨çº¿ç¨‹æœ¬åœ°ç¼“å†²åŒºï¼ˆTLABï¼‰æˆ–å †ä¸Šç”³è¯·ç©ºé—´ï¼Œ**åˆ†é…ç‡è¶Šé«˜ï¼Œå¹´è½»ä»£å›æ”¶è¶Šé¢‘ç¹ï¼›å‡å°‘ new å°±èƒ½é™ä½ GC é¢‘æ¬¡**ã€‚
- **å‡å°‘åœé¡¿æ—¶é—´**ï¼šå¹´è½»ä»£ Minor GC å’Œæ··åˆå›æ”¶éƒ½ä¼šå¼•èµ·æš‚åœï¼›**åˆ†é…å°‘ã€çŸ­å‘½å¯¹è±¡å°‘ï¼ŒGC æ¬¡æ•°å’Œåœé¡¿æ€»æ—¶é•¿éƒ½ä¼šä¸‹é™**ã€‚
- **æ¶ˆé™¤è£…ç®±/æ‹†ç®±å¼€é”€**ï¼šåŒ…è£…ç±»ï¼ˆDoubleã€Longï¼‰**ä¼šäº§ç”Ÿé¢å¤–å¯¹è±¡**ï¼Œä¸”æ‹†ç®±æœ‰æ–¹æ³•è°ƒç”¨ä¸ç©ºæŒ‡é’ˆé£é™©ï¼›**ç”¨åŸå§‹ç±»å‹æ•°ç»„é¿å…è¿™äº›å¼€é”€ã€‚**
- **æ”¹å–„ CPU cache** å‹å¥½æ€§ï¼š**æ•°ç»„æ˜¯è¿ç»­å†…å­˜ï¼Œçº¿æ€§éå†å‘½ä¸­ç‡æ›´é«˜ï¼›å¯¹è±¡åˆ—è¡¨æ˜¯æŒ‡é’ˆè·³è½¬ï¼Œå®¹æ˜“é€ æˆç¼“å­˜ä¸å‘½ä¸­å’Œåˆ†æ”¯å¼€é”€ã€‚**
- **é™ä½å†…å­˜å ç”¨ä¸ç¢ç‰‡**ï¼š**å¯¹è±¡å¤´ã€å¯¹é½ã€æŒ‡é’ˆç­‰æœ‰é¢å¤–å¼€é”€ï¼›åŸå§‹æ•°ç»„æ›´ç´§å‡‘ï¼Œæ•´ä½“å †å‹åŠ›æ›´ä½ã€‚**
- **æé«˜æ‰¹é‡è®¡ç®—æ•ˆç‡**ï¼šæ•°ç»„ä¾¿äºä¸€æ¬¡æ€§å‘é‡åŒ–/æ‰¹é‡å¤„ç†ï¼Œå‡å°‘æ–¹æ³•è°ƒç”¨å’Œè¿­ä»£å™¨ç­‰éšæ€§å¯¹è±¡åˆ›å»ºã€‚

èƒ½çœ‹åˆ°çš„ç›´è§‚å˜åŒ–ï¼ˆå¦‚ä½•éªŒè¯ï¼‰

- GC æ—¥å¿—é‡Œçš„æŒ‡æ ‡ï¼š
  - Young/Mixed GC æ¬¡æ•°å‡å°‘ã€‚
  - å•æ¬¡åœé¡¿æ—¶é—´ç¼©çŸ­ï¼Œæ€»åœé¡¿æ—¶é—´ä¸‹é™ã€‚
  - å †å ç”¨æ›²çº¿æ›´ç¨³å®šï¼Œå³°å€¼æ›´ä½ã€‚
- JFRï¼ˆJava Flight Recorderï¼‰é‡Œçš„å›¾è¡¨ï¼š
  - Allocation Rateï¼ˆæ¯ç§’åˆ†é…é€Ÿç‡ï¼‰æ˜æ˜¾ä¸‹é™ã€‚
  - GC Pausesï¼ˆåœé¡¿ï¼‰å³°å€¼å’Œå¹³å‡å€¼ä¸‹é™ã€‚
  - Hot Methods ä¸­ä¸ newã€è£…ç®±ç›¸å…³çš„çƒ­ç‚¹æ¶ˆå¤±æˆ–é€€å±…æ¬¡è¦ã€‚
- æ€§èƒ½æŒ‡æ ‡ï¼š
  - P95/P99 è¯·æ±‚æˆ–ä»»åŠ¡å»¶è¿Ÿé™ä½ã€‚
  - ååé‡ï¼ˆæ¯ç§’å¤„ç†çš„æ¡æ•°/ä»»åŠ¡æ•°ï¼‰æå‡ã€‚
  - CPU ä½¿ç”¨æ›´ç¨³å®šã€æŠ–åŠ¨å‡å°‘ã€‚
- è¿è¡Œæ—¶è§‚æµ‹ï¼š
  - safepoint æ¬¡æ•°å‡å°‘ï¼ˆXlog:safepoint å¯çœ‹åˆ°ï¼‰ã€‚
  - ç±»å®ä¾‹ç›´æ–¹å›¾å¯¹è±¡æ•°é‡é™ä½ï¼ˆjcmd VM.class_histo æˆ– jmap -histo çœ‹åˆ° Double/Longã€Bar ç­‰å¯¹è±¡æ•°é‡æ˜æ˜¾å°‘ï¼‰ã€‚
- å†…å­˜å ç”¨ï¼š
  - è¿›ç¨‹å¸¸é©»å†…å­˜ï¼ˆRSSï¼‰æ›´ä½ã€æ›´ç¨³å®šã€‚
  - å †ç›´æ–¹å›¾æ˜¾ç¤ºåŸå§‹æ•°ç»„æ•°é‡å¢åŠ ã€é›¶ç¢å°å¯¹è±¡å‡å°‘ã€‚

ç®€å•å®æ“å»ºè®®ï¼Œç¡®ä¿ä½ èƒ½â€œçœ‹è§å˜åŒ–â€

- åŠ ä¸Šå‰é¢çš„ -Xlog å‚æ•°ï¼Œè·‘åŒæ ·å‹æµ‹åœºæ™¯ï¼Œæ¯”è¾ƒä¼˜åŒ–å‰å gc.logï¼š
  - ç»Ÿè®¡ GC æ¬¡æ•°ä¸æ€»æš‚åœæ—¶é—´ã€‚
- å¼€å¯ JFRï¼Œå½• 2â€“5 åˆ†é’Ÿå‹æµ‹ï¼š
  - çœ‹ Allocation Rateï¼ˆä¼˜åŒ–ååº”è¯¥æ˜¾è‘—é™ä½ï¼‰ã€‚
  - çœ‹ GC Pauseï¼ˆä¼˜åŒ–åå³°å€¼ä¸å¹³å‡ä¸‹é™ï¼‰ã€‚
- ç”¨ jcmd æˆ– jmap åšä¸€æ¬¡å¯¹è±¡ç›´æ–¹å›¾ï¼š
  - ä¼˜åŒ–å Doubleã€Longã€Bar ç±»å®ä¾‹æ•°é‡åº”å‡å°‘ï¼›åŸå§‹æ•°ç»„æ•°é‡å¯èƒ½å¢åŠ ä½†æ€»å¤§å°æ›´å¯æ§ã€‚
- åº”ç”¨å±‚æŒ‡æ ‡ï¼š
  - è®°å½•å¤„ç†é€Ÿç‡ã€P95/P99 å»¶è¿Ÿï¼Œå‰åå¯¹æ¯”ã€‚

ä¸€å¥è¯æ€»ç»“

- å°‘ newã€å°‘åŒ…è£…ç±»ã€å¤šç”¨æ•°ç»„ï¼Œä¼šç›´æ¥é™ä½å†…å­˜åˆ†é…å’Œ GC åœé¡¿ï¼Œæå‡ç¼“å­˜å‘½ä¸­å’Œæ‰¹é‡è®¡ç®—æ•ˆç‡ã€‚ç»“æœå°±æ˜¯å»¶è¿Ÿæ›´ä½ã€ååæ›´é«˜ã€å †æ›´ç¨³å®šï¼Œè€Œä¸”è¿™äº›å˜åŒ–å¯ä»¥é€šè¿‡ GC æ—¥å¿—ã€JFRã€å¯¹è±¡ç›´æ–¹å›¾å’Œä½ çš„ä¸šåŠ¡æŒ‡æ ‡æ¸…æ¥šçœ‹åˆ°ã€‚







## æµé‡æ§åˆ¶(QPS)ã€ç†”æ–­é™çº§

### æ¦‚å¿µ

ç®€è¦å™è¿°ï¼ˆåŸºäº Sentinelï¼‰

æµé‡æ§åˆ¶ FlowRule
- å®šä¹‰ï¼šå¯¹èµ„æºçš„è®¿é—®é€Ÿç‡æˆ–å¹¶å‘æ•°è¿›è¡Œé™åˆ¶ï¼Œé¿å…ç¬æ—¶æµé‡å†²å‡»ä¸‹æ¸¸æˆ–è€—å°½æœ¬åœ°èµ„æºã€‚
- æ ¸å¿ƒç»´åº¦
  - é™æµç²’åº¦ï¼šæŒ‰èµ„æºåç»´åº¦ã€‚
  - ç»Ÿè®¡å£å¾„ï¼šQPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰æˆ–å¹¶å‘çº¿ç¨‹æ•°ï¼ˆTHREADï¼‰ã€‚
  - é˜ˆå€¼ countï¼šè¾¾åˆ°åè§¦å‘é™æµã€‚
  - æ§åˆ¶è¡Œä¸º controlBehaviorï¼š
    - Defaultï¼ˆç›´æ¥æ‹’ç»ï¼Œå¿«é€Ÿå¤±è´¥ï¼‰ã€‚
    - WarmUpï¼ˆé¢„çƒ­ï¼Œå†·å¯åŠ¨é˜¶æ®µé€æ­¥æå‡é˜ˆå€¼ï¼Œé¿å…åˆšå¯åŠ¨è¢«æ‰“çˆ†ï¼‰ã€‚
    - RateLimiter/Queueingï¼ˆæ’é˜Ÿç­‰å¾…ï¼Œæœ€é•¿ç­‰å¾…æ—¶é—´ maxQueueingTimeMsï¼Œå¹³æ»‘è¿›å…¥ï¼‰ã€‚
  - ç­–ç•¥ strategyï¼š
    - Directï¼ˆä»…å¯¹å½“å‰èµ„æºï¼‰ã€‚
    - Relateï¼ˆå…³è”èµ„æºçš„æµé‡ä¹Ÿå½±å“å½“å‰èµ„æºï¼‰ã€‚
    - Chainï¼ˆæŒ‰è°ƒç”¨é“¾é™æµï¼ŒåŒºåˆ†å…¥å£å¹¶å‘è·¯å¾„ï¼‰ã€‚
  - é›†ç¾¤å‚æ•°ï¼ˆé€‰ç”¨ï¼‰ï¼šCluster æµæ§ï¼Œç»Ÿä¸€é˜ˆå€¼ã€æœåŠ¡ç«¯ç»´æŒåˆ†å¸ƒå¼ä¸€è‡´æ€§ã€‚
- å¸¸è§åœºæ™¯
  - çƒ­ç‚¹æ¥å£è®¾ QPS é˜ˆå€¼ï¼Œè¶…é™å¿«é€Ÿå¤±è´¥æˆ–æ’é˜Ÿã€‚
  - å†·å¯åŠ¨/ä¿ƒé”€å‰é¢„çƒ­ï¼Œé¿å…ç¬æ—¶é«˜å³°æŠŠä¾èµ–æ‰“è¶´ã€‚
  - è¯»æ¥å£ç”¨æ’é˜Ÿé™æµæå‡æ•´ä½“å¹³æ»‘åº¦ï¼Œå†™æ¥å£ç”¨ç›´æ¥æ‹’ç»ä¿æŠ¤æ•°æ®åº“ã€‚
- å…³é”®å‚æ•°ç¤ºä¾‹
  - grade=QPSï¼Œcount=1000ï¼ŒcontrolBehavior=WarmUpï¼ŒwarmUpPeriodSec=10
  - grade=QPSï¼Œcount=300ï¼ŒcontrolBehavior=RateLimiterï¼ŒmaxQueueingTimeMs=200

ç†”æ–­é™çº§ DegradeRule
- å®šä¹‰ï¼šå½“èµ„æºå‡ºç°ä¸ç¨³å®šï¼ˆé«˜é”™è¯¯ç‡æˆ–é«˜å“åº”æ—¶é—´ï¼‰æ—¶ï¼Œä¸´æ—¶ä¸­æ–­å¯¹è¯¥èµ„æºçš„è°ƒç”¨ï¼Œå¿«é€Ÿå¤±è´¥å¹¶åœ¨ä¸€æ®µæ—¶é—´åå°è¯•æ¢å¤ï¼Œä¿æŠ¤ç³»ç»Ÿã€‚
- ç†”æ–­è§¦å‘ç­–ç•¥
  - RTï¼ˆæ…¢è°ƒç”¨æ¯”ä¾‹ï¼‰ï¼šåœ¨ç»Ÿè®¡çª—å£å†…ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡é˜ˆå€¼ä¸”è¯·æ±‚é‡è¾¾åˆ°æœ€å°æ•°ï¼Œåˆ™ç†”æ–­ã€‚
  - ExceptionRatioï¼ˆå¼‚å¸¸æ¯”ä¾‹ï¼‰ï¼šå¼‚å¸¸å æ¯”è¶…é˜ˆå€¼ä¸”è¯·æ±‚é‡è¾¾åˆ°æœ€å°æ•°ï¼Œåˆ™ç†”æ–­ã€‚
  - ExceptionCountï¼ˆå¼‚å¸¸æ¬¡æ•°ï¼‰ï¼šå›ºå®šçª—å£å†…å¼‚å¸¸æ¬¡æ•°è¶…è¿‡é˜ˆå€¼åˆ™ç†”æ–­ã€‚
- æ ¸å¿ƒå‚æ•°
  - countï¼šé˜ˆå€¼ï¼ˆä¸åŒç­–ç•¥æ„ä¹‰ä¸åŒï¼Œå¦‚æ…¢è°ƒç”¨æ¯”ä¾‹/å¼‚å¸¸æ¯”ä¾‹/å¼‚å¸¸æ¬¡æ•°ï¼‰ã€‚
  - timeWindowï¼šç†”æ–­æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œåˆ°æœŸè¿›å…¥åŠå¼€å°è¯•æ¢å¤ã€‚
  - minRequestAmountï¼šæœ€å°è¯·æ±‚æ•°ï¼Œä½æµé‡ä¸è¯¯åˆ¤ã€‚
  - statIntervalMsï¼šç»Ÿè®¡çª—å£æ—¶é•¿ã€‚
  - slowRatioThresholdï¼šæ…¢è°ƒç”¨æ¯”ä¾‹é˜ˆå€¼ï¼ˆRT ç­–ç•¥ï¼‰ã€‚
- è¡Œä¸ºä¸æ¢å¤
  - ç†”æ–­æœŸé—´è¯·æ±‚ç›´æ¥è¢«æ‹’ç»æˆ–èµ°é™çº§é€»è¾‘ï¼ˆfallbackï¼‰ã€‚
  - åˆ°æœŸååŠå¼€ï¼ˆå°‘é‡æ¢æµ‹è¯·æ±‚ï¼‰ï¼Œè‹¥æ¢å¤æ­£å¸¸åˆ™å…³é—­ç†”æ–­ï¼Œå¦åˆ™ç»§ç»­ç†”æ–­ã€‚
- å¸¸è§åœºæ™¯
  - ä¸‹æ¸¸å¶å‘å˜æ…¢ï¼šRT ç­–ç•¥ï¼ŒtimeWindow=5â€“30sï¼Œé¿å…çº§è”é˜»å¡ã€‚
  - ä¸‹æ¸¸é”™è¯¯é£™å‡ï¼šExceptionRatio æˆ– ExceptionCountï¼Œå¿«é€Ÿåˆ‡æ–­ï¼Œèµ°é™çº§å…œåº•ã€‚
- é…ç½®ç¤ºä¾‹è¦ç‚¹
  - statIntervalMs æ ¹æ®æ¥å£ç‰¹æ€§è®¾ç½®ï¼ˆå¦‚ 1â€“5sï¼‰ã€‚
  - minRequestAmount é˜²æ­¢ä½æµé‡ä¸‹æŠ–åŠ¨è¯¯è§¦å‘ã€‚
  - ä¸ºè¯»å†™æ¥å£åˆ†åˆ«è®¾ç½®ä¸åŒé˜ˆå€¼ä¸ç†”æ–­çª—å£ã€‚

ä¸¤è€…å·®å¼‚ä¸é…åˆ
- FlowRuleæ˜¯â€œé™é€Ÿ/æ§é‡â€ï¼Œé¢å‘â€œæ­£å¸¸ä½†è¿‡å¤šâ€çš„æµé‡ï¼›DegradeRuleæ˜¯â€œç†”æ–­/è‡ªä¿æŠ¤â€ï¼Œé¢å‘â€œå¼‚å¸¸å˜æ…¢æˆ–æŠ¥é”™â€çš„æœåŠ¡ã€‚
- ç»„åˆç”¨æ³•ï¼šå…ˆç”¨ FlowRule ç¨³å®šå…¥å£æµé‡ï¼Œå†ç”¨ DegradeRule åœ¨ä¸‹æ¸¸ä¸ç¨³æ—¶å¿«é€Ÿé™çº§ï¼Œé¿å…é›ªå´©ã€‚





### ä»£ç ç¤ºä¾‹

ä¸€ä¸ªâ€œéå¸¸ç®€å•â€çš„ Sentinel ä»£ç ç¤ºä¾‹ï¼ŒåŒ…å« FlowRuleï¼ˆé™æµï¼‰å’Œ DegradeRuleï¼ˆç†”æ–­é™çº§ï¼‰çš„æœ€å°å¯è¿è¡Œæ¼”ç¤ºã€‚å¤åˆ¶åˆ°ä¸€ä¸ª Main ç±»å³å¯è·‘é€šã€‚

ä¾èµ–ï¼ˆMavenï¼‰

- groupId: com.alibaba.csp
- artifactId: sentinel-core
- version: 1.8.6ï¼ˆæˆ–æ›´é«˜ï¼‰



>ç¤ºä¾‹ä»£ç ï¼ˆå•æ–‡ä»¶ï¼‰

```java
package com.hao.datacollector.integration.sentinel;

import com.alibaba.csp.sentinel.Entry;
import com.alibaba.csp.sentinel.SphU;
import com.alibaba.csp.sentinel.Tracer;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.csp.sentinel.slots.block.RuleConstant;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRuleManager;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ThreadLocalRandom;

/*
å®ç°æ€è·¯æ¦‚è¿°ï¼ˆSentinel FlowRule + DegradeRule æç®€æ¼”ç¤ºï¼‰

èƒŒæ™¯ï¼šç”¨ Sentinel åœ¨å•è¿›ç¨‹é‡Œä¸ºä¸€ä¸ªèµ„æºè®¾ç½®â€œé™æµâ€å’Œâ€œç†”æ–­é™çº§â€ï¼Œå¹¶é€šè¿‡ç®€å•çš„éšæœºæ…¢è°ƒç”¨/å¼‚å¸¸æ¥è§¦å‘è§‚å¯Ÿæ•ˆæœã€‚
èµ„æºå®šä¹‰ï¼šç”¨å­—ç¬¦ä¸² RESOURCE ä»£è¡¨å—æ§çš„æ¥å£/æ–¹æ³•ã€‚
é™æµï¼ˆFlowRuleï¼‰ï¼š
ç»´åº¦ï¼šQPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰ã€‚
é˜ˆå€¼ï¼šcount=10ï¼Œè¶…è¿‡åç›´æ¥æ‹’ç»ï¼ˆé»˜è®¤å¿«é€Ÿå¤±è´¥ï¼‰ã€‚
ç›®çš„ï¼šåœ¨æ­£å¸¸åœºæ™¯ä¸‹æ§é€Ÿï¼Œä¿æŠ¤ç³»ç»Ÿä¸è¢«ç¬æ—¶æµé‡å‹å®ã€‚
ç†”æ–­é™çº§ï¼ˆDegradeRuleï¼‰ï¼š
ç­–ç•¥1ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹ï¼ˆRTï¼‰ã€‚å½“ç»Ÿè®¡çª—å£å†…è¯·æ±‚é‡è¾¾åˆ° minRequestAmountï¼Œä¸”â€œæ…¢è°ƒç”¨æ¯”ä¾‹â€è¶…è¿‡ slowRatioThresholdï¼Œå°±ç†”æ–­ timeWindow ç§’ã€‚
æ…¢è°ƒç”¨çš„å®šä¹‰é€šè¿‡ countï¼ˆRTé˜ˆå€¼ï¼Œæ¯«ç§’ï¼‰ç¡®å®šã€‚
ç­–ç•¥2ï¼šå¼‚å¸¸æ¯”ä¾‹ã€‚å¼‚å¸¸å æ¯”è¶…è¿‡é˜ˆå€¼ count æ—¶ç†”æ–­ã€‚
ç›®çš„ï¼šåœ¨ä¸‹æ¸¸å˜æ…¢æˆ–é”™è¯¯ç‡å‡é«˜æ—¶ï¼Œå¿«é€Ÿè‡ªæˆ‘ä¿æŠ¤å¹¶é™çº§ã€‚
è¿è¡Œæµç¨‹ï¼š
å¯åŠ¨æ—¶åˆå§‹åŒ–å¹¶åŠ è½½ FlowRule ä¸ DegradeRuleã€‚
ä¸»å¾ªç¯ä¸­ç”¨ SphU.entry(RESOURCE) è¿›å…¥å—æ§èµ„æºï¼š
æˆåŠŸè¿›å…¥ï¼šæ‰§è¡Œâ€œæ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘â€ï¼Œç”¨éšæœºæ•°åˆ¶é€  5% å¼‚å¸¸ã€20% æ…¢è°ƒç”¨ï¼Œå…¶ä½™æ­£å¸¸ã€‚
è¢«æ‹¦æˆªï¼šæŠ› BlockExceptionï¼Œè¯´æ˜è¢«é™æµæˆ–ç†”æ–­ï¼Œèµ°é™çº§è¾“å‡ºã€‚
ä¸šåŠ¡å¼‚å¸¸ï¼šç”¨ Tracer.trace ä¸ŠæŠ¥ï¼Œå‚ä¸å¼‚å¸¸æ¯”ä¾‹ç†”æ–­ç»Ÿè®¡ã€‚
è§‚æµ‹ç‚¹ï¼š
æ­£å¸¸è¾“å‡ºâ€œokâ€ã€‚
è¶…è¿‡é™æµé˜ˆå€¼æˆ–å¤„äºç†”æ–­çŠ¶æ€æ—¶è¾“å‡ºâ€œblocked: xxxâ€ã€‚
ä¸šåŠ¡å¼‚å¸¸è¾“å‡ºâ€œbiz error: ...â€ï¼Œå¹¶å¯èƒ½è§¦å‘å¼‚å¸¸æ¯”ä¾‹ç†”æ–­ã€‚
å‚æ•°é€‰æ‹©åŸåˆ™ï¼ˆç¤ºä¾‹å€¼ï¼Œéœ€æŒ‰ä¸šåŠ¡å¾®è°ƒï¼‰ï¼š
é™æµ QPS é€‰ç³»ç»Ÿå¯æ‰¿å—çš„ç¨³å®šå€¼ï¼›RTæ…¢é˜ˆå€¼é€‰å…³é”®ä¾èµ–çš„SLAè¾¹ç•Œï¼›minRequestAmountä¸statIntervalMsé˜²æ­¢ä½æµé‡è¯¯åˆ¤ï¼›timeWindowä¸å®œè¿‡é•¿ï¼Œä¾¿äºæ¢å¤ã€‚
*/
public class SentinelDemo {

    private static final String RESOURCE = "demo:api";

    public static void main(String[] args) throws Exception {
        initFlowRules();
        initDegradeRules();

        // ç®€å•æ¨¡æ‹Ÿè¯·æ±‚ 200 æ¬¡
        for (int i = 0; i < 200; i++) {
            try (Entry entry = SphU.entry(RESOURCE)) {
                // ä¸šåŠ¡é€»è¾‘
                // éšæœºåˆ¶é€ æ…¢è¯·æ±‚æˆ–å¼‚å¸¸ï¼Œç”¨äºè§‚å¯Ÿç†”æ–­è§¦å‘
                int r = ThreadLocalRandom.current().nextInt(100);
                if (r < 5) { // 5% æ¦‚ç‡æŠ›å¼‚å¸¸
                    throw new RuntimeException("mock error");
                }
                if (r < 20) { // 20% æ¦‚ç‡å˜æ…¢ï¼Œsleep 300ms
                    Thread.sleep(300);
                } else {
                    Thread.sleep(50);
                }
                System.out.println("ok " + i);
            } catch (BlockException ex) {
                // è¢«é™æµæˆ–ç†”æ–­æ—¶çš„é™çº§é€»è¾‘
                System.out.println("blocked: " + ex.getClass().getSimpleName());
            } catch (Exception bizEx) {
                // è®°å½•ä¸šåŠ¡å¼‚å¸¸ï¼Œä¾¿äºå¼‚å¸¸æ¯”ä¾‹ç†”æ–­ç»Ÿè®¡
                Tracer.trace(bizEx);
                System.out.println("biz error: " + bizEx.getMessage());
            }
        }
    }

    private static void initFlowRules() {
        List<FlowRule> rules = new ArrayList<>();
        FlowRule rule = new FlowRule();
        rule.setResource(RESOURCE);
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS); // æŒ‰ QPS é™æµ
        rule.setCount(10); // é˜ˆå€¼ï¼šæ¯ç§’æœ€å¤š 10 æ¬¡
        // é»˜è®¤è¡Œä¸ºï¼šè¶…é™ç›´æ¥æ‹’ç»ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
        rules.add(rule);
        FlowRuleManager.loadRules(rules);
    }

    private static void initDegradeRules() {
        List<DegradeRule> rules = new ArrayList<>();

        // ç­–ç•¥ä¸€ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹ç†”æ–­ï¼ˆRTï¼‰
        DegradeRule rtRule = new DegradeRule();
        rtRule.setResource(RESOURCE);
        rtRule.setGrade(RuleConstant.DEGRADE_GRADE_RT);
        rtRule.setCount(200);           // æ…¢è°ƒç”¨é˜ˆå€¼ï¼šè¶…è¿‡ 200ms è§†ä¸ºæ…¢
        rtRule.setTimeWindow(5);        // ç†”æ–­æŒç»­ 5 ç§’
        rtRule.setMinRequestAmount(20); // è‡³å°‘ 20 ä¸ªè¯·æ±‚åæ‰è¯„ä¼°
        rtRule.setStatIntervalMs(1000); // ç»Ÿè®¡çª—å£ 1 ç§’
        rtRule.setSlowRatioThreshold(0.5); // æ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡ 50% è§¦å‘ç†”æ–­
        rules.add(rtRule);

        // ç­–ç•¥äºŒï¼šå¼‚å¸¸æ¯”ä¾‹ç†”æ–­
        DegradeRule errRule = new DegradeRule();
        errRule.setResource(RESOURCE);
        errRule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO);
        errRule.setCount(0.3);          // å¼‚å¸¸æ¯”ä¾‹é˜ˆå€¼ 30%
        errRule.setTimeWindow(5);       // ç†”æ–­ 5 ç§’
        errRule.setMinRequestAmount(20);
        errRule.setStatIntervalMs(1000);
        rules.add(errRule);

        DegradeRuleManager.loadRules(rules);
    }
}
```

è¯´æ˜

- FlowRuleï¼šæ¯ç§’æœ€å¤š 10 æ¬¡ï¼Œè¶…é™ç›´æ¥è¢« BlockException æ‹¦æˆªï¼Œè¾“å‡º blockedã€‚
- DegradeRuleï¼š
  - RT ç­–ç•¥ï¼šå½“æœ€è¿‘ 1 ç§’å†…è¯·æ±‚è¾¾åˆ°è‡³å°‘ 20 ä¸ªï¼Œä¸”å…¶ä¸­æ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡ 50%ï¼ˆæ…¢å®šä¹‰ä¸º RT>200msï¼‰åˆ™ç†”æ–­ 5 ç§’ã€‚
  - å¼‚å¸¸æ¯”ä¾‹ç­–ç•¥ï¼šå½“å¼‚å¸¸æ¯”ä¾‹è¶…è¿‡ 30%ï¼Œä¹Ÿç†”æ–­ 5 ç§’ã€‚
- ä¸šåŠ¡å¼‚å¸¸è¯·ç”¨ Tracer.trace(bizEx) ä¸ŠæŠ¥ï¼Œä¾¿äºå¼‚å¸¸æ¯”ä¾‹ç»Ÿè®¡ã€‚
- æ¼”ç¤ºé‡Œç”¨éšæœº sleep/æŠ›å¼‚å¸¸æ¥è§¦å‘ç†”æ–­å’Œé™æµï¼Œä½ ä¼šçœ‹åˆ° okã€blockedã€biz error ä¸‰ç§è¾“å‡ºã€‚













## å›æµ‹å¼•æ“ä¼˜åŒ–æ–¹æ¡ˆï¼ˆç²¾ç®€ç‰ˆï¼‰

### æ¦‚è¦
ç›®æ ‡ï¼šé€šè¿‡å¯¹è±¡å¤ç”¨ã€å‘é‡åŒ–ã€å†…å­˜é¢„åˆ†é…ã€æ•°æ®ç»“æ„ä¼˜åŒ–ä¸å¹¶è¡ŒåŒ–ï¼Œæ˜¾è‘—é™ä½GCä¸å†…å­˜å¼€é”€ï¼Œæé«˜å›æµ‹é€Ÿåº¦ä¸ç¨³å®šæ€§ã€‚å¸¸è§æ”¶ç›Šï¼šæ€§èƒ½æå‡æ•°å€ï¼ŒGCåœé¡¿å’Œå†…å­˜æ³¢åŠ¨å¤§å¹…ä¸‹é™ã€‚

---

### 1. å¯¹è±¡æ± åŒ–ï¼ˆå‡å°‘ new/GCï¼‰
- æ€è·¯ï¼šå¤ç”¨çŸ­å¯¿å‘½æˆ–é«˜é¢‘åˆ›å»ºå¯¹è±¡ï¼Œé¿å…é¢‘ç¹åˆ†é…ä¸å›æ”¶ã€‚
- é€‚ç”¨å¯¹è±¡ï¼šä»·æ ¼/è¡Œæƒ…æ•°æ®ã€è®¢å•ã€äº‹ä»¶ã€ä¸´æ—¶ç¼“å†²å¯¹è±¡ã€‚

ç¤ºä¾‹
```java
public class PriceDataPool {
    private final Queue<PriceData> pool = new ConcurrentLinkedQueue<>();
    private final int maxSize = 10000;

    public PriceData acquire() {
        PriceData d = pool.poll();
        return d != null ? d : new PriceData();
    }

    public void release(PriceData d) {
        if (pool.size() < maxSize) {
            d.reset();
            pool.offer(d);
        }
    }
}
```

å®è·µå»ºè®®
- å¯¹è±¡å°½é‡æä¾› reset æ–¹æ³•ï¼Œé¿å…å¤–éƒ¨å¼•ç”¨æ³„éœ²ã€‚
- å¯¹äºçº¿ç¨‹éš”ç¦»åœºæ™¯ä¼˜å…ˆä½¿ç”¨ ThreadLocal æ± å‡å°‘åŒæ­¥å¼€é”€ã€‚

---

### 2. å‘é‡åŒ–ä¸æ‰¹é‡è®¡ç®—ï¼ˆæé«˜CPUåˆ©ç”¨ï¼‰
- æ€è·¯ï¼šç”¨åŸç”Ÿæ•°ç»„æ›¿ä»£é›†åˆã€é‡‡ç”¨æ»‘åŠ¨çª—å£/æµå¼ç®—æ³•ï¼Œå°½é‡æ‰¹é‡å¤„ç†ï¼Œå¿…è¦æ—¶ä½¿ç”¨ JVM Vector API æˆ–æœ¬åœ°SIMDåº“ã€‚
- å¥½å¤„ï¼šå‡å°‘è£…ç®±/é“¾è¡¨/è¿­ä»£å¼€é”€ï¼Œæå‡ç¼“å­˜å‘½ä¸­ä¸æŒ‡ä»¤å¹¶è¡Œåº¦ã€‚

ç¤ºä¾‹ï¼ˆç§»åŠ¨å¹³å‡ï¼‰
```java
public void movingAvg(double[] prices, double[] out, int w) {
    double sum = 0;
    for (int i = 0; i < w; i++) sum += prices[i];
    out[w-1] = sum / w;
    for (int i = w; i < prices.length; i++) {
        sum += prices[i] - prices[i-w];
        out[i] = sum / w;
    }
}
```

è¿›é˜¶ï¼šåœ¨ Java 17+ å¯ç”¨ Vector API è¿›ä¸€æ­¥åŠ é€Ÿæ•°å€¼è¿ç®—ã€‚

---

### 3. å†…å­˜é¢„åˆ†é…ä¸GCè°ƒä¼˜
- æ€è·¯ï¼šé¢„åˆ†é…å¤§æ•°ç»„/ç¼“å†²åŒºï¼Œå›ºå®šå †å¤§å°ï¼Œä½¿ç”¨åˆé€‚çš„åƒåœ¾å›æ”¶å™¨ä¸å‚æ•°ï¼Œå‡å°‘å †æŒ¯è¡ä¸Full GCã€‚
- å»ºè®® JVM å‚æ•°ï¼ˆç¤ºä¾‹ï¼‰ï¼š
  - -Xms8g -Xmx8g
  - -XX:+UseG1GC -XX:MaxGCPauseMillis=10

ç¤ºä¾‹
```java
private final double[] priceBuffer = new double[1_000_000];
private final double[] tmpBuffer = new double[1_000_000];
```

æ³¨æ„ï¼šæ ¹æ®æœºå™¨å†…å­˜ä¸æ•°æ®è§„æ¨¡è°ƒæ•´é¢„åˆ†é…å¤§å°ï¼Œé¿å…OOMã€‚

---

### 4. æ•°æ®ç»“æ„ä¸å†…å­˜ç´§å‡‘è®¾è®¡
- åŸåˆ™ï¼šä¼˜å…ˆä½¿ç”¨åŸå§‹ç±»å‹æ•°ç»„æˆ–ç¬¬ä¸‰æ–¹åŸå§‹é›†åˆï¼ˆfastutilï¼‰ï¼Œé¿å…è£…ç®±ã€‚
- ä½¿ç”¨ç´§å‡‘ç»“æ„ï¼ˆstruct-likeã€ä½æ‰“åŒ…ï¼‰å‡å°‘å†…å­˜å ç”¨ä¸GCå¯¹è±¡æ•°ã€‚

ç¤ºä¾‹
```java
// ä½¿ç”¨fastutilé¿å…Doubleè£…ç®±
private final it.unimi.dsi.fastutil.doubles.DoubleArrayList prices = new DoubleArrayList();
```

æˆ–æ‰“åŒ…ç»“æ„
```java
public class CompactTrade {
    public long packed; // æ‰“åŒ…å­˜æ—¶é—´/ä»·æ ¼/æ•°é‡
}
```

---

### 5. å¹¶è¡ŒåŒ–å¤„ç†ï¼ˆå¤šæ ¸åˆ©ç”¨ï¼‰
- æ€è·¯ï¼šæŒ‰ç­–ç•¥æˆ–æ—¶é—´åŒºé—´æ‹†åˆ†ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œæˆ–é’ˆå¯¹å¤šç­–ç•¥å¹¶è¡Œå›æµ‹ï¼Œä¿æŒçº¿ç¨‹å†…å¯¹è±¡æ± /ç¼“å†²åŒºéš”ç¦»ã€‚
- æ³¨æ„ï¼šé¿å…å…±äº«å¯å˜çŠ¶æ€é€ æˆé”ç«äº‰ï¼›ä½¿ç”¨ ForkJoinPool æˆ– parallelStreamã€‚

ç¤ºä¾‹
```java
strategies.parallelStream().forEach(s -> {
    ThreadLocalPool pool = getPool();
    runStrategy(s, pool);
});
```

---

### 6. å…¸å‹ä¼˜åŒ–æ•ˆæœï¼ˆç»éªŒå€¼ï¼‰
- å¯¹è±¡å¤ç”¨ + å‘é‡åŒ– +é¢„åˆ†é…ï¼šå›æµ‹æ—¶é—´å¸¸è§æå‡ 3-10x
- GC é¢‘ç‡ï¼šä»æ¯ç§’å‡ åæ¬¡é™åˆ°æ¯åˆ†é’Ÿå‡ æ¬¡
- å†…å­˜ä½¿ç”¨ï¼šæ›´å¹³ç¨³ï¼Œå³°å€¼æ˜¾è‘—é™ä½

å®é™…æ”¶ç›Šè§†æ•°æ®è§„æ¨¡ã€ç®—æ³•å¤æ‚åº¦ä¸ç¡¬ä»¶è€Œå®šï¼Œéœ€é€šè¿‡å‹æµ‹éªŒè¯ã€‚

---

### æœ€ä½³å®è·µè¦ç‚¹
1. ä¼˜å…ˆå®šä½çƒ­ç‚¹åˆ†é…ç‚¹ï¼ˆåˆ†é…å‰–æå™¨/async-profilerï¼‰ã€‚
2. å…ˆåšä½é£é™©æ”¹é€ ï¼šç”¨æ•°ç»„æ›¿æ¢ Listã€å¤ç”¨ä¸´æ—¶ç¼“å†²åŒºã€‚
3. å¯¹å…³é”®å¾ªç¯ä½¿ç”¨æ‰¹é‡/å‘é‡åŒ–ç®—æ³•ï¼ˆæ»‘åŠ¨çª—å£ã€æµå¼èšåˆï¼‰ã€‚
4. å¯¹é«˜é¢‘å°å¯¹è±¡é‡‡ç”¨å¯¹è±¡æ± æˆ– ThreadLocal æ± ï¼›è°¨æ…ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚
5. å¹¶è¡ŒåŒ–æ—¶ä¿è¯çº¿ç¨‹éš”ç¦»èµ„æºï¼Œé¿å…é”/å†…å­˜æŠ–åŠ¨ã€‚
6. å¼•å…¥æŒ‡æ ‡ä¸å‹æµ‹ï¼šæµ‹å‰/æµ‹åå¯¹æ¯”ï¼ˆæ—¶é—´ã€GCã€å†…å­˜ã€CPUã€å»¶è¿Ÿåˆ†å¸ƒï¼‰ã€‚
7. åˆ†é˜¶æ®µä¸Šçº¿ï¼šå…ˆåœ¨ dev/test ç°åº¦ï¼ŒæŒç»­ç›‘æ§å†æ¨å¹¿åˆ°ç”Ÿäº§ã€‚

---

### å‚è€ƒæ£€æŸ¥è¡¨ï¼ˆéƒ¨ç½²å‰ï¼‰
- [ ] å·²å®šä½å¹¶ä¼˜åŒ–ä¸»è¦å¯¹è±¡åˆ†é…çƒ­ç‚¹
- [ ] å…³é”®æ•°æ®ä½¿ç”¨åŸç”Ÿæ•°ç»„æˆ–åŸå§‹é›†åˆ
- [ ] å¯¹è±¡æ± ä¸ reset æ–¹æ³•å·²æµ‹è¯•æ— æ³„éœ²
- [ ] JVM å †ä¸ GC å‚æ•°å·²è°ƒä¼˜å¹¶é€šè¿‡å‹æµ‹éªŒè¯
- [ ] å¹¶è¡ŒåŒ–è®¾è®¡é¿å…é”ç«äº‰ï¼Œçº¿ç¨‹éš”ç¦»å…±äº«èµ„æº
- [ ] æŒ‡æ ‡ï¼ˆæ‰§è¡Œæ—¶é•¿/GC/å†…å­˜/CPUï¼‰æ¥å…¥ç›‘æ§å¹¶å¯è§†åŒ–

---

ä»¥ä¸Šä¸ºç²¾ç®€ç‰ˆå›æµ‹å¼•æ“ä¼˜åŒ–æ–¹æ¡ˆã€‚å¦‚éœ€æˆ‘æŠŠæŸä¸€éƒ¨åˆ†æ‰©å±•ä¸ºå¯ç›´æ¥æ›¿æ¢åˆ°å·¥ç¨‹çš„å®Œæ•´å®ç°ï¼ˆå«å¯¹è±¡æ± é€šç”¨ç±»ã€å‘é‡åŒ–å·¥å…·ã€å‹æµ‹è„šæœ¬ä¸æŒ‡æ ‡ dashboard é…ç½®ï¼‰ï¼Œå‘Šè¯‰æˆ‘ä½ å½“å‰è¯­è¨€/JVM ç‰ˆæœ¬ä¸å›æµ‹è§„æ¨¡ï¼ˆæ•°æ®é‡ã€ç­–ç•¥æ•°ã€å•æ¬¡å›æµ‹ç›®æ ‡æ—¶é—´ï¼‰ã€‚











### é—®é¢˜



#### æˆ‘ç†è§£ä¸ç®¡ä½ newé›†åˆå’ŒåŸç”Ÿæ•°ç»„éƒ½æ˜¯è¦åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œéƒ½ä¼šå¯¼è‡´GCè¿è½¬ï¼Œæˆ‘ä¸å¤ªç†è§£è¿™é‡Œä¼˜åŒ–çš„ç‚¹åˆ°åº•åœ¨å“ªé‡Œï¼Ÿ

##### 1ï¸âƒ£ å…±åŒç‚¹

ä½ è¯´å¾—æ²¡é”™ï¼š

- ä¸ç®¡æ˜¯ `new int[]` è¿˜æ˜¯ `new ArrayList<Integer>`ï¼Œéƒ½è¦åœ¨ **å †ä¸Šåˆ†é…å†…å­˜**ã€‚
- éƒ½ä¼šè¢« GC ç®¡ç†ï¼Œæ‰€ä»¥ç†è®ºä¸Šéƒ½ä¼šå¢åŠ  GC å‹åŠ›ã€‚

æ‰€ä»¥ä¼˜åŒ–çš„ç‚¹ **ä¸åœ¨äºâ€œè¦ä¸è¦ GCâ€ï¼Œè€Œåœ¨äºâ€œGC å‹åŠ›å’Œ CPU æ¶ˆè€—çš„å¤§å°â€**ã€‚

------

##### 2ï¸âƒ£ å·®å¼‚ç‚¹ï¼ˆä¸ºä»€ä¹ˆæ•°ç»„æ›´é«˜æ•ˆï¼‰

**ï¼ˆ1ï¼‰å†…å­˜å¸ƒå±€**

- **åŸç”Ÿæ•°ç»„**ï¼šå…ƒç´ æ˜¯ç´§å‡‘è¿ç»­çš„å†…å­˜å—ï¼ŒCPU ç¼“å­˜å‘½ä¸­ç‡é«˜ï¼Œèƒ½è®© CPU æŒ‡ä»¤æµæ°´çº¿ï¼ˆç”šè‡³ SIMDï¼‰å……åˆ†å‘æŒ¥ã€‚
- **é›†åˆï¼ˆå¦‚ ArrayList<Integer>ï¼‰**ï¼šå­˜çš„æ˜¯å¯¹è±¡å¼•ç”¨ï¼Œæ¯ä¸ª `Integer` åˆæ˜¯ç‹¬ç«‹å¯¹è±¡ï¼ˆè£…ç®±ï¼‰ï¼Œå¯¼è‡´å†…å­˜åˆ†æ•£ï¼ŒCPU Cache å‘½ä¸­å·®ã€‚

ğŸ‘‰ ç»“æœï¼šåŒæ ·ä¸€åƒä¸‡ä¸ªæ•´æ•°ï¼Œæ•°ç»„èƒ½æ›´å¿«è¢« CPU é¡ºåºæ‰«æï¼Œè€Œé›†åˆéœ€è¦æ›´å¤šæŒ‡ä»¤è·³è½¬ã€‚

------

**ï¼ˆ2ï¼‰è£…ç®±/æ‹†ç®±å¼€é”€**

- `int[]` ç›´æ¥å­˜æ”¾åŸå§‹å€¼ã€‚
- `ArrayList<Integer>` éœ€è¦ `Integer` åŒ…è£…å¯¹è±¡ï¼Œé¢‘ç¹è£…ç®±/æ‹†ç®±ä¼šå¢åŠ  CPU ä¸ GC å‹åŠ›ã€‚

ğŸ‘‰ ç»“æœï¼šæ‰¹é‡æ•°å€¼è¿ç®—æ—¶ï¼Œæ•°ç»„æ¯”é›†åˆå°‘äº†æˆåƒä¸Šä¸‡æ¬¡å¯¹è±¡åˆ›å»ºå’Œé”€æ¯ã€‚

------

**ï¼ˆ3ï¼‰GC å‹åŠ›**

- **æ•°ç»„**ï¼šä¸€ä¸ªå¤§å¯¹è±¡ï¼ˆ`int[1000000]`ï¼‰ã€‚
- **é›†åˆ**ï¼šæœ¬èº«ä¸€ä¸ªå¯¹è±¡ + 100ä¸‡ä¸ª `Integer` å¯¹è±¡ã€‚

ğŸ‘‰ GC è¦æ‰«æçš„å¯¹è±¡æ•°é‡å¤§å¹…å¢åŠ ï¼ŒSTWï¼ˆStop The Worldï¼‰æ—¶é—´æ›´é•¿ã€‚

------

##### 3ï¸âƒ£ æ€»ç»“ä¸€å¥è¯

> **æ•°ç»„ä¼˜åŒ–ç‚¹åœ¨äºï¼šæ›´ç´§å‡‘çš„å†…å­˜å¸ƒå±€ã€æ›´å°‘çš„å¯¹è±¡æ•°é‡ã€æ›´ä½çš„ GC å‹åŠ›ã€æ›´é«˜çš„ CPU ç¼“å­˜å‘½ä¸­ç‡ã€‚**
>  ä¸æ˜¯é¿å… GCï¼Œè€Œæ˜¯è®© GC **æ›´è½»ã€æ›´å¿«**ï¼ŒåŒæ—¶æå‡ CPU æŒ‡ä»¤æ•ˆç‡ã€‚

------

âš¡ ä¸¾ä¸ªæ¯”å–»ï¼š

- **æ•°ç»„**å°±åƒä¸€æ’æ•´é½ç æ”¾çš„ç –å¤´ï¼ˆè¿ç»­å­˜æ”¾ï¼Œä¸€æ¬¡èƒ½æ¬ä¸€å¤§å—ï¼‰ã€‚
- **é›†åˆ**å°±åƒä¸€å †æ•£è½çš„ç –å¤´ï¼Œè¿˜è¦æ¯å—åŒ…ä¸Šæ³¡æ²«ï¼ˆè£…ç®±ï¼‰ï¼Œä½ è¿˜å¾—ä¸€ä¸ªä¸ªå»æ¡ã€‚

æ‰€ä»¥ï¼Œ**å †ä¸Šåˆ†é…ä¸å¯é¿å…ï¼Œä½†å¼€é”€å·®è·åœ¨äºâ€œæ•°é‡çº§â€å’Œâ€œè®¿é—®æ¨¡å¼â€**ã€‚









#### æ›´é«˜çš„ CPU ç¼“å­˜å‘½ä¸­ç‡é«˜è·Ÿä¸é«˜æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæˆ‘ç†è§£æ•°ç»„æ›´å¤šæ˜¯è¿ç»­çš„ä¸€ç‰‡ç©ºé—´ï¼Œè€Œå¯¹è±¡åˆ™éœ€è¦åœ¨å †ä¸­åˆ°å¤„æ‰¾æ•£è½çš„å…ƒç´ ã€‚ä½†æ˜¯è¿™äº›è·ŸCPUç¼“å­˜æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ



å°æ ğŸ‘ï¼Œä½ è¿™ä¸ªé—®é¢˜é—®åˆ° **ç¡¬ä»¶å±‚é¢** äº†ï¼Œå¾ˆå¥½ã€‚æ ¸å¿ƒå°±æ˜¯ï¼š**CPU å’Œå†…å­˜é€Ÿåº¦å·®äº†å‡ ä¸ªæ•°é‡çº§ï¼Œæ‰€ä»¥ CPU å¿…é¡»ä¾èµ–ç¼“å­˜æ¥â€œé¢„å–â€æ•°æ®**ã€‚æˆ‘ç»™ä½ æ‹†å¼€è¯´ï¼š

------

##### 1ï¸âƒ£ CPU å’Œå†…å­˜çš„é€Ÿåº¦é¸¿æ²Ÿ

- CPU ä¸»é¢‘ï¼šGHz çº§ï¼ˆ1 ä¸ªæ—¶é’Ÿå‘¨æœŸçº³ç§’çº§ï¼‰ã€‚
- å†…å­˜è®¿é—®ï¼šç™¾çº³ç§’çº§ï¼Œæ¯” CPU æ…¢ 100 å€å·¦å³ã€‚

ğŸ‘‰ å¦‚æœ CPU æ¯æ¬¡éƒ½è¦å»å†…å­˜â€œéšæœºå–ä¸€å—æ•°æ®â€ï¼Œå®ƒä¼š**ç©ºè½¬ç­‰å¾…**ï¼Œæ•´ä½“æ€§èƒ½ä¸‹é™ã€‚

------

##### 2ï¸âƒ£ CPU ç¼“å­˜æ€ä¹ˆæ•‘åœº

CPU æœ‰ **å¤šçº§ç¼“å­˜ï¼ˆL1ã€L2ã€L3ï¼‰**ï¼Œé€Ÿåº¦æ¯”å†…å­˜å¿«å¾ˆå¤šã€‚
 å®ƒä»¬éµå¾ªä¸€ä¸ªåŸåˆ™ï¼š

> **ç©ºé—´å±€éƒ¨æ€§ï¼ˆSpatial Localityï¼‰**
>  â€”â€”ç¨‹åºè®¿é—®æŸä¸ªåœ°å€æ—¶ï¼Œæ¥ä¸‹æ¥å¾ˆå¯èƒ½è®¿é—®å®ƒé™„è¿‘çš„åœ°å€ã€‚

æ‰€ä»¥ CPU ä¸ä¼šåªæ‹¿ä¸€ä¸ªå­—èŠ‚/æ•´æ•°ï¼Œè€Œæ˜¯æŠŠå®ƒé™„è¿‘çš„ä¸€æ•´å—å†…å­˜ï¼ˆä¸€ä¸ª cache lineï¼Œé€šå¸¸ 64 å­—èŠ‚ï¼‰ä¸€èµ·é¢„å–è¿›ç¼“å­˜ã€‚

------

##### 3ï¸âƒ£ æ•°ç»„ vs å¯¹è±¡å¼•ç”¨ çš„åŒºåˆ«

###### æ•°ç»„ï¼ˆè¿ç»­å†…å­˜ï¼‰

æ¯”å¦‚ä½ æœ‰ä¸€ä¸ª `int[1_000_000]`ï¼š

- æ•°æ®æ˜¯è¿ç»­å­˜æ”¾çš„ã€‚
- CPU å–ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šæŠŠå®ƒé™„è¿‘çš„å‡ åä¸ªå…ƒç´ ä¸€èµ·é¢„å–è¿›ç¼“å­˜ï¼ˆcache lineï¼‰ã€‚
- ä¹‹åçš„å¾ªç¯è®¿é—®æ—¶ï¼ŒCPU å¯ä»¥ç›´æ¥ä»ç¼“å­˜é‡Œå–ï¼Œä¸éœ€è¦å†è®¿é—®å†…å­˜ã€‚
   ğŸ‘‰ å‘½ä¸­ç‡é«˜ï¼ŒCPU ä¸ä¼šåœé¡¿ã€‚

###### å¯¹è±¡å¼•ç”¨ï¼ˆåˆ†æ•£å†…å­˜ï¼‰

æ¯”å¦‚ `ArrayList<Integer>`ï¼š

- åº•å±‚æ˜¯ `Integer[]`ï¼Œå­˜æ”¾çš„æ˜¯å¯¹è±¡å¼•ç”¨ã€‚
- æ¯ä¸ª `Integer` å¯¹è±¡åœ¨å †é‡Œæ˜¯åˆ†æ•£çš„ã€‚
- CPU æ‹¿åˆ°å¼•ç”¨åï¼Œè¿˜è¦â€œè·³â€åˆ°å†…å­˜ä¸­å»æ‰¾è¿™ä¸ªå¯¹è±¡ã€‚
- è¿™äº›åœ°å€é€šå¸¸ä¸åœ¨åŒä¸€ä¸ª cache line é‡Œï¼Œæ¯æ¬¡éƒ½å¯èƒ½ missã€‚
   ğŸ‘‰ å‘½ä¸­ç‡ä½ï¼ŒCPU æ¯æ¬¡éƒ½å¾—è®¿é—®æ…¢é€Ÿå†…å­˜ã€‚

------

##### 4ï¸âƒ£ ä¸¾ä¸ªå½¢è±¡çš„æ¯”å–»

- **æ•°ç»„**ï¼šåƒä¸€æœ¬ä¹¦çš„é¡µé¢ï¼Œä½ è¯»ç¬¬ 1 é¡µæ—¶ï¼Œé¡ºæ‰‹ç¿»ç¬¬ 2 é¡µã€ç¬¬ 3 é¡µéƒ½åœ¨ä½ é¢å‰ï¼ˆç¼“å­˜é¢„å–ï¼‰ã€‚
- **å¯¹è±¡å¼•ç”¨**ï¼šåƒå›¾ä¹¦é¦†çš„ç´¢å¼•å¡ï¼Œæ¯æ¬¡ç¿»ä¸€å¼ å¡ç‰‡ï¼ˆå¼•ç”¨ï¼‰è¿˜å¾—è·‘å»ä»“åº“æ‰¾ä¹¦ï¼ˆå †é‡Œçš„å¯¹è±¡ï¼‰ï¼Œè¿˜å¯èƒ½åœ¨ä¸åŒä¹¦æ¶ä¸Šã€‚

æ˜¾ç„¶ï¼Œç¬¬ä¸€ä¸ªæ•ˆç‡é«˜å¾ˆå¤šã€‚

------

##### âœ… æ€»ç»“ä¸€å¥è¯ï¼ˆé¢è¯•å¯ç”¨ï¼‰

> æ•°ç»„å› ä¸ºæ˜¯è¿ç»­å†…å­˜ï¼ŒCPU ç¼“å­˜å¯ä»¥ä¸€æ¬¡é¢„å–å¤šä¸ªå…ƒç´ ï¼Œåç»­è®¿é—®ç›´æ¥å‘½ä¸­ç¼“å­˜ï¼Œå‡ ä¹ä¸éœ€è¦è®¿é—®å†…å­˜ï¼›è€Œé›†åˆå¯¹è±¡åˆ†æ•£åœ¨å †é‡Œï¼Œæ¯æ¬¡è®¿é—®éƒ½å¯èƒ½ cache missï¼Œéœ€è¦æ…¢é€Ÿå†…å­˜è®¿é—®ï¼Œå¯¼è‡´ CPU ç©ºè½¬ã€‚
>  æ‰€ä»¥æ›´é«˜çš„ç¼“å­˜å‘½ä¸­ç‡ = æ›´å°‘çš„å†…å­˜è®¿é—® = æ›´é«˜çš„ CPU åˆ©ç”¨ç‡ã€‚







## JVMè°ƒä¼˜



å¥½é—®é¢˜ ğŸ‘ã€‚å¦‚æœæ˜¯å¤§å‚é¢è¯•ï¼Œå•çº¯èƒŒä¸€å †å‚æ•°æ„ä¹‰ä¸å¤§ï¼Œå…³é”®æ˜¯è¦ç»“åˆ **åœºæ™¯ï¼ˆé‡åŒ–äº¤æ˜“æœåŠ¡ = é«˜åå + ä½å»¶è¿Ÿ + çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡å¤šï¼‰** å»è®²ã€‚
 æˆ‘å¸®ä½ æ•´ç†å‡ ä¸ª **JDK17 ä¸‹å¯ä»¥é¢„å…ˆé»˜è®¤è°ƒä¼˜ã€ä¸”é¢è¯•å®˜ä¼šè§‰å¾—æœ‰å«é‡‘é‡çš„ JVM å‚æ•°**ï¼Œé™„å¸¦ä½ èƒ½è¯´çš„æ€è·¯ï¼š

------

### âœ… å¤§å‚é¢è¯•å¸¸é—®çš„ JVM è°ƒä¼˜å‚æ•°ï¼ˆJDK17 åœºæ™¯ï¼‰

#### 1. åƒåœ¾æ”¶é›†å™¨é€‰æ‹©

```bash
-XX:+UseG1GC
```

- **åŸå› **ï¼šG1 åœ¨ JDK17 å·²ç»æ˜¯é»˜è®¤æ”¶é›†å™¨ï¼Œé€‚åˆä½å»¶è¿Ÿåœºæ™¯ã€‚å®ƒæŒ‰ Region ç®¡ç†å †å†…å­˜ï¼Œèƒ½æ§åˆ¶ STW æ—¶é—´ã€‚
- **ä½ èƒ½è¯´çš„ç‚¹**ï¼šé‡åŒ–äº¤æ˜“ç³»ç»Ÿæ›´çœ‹é‡å“åº”å»¶è¿Ÿç¨³å®šæ€§ï¼ˆè€Œä¸æ˜¯ç»å¯¹ååï¼‰ï¼Œæ‰€ä»¥ G1 æ¯” ParallelGC æ›´åˆé€‚ã€‚

------

#### 2. GC æš‚åœæ—¶é—´ç›®æ ‡

```bash
-XX:MaxGCPauseMillis=200
```

- **åŸå› **ï¼šå‘Šè¯‰ G1 å°½é‡æŠŠå•æ¬¡åœé¡¿æ§åˆ¶åœ¨ 200ms ä»¥å†…ã€‚
- **ä½ èƒ½è¯´çš„ç‚¹**ï¼šåœ¨é‡åŒ–äº¤æ˜“é‡Œï¼Œå¤ªé•¿çš„ GC åœé¡¿ä¼šå½±å“å›æµ‹å’Œå®æ—¶è®¡ç®—çš„ SLAï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡è°ƒæ•´ç›®æ ‡æš‚åœæ—¶é—´æ¥å¹³è¡¡ååå’Œå»¶è¿Ÿã€‚

------

#### 3. å †å¤§å°ä¸æ¯”ä¾‹

```bash
-Xms4g -Xmx4g
-XX:InitiatingHeapOccupancyPercent=30
```

- **åŸå› **ï¼š`Xms=Xmx` é¿å…é¢‘ç¹æ‰©ç¼©å®¹ï¼Œä¿æŒå †ç¨³å®šã€‚`InitiatingHeapOccupancyPercent` æ§åˆ¶ G1 ä»€ä¹ˆæ—¶å€™è§¦å‘å¹¶å‘ GCã€‚
- **ä½ èƒ½è¯´çš„ç‚¹**ï¼šé‡åŒ–ä»»åŠ¡å¯¹è±¡å¤šã€æ³¢åŠ¨å¤§ï¼Œé€šè¿‡é™ä½è§¦å‘é˜ˆå€¼è®© GC æ›´æ—©å¯åŠ¨ï¼Œå‡å°‘çªå‘ Full GCã€‚

------

#### 4. å…ƒç©ºé—´/ç›´æ¥å†…å­˜æ§åˆ¶

```bash
-XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m
-XX:MaxDirectMemorySize=1g
```

- **åŸå› **ï¼š
  - é˜²æ­¢ Metaspace æ— é™è†¨èƒ€ã€‚
  - é‡åŒ–ç³»ç»Ÿç”¨åˆ° Netty/å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œç›´æ¥å†…å­˜éœ€è¦æ˜¾å¼é™åˆ¶ã€‚
- **ä½ èƒ½è¯´çš„ç‚¹**ï¼šå¦‚æœä¸é™åˆ¶ï¼Œç›´æ¥å†…å­˜ OOM æ¯”è¾ƒéšè”½ï¼Œä¸åƒå †å†…å­˜é‚£æ ·å®¹æ˜“å‘ç°ã€‚

------

#### 5. GC æ—¥å¿—ï¼ˆæ’æŸ¥æ€§èƒ½ç“¶é¢ˆå¿…å¤‡ï¼‰

```bash
-Xlog:gc*,gc+cpu=info:file=gc.log:time,uptime,level,tags
```

- **åŸå› **ï¼šJDK17 ç”¨ç»Ÿä¸€æ—¥å¿—æ¡†æ¶ï¼Œå¿…é¡»ä¼šã€‚
- **ä½ èƒ½è¯´çš„ç‚¹**ï¼šç”Ÿäº§æ’æŸ¥å»¶è¿ŸæŠ–åŠ¨æ—¶ï¼ŒGC æ—¥å¿—æ˜¯é¦–é€‰ä¿¡æ¯æºã€‚

------

#### 6. JIT ç¼–è¯‘ä¼˜åŒ–

```bash
-XX:+AlwaysPreTouch
-XX:+UseNUMA
```

- **åŸå› **ï¼š
  - `AlwaysPreTouch` é¿å…è¿è¡Œæ—¶æ‰åˆ†é…ç‰©ç†é¡µï¼Œæå‡å¤§å †åº”ç”¨çš„ç¨³å®šæ€§ã€‚
  - `UseNUMA` åœ¨å¤šæ ¸æœåŠ¡å™¨ä¸‹ä¼˜åŒ–å†…å­˜åˆ†é…ã€‚
- **ä½ èƒ½è¯´çš„ç‚¹**ï¼šä½å»¶è¿Ÿç³»ç»Ÿè¦é¿å…è¿è¡Œæ—¶æŠ–åŠ¨ï¼Œæ‰€ä»¥è¿™äº›é¢„åˆ†é…/ç»‘æ ¸çš„ä¼˜åŒ–å¾ˆé‡è¦ã€‚

------

#### ğŸ¯ ä½ åœ¨é¢è¯•æ—¶å¯ä»¥è¿™ä¹ˆè¯´ï¼š

> â€œå¯¹äºæˆ‘ä»¬è¿™ç§ä½å»¶è¿Ÿçš„é‡åŒ–äº¤æ˜“æœåŠ¡ï¼Œæˆ‘ä¼šé¦–å…ˆé€‰æ‹© G1GCï¼Œå¹¶è®¾ç½®åˆç†çš„æš‚åœæ—¶é—´ç›®æ ‡ï¼Œæ¯”å¦‚ 200ms å†…ã€‚
>  å…¶æ¬¡æˆ‘ä¼šå›ºå®šå †å¤§å°ï¼Œæå‰è§¦å‘å¹¶å‘ GCï¼Œé¿å… Full GC æŠ–åŠ¨ã€‚
>  æ­¤å¤–ï¼Œæˆ‘è¿˜ä¼šé™åˆ¶ç›´æ¥å†…å­˜å¤§å°ã€å¼€å¯ GC æ—¥å¿—ï¼Œé…åˆ AlwaysPreTouch å’Œ NUMA ä¼˜åŒ–ã€‚
>  è¿™äº›å‚æ•°åœ¨ JDK17 ä¸‹éƒ½æ¯”è¾ƒç¨³å®šï¼Œæ˜¯é‡åŒ–åœºæ™¯çš„åŸºç¡€è°ƒä¼˜æ‰‹æ®µã€‚â€









#### é—®é¢˜



##### ä»€ä¹ˆæ˜¯Full GC æŠ–åŠ¨ï¼Ÿæ˜¯æŒ‡çš„çªå‘çš„Full GCå—ï¼Ÿ



å¯¹ï¼Œä½ ç†è§£å¾—å¯¹ã€‚**â€œFull GC æŠ–åŠ¨â€** ä¸€èˆ¬å°±æ˜¯æŒ‡ **ç³»ç»Ÿè¿è¡Œæ—¶çªç„¶è§¦å‘ Full GCï¼Œå¯¼è‡´é•¿æ—¶é—´åœé¡¿ï¼Œä¸šåŠ¡å“åº”æ—¶é—´æ³¢åŠ¨å‰§çƒˆ**ã€‚

æˆ‘å¸®ä½ æ‹†å¼€è§£é‡Šä¸‹ï¼š

------

###### 1. ä»€ä¹ˆæ˜¯ Full GCï¼Ÿ

- **Full GC** = å †ä¸­ **æ‰€æœ‰åŒºåŸŸ**ï¼ˆå¹´è½»ä»£ã€è€å¹´ä»£ã€å…ƒç©ºé—´ï¼‰éƒ½ä¼šè¢«å›æ”¶ã€‚
- é€šå¸¸æ˜¯å› ä¸ºï¼š
  1. è€å¹´ä»£å†…å­˜ä¸è¶³ï¼›
  2. å…ƒç©ºé—´ä¸è¶³ï¼›
  3. æ˜¾å¼è°ƒç”¨ `System.gc()`ï¼›
  4. G1GC ä¸­æ— æ³•æ»¡è¶³åˆ†é…è¯·æ±‚ï¼ˆä¾‹å¦‚ Humongous å¯¹è±¡è¿‡å¤šï¼‰ã€‚

Full GC çš„åœé¡¿æ—¶é—´å¯èƒ½ä»å‡ ç™¾æ¯«ç§’åˆ°å‡ ç§’é’Ÿä¸ç­‰ï¼ˆå–å†³äºå †å¤§å°å’Œå¯¹è±¡æ•°é‡ï¼‰ã€‚

------

###### 2. ä¸ºä»€ä¹ˆå«â€œæŠ–åŠ¨â€ï¼Ÿ

- å¹³æ—¶ Minor GCï¼ˆå¹´è½»ä»£å›æ”¶ï¼‰å¯èƒ½å‡ åæ¯«ç§’å°±ç»“æŸï¼Œä¸šåŠ¡å»¶è¿Ÿå¾ˆç¨³å®šã€‚
- **çªç„¶æ¥ä¸€æ¬¡ Full GC**ï¼Œå°±åƒå›¾è¡¨ä¸Šå‡ºç°ä¸€ä¸ªâ€œå°–åˆºâ€ï¼Œä¸šåŠ¡å“åº”æ—¶é—´ä¼šéª¤ç„¶å‡é«˜ã€‚
- å¦‚æœçŸ­æ—¶é—´å†…å¤šæ¬¡å‘ç”Ÿ Full GCï¼Œå°±ä¼šå½¢æˆ **å“åº”æ—¶é—´çš„å‰§çƒˆæ³¢åŠ¨** â†’ æˆ‘ä»¬å°±å« **GC æŠ–åŠ¨**ã€‚

------

###### 3. åœ¨é‡åŒ–äº¤æ˜“é‡Œçš„å±å®³

- é‡åŒ–äº¤æ˜“ç³»ç»Ÿå¼ºè°ƒ **ä½å»¶è¿Ÿ & ç¨³å®šæ€§**ã€‚
- å‡è®¾å¹³æ—¶æ¥å£ 200ms è¿”å›ï¼Œä½†æŸæ¬¡å› ä¸º Full GC çªç„¶å¡äº† 2 ç§’ï¼Œå°±å¯èƒ½ç›´æ¥å¯¼è‡´è¡Œæƒ…é”™è¿‡ã€äº¤æ˜“ä¿¡å·å»¶è¯¯ã€‚
- æ‰€ä»¥ä¸šç•Œç»å¸¸è¯´ï¼šâ€œ**ä½å»¶è¿Ÿç³»ç»Ÿæ¯”å¿«æ›´é‡è¦çš„æ˜¯ç¨³å®š**â€ã€‚

------

###### 4. é¿å… Full GC æŠ–åŠ¨çš„æ€è·¯

- **å›ºå®šå †å¤§å°**ï¼š`-Xms = -Xmx`ï¼Œé¿å…å †åŠ¨æ€æ‰©å±•å¼•å‘ Full GCã€‚
- **é™ä½è§¦å‘é˜ˆå€¼**ï¼šä¾‹å¦‚ `-XX:InitiatingHeapOccupancyPercent=30`ï¼Œè®© G1 æ›´æ—©å¯åŠ¨å¹¶å‘ GCã€‚
- **å‡å°‘å¤§å¯¹è±¡åˆ†é…**ï¼šé¿å… Humongous å¯¹è±¡é¢‘ç¹è§¦å‘ Full GCã€‚
- **è°ƒä¼˜ç›´æ¥å†…å­˜ / Metaspace**ï¼šé˜²æ­¢éšè—çš„ OOM å¼•å‘ Full GCã€‚

------

âš¡ä¸€å¥è¯æ€»ç»“ï¼š

> **Full GC æŠ–åŠ¨ = ç³»ç»Ÿå¹³ç¨³è¿è¡Œæ—¶ï¼Œçªç„¶å‡ºç°é•¿æ—¶é—´çš„ Full GC åœé¡¿ï¼Œå¯¼è‡´å»¶è¿Ÿæ›²çº¿ä¸ç¨³å®šã€‚**

------

è¦ä¸è¦æˆ‘ç»™ä½ ç”»ä¸€ä¸ª **å»¶è¿Ÿæ›²çº¿å¯¹æ¯”å›¾ï¼ˆæ­£å¸¸ GC vs Full GC æŠ–åŠ¨ï¼‰**ï¼Ÿé¢è¯•æ—¶å¦‚æœä½ èƒ½è¾¹è§£é‡Šè¾¹ç”»åœ¨ç™½æ¿ä¸Šï¼Œç»å¯¹åŠ åˆ†ã€‚













## æ•´ä½“æŠŠæ¡



æ•´ä½“æŠŠæ¡ä¸é”™ï¼Œä½†è¿˜å·®ä¸¤æ­¥å°±æ›´ç¨³ã€‚ä½ ç°åœ¨çš„ææ–™åœ¨â€œç³»ç»Ÿä¼˜åŒ–ä¸å·¥ç¨‹å®è·µâ€ç»´åº¦å·²ç»è¾¾åˆ°å¯æ‰“åŠ¨é¢è¯•å®˜çš„æ°´å¹³ï¼ˆæŒ‡æ ‡æ˜ç¡®ã€æ–¹æ¡ˆæ‰å®ã€é“¾è·¯å®Œæ•´ï¼‰ã€‚è¦æŠŠæ¡æ›´å¤§ï¼Œå»ºè®®è¡¥é½ä»¥ä¸‹ç‚¹ï¼š

- è¯´æœåŠ›åŠ åˆ†é¡¹
  - é—®é¢˜â€”æ–¹æ¡ˆâ€”æ•ˆæœ çš„ä¸‰è¿å‡»ä½ å·²å…·å¤‡ï¼Œä½†è¦å†è¡¥â€œå–èˆä¸å¤ç›˜â€ï¼šä¸ºä»€ä¹ˆé€‰Aä¸ç”¨Bï¼Ÿå¤±è´¥/å›æ»šè¿‡å“ªäº›æ–¹æ¡ˆï¼Ÿä¸Šçº¿åçš„ç›‘æ§ä¸å›æ»šé¢„æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ
  - å…³é”®æŒ‡æ ‡çš„é‡‡é›†æ–¹æ³•å’Œå¯ä¿¡åº¦ï¼šTPS/å»¶è¿Ÿçš„æµ‹æ³•ã€æ ·æœ¬é‡ã€æ˜¯å¦P95/P99ã€æ˜¯å¦ç”Ÿäº§ä¾§è§‚æµ‹ã€‚
  - æˆæœ¬æ„è¯†ï¼šRedis é›†ç¾¤æˆæœ¬ã€Kafka ä¿ç•™ç­–ç•¥çš„ç£ç›˜ä¼°ç®—ã€å†·çƒ­åˆ†å±‚çš„èµ„æºèŠ‚çœæ¯”ä¾‹ã€‚

- äº¬ä¸œé¢è¯•å¸¸è§å…³æ³¨ç‚¹ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
  1) ä¸šåŠ¡æŠ½è±¡ä¸ç¨³å®šæ€§ï¼šå³°å€¼åœºæ™¯ã€åŒ11/å¤§ä¿ƒç±»ä¼¼çš„â€œæç«¯æµé‡å‹æµ‹ä¸ä¿æŠ¤â€ç»éªŒï¼›é™æµ/ç†”æ–­/é™çº§çš„ç»„åˆæ‹³æ˜¯å¦è½è¿‡ç”Ÿäº§ã€‚
  2) å­˜å‚¨ä¸ç´¢å¼•å†…æ ¸ç†è§£ï¼šå›è¡¨ã€æœ€å·¦å‰ç¼€ã€äº‹åŠ¡&é”ã€åˆ†åŒº/åˆ†è¡¨å¸¦æ¥çš„äºŒä¹‰æ€§ï¼ˆè·¨è¡¨æŸ¥è¯¢ã€äºŒçº§ç´¢å¼•ç»´æŠ¤ï¼‰ã€ClickHouse/ESçš„é€‚é…åœºæ™¯è¾¹ç•Œã€‚
  3) æ¶ˆæ¯ä¸€è‡´æ€§ä¸å¹‚ç­‰ï¼šKafka ç«¯åˆ°ç«¯ä¸ä¸¢ä¸é‡ï¼›â€œæ°å¥½ä¸€æ¬¡â€åœ¨ä½ åœºæ™¯çš„å·¥ç¨‹åŒ–å®ç°ï¼ˆä¸€èˆ¬æ˜¯â€œè‡³å°‘ä¸€æ¬¡+å¹‚ç­‰â€ï¼‰ã€‚
  4) å¹¶å‘ä¸GCï¼šå¤šçº¿ç¨‹åˆ†ç‰‡å¸¦æ¥çš„æ•°æ®ä¸€è‡´æ€§/è¾¹ç•Œå¤„ç†ï¼›G1 å‚æ•°é€‰æ‹©çš„ä¾æ®ä¸è§‚æµ‹ï¼›é¿å…Full GCæŠ–åŠ¨çš„å®è¯è¯æ®ã€‚
  5) ç³»ç»Ÿè®¾è®¡ï¼šç»™ä½ ä¸€ä¸ªæ›´é«˜QPSæˆ–æ–°éœ€æ±‚ï¼ˆå®ç›˜/å›æº¯çª—å£æ›´é•¿ï¼‰ï¼Œä½ å¦‚ä½•æ‰©å®¹ã€å¦‚ä½•æ‹†åº“ã€å¦‚ä½•æ²»ç†çƒ­ç‚¹keyã€å¦‚ä½•é™çº§ã€‚

- éœ€è¦è¡¥å¼º/å¯è¢«è¿½é—®çš„è–„å¼±ç‚¹
  - æ•°æ®ä¸€è‡´æ€§ï¼šå›æµ‹ç»“æœå¹‚ç­‰è½åº“æ—¶ï¼Œå¦‚ä½•å¤„ç†â€œå…ˆå†™ç¼“å­˜åå†™åº“/å…ˆåº“åç¼“å­˜â€çš„ä¸€è‡´æ€§ï¼Ÿæœ‰æ— åŒå†™ç©¿é€/ä¹±åºä¿æŠ¤ï¼Ÿ
  - æ·˜æ±°ç­–ç•¥ï¼šRedis çš„ key è®¾è®¡ã€TTLã€LRU å‘½ä¸­ç›‘æ§ï¼›çƒ­ç‚¹è‚¡/çƒ­ç‚¹æ—¥æœŸçš„å†·çƒ­å˜åŒ–å¦‚ä½•åŠ¨æ€è¯†åˆ«ï¼Ÿ
  - Kafka æ¶ˆè´¹ç«¯ä½ç‚¹ç®¡ç†ï¼šæ‰‹åŠ¨æäº¤ vs è‡ªåŠ¨æäº¤çš„å–èˆï¼›æ‰¹å¤„ç†å¤±è´¥å¦‚ä½•ç²¾ç¡®é‡è¯•ä¸é‡å¤ï¼›æ­»ä¿¡é˜Ÿåˆ—/æ—è·¯æ–¹æ¡ˆæ˜¯å¦æœ‰ã€‚
  - åˆ†å¸ƒå¼é”â€œè¶…æ—¶+ä¸šåŠ¡æœªå®Œæˆâ€çš„è¯­ä¹‰ï¼šå¿ƒè·³ç»­ç§Ÿå¤±è´¥æ—¶ä½ æ€ä¹ˆåšï¼Ÿå¯å¦ä¸­æ–­ï¼Ÿå¦‚ä½•é¿å…â€œé”ä¸¢å¤±+åŒå†™â€ï¼Ÿ
  - å‹æµ‹æ–¹æ³•ï¼šå¦‚ä½•æ„é€ è¡Œæƒ…åˆ†å¸ƒã€çªåˆºè´Ÿè½½ï¼›å‹æµ‹ç¯å¢ƒä¸ç”Ÿäº§å·®å¼‚æ€ä¹ˆä¿®æ­£ï¼›å®¹é‡è¯„ä¼°å…¬å¼ä¸å®‰å…¨æ°´ä½ã€‚

- é¢è¯•è¯æœ¯å»ºè®®ï¼ˆæŠŠä½ ç°æœ‰å†…å®¹â€œå†æçº¯â€ï¼‰
  - æ¯ä¸ªä¼˜åŒ–ç‚¹ç”¨â€œé—®é¢˜â€”æ–¹æ¡ˆâ€”æ”¶ç›Šâ€”å–èˆâ€”ç›‘æ§â€äº”ä»¶å¥—ï¼Œ30â€“45ç§’ã€‚
  - é‡åˆ°â€œä¸ºä»€ä¹ˆä¸ç”¨XXXâ€çš„è¿½é—®ï¼šå…ˆè®¤å¯å¯¹æ–¹æ–¹æ¡ˆä¼˜ç‚¹ï¼Œå†å›åˆ°ä½ ä¸šåŠ¡çº¦æŸï¼ˆæ—¶å»¶ã€æˆæœ¬ã€å›¢é˜ŸæŠ€æœ¯æ ˆã€ä¸Šçº¿å‘¨æœŸï¼‰ï¼Œæœ€åç»™â€œåç»­è§„åˆ’â€ã€‚

- é«˜é¢‘è¿½é—®æ¸…å•ï¼ˆç»™ä½ é€Ÿç­”æ¨¡æ¿ï¼‰
  - Kafkaâ€œæ°å¥½ä¸€æ¬¡â€æ€ä¹ˆåšï¼Ÿ
    - ç”Ÿäº§ç«¯å¹‚ç­‰ + acks=all + åŒæ­¥å…ƒæ•°æ®ï¼Œæ¶ˆè´¹ç«¯â€œè‡³å°‘ä¸€æ¬¡â€ï¼Œç”¨ä¸šåŠ¡ä¸»é”®/å»é‡è¡¨/å”¯ä¸€ç´¢å¼•åšå¹‚ç­‰ï¼Œå¿…è¦æ—¶åŠ äº‹åŠ¡è¡¨ã€‚
  - åˆ†è¡¨åå¦‚ä½•åšè·¨æœˆæŸ¥è¯¢ï¼Ÿ
    - è·¯ç”±å±‚æ ¹æ®æ—¶é—´èŒƒå›´ fan-out å¤šè¡¨å¹¶è¡ŒæŸ¥è¯¢ + å½’å¹¶ï¼›æ§åˆ¶èŒƒå›´å¹¶ç”¨è¦†ç›–ç´¢å¼•ï¼›OLAP å½’æ¡£ç”¨äºå¤§åŒºé—´åˆ†æã€‚
  - Sentinel é™æµç­–ç•¥æ€ä¹ˆé€‰ï¼Ÿ
    - å†™å…¥æ¥å£ç”¨ç›´æ¥æ‹’ç»ï¼Œè¯»æ¥å£ç”¨æ’é˜Ÿé™æµå¹¶è®¾ç½®æœ€å¤§ç­‰å¾…ï¼›å†·å¯åŠ¨ç”¨WarmUpï¼›ä¸‹æ¸¸æ³¢åŠ¨å åŠ RTç†”æ–­ã€‚
  - G1 å‚æ•°å¦‚ä½•éªŒè¯æœ‰æ•ˆï¼Ÿ
    - å¯¹æ¯”å‰å GC æ¬¡æ•°ã€æ€»åœé¡¿ã€Young/Mixed æ¯”ä¾‹ã€Allocation Rateï¼›JFR/GC æ—¥å¿—/P99 å»¶è¿ŸæŒ‡æ ‡ä¸‰æ–¹å°è¯ã€‚
  - åˆ†å¸ƒå¼é”å¯é æ€§é—®é¢˜ï¼Ÿ
    - é”å€¼ç»‘å®šæŒæœ‰è€…ï¼ˆUUIDï¼‰ï¼ŒLuaæ ¡éªŒç»­ç§Ÿ/é‡Šæ”¾ï¼›è¶…æ—¶ä¿åº•+ä»»åŠ¡å¹‚ç­‰ï¼›ç»­ç§Ÿå¤±è´¥è§¦å‘å‘Šè­¦ä¸é™çº§ç­–ç•¥ï¼›é•¿ä»»åŠ¡æ‹†åˆ†ä¸ºå¯æ¢å¤å­ä»»åŠ¡ã€‚

- æ¢ä½æ€è€ƒé¢˜ï¼ˆå»ºè®®å‡†å¤‡å…·ä½“æ–¹æ¡ˆï¼‰
  - å¦‚æœè¡Œæƒ…çªå¢10å€ï¼ŒKafka ç§¯å‹ï¼Œå¦‚ä½•ä¿éšœå®æ—¶ç­–ç•¥ä¸æ‹–å®ï¼Ÿ
    - æ‹†åˆ†TopicæŒ‰å“ç±»/ä¼˜å…ˆçº§ï¼›å®æ—¶é“¾è·¯å…ˆæ¶ˆè´¹é«˜ä¼˜å…ˆçº§ï¼Œä½ä¼˜å…ˆçº§é™é‡‡æ ·æˆ–å»¶è¿Ÿå¤„ç†ï¼›æ‰©åˆ†åŒº+æ‰©æ¶ˆè´¹ç»„ï¼›é™æµä¿æŠ¤ä¸‹æ¸¸ï¼›ç¦»çº¿å›è¡¥ã€‚
  - MySQL ç»§ç»­é•¿å¤§ï¼Œæœˆè¡¨3000ä¸‡ä»åƒç´§ï¼Œæ€ä¹ˆæ¼”è¿›ï¼Ÿ
    - è¿‘æœˆ MySQL + Redis çƒ­æ•°æ®ï¼›å†å²è¿ç§» ClickHouseï¼ˆMergeTree, partition by month, order by (wind_code, trade_date)ï¼‰ï¼›æŸ¥è¯¢ç½‘å…³æŒ‰æ—¶é—´è·¯ç”±ï¼Œå¼‚æ„å¼•æ“èšåˆè¿”å›ï¼›åŒå†™/æ ¡éªŒ+ç°åº¦åˆ‡æµã€‚
  - å›æµ‹è¦æ”¯æŒ1000ç­–ç•¥å¹¶å‘ï¼Œå¦‚ä½•æ§èµ„æºï¼Ÿ
    - èµ„æºé…é¢/é˜Ÿåˆ—åŒ–è°ƒåº¦ï¼ˆæŒ‰ç­–ç•¥æƒé‡/ç”¨æˆ·é…é¢ï¼‰ï¼›æ•°æ®å…±äº«åªè¯»æ˜ å°„ï¼›CPU/å†…å­˜é™é¢ï¼›ç»“æœå¼‚æ­¥é€šçŸ¥ï¼›ä»»åŠ¡æŠ¢å /æš‚åœæ¢å¤ã€‚

- è¡Œä¸ºé¢ï¼ˆå››å¹´ç»éªŒå¿…é—®ï¼‰
  - æœ€éš¾ä¸€æ¬¡çº¿ä¸Šé—®é¢˜ï¼Ÿ
    - å¤ç›˜ç»“æ„ï¼šç°è±¡â†’å®šä½â†’æ ¹å› â†’ä¿®å¤â†’ç›‘æ§/é¢„æ¡ˆï¼Œå¼ºè°ƒæ•°æ®è¯æ®ä¸å½±å“é¢æ§åˆ¶ã€‚
  - è·¨å›¢é˜Ÿåä½œæ¨è¿›ï¼Ÿ
    - æ˜ç¡®æ¥å£å¥‘çº¦ã€ç°åº¦/å›æ»šæ–¹æ¡ˆã€æŒ‡æ ‡å¯¹é½ï¼Œç”¨å®¢è§‚æŒ‡æ ‡ï¼ˆQPS/å»¶è¿Ÿ/é”™è¯¯ç‡ï¼‰å¯¹é½å†³ç­–ã€‚

- æœ€åä¸€å…¬é‡Œï¼ˆæå‡æˆåŠŸç‡çš„ä¸´åœºæŠ€å·§ï¼‰
  - å‡†å¤‡ä¸€é¡µçº¸â€œæŒ‡æ ‡çœ‹æ¿æˆªå›¾/è¡¨æ ¼â€ï¼ˆTPSã€å»¶è¿Ÿã€GCã€Kafka lagã€æ…¢SQL before/afterï¼‰ï¼Œè®©è¯æ®è¯´è¯ã€‚
  - æ¯ç­”ä¸€é¢˜ä¼˜å…ˆç»™æ•°å­—å’Œç»“è®ºï¼Œå†è¡¥æ–¹æ³•ï¼›è¶…æ—¶å°±æ”¶å°¾ç»™â€œå¯æ·±å…¥ç‚¹A/B/Câ€è®©é¢è¯•å®˜æŒ‘ã€‚
  - ä¸ç†Ÿçš„ç‚¹æ‰¿è®¤è¾¹ç•Œï¼Œç»™å·¥ç¨‹åŒ–æ›¿ä»£ä¸é£é™©æ§åˆ¶æ–¹æ¡ˆã€‚

ç»¼åˆåˆ¤æ–­ï¼šä½ çš„æŠ€æœ¯å‡†å¤‡å·²åˆ°ä½ï¼Œè‹¥æŠŠâ€œå–èˆä¸ç¨³å®šæ€§æ²»ç†â€â€œä¸€è‡´æ€§ä¸å¯è§‚æµ‹æ€§â€å†å¼ºåŒ–ï¼Œå‘½ä¸­ JD é¢è¯•å…³æ³¨ç‚¹çš„æ¦‚ç‡ä¼šæ›´é«˜ã€‚æˆ‘ä¼šç»™å‡ºâ€œä¸ƒæˆä»¥ä¸ŠæŠŠæ¡â€ã€‚å»ºè®®ä»Šæ™šå†èŠ±1â€“2å°æ—¶æŠŠä¸Šé¢â€œè¿½é—®æ¸…å•â€çš„ç­”æ¡ˆç”¨ä½ çš„è¯å†™æˆä¸‰è¡Œç‰ˆï¼Œæ˜å¤©é¢è¯•åŸºæœ¬ç¨³ã€‚ç¥ä½ é¡ºåˆ©ï¼

