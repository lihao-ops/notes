CAP
===

> 2000年7月，加州大学伯克利分校的Eric Brewer教授在ACM PODC会议上提出CAP猜想。2年后，麻省理工学院的Seth Gilbert和Nancy Lynch从理论上证明了CAP。之后，CAP理论正式成为分布式计算领域的公认定理。

 CAP作为分布式系统的基石，应该每个入门分布式系统(包括区块链)的人都应该学习。

![Teorema-CAP-2](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202412080932180.png)





 

一、概述
---

**一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance）这三项中的两项**。



### C(Consistency)：一致性

#### 1.all nodes see the same data at the same time

即更新操作成功后，并返回客户端完成后，**所有节点在同一时间的数据完全一致！**

- 所有节点上的**数据**在任何时候都是**一致**的。
- 示例：当一个事务在数据库的一部分提交后，所有其它部分立刻反映相同的结果。
- 比如：关系型数据库(如：MySQL),写操作会锁表以保证一致性。



#### 2.对于一致性可以从客户端和服务端两个不同的视角

1. **客户端**：从客户端来看，一致性主要指的是**多并发访问时更新过的数据如何获取的问题**。
2. **服务端**：从服务端来看，则是**更新如何分布到整个系统，以保证数据最终一致**。





#### 3.强/弱/最终一致性三类

##### 强一致性

对于关系型数据库，要求**更新过的数据后续的访问都能看到**，这是强一致性。



##### 弱一致性

如果能**容忍后续的部分或者全部访问不到**，则是弱一致性。



##### 最终一致性

如果**经过一段时间后**要求能访问到更新后的数据，则是最终一致性。





### A(Availability)：可用性

#### 1.Reads and writes always succeed

服务在正常响应时间内一直可用。好的可用性主要是指系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。

可用性通常情况下可用性和**分布式数据冗余，负载均衡等有着很大的关联。**

- **每次请求都能获得非错误响应**(即时响应的数据可能不是最新的)。
- 示例：**系统始终可用，即使有部分节点失效也能正常处理请求。**
- 比如：DNS系统，**哪怕部分节点不可用，查询仍然能得到结果**。





### P(Partition Tolerance)：分区容忍性

#### 1.the system continues to operate despite arbitrary message loss or failure of part of the system

即分布式系统**在遇到某节点或网络分区时故障的时候，仍然能够对外提供满足一致性或可用性的服务**。

- 系统能够容忍网络分区(节点之间通信失败)，并继续提供服务。
- 示例：即使网络出现分区问题，系统任然保持部分功能的运行能力。





#### 2.是分区容忍性还是容错性

1. **容忍性：** 系统的部分节点仍能处理请求，尽量维持功能运行（例如 AP 系统）。
2. **容错性：** 系统试图纠正网络分区的问题（但在 CAP 理论中，分区是不可避免的，因此更偏向容忍）。

在 CAP 理论中，**Partition Tolerance** 更准确的翻译是 **分区容忍性**，因为它强调系统在网络分区下的韧性，而不是纠正分区问题本身。

分区容错性虽然字面意思接近，但更适合描述其他场景（如硬件故障的纠错能力）。





二、论证CAP
---

### 图片说明一

![img](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202412081030505.png)

> 根据上图，我们证明CAP的基本场景，网络中有两个节点N1和N2,

1. 可以简单的理解`N1`和`N2`分别是两台计算机。
2. 它们之间网络互通。
3. `N1`中有一个应用程序`A`，和一个数据库`V`。
4. `N2`中也有一个应用程序`B`，和一个数据库`V`。
5. 现在`A`和`B`是分布式系统的两个部分，`V`是分布式系统的数据存储的两个子数据库。



#### 满足一致性时

`N1`和`N2`的数据是一样的。
$$
V0(N1) = V0(N2)
$$


#### 满足可用性时

- 用户**不管请求`N1`或者`N2`，都会得到立即响应**。

- 在满足分区容错性的情况下，**`N1`和`N2`有任何一方宕机，或者网络不通的时候，**
- **都不会影响`N1`和`N2`彼此之间的正常运作。**







### 图片说明二

![img](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202412081109952.png)

> 上图是分布式系统正常运转的流程：

1. 用户向`N1`机器请求数据更新，程序A更新数据库`V0`为`V1`，
2. 分布式系统将数据进行**同步操作M**，将`V1`同步到`N2`中`V0`，
3. 使得`N2`中的数据`V0`也更新为`V1`,
4. `N2`中的数据再响应`N2`的请求。



> 这里，可以定义：

- `N1`和`N2`的数据库`V`之间的数据是否一样为**一致性**；

- 外部对`N1`和`N2`的请求响应为**可用性**；

- `N1`和`N2`之间的网络环境为**分区容错性**。





### 思考分析

上述说的，这是正常运行的场景。也是理想的场景，然而现实是残酷的。

> 当错误发生的时候，一致性和可用性，还有分区容错性，是否能同时满足，还是要进行取舍呢？

作为**==一个分布式系统，它和单机系统的最大区别，就在于网络！==**



现在假设一种极端情况，

#### `N1`和`N2`之间的网络断开了

我们要支持这种网络异常，相当于要满足分区容错性，

> 能不能同时满足一致性和响应性呢？还是说要对它们进行取舍？

![img](https://notes-1307435281.cos.ap-shanghai.myqcloud.com/note/master/202412081124840.png)

假设在`N1`和`N2`之间网络断开时：

1. 有用户向`N1`发送数据更新请求，那么`N1`中的数据`V0`被更新成`V1`。
2. 由于网络是断开的，所以分布式系统`同步操作M`，所以`N2`中的数据依旧是`V0`;
3. 这个时候，有用户向`N2`发送数据读取请求，**由于数据还没有进行同步，应用程序没办法立即给用户返回最新的数据`V1`，怎么办？**



##### 选择一：牺牲数据一致性

牺牲数据一致性，就是先将未经过同步的旧数据`V0`返回给用户！



##### 选择二：牺牲可用性

牺牲可用性，阻塞等待，直到网络恢复，数据更新操作M完成之后，再给用户响应最新的数据`V1`。



#### 论证结果

这个过程，证明了要**满足分区容错性的分布式系统，必须在一致性和可用性两者之间选择其中一个！**







三、CAP权衡
---

通过CAP理论，我们知道无法同时满足一致性、可用性和分区容错性这三个特征：

> 那要舍弃哪个？怎么取舍？

- CA without P：**如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但其实分区不是你想不想的问题，而是始终会存在**，因此CA的系统更多的是允许分区后各子系统依然保持CA。
- CP without A：**如果不要求A（可用），相当于每个请求都需要在Server之间强一致，而P（分区）会导致同步时间无限延长，如此CP也是可以保证的。**很多传统的数据库分布式事务都属于这种模式。
- AP wihtout C：**要高可用并允许分区，则需放弃一致性。一旦分区发生，节点之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。**现在众多的NoSQL都属于此类。

对于涉及到钱财这样不能有一丝让步的场景，`C一致性`必须保证。网络发生故障宁可停止服务，这是保证`C一致性，A可用性`，舍弃`P(分区容忍性)`。

貌似这几年国内银行业发生了不下10起事故，但影响面不大，报道也不多，广大群众知道的少。还有一种是保证`CP`，舍弃`A`。例如网络故障事只读不写。

孰优孰略，没有定论，只能根据场景定夺，**适合的才是最好的**。







四、举例
---



### MySQL

主从复制就是**主写从读**。弱一致性：

因为当MySQL主写的时候，一瞬间从实例中的数据还没有从主实例中更新。此时是**弱一致性**。

从实例坏了，还有其它从实例，所以它是**A可用性**。

主写从读，所以它是**P分区容错性**。

MySQL 在 **主从复制（Replication）模式** 下的确是一个 **AP 系统**，而不是严格的 CA 或 CP 系统。



> 以下是详细的解析：

#### **1. 分析 MySQL 的一致性（C）**

- 在 

  主从复制

   模式下：

  - 主节点负责写入操作，从节点负责读取操作。
  - 复制机制：
    - **异步复制（默认）**：主节点写入后立即返回成功，异步将数据同步到从节点。从节点可能存在短暂的数据延迟，造成数据不一致（弱一致性）。
    - **半同步复制**：主节点写入时等待至少一个从节点确认数据接收，增强了一致性，但仍不能保证强一致性。
    - **同步复制**：主节点等待所有从节点完成写入，确保强一致性，但会显著降低可用性。

**总结：**

- 默认情况下，MySQL 的主从复制使用异步机制，表现为 **弱一致性**（最终一致性）。
- 如果配置为同步复制，则可以接近强一致性，但会牺牲可用性。

------

#### **2. 分析 MySQL 的可用性（A）**

- 即使某个从节点失效，其他从节点仍然可用，可以继续提供读取服务。
- 通过主从切换（如 MHA、ProxySQL 等工具），可以快速将新的主节点切换上线，保障写入服务的可用性。

**总结：**

- MySQL 主从复制模式在分区容忍的情况下，仍然能够提供一定程度的服务，表现出较高的可用性。

------

#### **3. 分析 MySQL 的分区容忍性（P）**

- **分区容忍性（Partition Tolerance）** 指系统在网络分区的情况下是否能够继续提供服务。
- 在 MySQL 的主从复制模式中：
  - 主节点与从节点可能因网络问题而出现通信中断（分区）。
  - 主节点仍能继续处理写入，但从节点的读操作可能返回旧数据（弱一致性）。

**总结：**

- MySQL 在网络分区下，主节点可以继续服务，表现为 **分区容忍性（P）**，但会牺牲数据的一致性。

------

#### **最终结论：MySQL 主从复制时是 AP 系统，单机模式下是CA系统**

- **一致性（C）**：主从复制模式下通常是弱一致性（最终一致性），而不是强一致性。
- **可用性（A）**：即使某些从节点不可用，仍能提供读取服务，且主节点能继续写入。
- **分区容忍性（P）**：主节点与从节点间通信中断时，主节点仍能继续提供写入服务。

**因此，MySQL 主从复制模式更符合 AP 系统的特性。**

------



####  **补充：如果是单机模式**

- **如果 MySQL 运行在单机模式下（无主从复制），则没有分区容忍性（P）的考虑**，可以视为 **CA 系统**。









资源
---

### 网页链接

https://www.hollischuang.com/archives/666

