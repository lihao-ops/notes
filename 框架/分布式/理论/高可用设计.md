高可用设计
===





一、主从复制
---

MySQL 的主从复制本质上是 **主写从读** 的架构，以下是总结和扩展：

------



### （Master-Slave Replication）概述

- **主从复制** 是一种分布式数据库架构设计，用于实现数据从主节点到从节点的同步，通常用于分担读写压力和提升系统的可用性。



#### 1. 主从复制的核心机制

1. **主写从读**：

   - 主节点（Master）负责处理所有的写入请求，更新后的数据通过复制机制传递给从节点。
   - 从节点（Slave）主要用于处理读取请求，缓解主节点的读负载。

2. **复制过程**：

   - **Binlog（二进制日志）：**
      主节点将所有的写入操作记录到二进制日志中。
   - **I/O 线程：**
      从节点启动 I/O 线程，读取主节点的 Binlog 并写入到从节点的中继日志（Relay Log）。
   - **SQL 线程：**
      从节点启动 SQL 线程，从中继日志中读取写入操作并执行，最终使从节点的数据与主节点保持一致。

   



#### 2. 主从复制的特点

1. **弱一致性**（最终一致性）：
   - 数据从主节点复制到从节点有一定延迟（Replication Lag）。
   - 主节点更新完成后，从节点需要一段时间才能同步这些更新，因此从节点读取到的数据可能不是最新的。
   - 异步复制模式下尤其如此。
2. **高可用性**：
   - 即使从节点故障，其他从节点仍然可用。
   - 主节点故障后，可以通过主从切换工具（如 MHA、Keepalived 等）快速提升某个从节点为主节点，保证服务可用性。
3. **分区容忍性**：
   - 当主从节点之间的网络分区发生时，主节点仍然可以继续写入数据，而从节点会在网络恢复后继续同步。
   - 这种设计保证了分区下的容忍性，但数据一致性可能受到影响。





#### 3. 主从复制的优势

1. 读写分离
   - 主节点处理写操作，从节点分担读操作，缓解单点性能瓶颈。
2. 数据备份
   - 从节点可以作为主节点的实时备份，提升数据安全性。
3. 扩展性
   - 通过增加从节点数量，轻松扩展系统的读能力。





#### 4. 主从复制的局限

1. 数据一致性问题
   - 异步复制可能导致从节点存在短时间内的数据不一致。
   - 半同步复制虽然提高了一致性，但增加了写操作的延迟。
2. 写入性能瓶颈
   - 写入操作只能由主节点完成，主节点的写能力是系统的瓶颈。
3. 故障切换复杂性
   - 主节点故障后，需要手动或借助工具提升从节点为主节点，存在短暂的不可用时间。





#### 5. 常见复制模式

1. 异步复制（默认）
   - 主节点不等待从节点确认复制完成，写操作性能高，但可能导致数据丢失或不一致。
2. 半同步复制
   - 主节点至少等待一个从节点确认接收到日志后再返回成功，提高一致性但降低性能。
3. 同步复制
   - 所有从节点都完成同步后，主节点才返回成功，保证强一致性，但性能较差。





#### 6. 总结

MySQL 主从复制的关键特性：

- **架构模式：** 主写从读。
- **复制机制：** Binlog + Relay Log + SQL 线程。
- **特点：** 弱一致性（最终一致性）、高可用性、分区容忍性。
- **适用场景：** 高读负载的系统（如电商、社交网络）、读写分离场景。





### 如何搭建

搭建 MySQL 主从复制需要按照以下步骤进行配置和操作。我们以一个主节点和一个从节点为例，介绍具体的配置步骤。

------

#### **环境准备**

- **操作系统**：Linux 或 Windows

- **MySQL 版本**：建议使用相同版本的 MySQL，避免兼容性问题。

- 角色划分

  ：

  - 主节点（Master）：负责写入数据。
  - 从节点（Slave）：同步主节点的数据，主要负责读操作。

------



#### 1. 主节点配置



##### 1.1 编辑 MySQL 配置文件

- 配置文件路径（常见位置）：
  - Linux: `/etc/my.cnf`
  - Windows: `my.ini`

在 `[mysqld]` 部分添加以下配置：

```bash
[mysqld]
server-id=1                # 唯一的服务器ID，主节点设为1
log-bin=mysql-bin          # 启用二进制日志，文件名为mysql-bin
binlog-format=ROW          # 推荐使用ROW模式，支持行级复制
```

> **注意：**
>
> - `server-id` 是 MySQL 实例的唯一标识，主从节点不能相同。
> - 二进制日志（`log-bin`）是主从复制的核心。



##### 1.2 重启 MySQL 服务

```bash
# 在 Linux 上
sudo systemctl restart mysqld
```



##### 1.3 创建复制用户

- 为从节点设置一个专用的复制账号，用于从主节点读取二进制日志。

```sql
-- 登录 MySQL
mysql -u root -p

-- 创建用户
CREATE USER 'repl'@'%' IDENTIFIED BY 'password';

-- 授予复制权限
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```



##### 1.4 查看二进制日志信息

- 获取当前的二进制日志文件名和位置：

```sql
SHOW MASTER STATUS;
```

输出示例：

```text
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 |      154 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
```

记下 **File** 和 **Position** 的值，在配置从节点时需要用到。

------





#### 2. 从节点配置



##### 2.1 编辑 MySQL 配置文件

在 `[mysqld]` 部分添加以下配置：

```bash
[mysqld]
server-id=2                # 唯一的服务器ID，必须与主节点不同
relay-log=relay-bin        # 启用中继日志，文件名为relay-bin
read_only=1                # 设置为只读模式，防止写入数据破坏一致性
```



##### 2.2 重启 MySQL 服务

```bash
# 在 Linux 上
sudo systemctl restart mysqld
```



##### 2.3 配置主从复制

登录从节点的 MySQL：

```sql
-- 设置主节点信息
CHANGE MASTER TO
  MASTER_HOST='主节点IP地址',
  MASTER_USER='repl',                 -- 复制用户
  MASTER_PASSWORD='password',         -- 复制用户密码
  MASTER_LOG_FILE='mysql-bin.000001', -- 主节点的二进制日志文件名
  MASTER_LOG_POS=154;                 -- 主节点的二进制日志位置
```



##### 2.4 启动复制

```sql
START SLAVE;
```



##### 2.5 查看复制状态

```sql
SHOW SLAVE STATUS\G;
```

输出关键字段：

- **Slave_IO_Running: Yes**
- **Slave_SQL_Running: Yes**

如果两项都是 `Yes`，说明主从复制已经成功运行。

------





#### 3. 验证主从复制

1. **在主节点插入数据：**

   ```sql
   USE testdb;
   INSERT INTO users (id, name) VALUES (1, 'Alice');
   ```

2. **在从节点查询数据：**

   ```sql
   USE testdb;
   SELECT * FROM users;
   ```

如果数据成功同步到从节点，说明主从复制配置完成。

------



#### 常见问题排查

1. **从节点复制失败：**
   - 检查 `SHOW SLAVE STATUS\G` 中的 **Last_IO_Error** 和 **Last_SQL_Error**。
   - 确保主从节点的 `server-id` 不重复。
   - 确认主节点的二进制日志和位置是否正确。
2. **延迟问题：**
   - 检查从节点的 **Seconds_Behind_Master**。
   - 增加从节点的 I/O 性能，调整网络质量。

------





#### 总结

- 主从复制通过 **Binlog + Relay Log** 实现主节点写入操作的同步。

  - Binlog（二进制日志）：

    - **定义**：主节点记录所有写操作（如 `INSERT`、`UPDATE`、`DELETE`）的日志文件。

      **作用**：提供一份可以重播的操作记录，从节点通过读取 Binlog 重现主节点上的操作，从而保持数据一致。

      **存储位置**：在主节点的磁盘上，以 `mysql-bin.000001` 等文件形式存储。

  - Relay Log（中继日志）：

    - **定义**：从节点在接收到主节点的 Binlog 后，保存到自己的中继日志中。

      **作用**：从节点的 SQL 线程从中继日志读取操作并执行，使得从节点的数据逐步和主节点同步。

      **存储位置**：在从节点的磁盘上，以 `relay-bin.000001` 等文件形式存储。

- 默认的异步复制适合大多数场景，但需要根据一致性需求调整为半同步或同步复制。

- 实际部署中，可以通过 ProxySQL 或 Keepalived 增强主从切换能力。

如果需要更深入的实践或想了解更多主从复制的高级配置（如 GTID 模式），可以随时告诉我！ 😊





### 实现流程



主从复制的过程分为以下三个阶段：

#### **阶段1：主节点生成二进制日志（Binlog）**

主节点上的所有写操作（如 `INSERT`、`UPDATE`）会先被写入 Binlog。

- 操作包括事务开始、SQL 语句执行和事务提交等。

Binlog 中包含操作的 **时间戳**、**事务 ID** 和 **操作数据**。

- 对于 `INSERT INTO users (id, name) VALUES (1, 'Alice');`，Binlog 会记录类似以下内容：

```sql
BEGIN;
INSERT INTO users (id, name) VALUES (1, 'Alice');
COMMIT;
```





#### **阶段2：从节点读取主节点的 Binlog**

1. 从节点启动 **I/O 线程**，通过网络连接到主节点。
2. **I/O 线程发送请求，要求从 Binlog 的指定位置开始读取数据。**
   - **如果从节点是首次连接，会从最新的 Binlog 文件开始读取。**
   - **如果从节点已经同步过数据，会从上次中断的位置继续。**
3. 主节点将 Binlog 的内容通过网络发送给从节点。
4. 从节点的 I/O 线程接收到数据后，写入自己的中继日志（Relay Log）。



#### **阶段3：从节点执行中继日志（Relay Log）**

1. 从节点启动 **SQL 线程**，从 Relay Log 中读取操作记录。

2. SQL 线程按顺序执行 Relay Log 中的每一条操作，将主节点的写操作重现到从节点上。

   - 示例：Relay Log 中的内容：

     ```sql
     BEGIN;
     INSERT INTO users (id, name) VALUES (1, 'Alice');
     COMMIT;
     ```

   - SQL 线程会在从节点上执行 `INSERT INTO users (id, name) VALUES (1, 'Alice');`。

3. 随着 Relay Log 的执行，从节点的数据逐步与主节点保持一致。

------



### 状态保持

- 主节点的状态：
  - **主节点会持续生成 Binlog，不会因为从节点的状态变化而中断。**
- 从节点的状态：
  - 从节点通过 **SHOW SLAVE STATUS** 命令，记录 Binlog 的当前文件名和位置，确保中断后能继续同步。
  - 关键字段：
    - `Master_Log_File`：当前同步的主节点 Binlog 文件名。
    - `Read_Master_Log_Pos`：当前同步到的 Binlog 文件位置。
    - `Relay_Master_Log_File`：从节点对应的中继日志的主节点文件。
    - `Seconds_Behind_Master`：从节点落后于主节点的时间（以秒计）。



### 主从复制的优势

#### 读写分离：

- 主节点专注于写操作，从节点分担读操作，提升整体性能。

#### 容错能力：

- 从节点可以作为主节点的备份，主节点故障后快速切换。

#### 数据备份：

- 从节点可以用于定期备份，避免主节点备份对业务的影响。







### 延迟排查



#### 常见问题

1. **复制延迟（Replication Lag）：**
   - 原因：主节点写入速度过快，从节点处理能力不足。
   - 解决：优化从节点的硬件性能，减少 SQL 线程的执行压力。
2. **网络分区问题：**
   - 主从节点之间的网络延迟或分区会导致同步中断。
   - 解决：定期监控网络状态，配置重试机制。
3. **数据不一致：**
   - 可能由于从节点手动修改数据，或者复制中断过长导致。
   - 解决：通过重新同步数据或使用工具修复。















